'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumAtoms = require('appium-atoms');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

/*
 * Takes a dictionary from the remote debugger and makes a more manageable
 * dictionary whose keys are understandable
 */
function appInfoFromDict(dict) {
  var id = dict.WIRApplicationIdentifierKey;
  var isProxy = _lodash2['default'].isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  var entry = {
    id: id,
    isProxy: isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled: !!dict.WIRRemoteAutomationEnabledKey
  };

  return [id, entry];
}

/*
 * Take a dictionary from the remote debugger and makes a more manageable
 * dictionary of pages available.
 */
function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    // the page is already translated, so wrap in an array and pass back
    return [pageDict];
  }
  var newPageArray = [];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].values(pageDict)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dict = _step.value;

      // count only WIRTypeWeb pages and ignore all others (WIRTypeJavaScript etc)
      if (_lodash2['default'].isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
        newPageArray.push({
          id: dict.WIRPageIdentifierKey,
          title: dict.WIRTitleKey,
          url: dict.WIRURLKey,
          isKey: !_lodash2['default'].isUndefined(dict.WIRConnectionIdentifierKey)
        });
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return newPageArray;
}

/*
 * Given a bundle id, finds the correct remote debugger app that is
 * connected.
 */
function getDebuggerAppKey(bundleId, platformVersion, appDict) {
  var appId = undefined;
  if (parseFloat(platformVersion) >= 8) {
    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(appDict)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        var _step2$value = _slicedToArray(_step2.value, 2);

        var key = _step2$value[0];
        var data = _step2$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }
      // now we need to determine if we should pick a proxy for this instead
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }

    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var proxiedAppIds = [];
      var _iteratorNormalCompletion3 = true;
      var _didIteratorError3 = false;
      var _iteratorError3 = undefined;

      try {
        for (var _iterator3 = _getIterator(_lodash2['default'].toPairs(appDict)), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          var _step3$value = _slicedToArray(_step3.value, 2);

          var key = _step3$value[0];
          var data = _step3$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError3 = true;
        _iteratorError3 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion3 && _iterator3['return']) {
            _iterator3['return']();
          }
        } finally {
          if (_didIteratorError3) {
            throw _iteratorError3;
          }
        }
      }

      if (proxiedAppIds.length) {
        // use the last app being proxied
        appId = _lodash2['default'].last(proxiedAppIds);
        _logger2['default'].debug('Using proxied app id \'' + appId + '\'');
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      appId = bundleId;
    }
  }

  return appId;
}

function getPossibleDebuggerAppKeys(bundleId, platformVersion, appDict) {
  var proxiedAppIds = [];
  if (parseFloat(platformVersion) >= 8) {
    var appId = undefined;
    var _iteratorNormalCompletion4 = true;
    var _didIteratorError4 = false;
    var _iteratorError4 = undefined;

    try {
      for (var _iterator4 = _getIterator(_lodash2['default'].toPairs(appDict)), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
        var _step4$value = _slicedToArray(_step4.value, 2);

        var key = _step4$value[0];
        var data = _step4$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }
      // now we need to determine if we should pick a proxy for this instead
    } catch (err) {
      _didIteratorError4 = true;
      _iteratorError4 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }
      } finally {
        if (_didIteratorError4) {
          throw _iteratorError4;
        }
      }
    }

    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var _iteratorNormalCompletion5 = true;
      var _didIteratorError5 = false;
      var _iteratorError5 = undefined;

      try {
        for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(appDict)), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
          var _step5$value = _slicedToArray(_step5.value, 2);

          var key = _step5$value[0];
          var data = _step5$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError5 = true;
        _iteratorError5 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion5 && _iterator5['return']) {
            _iterator5['return']();
          }
        } finally {
          if (_didIteratorError5) {
            throw _iteratorError5;
          }
        }
      }

      if (proxiedAppIds.length === 0) {
        proxiedAppIds = [appId];
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      proxiedAppIds = [bundleId];
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  var errors = [];
  var _iteratorNormalCompletion6 = true;
  var _didIteratorError6 = false;
  var _iteratorError6 = undefined;

  try {
    for (var _iterator6 = _getIterator(_lodash2['default'].toPairs(params)), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {
      var _step6$value = _slicedToArray(_step6.value, 2);

      var param = _step6$value[0];
      var value = _step6$value[1];

      try {
        _assert2['default'].ok(value);
      } catch (err) {
        errors.push(param);
      }
    }
  } catch (err) {
    _didIteratorError6 = true;
    _iteratorError6 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion6 && _iterator6['return']) {
        _iterator6['return']();
      }
    } finally {
      if (_didIteratorError6) {
        throw _iteratorError6;
      }
    }
  }

  if (errors.length) {
    return errors;
  }
}

function wrapScriptForFrame(script, frame) {
  _logger2['default'].debug('Wrapping script for frame \'' + frame + '\'');
  var elFromCache = (0, _appiumAtoms.get)('get_element_from_cache');
  return '(function (window) { var document = window.document; ' + ('return (' + script + '); })((' + elFromCache.toString('utf8') + ')(' + JSON.stringify(frame) + '))');
}

function getScriptForAtom(atom, args, frames) {
  var asyncCallBack = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

  var atomSrc = (0, _appiumAtoms.get)(atom);
  var script = undefined;
  if (frames.length > 0) {
    script = atomSrc;
    var _iteratorNormalCompletion7 = true;
    var _didIteratorError7 = false;
    var _iteratorError7 = undefined;

    try {
      for (var _iterator7 = _getIterator(frames), _step7; !(_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done); _iteratorNormalCompletion7 = true) {
        var frame = _step7.value;

        script = wrapScriptForFrame(script, frame);
      }
    } catch (err) {
      _didIteratorError7 = true;
      _iteratorError7 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion7 && _iterator7['return']) {
          _iterator7['return']();
        }
      } finally {
        if (_didIteratorError7) {
          throw _iteratorError7;
        }
      }
    }
  } else {
    _logger2['default'].debug('Executing \'' + atom + '\' atom in default context');
    script = '(' + atomSrc + ')';
  }

  // add the arguments, as strings
  args = args.map(JSON.stringify);
  if (asyncCallBack) {
    script += '(' + args.join(',') + ', ' + asyncCallBack + ', true )';
  } else {
    script += '(' + args.join(',') + ')';
  }

  return script;
}

function simpleStringify(value) {
  if (!value) return JSON.stringify(value);

  // we get back objects sometimes with string versions of functions
  // which muddy the logs
  var cleanValue = _lodash2['default'].clone(value);
  var _arr = ['ceil', 'clone', 'floor', 'round', 'scale', 'toString'];
  for (var _i = 0; _i < _arr.length; _i++) {
    var property = _arr[_i];
    delete cleanValue[property];
  }
  return JSON.stringify(cleanValue);
}

function deferredPromise() {
  // http://bluebirdjs.com/docs/api/deferred-migration.html
  var resolve = undefined;
  var reject = undefined;
  var promise = new _bluebird2['default'](function (res, rej) {
    resolve = res;
    reject = rej;
  });
  return {
    promise: promise,
    resolve: resolve,
    reject: reject
  };
}

exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQkFBZ0IsVUFBVTs7OzsyQkFDSyxjQUFjOztzQkFDL0IsUUFBUTs7OztzQkFDSCxRQUFROzs7O3dCQUNQLFVBQVU7Ozs7Ozs7O0FBTzlCLFNBQVMsZUFBZSxDQUFFLElBQUksRUFBRTtBQUM5QixNQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsMkJBQTJCLENBQUM7QUFDMUMsTUFBSSxPQUFPLEdBQUcsb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxHQUN2QyxJQUFJLENBQUMsd0JBQXdCLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQztBQUN2RyxNQUFJLEtBQUssR0FBRztBQUNWLE1BQUUsRUFBRixFQUFFO0FBQ0YsV0FBTyxFQUFQLE9BQU87QUFDUCxRQUFJLEVBQUUsSUFBSSxDQUFDLHFCQUFxQjtBQUNoQyxZQUFRLEVBQUUsSUFBSSxDQUFDLGlDQUFpQztBQUNoRCxVQUFNLEVBQUUsSUFBSSxDQUFDLCtCQUErQjtBQUM1QyxZQUFRLEVBQUUsSUFBSSxDQUFDLHlCQUF5QjtBQUN4Qyx1QkFBbUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLDZCQUE2QjtHQUMxRCxDQUFDOztBQUVGLFNBQU8sQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7Q0FDcEI7Ozs7OztBQU1ELFNBQVMsaUJBQWlCLENBQUUsUUFBUSxFQUFFO0FBQ3BDLE1BQUksUUFBUSxDQUFDLEVBQUUsRUFBRTs7QUFFZixXQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7R0FDbkI7QUFDRCxNQUFJLFlBQVksR0FBRyxFQUFFLENBQUM7Ozs7OztBQUN0QixzQ0FBaUIsb0JBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyw0R0FBRTtVQUE1QixJQUFJOzs7QUFFWCxVQUFJLG9CQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxZQUFZLEVBQUU7QUFDdEUsb0JBQVksQ0FBQyxJQUFJLENBQUM7QUFDaEIsWUFBRSxFQUFFLElBQUksQ0FBQyxvQkFBb0I7QUFDN0IsZUFBSyxFQUFFLElBQUksQ0FBQyxXQUFXO0FBQ3ZCLGFBQUcsRUFBRSxJQUFJLENBQUMsU0FBUztBQUNuQixlQUFLLEVBQUUsQ0FBQyxvQkFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDO1NBQ3ZELENBQUMsQ0FBQztPQUNKO0tBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDRCxTQUFPLFlBQVksQ0FBQztDQUNyQjs7Ozs7O0FBTUQsU0FBUyxpQkFBaUIsQ0FBRSxRQUFRLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRTtBQUM5RCxNQUFJLEtBQUssWUFBQSxDQUFDO0FBQ1YsTUFBSSxVQUFVLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFOzs7Ozs7QUFDcEMseUNBQXdCLG9CQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUhBQUU7OztZQUFsQyxHQUFHO1lBQUUsSUFBSTs7QUFDakIsWUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRTtBQUM5QixlQUFLLEdBQUcsR0FBRyxDQUFDO0FBQ1osZ0JBQU07U0FDUDtPQUNGOzs7Ozs7Ozs7Ozs7Ozs7OztBQUVELFFBQUksS0FBSyxFQUFFO0FBQ1QsMEJBQUksS0FBSyx5QkFBc0IsS0FBSyx3QkFBaUIsUUFBUSxRQUFJLENBQUM7QUFDbEUsVUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDOzs7Ozs7QUFDdkIsMkNBQXdCLG9CQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUhBQUU7OztjQUFsQyxHQUFHO2NBQUUsSUFBSTs7QUFDakIsY0FBSSxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssS0FBSyxFQUFFO0FBQ3pDLGdDQUFJLEtBQUssQ0FBQywrQkFBNEIsSUFBSSxDQUFDLFFBQVEsdUNBQ2pCLFFBQVEsMEJBQW1CLEdBQUcsUUFBRyxDQUFDLENBQUM7QUFDckUseUJBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7V0FDekI7U0FDRjs7Ozs7Ozs7Ozs7Ozs7OztBQUNELFVBQUksYUFBYSxDQUFDLE1BQU0sRUFBRTs7QUFFeEIsYUFBSyxHQUFHLG9CQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUM5Qiw0QkFBSSxLQUFLLDZCQUEwQixLQUFLLFFBQUksQ0FBQztPQUM5QztLQUNGO0dBQ0YsTUFBTTtBQUNMLFFBQUksb0JBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRTtBQUM1QixXQUFLLEdBQUcsUUFBUSxDQUFDO0tBQ2xCO0dBQ0Y7O0FBRUQsU0FBTyxLQUFLLENBQUM7Q0FDZDs7QUFFRCxTQUFTLDBCQUEwQixDQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFO0FBQ3ZFLE1BQUksYUFBYSxHQUFHLEVBQUUsQ0FBQztBQUN2QixNQUFJLFVBQVUsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUU7QUFDcEMsUUFBSSxLQUFLLFlBQUEsQ0FBQzs7Ozs7O0FBQ1YseUNBQXdCLG9CQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUhBQUU7OztZQUFsQyxHQUFHO1lBQUUsSUFBSTs7QUFDakIsWUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRTtBQUM5QixlQUFLLEdBQUcsR0FBRyxDQUFDO0FBQ1osZ0JBQU07U0FDUDtPQUNGOzs7Ozs7Ozs7Ozs7Ozs7OztBQUVELFFBQUksS0FBSyxFQUFFO0FBQ1QsMEJBQUksS0FBSyx5QkFBc0IsS0FBSyx3QkFBaUIsUUFBUSxRQUFJLENBQUM7Ozs7OztBQUNsRSwyQ0FBd0Isb0JBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxpSEFBRTs7O2NBQWxDLEdBQUc7Y0FBRSxJQUFJOztBQUNqQixjQUFJLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxLQUFLLEVBQUU7QUFDekMsZ0NBQUksS0FBSyxDQUFDLCtCQUE0QixJQUFJLENBQUMsUUFBUSx1Q0FDakIsUUFBUSwwQkFBbUIsR0FBRyxRQUFHLENBQUMsQ0FBQztBQUNyRSx5QkFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztXQUN6QjtTQUNGOzs7Ozs7Ozs7Ozs7Ozs7O0FBQ0QsVUFBSSxhQUFhLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUM5QixxQkFBYSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7T0FDekI7S0FDRjtHQUNGLE1BQU07QUFDTCxRQUFJLG9CQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUU7QUFDNUIsbUJBQWEsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQzVCO0dBQ0Y7O0FBRUQsU0FBTyxhQUFhLENBQUM7Q0FDdEI7O0FBRUQsU0FBUyxXQUFXLENBQUUsTUFBTSxFQUFFO0FBQzVCLE1BQUksTUFBTSxHQUFHLEVBQUUsQ0FBQzs7Ozs7O0FBQ2hCLHVDQUEyQixvQkFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLGlIQUFFOzs7VUFBcEMsS0FBSztVQUFFLEtBQUs7O0FBQ3BCLFVBQUk7QUFDRiw0QkFBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7T0FDbEIsQ0FBQyxPQUFPLEdBQUcsRUFBRTtBQUNaLGNBQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7T0FDcEI7S0FDRjs7Ozs7Ozs7Ozs7Ozs7OztBQUNELE1BQUksTUFBTSxDQUFDLE1BQU0sRUFBRTtBQUNqQixXQUFPLE1BQU0sQ0FBQztHQUNmO0NBQ0Y7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO0FBQzFDLHNCQUFJLEtBQUssa0NBQStCLEtBQUssUUFBSSxDQUFDO0FBQ2xELE1BQUksV0FBVyxHQUFHLHNCQUFRLHdCQUF3QixDQUFDLENBQUM7QUFDcEQsU0FBTyx3RUFDVyxNQUFNLGVBQVUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBSyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxRQUFJLENBQUM7Q0FDOUY7O0FBRUQsU0FBUyxnQkFBZ0IsQ0FBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBd0I7TUFBdEIsYUFBYSx5REFBRyxJQUFJOztBQUNqRSxNQUFJLE9BQU8sR0FBRyxzQkFBUSxJQUFJLENBQUMsQ0FBQztBQUM1QixNQUFJLE1BQU0sWUFBQSxDQUFDO0FBQ1gsTUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUNyQixVQUFNLEdBQUcsT0FBTyxDQUFDOzs7Ozs7QUFDakIseUNBQWtCLE1BQU0saUhBQUU7WUFBakIsS0FBSzs7QUFDWixjQUFNLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO09BQzVDOzs7Ozs7Ozs7Ozs7Ozs7R0FDRixNQUFNO0FBQ0wsd0JBQUksS0FBSyxrQkFBZSxJQUFJLGdDQUE0QixDQUFDO0FBQ3pELFVBQU0sU0FBTyxPQUFPLE1BQUcsQ0FBQztHQUN6Qjs7O0FBR0QsTUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2hDLE1BQUksYUFBYSxFQUFFO0FBQ2pCLFVBQU0sVUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFLLGFBQWEsYUFBVSxDQUFDO0dBQzFELE1BQU07QUFDTCxVQUFNLFVBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBRyxDQUFDO0dBQ2pDOztBQUVELFNBQU8sTUFBTSxDQUFDO0NBQ2Y7O0FBRUQsU0FBUyxlQUFlLENBQUUsS0FBSyxFQUFFO0FBQy9CLE1BQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDOzs7O0FBSXpDLE1BQUksVUFBVSxHQUFHLG9CQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNYLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLENBQUM7QUFBN0UsMkNBQStFO0FBQTFFLFFBQUksUUFBUSxXQUFBLENBQUE7QUFDZixXQUFPLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztHQUM3QjtBQUNELFNBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztDQUNuQzs7QUFFRCxTQUFTLGVBQWUsR0FBSTs7QUFFMUIsTUFBSSxPQUFPLFlBQUEsQ0FBQztBQUNaLE1BQUksTUFBTSxZQUFBLENBQUM7QUFDWCxNQUFJLE9BQU8sR0FBRywwQkFBWSxVQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUs7QUFDdEMsV0FBTyxHQUFHLEdBQUcsQ0FBQztBQUNkLFVBQU0sR0FBRyxHQUFHLENBQUM7R0FDZCxDQUFDLENBQUM7QUFDSCxTQUFPO0FBQ0wsV0FBTyxFQUFQLE9BQU87QUFDUCxXQUFPLEVBQVAsT0FBTztBQUNQLFVBQU0sRUFBTixNQUFNO0dBQ1AsQ0FBQztDQUNIOztRQUVRLGVBQWUsR0FBZixlQUFlO1FBQUUsaUJBQWlCLEdBQWpCLGlCQUFpQjtRQUFFLGlCQUFpQixHQUFqQixpQkFBaUI7UUFBRSwwQkFBMEIsR0FBMUIsMEJBQTBCO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFDOUYsa0JBQWtCLEdBQWxCLGtCQUFrQjtRQUFFLGdCQUFnQixHQUFoQixnQkFBZ0I7UUFBRSxlQUFlLEdBQWYsZUFBZTtRQUFFLGVBQWUsR0FBZixlQUFlIiwiZmlsZSI6ImxpYi9oZWxwZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXQgYXMgZ2V0QXRvbSB9IGZyb20gJ2FwcGl1bS1hdG9tcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGFzc2VydCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbi8qXG4gKiBUYWtlcyBhIGRpY3Rpb25hcnkgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyIGFuZCBtYWtlcyBhIG1vcmUgbWFuYWdlYWJsZVxuICogZGljdGlvbmFyeSB3aG9zZSBrZXlzIGFyZSB1bmRlcnN0YW5kYWJsZVxuICovXG5mdW5jdGlvbiBhcHBJbmZvRnJvbURpY3QgKGRpY3QpIHtcbiAgbGV0IGlkID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gIGxldCBpc1Byb3h5ID0gXy5pc1N0cmluZyhkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleSkgP1xuICAgICAgICAgICAgICAgICAgZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnIDogZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXk7XG4gIGxldCBlbnRyeSA9IHtcbiAgICBpZCxcbiAgICBpc1Byb3h5LFxuICAgIG5hbWU6IGRpY3QuV0lSQXBwbGljYXRpb25OYW1lS2V5LFxuICAgIGJ1bmRsZUlkOiBkaWN0LldJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleSxcbiAgICBob3N0SWQ6IGRpY3QuV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleSxcbiAgICBpc0FjdGl2ZTogZGljdC5XSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5LFxuICAgIGlzQXV0b21hdGlvbkVuYWJsZWQ6ICEhZGljdC5XSVJSZW1vdGVBdXRvbWF0aW9uRW5hYmxlZEtleSxcbiAgfTtcblxuICByZXR1cm4gW2lkLCBlbnRyeV07XG59XG5cbi8qXG4gKiBUYWtlIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IG9mIHBhZ2VzIGF2YWlsYWJsZS5cbiAqL1xuZnVuY3Rpb24gcGFnZUFycmF5RnJvbURpY3QgKHBhZ2VEaWN0KSB7XG4gIGlmIChwYWdlRGljdC5pZCkge1xuICAgIC8vIHRoZSBwYWdlIGlzIGFscmVhZHkgdHJhbnNsYXRlZCwgc28gd3JhcCBpbiBhbiBhcnJheSBhbmQgcGFzcyBiYWNrXG4gICAgcmV0dXJuIFtwYWdlRGljdF07XG4gIH1cbiAgbGV0IG5ld1BhZ2VBcnJheSA9IFtdO1xuICBmb3IgKGxldCBkaWN0IG9mIF8udmFsdWVzKHBhZ2VEaWN0KSkge1xuICAgIC8vIGNvdW50IG9ubHkgV0lSVHlwZVdlYiBwYWdlcyBhbmQgaWdub3JlIGFsbCBvdGhlcnMgKFdJUlR5cGVKYXZhU2NyaXB0IGV0YylcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChkaWN0LldJUlR5cGVLZXkpIHx8IGRpY3QuV0lSVHlwZUtleSA9PT0gJ1dJUlR5cGVXZWInKSB7XG4gICAgICBuZXdQYWdlQXJyYXkucHVzaCh7XG4gICAgICAgIGlkOiBkaWN0LldJUlBhZ2VJZGVudGlmaWVyS2V5LFxuICAgICAgICB0aXRsZTogZGljdC5XSVJUaXRsZUtleSxcbiAgICAgICAgdXJsOiBkaWN0LldJUlVSTEtleSxcbiAgICAgICAgaXNLZXk6ICFfLmlzVW5kZWZpbmVkKGRpY3QuV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXkpLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBuZXdQYWdlQXJyYXk7XG59XG5cbi8qXG4gKiBHaXZlbiBhIGJ1bmRsZSBpZCwgZmluZHMgdGhlIGNvcnJlY3QgcmVtb3RlIGRlYnVnZ2VyIGFwcCB0aGF0IGlzXG4gKiBjb25uZWN0ZWQuXG4gKi9cbmZ1bmN0aW9uIGdldERlYnVnZ2VyQXBwS2V5IChidW5kbGVJZCwgcGxhdGZvcm1WZXJzaW9uLCBhcHBEaWN0KSB7XG4gIGxldCBhcHBJZDtcbiAgaWYgKHBhcnNlRmxvYXQocGxhdGZvcm1WZXJzaW9uKSA+PSA4KSB7XG4gICAgZm9yIChsZXQgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgICBpZiAoZGF0YS5idW5kbGVJZCA9PT0gYnVuZGxlSWQpIHtcbiAgICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBub3cgd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIHBpY2sgYSBwcm94eSBmb3IgdGhpcyBpbnN0ZWFkXG4gICAgaWYgKGFwcElkKSB7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIGFwcCBpZCBrZXkgJyR7YXBwSWR9JyBmb3IgYnVuZGxlICcke2J1bmRsZUlkfSdgKTtcbiAgICAgIGxldCBwcm94aWVkQXBwSWRzID0gW107XG4gICAgICBmb3IgKGxldCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgICAgaWYgKGRhdGEuaXNQcm94eSAmJiBkYXRhLmhvc3RJZCA9PT0gYXBwSWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvdW5kIHNlcGFyYXRlIGJ1bmRsZUlkICcke2RhdGEuYnVuZGxlSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgICBwcm94aWVkQXBwSWRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHByb3hpZWRBcHBJZHMubGVuZ3RoKSB7XG4gICAgICAgIC8vIHVzZSB0aGUgbGFzdCBhcHAgYmVpbmcgcHJveGllZFxuICAgICAgICBhcHBJZCA9IF8ubGFzdChwcm94aWVkQXBwSWRzKTtcbiAgICAgICAgbG9nLmRlYnVnKGBVc2luZyBwcm94aWVkIGFwcCBpZCAnJHthcHBJZH0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChfLmhhcyhhcHBEaWN0LCBidW5kbGVJZCkpIHtcbiAgICAgIGFwcElkID0gYnVuZGxlSWQ7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFwcElkO1xufVxuXG5mdW5jdGlvbiBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyAoYnVuZGxlSWQsIHBsYXRmb3JtVmVyc2lvbiwgYXBwRGljdCkge1xuICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuICBpZiAocGFyc2VGbG9hdChwbGF0Zm9ybVZlcnNpb24pID49IDgpIHtcbiAgICBsZXQgYXBwSWQ7XG4gICAgZm9yIChsZXQgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgICBpZiAoZGF0YS5idW5kbGVJZCA9PT0gYnVuZGxlSWQpIHtcbiAgICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBub3cgd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIHBpY2sgYSBwcm94eSBmb3IgdGhpcyBpbnN0ZWFkXG4gICAgaWYgKGFwcElkKSB7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIGFwcCBpZCBrZXkgJyR7YXBwSWR9JyBmb3IgYnVuZGxlICcke2J1bmRsZUlkfSdgKTtcbiAgICAgIGZvciAobGV0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgICBpZiAoZGF0YS5pc1Byb3h5ICYmIGRhdGEuaG9zdElkID09PSBhcHBJZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgc2VwYXJhdGUgYnVuZGxlSWQgJyR7ZGF0YS5idW5kbGVJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgYWN0aW5nIGFzIHByb3h5IGZvciAnJHtidW5kbGVJZH0nLCB3aXRoIGFwcCBpZCAnJHtrZXl9J2ApO1xuICAgICAgICAgIHByb3hpZWRBcHBJZHMucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAocHJveGllZEFwcElkcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcHJveGllZEFwcElkcyA9IFthcHBJZF07XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChfLmhhcyhhcHBEaWN0LCBidW5kbGVJZCkpIHtcbiAgICAgIHByb3hpZWRBcHBJZHMgPSBbYnVuZGxlSWRdO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwcm94aWVkQXBwSWRzO1xufVxuXG5mdW5jdGlvbiBjaGVja1BhcmFtcyAocGFyYW1zKSB7XG4gIGxldCBlcnJvcnMgPSBbXTtcbiAgZm9yIChsZXQgW3BhcmFtLCB2YWx1ZV0gb2YgXy50b1BhaXJzKHBhcmFtcykpIHtcbiAgICB0cnkge1xuICAgICAgYXNzZXJ0Lm9rKHZhbHVlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGVycm9ycy5wdXNoKHBhcmFtKTtcbiAgICB9XG4gIH1cbiAgaWYgKGVycm9ycy5sZW5ndGgpIHtcbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG59XG5cbmZ1bmN0aW9uIHdyYXBTY3JpcHRGb3JGcmFtZSAoc2NyaXB0LCBmcmFtZSkge1xuICBsb2cuZGVidWcoYFdyYXBwaW5nIHNjcmlwdCBmb3IgZnJhbWUgJyR7ZnJhbWV9J2ApO1xuICBsZXQgZWxGcm9tQ2FjaGUgPSBnZXRBdG9tKCdnZXRfZWxlbWVudF9mcm9tX2NhY2hlJyk7XG4gIHJldHVybiBgKGZ1bmN0aW9uICh3aW5kb3cpIHsgdmFyIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50OyBgICtcbiAgICAgICAgIGByZXR1cm4gKCR7c2NyaXB0fSk7IH0pKCgke2VsRnJvbUNhY2hlLnRvU3RyaW5nKCd1dGY4Jyl9KSgke0pTT04uc3RyaW5naWZ5KGZyYW1lKX0pKWA7XG59XG5cbmZ1bmN0aW9uIGdldFNjcmlwdEZvckF0b20gKGF0b20sIGFyZ3MsIGZyYW1lcywgYXN5bmNDYWxsQmFjayA9IG51bGwpIHtcbiAgbGV0IGF0b21TcmMgPSBnZXRBdG9tKGF0b20pO1xuICBsZXQgc2NyaXB0O1xuICBpZiAoZnJhbWVzLmxlbmd0aCA+IDApIHtcbiAgICBzY3JpcHQgPSBhdG9tU3JjO1xuICAgIGZvciAobGV0IGZyYW1lIG9mIGZyYW1lcykge1xuICAgICAgc2NyaXB0ID0gd3JhcFNjcmlwdEZvckZyYW1lKHNjcmlwdCwgZnJhbWUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2cuZGVidWcoYEV4ZWN1dGluZyAnJHthdG9tfScgYXRvbSBpbiBkZWZhdWx0IGNvbnRleHRgKTtcbiAgICBzY3JpcHQgPSBgKCR7YXRvbVNyY30pYDtcbiAgfVxuXG4gIC8vIGFkZCB0aGUgYXJndW1lbnRzLCBhcyBzdHJpbmdzXG4gIGFyZ3MgPSBhcmdzLm1hcChKU09OLnN0cmluZ2lmeSk7XG4gIGlmIChhc3luY0NhbGxCYWNrKSB7XG4gICAgc2NyaXB0ICs9IGAoJHthcmdzLmpvaW4oJywnKX0sICR7YXN5bmNDYWxsQmFja30sIHRydWUgKWA7XG4gIH0gZWxzZSB7XG4gICAgc2NyaXB0ICs9IGAoJHthcmdzLmpvaW4oJywnKX0pYDtcbiAgfVxuXG4gIHJldHVybiBzY3JpcHQ7XG59XG5cbmZ1bmN0aW9uIHNpbXBsZVN0cmluZ2lmeSAodmFsdWUpIHtcbiAgaWYgKCF2YWx1ZSkgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcblxuICAvLyB3ZSBnZXQgYmFjayBvYmplY3RzIHNvbWV0aW1lcyB3aXRoIHN0cmluZyB2ZXJzaW9ucyBvZiBmdW5jdGlvbnNcbiAgLy8gd2hpY2ggbXVkZHkgdGhlIGxvZ3NcbiAgbGV0IGNsZWFuVmFsdWUgPSBfLmNsb25lKHZhbHVlKTtcbiAgZm9yIChsZXQgcHJvcGVydHkgb2YgWydjZWlsJywgJ2Nsb25lJywgJ2Zsb29yJywgJ3JvdW5kJywgJ3NjYWxlJywgJ3RvU3RyaW5nJ10pIHtcbiAgICBkZWxldGUgY2xlYW5WYWx1ZVtwcm9wZXJ0eV07XG4gIH1cbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNsZWFuVmFsdWUpO1xufVxuXG5mdW5jdGlvbiBkZWZlcnJlZFByb21pc2UgKCkge1xuICAvLyBodHRwOi8vYmx1ZWJpcmRqcy5jb20vZG9jcy9hcGkvZGVmZXJyZWQtbWlncmF0aW9uLmh0bWxcbiAgbGV0IHJlc29sdmU7XG4gIGxldCByZWplY3Q7XG4gIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlcywgcmVqKSA9PiB7XG4gICAgcmVzb2x2ZSA9IHJlcztcbiAgICByZWplY3QgPSByZWo7XG4gIH0pO1xuICByZXR1cm4ge1xuICAgIHByb21pc2UsXG4gICAgcmVzb2x2ZSxcbiAgICByZWplY3RcbiAgfTtcbn1cblxuZXhwb3J0IHsgYXBwSW5mb0Zyb21EaWN0LCBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksIGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzLCBjaGVja1BhcmFtcyxcbiAgICAgICAgIHdyYXBTY3JpcHRGb3JGcmFtZSwgZ2V0U2NyaXB0Rm9yQXRvbSwgc2ltcGxlU3RyaW5naWZ5LCBkZWZlcnJlZFByb21pc2UgfTtcbiJdfQ==