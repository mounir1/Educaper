'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _remoteDebugger = require('./remote-debugger');

var _remoteMessages = require('./remote-messages');

var _remoteMessages2 = _interopRequireDefault(_remoteMessages);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _helpers = require('./helpers');

var WebKitRpcClient = (function (_events$EventEmitter) {
  _inherits(WebKitRpcClient, _events$EventEmitter);

  function WebKitRpcClient(host) {
    var port = arguments.length <= 1 || arguments[1] === undefined ? _remoteDebugger.REMOTE_DEBUGGER_PORT : arguments[1];

    _classCallCheck(this, WebKitRpcClient);

    _get(Object.getPrototypeOf(WebKitRpcClient.prototype), 'constructor', this).call(this);

    this.host = host;
    this.port = port;

    this.curMsgId = 0;

    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};

    this.setHandlers();
  }

  _createClass(WebKitRpcClient, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var url;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    url = 'ws://' + this.host + ':' + this.port + '/devtools/page/' + pageId;

                    this.pageIdKey = pageId;

                    // create and set up socket with appropriate event handlers
                    this.socket = new _ws2['default'](url);
                    this.socket.on('open', function () {
                      _logger2['default'].debug('WebKit debugger web socket connected to url: ' + url);
                      _this.connected = true;
                      resolve();
                    });
                    this.socket.on('close', function () {
                      _logger2['default'].debug('WebKit remote debugger socket disconnected');
                      _this.connected = false;
                    });
                    this.socket.on('error', function (exception) {
                      if (_this.connected) {
                        _logger2['default'].debug('WebKit debugger web socket error: ' + exception.message);
                        _this.connected = false;
                      }

                      reject(exception);
                    });
                    this.socket.on('message', this.receive.bind(this));

                  case 7:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      _logger2['default'].debug('Disconnecting from WebKit remote debugger');
      if (this.isConnected()) {
        this.socket.close(1001);
      }
      this.connected = false;
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return this.socket !== null && this.connected;
    }
  }, {
    key: 'send',
    value: function send(command) {
      var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var data, id;
      return _regeneratorRuntime.async(function send$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            data = (0, _remoteMessages2['default'])(command, _lodash2['default'].defaults({ connId: this.connId, senderId: this.senderId }, opts));

            _logger2['default'].debug('Sending WebKit data: ' + _lodash2['default'].truncate(JSON.stringify(data), 50));

            this.curMsgId++;
            data.id = this.curMsgId;

            id = this.curMsgId.toString();
            return context$2$0.abrupt('return', new _bluebird2['default'](function callee$2$0(resolve, reject) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    // only resolve the send command when WebKit returns a response
                    // store the handler and the data sent
                    this.dataHandlers[id] = resolve;
                    this.dataMethods[id] = data.method;
                    this.errorHandlers[id] = reject;

                    // send the data
                    data = JSON.stringify(data);
                    this.socket.send(data, function (error) {
                      if (!_lodash2['default'].isUndefined(error) && !_lodash2['default'].isNull(error)) {
                        _logger2['default'].debug('WebKit socket error occurred: ' + error);
                        reject(new Error(error));
                      }
                    });

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            })['finally'](function (res) {
              // no need to hold onto anything
              delete _this3.dataHandlers[id];
              delete _this3.dataMethods[id];
              delete _this3.errorHandlers[id];

              // and pass along the result
              return res;
            }).timeout(_remoteDebugger.RPC_RESPONSE_TIMEOUT_MS));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'receive',
    value: function receive(data) {
      _logger2['default'].debug('Receiving WebKit data: ' + _lodash2['default'].truncate(data, 50));

      data = JSON.parse(data);

      // we can get an error, or we can get a response that is an error
      if (data.wasThrown) {
        var message = data.result.value || data.result.description;
        var error = new Error(message);
        if (data.id && this.errorHandlers[data.id]) {
          this.errorHandlers[data.id](error);
          return;
        } else {
          // this should never happen, but log at least
          _logger2['default'].errorAndThrow(error);
        }
      }

      // when sending we set a data method and associated callback.
      // get that, or the generic (automatically sent, not associated
      // with a particular request) method
      var handlerFor = undefined;
      if (data.id && this.dataMethods[data.id]) {
        _logger2['default'].debug('Found handler for message \'' + data.id + '\'');
        handlerFor = this.dataMethods[data.id];
      } else {
        _logger2['default'].debug('Did not find handler for message');
        handlerFor = data.method;
      }

      if (!handlerFor) {
        _logger2['default'].debug('Received an invalid method: ' + data.method);
        return;
      }
      if (_lodash2['default'].has(this.handlers, handlerFor)) {
        this.handlers[handlerFor](data);
      } else {
        _logger2['default'].debug('WebKit debugger got a message for \'' + handlerFor + '\' ' + 'and have no handler, doing nothing.');
      }
    }
  }, {
    key: 'setHandlers',
    value: function setHandlers() {
      var _this4 = this;

      this.handlers = {
        'Runtime.evaluate': function RuntimeEvaluate(data) {
          var msgId = data.id;
          if (data.error) {
            _this4.errorHandlers[msgId](data.error);
          }

          _this4.dataHandlers[msgId](data.result);
        },
        'Page.navigate': function PageNavigate(data) {
          _logger2['default'].debug('Received page navigated message: ' + (0, _helpers.simpleStringify)(data));
          var msgId = data.id;
          if (data.error) {
            _this4.errorHandlers[msgId](data.error);
          }

          _this4.dataHandlers[msgId](data.result);
        },
        'Profiler.resetProfiles': function ProfilerResetProfiles() {
          _logger2['default'].debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
        },
        'Timeline.eventRecorded': function TimelineEventRecorded(data) {
          _this4.timelineEventHandler(data.result);
        }
      };
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
      this.messageHandler.setTimelineEventHandler(timelineEventHandler);
    }
  }]);

  return WebKitRpcClient;
})(_events2['default'].EventEmitter);

exports['default'] = WebKitRpcClient;
module.exports = exports['default'];

// we will only resolve this call when the socket is open
// WebKit url
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWdCLFVBQVU7Ozs7OEJBQ29DLG1CQUFtQjs7OEJBQ3BELG1CQUFtQjs7OztrQkFDMUIsSUFBSTs7Ozt3QkFDTixVQUFVOzs7O3NCQUNoQixRQUFROzs7O3NCQUNILFFBQVE7Ozs7dUJBQ0ssV0FBVzs7SUFHdEIsZUFBZTtZQUFmLGVBQWU7O0FBQ3RCLFdBRE8sZUFBZSxDQUNyQixJQUFJLEVBQStCO1FBQTdCLElBQUk7OzBCQURKLGVBQWU7O0FBRWhDLCtCQUZpQixlQUFlLDZDQUV4Qjs7QUFFUixRQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUNqQixRQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQzs7QUFFakIsUUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7O0FBRWxCLFFBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLFFBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLFFBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDOztBQUV4QixRQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7R0FDcEI7O2VBZGtCLGVBQWU7O1dBZ0JwQixpQkFBQyxNQUFNOzs7Ozs7Z0RBQ1osMEJBQVksb0JBQU8sT0FBTyxFQUFFLE1BQU07a0JBR25DLEdBQUc7Ozs7OztBQUFILHVCQUFHLGFBQVcsSUFBSSxDQUFDLElBQUksU0FBSSxJQUFJLENBQUMsSUFBSSx1QkFBa0IsTUFBTTs7QUFDaEUsd0JBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDOzs7QUFHeEIsd0JBQUksQ0FBQyxNQUFNLEdBQUcsb0JBQWMsR0FBRyxDQUFDLENBQUM7QUFDakMsd0JBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxZQUFNO0FBQzNCLDBDQUFJLEtBQUssbURBQWlELEdBQUcsQ0FBRyxDQUFDO0FB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LFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDdkM7QUFDRCxnQ0FBd0IsRUFBRSxpQ0FBTTtBQUM5Qiw4QkFBSSxLQUFLLENBQUMsMERBQTBELEdBQzFELCtCQUErQixDQUFDLENBQUM7U0FDNUM7QUFDRCxnQ0FBd0IsRUFBRSwrQkFBQyxJQUFJLEVBQUs7QUFDbEMsaUJBQUssb0JBQW9CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3hDO09BQ0YsQ0FBQztLQUNIOzs7V0FHdUIsaUNBQUMsb0JBQW9CLEVBQUU7QUFDN0MsVUFBSSxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO0FBQ2pELFVBQUksQ0FBQyxjQUFjLENBQUMsdUJBQXVCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztLQUNuRTs7O1NBMUtrQixlQUFlO0dBQVMsb0JBQU8sWUFBWTs7cUJBQTNDLGVBQWUiLCJmaWxlIjoibGliL3dlYmtpdC1ycGMtY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBSRU1PVEVfREVCVUdHRVJfUE9SVCwgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMgfSBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlcic7XG5pbXBvcnQgZ2V0UmVtb3RlQ29tbWFuZCBmcm9tICcuL3JlbW90ZS1tZXNzYWdlcyc7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBzaW1wbGVTdHJpbmdpZnkgfSBmcm9tICcuL2hlbHBlcnMnO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdlYktpdFJwY0NsaWVudCBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvciAoaG9zdCwgcG9ydCA9IFJFTU9URV9ERUJVR0dFUl9QT1JUKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuaG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcblxuICAgIHRoaXMuY3VyTXNnSWQgPSAwO1xuXG4gICAgdGhpcy5kYXRhSGFuZGxlcnMgPSB7fTtcbiAgICB0aGlzLmRhdGFNZXRob2RzID0ge307XG4gICAgdGhpcy5lcnJvckhhbmRsZXJzID0ge307XG5cbiAgICB0aGlzLnNldEhhbmRsZXJzKCk7XG4gIH1cblxuICBhc3luYyBjb25uZWN0IChwYWdlSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gd2Ugd2lsbCBvbmx5IHJlc29sdmUgdGhpcyBjYWxsIHdoZW4gdGhlIHNvY2tldCBpcyBvcGVuXG4gICAgICAvLyBXZWJLaXQgdXJsXG4gICAgICBsZXQgdXJsID0gYHdzOi8vJHt0aGlzLmhvc3R9OiR7dGhpcy5wb3J0fS9kZXZ0b29scy9wYWdlLyR7cGFnZUlkfWA7XG4gICAgICB0aGlzLnBhZ2VJZEtleSA9IHBhZ2VJZDtcblxuICAgICAgLy8gY3JlYXRlIGFuZCBzZXQgdXAgc29ja2V0IHdpdGggYXBwcm9wcmlhdGUgZXZlbnQgaGFuZGxlcnNcbiAgICAgIHRoaXMuc29ja2V0ID0gbmV3IFdlYlNvY2tldCh1cmwpO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ29wZW4nLCAoKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IGRlYnVnZ2VyIHdlYiBzb2NrZXQgY29ubmVjdGVkIHRvIHVybDogJHt1cmx9YCk7XG4gICAgICAgIHRoaXMuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZygnV2ViS2l0IHJlbW90ZSBkZWJ1Z2dlciBzb2NrZXQgZGlzY29ubmVjdGVkJyk7XG4gICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsIChleGNlcHRpb24pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBXZWJLaXQgZGVidWdnZXIgd2ViIHNvY2tldCBlcnJvcjogJHtleGNlcHRpb24ubWVzc2FnZX1gKTtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVqZWN0KGV4Y2VwdGlvbik7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdtZXNzYWdlJywgdGhpcy5yZWNlaXZlLmJpbmQodGhpcykpO1xuICAgIH0pO1xuICB9XG5cbiAgZGlzY29ubmVjdCAoKSB7XG4gICAgbG9nLmRlYnVnKCdEaXNjb25uZWN0aW5nIGZyb20gV2ViS2l0IHJlbW90ZSBkZWJ1Z2dlcicpO1xuICAgIGlmICh0aGlzLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgIHRoaXMuc29ja2V0LmNsb3NlKDEwMDEpO1xuICAgIH1cbiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICB9XG5cbiAgaXNDb25uZWN0ZWQgKCkge1xuICAgIHJldHVybiAodGhpcy5zb2NrZXQgIT09IG51bGwgJiYgdGhpcy5jb25uZWN0ZWQpO1xuICB9XG5cblxuICBhc3luYyBzZW5kIChjb21tYW5kLCBvcHRzID0ge30pIHtcbiAgICBsZXQgZGF0YSA9IGdldFJlbW90ZUNvbW1hbmQoY29tbWFuZCwgXy5kZWZhdWx0cyh7Y29ubklkOiB0aGlzLmNvbm5JZCwgc2VuZGVySWQ6IHRoaXMuc2VuZGVySWR9LCBvcHRzKSk7XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgV2ViS2l0IGRhdGE6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShkYXRhKSwgNTApfWApO1xuXG4gICAgdGhpcy5jdXJNc2dJZCsrO1xuICAgIGRhdGEuaWQgPSB0aGlzLmN1ck1zZ0lkO1xuXG4gICAgbGV0IGlkID0gdGhpcy5jdXJNc2dJZC50b1N0cmluZygpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBvbmx5IHJlc29sdmUgdGhlIHNlbmQgY29tbWFuZCB3aGVuIFdlYktpdCByZXR1cm5zIGEgcmVzcG9uc2VcbiAgICAgIC8vIHN0b3JlIHRoZSBoYW5kbGVyIGFuZCB0aGUgZGF0YSBzZW50XG4gICAgICB0aGlzLmRhdGFIYW5kbGVyc1tpZF0gPSByZXNvbHZlO1xuICAgICAgdGhpcy5kYXRhTWV0aG9kc1tpZF0gPSBkYXRhLm1ldGhvZDtcbiAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1tpZF0gPSByZWplY3Q7XG5cbiAgICAgIC8vIHNlbmQgdGhlIGRhdGFcbiAgICAgIGRhdGEgPSBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgICAgIHRoaXMuc29ja2V0LnNlbmQoZGF0YSwgZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChlcnJvcikgJiYgIV8uaXNOdWxsKGVycm9yKSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IHNvY2tldCBlcnJvciBvY2N1cnJlZDogJHtlcnJvcn1gKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGVycm9yKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pLmZpbmFsbHkoKHJlcykgPT4ge1xuICAgICAgLy8gbm8gbmVlZCB0byBob2xkIG9udG8gYW55dGhpbmdcbiAgICAgIGRlbGV0ZSB0aGlzLmRhdGFIYW5kbGVyc1tpZF07XG4gICAgICBkZWxldGUgdGhpcy5kYXRhTWV0aG9kc1tpZF07XG4gICAgICBkZWxldGUgdGhpcy5lcnJvckhhbmRsZXJzW2lkXTtcblxuICAgICAgLy8gYW5kIHBhc3MgYWxvbmcgdGhlIHJlc3VsdFxuICAgICAgcmV0dXJuIHJlcztcbiAgICB9KS50aW1lb3V0KFJQQ19SRVNQT05TRV9USU1FT1VUX01TKTtcbiAgfVxuXG5cbiAgcmVjZWl2ZSAoZGF0YSkge1xuICAgIGxvZy5kZWJ1ZyhgUmVjZWl2aW5nIFdlYktpdCBkYXRhOiAke18udHJ1bmNhdGUoZGF0YSwgNTApfWApO1xuXG4gICAgZGF0YSA9IEpTT04ucGFyc2UoZGF0YSk7XG5cbiAgICAvLyB3ZSBjYW4gZ2V0IGFuIGVycm9yLCBvciB3ZSBjYW4gZ2V0IGEgcmVzcG9uc2UgdGhhdCBpcyBhbiBlcnJvclxuICAgIGlmIChkYXRhLndhc1Rocm93bikge1xuICAgICAgbGV0IG1lc3NhZ2UgPSBkYXRhLnJlc3VsdC52YWx1ZSB8fCBkYXRhLnJlc3VsdC5kZXNjcmlwdGlvbjtcbiAgICAgIGxldCBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICAgIGlmIChkYXRhLmlkICYmIHRoaXMuZXJyb3JIYW5kbGVyc1tkYXRhLmlkXSkge1xuICAgICAgICB0aGlzLmVycm9ySGFuZGxlcnNbZGF0YS5pZF0oZXJyb3IpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB0aGlzIHNob3VsZCBuZXZlciBoYXBwZW4sIGJ1dCBsb2cgYXQgbGVhc3RcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coZXJyb3IpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHdoZW4gc2VuZGluZyB3ZSBzZXQgYSBkYXRhIG1ldGhvZCBhbmQgYXNzb2NpYXRlZCBjYWxsYmFjay5cbiAgICAvLyBnZXQgdGhhdCwgb3IgdGhlIGdlbmVyaWMgKGF1dG9tYXRpY2FsbHkgc2VudCwgbm90IGFzc29jaWF0ZWRcbiAgICAvLyB3aXRoIGEgcGFydGljdWxhciByZXF1ZXN0KSBtZXRob2RcbiAgICBsZXQgaGFuZGxlckZvcjtcbiAgICBpZiAoZGF0YS5pZCAmJiB0aGlzLmRhdGFNZXRob2RzW2RhdGEuaWRdKSB7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIGhhbmRsZXIgZm9yIG1lc3NhZ2UgJyR7ZGF0YS5pZH0nYCk7XG4gICAgICBoYW5kbGVyRm9yID0gdGhpcy5kYXRhTWV0aG9kc1tkYXRhLmlkXTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKGBEaWQgbm90IGZpbmQgaGFuZGxlciBmb3IgbWVzc2FnZWApO1xuICAgICAgaGFuZGxlckZvciA9IGRhdGEubWV0aG9kO1xuICAgIH1cblxuICAgIGlmICghaGFuZGxlckZvcikge1xuICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBhbiBpbnZhbGlkIG1ldGhvZDogJHtkYXRhLm1ldGhvZH1gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKF8uaGFzKHRoaXMuaGFuZGxlcnMsIGhhbmRsZXJGb3IpKSB7XG4gICAgICB0aGlzLmhhbmRsZXJzW2hhbmRsZXJGb3JdKGRhdGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciBnb3QgYSBtZXNzYWdlIGZvciAnJHtoYW5kbGVyRm9yfScgYCArXG4gICAgICAgICAgICAgICAgYGFuZCBoYXZlIG5vIGhhbmRsZXIsIGRvaW5nIG5vdGhpbmcuYCk7XG4gICAgfVxuICB9XG5cbiAgc2V0SGFuZGxlcnMgKCkge1xuICAgIHRoaXMuaGFuZGxlcnMgPSB7XG4gICAgICAnUnVudGltZS5ldmFsdWF0ZSc6IChkYXRhKSA9PiB7XG4gICAgICAgIGxldCBtc2dJZCA9IGRhdGEuaWQ7XG4gICAgICAgIGlmIChkYXRhLmVycm9yKSB7XG4gICAgICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShkYXRhLmVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXShkYXRhLnJlc3VsdCk7XG4gICAgICB9LFxuICAgICAgJ1BhZ2UubmF2aWdhdGUnOiAoZGF0YSkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIHBhZ2UgbmF2aWdhdGVkIG1lc3NhZ2U6ICR7c2ltcGxlU3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgICBsZXQgbXNnSWQgPSBkYXRhLmlkO1xuICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xuICAgICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1ttc2dJZF0oZGF0YS5lcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0oZGF0YS5yZXN1bHQpO1xuICAgICAgfSxcbiAgICAgICdQcm9maWxlci5yZXNldFByb2ZpbGVzJzogKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoJ0RldmljZSBpcyB0ZWxsaW5nIHVzIHRvIHJlc2V0IHByb2ZpbGVzLiBTaG91bGQgcHJvYmFibHkgJyArXG4gICAgICAgICAgICAgICAgICAnZG8gc29tZSBraW5kIG9mIGNhbGxiYWNrIGhlcmUnKTtcbiAgICAgIH0sXG4gICAgICAnVGltZWxpbmUuZXZlbnRSZWNvcmRlZCc6IChkYXRhKSA9PiB7XG4gICAgICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIoZGF0YS5yZXN1bHQpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuXG4gIHNldFRpbWVsaW5lRXZlbnRIYW5kbGVyICh0aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIgPSB0aW1lbGluZUV2ZW50SGFuZGxlcjtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldFRpbWVsaW5lRXZlbnRIYW5kbGVyKHRpbWVsaW5lRXZlbnRIYW5kbGVyKTtcbiAgfVxufVxuIl19