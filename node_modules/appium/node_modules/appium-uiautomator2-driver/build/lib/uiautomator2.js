'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _installer = require('./installer');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var REQD_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort'];

var adbkit = require('adbkit');
var client = adbkit.createClient();

var UiAutomator2Server = (function () {
  function UiAutomator2Server() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, UiAutomator2Server);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQD_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !opts[req]) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({ host: this.host, port: this.systemPort });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
  }

  _createClass(UiAutomator2Server, [{
    key: 'installServerApk',
    value: function installServerApk() {
      var apkPackage, testApkPackage, isApkInstalled, isTestApkInstalled, apkVersion, pkgVersion;
      return _regeneratorRuntime.async(function installServerApk$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getPackageName(_installer.UI2_SERVER_APK_PATH));

          case 2:
            apkPackage = context$2$0.sent;
            testApkPackage = apkPackage + '.test';
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(apkPackage));

          case 6:
            isApkInstalled = context$2$0.sent;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(testApkPackage));

          case 9:
            isTestApkInstalled = context$2$0.sent;

            if (!(isApkInstalled || isTestApkInstalled)) {
              context$2$0.next = 24;
              break;
            }

            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.getAPKVersion(_installer.UI2_SERVER_APK_PATH));

          case 13:
            apkVersion = context$2$0.sent;
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.getInstalledPackageVersion(apkPackage));

          case 16:
            pkgVersion = context$2$0.sent;

            if (!(apkVersion !== pkgVersion)) {
              context$2$0.next = 24;
              break;
            }

            isApkInstalled = false;
            isTestApkInstalled = false;
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(apkPackage));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(testApkPackage));

          case 24:
            if (isApkInstalled) {
              context$2$0.next = 27;
              break;
            }

            context$2$0.next = 27;
            return _regeneratorRuntime.awrap(this.signAndInstall(_installer.UI2_SERVER_APK_PATH, apkPackage));

          case 27:
            if (isTestApkInstalled) {
              context$2$0.next = 30;
              break;
            }

            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.signAndInstall(_installer.UI2_TEST_APK_PATH, testApkPackage));

          case 30:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'signAndInstall',
    value: function signAndInstall(apk, apkPackage) {
      return _regeneratorRuntime.async(function signAndInstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(apk, apkPackage));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.adb.install(apk));

          case 4:
            _logger2['default'].info("Installed UiAutomator2 server apk");

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getPackageName',
    value: function getPackageName(apk) {
      var args, _ref, stdout, apkPackage;

      return _regeneratorRuntime.async(function getPackageName$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['dump', 'badging', apk];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.adb.binaries.aapt, args));

          case 5:
            _ref = context$2$0.sent;
            stdout = _ref.stdout;
            apkPackage = new RegExp(/package: name='([^']+)'/g).exec(stdout);

            if (apkPackage && apkPackage.length >= 2) {
              apkPackage = apkPackage[1];
            } else {
              apkPackage = null;
            }
            return context$2$0.abrupt('return', apkPackage);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getAPKVersion',
    value: function getAPKVersion(apk) {
      var args, _ref2, stdout, apkVersion;

      return _regeneratorRuntime.async(function getAPKVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['dump', 'badging', apk];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.adb.binaries.aapt, args));

          case 5:
            _ref2 = context$2$0.sent;
            stdout = _ref2.stdout;
            apkVersion = new RegExp(/versionName='([^']+)'/g).exec(stdout);

            if (apkVersion && apkVersion.length >= 2) {
              apkVersion = apkVersion[1];
            } else {
              apkVersion = null;
            }
            return context$2$0.abrupt('return', apkVersion.toString());

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getInstalledPackageVersion',
    value: function getInstalledPackageVersion(pkg) {
      var stdout, pkgVersion;
      return _regeneratorRuntime.async(function getInstalledPackageVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.shell(['dumpsys', 'package', pkg]));

          case 2:
            stdout = context$2$0.sent;
            pkgVersion = new RegExp(/versionName=([^\s\s]+)/g).exec(stdout);

            if (pkgVersion && pkgVersion.length >= 2) {
              pkgVersion = pkgVersion[1];
            } else {
              pkgVersion = null;
            }
            return context$2$0.abrupt('return', pkgVersion.toString());

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk, apkPackage) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, apkPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var cmd;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = ['am', 'instrument', '-w', 'io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner'];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.killUiAutomatorOnDevice());

          case 3:

            _logger2['default'].info('Starting uiautomator2 server ' + _installer.UI2_VER + ' with cmd: ' + ('' + cmd));
            //this.adb.shell(cmd);
            //using 3rd party module called 'adbKit' for time being as using 'appium-adb'
            //facing IllegalStateException: UiAutomation not connected exception
            //https://github.com/appium/appium-uiautomator2-driver/issues/19
            this.startSessionUsingAdbkit();
            _logger2['default'].info('Waiting for UiAutomator2 to be online...');
            // wait 20s for UiAutomator2 to be online
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 1000, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSessionUsingAdbkit',
    value: function startSessionUsingAdbkit() {
      return _regeneratorRuntime.async(function startSessionUsingAdbkit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            client.listDevices().then(function (devices) {
              _bluebird2['default'].map(devices, function (device) {
                _logger2['default'].info("running command...\n adb shell am instrument -w io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner... ");
                client.shell(device.id, "am instrument -w io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner");
              });
            })['catch'](function (err) {
              _logger2['default'].error('Something went wrong while executing instrument test:', err.stack);
            });

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting UiAutomator2 server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation UiAutomator2 deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }, {
    key: 'killUiAutomatorOnDevice',
    value: function killUiAutomatorOnDevice() {
      return _regeneratorRuntime.async(function killUiAutomatorOnDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.killProcessesByName('io.appium.uiautomator2.server'));

          case 3:
            context$2$0.next = 8;
            break;

          case 5:
            context$2$0.prev = 5;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].info("Unable to kill the io.appium.uiautomator2.server process, assuming it is already killed");

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 5]]);
    }
  }]);

  return UiAutomator2Server;
})();

exports['default'] = UiAutomator2Server;
module.exports = exports['default'];

// Installs the apks on to the device or emulator

// appending .test to apkPackage name to get test apk package name

//check server apk versionName

// killing any uiautomator existing processes
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG9tYXRvcjIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs0QkFBcUIsY0FBYzs7Z0NBQ1gsb0JBQW9COzt3QkFDZCxVQUFVOztzQkFDckIsVUFBVTs7Ozt5QkFDNEQsYUFBYTs7d0JBQ2xGLFVBQVU7Ozs7QUFFOUIsSUFBTSxXQUFXLEdBQUcsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7O0FBRTFFLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7O0lBRTdCLGtCQUFrQjtBQUNWLFdBRFIsa0JBQWtCLEdBQ0U7UUFBWCxJQUFJLHlEQUFHLEVBQUU7OzBCQURsQixrQkFBa0I7Ozs7Ozs7QUFFcEIsd0NBQWdCLFdBQVcsNEdBQUU7WUFBcEIsR0FBRzs7QUFDVixZQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ3ZCLGdCQUFNLElBQUksS0FBSyxlQUFZLEdBQUcscUJBQWlCLENBQUM7U0FDakQ7QUFDRCxZQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO09BQ3ZCOzs7Ozs7Ozs7Ozs7Ozs7O0FBQ0QsUUFBSSxDQUFDLE9BQU8sR0FBRyw4QkFBWSxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFDLENBQUMsQ0FBQztBQUNyRSxRQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7R0FDaEU7O2VBVkcsa0JBQWtCOztXQVlDO1VBRWpCLFVBQVUsRUFFVixjQUFjLEVBQ2QsY0FBYyxFQUNkLGtCQUFr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LFNBQVMsRUFBRSxLQUFLLENBQUM7Ozs7Ozs7YUFDN0MsQ0FBQzs7Ozs2Q0FDSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLEVBQUMsbUJBQW1CLEVBQUUsSUFBSSxFQUFDLENBQUM7Ozs7Ozs7S0FDNUU7OztXQUU2Qjs7OztBQUM1QixrQkFBTSxDQUFDLFdBQVcsRUFBRSxDQUNmLElBQUksQ0FBQyxVQUFVLE9BQU8sRUFBRTtBQUN2QixvQ0FBUSxHQUFHLENBQUMsT0FBTyxFQUFFLFVBQVUsTUFBTSxFQUFFO0FBQ3JDLG9DQUFPLElBQUksQ0FBQyx1SUFBdUksQ0FBQyxDQUFDO0FBQ3JKLHNCQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsb0dBQW9HLENBQUMsQ0FBQztlQUMvSCxDQUFDLENBQUM7YUFDSixDQUFDLFNBQ0ksQ0FBQyxVQUFVLEdBQUcsRUFBRTtBQUNwQixrQ0FBTyxLQUFLLENBQUMsdURBQXVELEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ2xGLENBQUMsQ0FBQzs7Ozs7OztLQUNSOzs7V0FFbUI7Ozs7QUFDbEIsZ0NBQU8sS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7Ozs7OzZDQUk3QyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDOzs7Ozs7Ozs7O0FBRXpDLGdDQUFPLElBQUksQ0FBQyxpR0FDVyxDQUFDLENBQUM7Ozs7Ozs7S0FFNUI7OztXQUU2Qjs7Ozs7OzZDQUVwQixJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLCtCQUErQixDQUFDOzs7Ozs7Ozs7O0FBRW5FLGdDQUFPLElBQUksQ0FBQyx5RkFBeUYsQ0FBQyxDQUFDOzs7Ozs7O0tBRTFHOzs7U0E5SUcsa0JBQWtCOzs7cUJBaUpULGtCQUFrQiIsImZpbGUiOiJsaWIvdWlhdXRvbWF0b3IyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IFVJMl9TRVJWRVJfQVBLX1BBVEggYXMgYXBrUGF0aCwgVUkyX1RFU1RfQVBLX1BBVEggYXMgdGVzdEFwa1BhdGgsIFVJMl9WRVJ9IGZyb20gJy4vaW5zdGFsbGVyJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcblxuY29uc3QgUkVRRF9QQVJBTVMgPSBbJ2FkYicsICd0bXBEaXInLCAnaG9zdCcsICdzeXN0ZW1Qb3J0JywgJ2RldmljZVBvcnQnXTtcblxudmFyIGFkYmtpdCA9IHJlcXVpcmUoJ2FkYmtpdCcpO1xudmFyIGNsaWVudCA9IGFkYmtpdC5jcmVhdGVDbGllbnQoKTtcblxuY2xhc3MgVWlBdXRvbWF0b3IyU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICFvcHRzW3JlcV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtob3N0OiB0aGlzLmhvc3QsIHBvcnQ6IHRoaXMuc3lzdGVtUG9ydH0pO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFNlcnZlckFwayAoKSB7XG4gICAgLy8gSW5zdGFsbHMgdGhlIGFwa3Mgb24gdG8gdGhlIGRldmljZSBvciBlbXVsYXRvclxuICAgIGxldCBhcGtQYWNrYWdlID0gYXdhaXQgdGhpcy5nZXRQYWNrYWdlTmFtZShhcGtQYXRoKTtcbiAgICAvLyBhcHBlbmRpbmcgLnRlc3QgdG8gYXBrUGFja2FnZSBuYW1lIHRvIGdldCB0ZXN0IGFwayBwYWNrYWdlIG5hbWVcbiAgICBsZXQgdGVzdEFwa1BhY2thZ2UgPSBhcGtQYWNrYWdlICsgJy50ZXN0JztcbiAgICBsZXQgaXNBcGtJbnN0YWxsZWQgPSBhd2FpdCB0aGlzLmFkYi5pc0FwcEluc3RhbGxlZChhcGtQYWNrYWdlKTtcbiAgICBsZXQgaXNUZXN0QXBrSW5zdGFsbGVkID0gYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQodGVzdEFwa1BhY2thZ2UpO1xuICAgIGlmIChpc0Fwa0luc3RhbGxlZCB8fCBpc1Rlc3RBcGtJbnN0YWxsZWQpIHtcbiAgICAgIC8vY2hlY2sgc2VydmVyIGFwayB2ZXJzaW9uTmFtZVxuICAgICAgbGV0IGFwa1ZlcnNpb24gPSBhd2FpdCB0aGlzLmdldEFQS1ZlcnNpb24oYXBrUGF0aCk7XG4gICAgICBsZXQgcGtnVmVyc2lvbiA9IGF3YWl0IHRoaXMuZ2V0SW5zdGFsbGVkUGFja2FnZVZlcnNpb24oYXBrUGFja2FnZSk7XG4gICAgICBpZiAoYXBrVmVyc2lvbiAhPT0gcGtnVmVyc2lvbikge1xuICAgICAgICBpc0Fwa0luc3RhbGxlZCA9IGZhbHNlO1xuICAgICAgICBpc1Rlc3RBcGtJbnN0YWxsZWQgPSBmYWxzZTtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKGFwa1BhY2thZ2UpO1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsodGVzdEFwa1BhY2thZ2UpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWlzQXBrSW5zdGFsbGVkKSB7XG4gICAgICBhd2FpdCB0aGlzLnNpZ25BbmRJbnN0YWxsKGFwa1BhdGgsIGFwa1BhY2thZ2UpO1xuICAgIH1cbiAgICBpZiAoIWlzVGVzdEFwa0luc3RhbGxlZCkge1xuICAgICAgYXdhaXQgdGhpcy5zaWduQW5kSW5zdGFsbCh0ZXN0QXBrUGF0aCwgdGVzdEFwa1BhY2thZ2UpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNpZ25BbmRJbnN0YWxsIChhcGssIGFwa1BhY2thZ2UpIHtcbiAgICBhd2FpdCB0aGlzLmNoZWNrQW5kU2lnbkNlcnQoYXBrLCBhcGtQYWNrYWdlKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKGFwayk7XG4gICAgbG9nZ2VyLmluZm8oXCJJbnN0YWxsZWQgVWlBdXRvbWF0b3IyIHNlcnZlciBhcGtcIik7XG4gIH1cblxuICBhc3luYyBnZXRQYWNrYWdlTmFtZSAoYXBrKSB7XG4gICAgbGV0IGFyZ3MgPSBbJ2R1bXAnLCAnYmFkZ2luZycsIGFwa107XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5pdEFhcHQoKTtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKHRoaXMuYWRiLmJpbmFyaWVzLmFhcHQsIGFyZ3MpO1xuICAgIGxldCBhcGtQYWNrYWdlID0gbmV3IFJlZ0V4cCgvcGFja2FnZTogbmFtZT0nKFteJ10rKScvZykuZXhlYyhzdGRvdXQpO1xuICAgIGlmIChhcGtQYWNrYWdlICYmIGFwa1BhY2thZ2UubGVuZ3RoID49IDIpIHtcbiAgICAgIGFwa1BhY2thZ2UgPSBhcGtQYWNrYWdlWzFdO1xuICAgIH0gZWxzZSB7XG4gICAgICBhcGtQYWNrYWdlID0gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGFwa1BhY2thZ2U7XG4gIH1cblxuICBhc3luYyBnZXRBUEtWZXJzaW9uIChhcGspIHtcbiAgICBsZXQgYXJncyA9IFsnZHVtcCcsICdiYWRnaW5nJywgYXBrXTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbml0QWFwdCgpO1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5hZGIuYmluYXJpZXMuYWFwdCwgYXJncyk7XG4gICAgbGV0IGFwa1ZlcnNpb24gPSBuZXcgUmVnRXhwKC92ZXJzaW9uTmFtZT0nKFteJ10rKScvZykuZXhlYyhzdGRvdXQpO1xuICAgIGlmIChhcGtWZXJzaW9uICYmIGFwa1ZlcnNpb24ubGVuZ3RoID49IDIpIHtcbiAgICAgIGFwa1ZlcnNpb24gPSBhcGtWZXJzaW9uWzFdO1xuICAgIH0gZWxzZSB7XG4gICAgICBhcGtWZXJzaW9uID0gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGFwa1ZlcnNpb24udG9TdHJpbmcoKTtcbiAgfVxuXG4gIGFzeW5jIGdldEluc3RhbGxlZFBhY2thZ2VWZXJzaW9uIChwa2cpIHtcbiAgICBsZXQgc3Rkb3V0ID0gIGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsnZHVtcHN5cycsICdwYWNrYWdlJywgcGtnXSk7XG4gICAgbGV0IHBrZ1ZlcnNpb24gPSBuZXcgUmVnRXhwKC92ZXJzaW9uTmFtZT0oW15cXHNcXHNdKykvZykuZXhlYyhzdGRvdXQpO1xuICAgIGlmIChwa2dWZXJzaW9uICYmIHBrZ1ZlcnNpb24ubGVuZ3RoID49IDIpIHtcbiAgICAgIHBrZ1ZlcnNpb24gPSBwa2dWZXJzaW9uWzFdO1xuICAgIH0gZWxzZSB7XG4gICAgICBwa2dWZXJzaW9uID0gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHBrZ1ZlcnNpb24udG9TdHJpbmcoKTtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrQW5kU2lnbkNlcnQgKGFwaywgYXBrUGFja2FnZSkge1xuICAgIGxldCBzaWduZWQgPSBhd2FpdCB0aGlzLmFkYi5jaGVja0Fwa0NlcnQoYXBrLCBhcGtQYWNrYWdlKTtcbiAgICBpZiAoIXNpZ25lZCkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuc2lnbihhcGspO1xuICAgIH1cbiAgICByZXR1cm4gIXNpZ25lZDtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIGxldCBjbWQgPSBbJ2FtJywgJ2luc3RydW1lbnQnLCAnLXcnLFxuICAgICAgJ2lvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyLnRlc3QvYW5kcm9pZC5zdXBwb3J0LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lciddO1xuXG4gICAgLy8ga2lsbGluZyBhbnkgdWlhdXRvbWF0b3IgZXhpc3RpbmcgcHJvY2Vzc2VzXG4gICAgYXdhaXQgdGhpcy5raWxsVWlBdXRvbWF0b3JPbkRldmljZSgpO1xuXG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIHVpYXV0b21hdG9yMiBzZXJ2ZXIgJHtVSTJfVkVSfSB3aXRoIGNtZDogYCArXG4gICAgICAgIGAke2NtZH1gKTtcbiAgICAvL3RoaXMuYWRiLnNoZWxsKGNtZCk7XG4gICAgLy91c2luZyAzcmQgcGFydHkgbW9kdWxlIGNhbGxlZCAnYWRiS2l0JyBmb3IgdGltZSBiZWluZyBhcyB1c2luZyAnYXBwaXVtLWFkYidcbiAgICAvL2ZhY2luZyBJbGxlZ2FsU3RhdGVFeGNlcHRpb246IFVpQXV0b21hdGlvbiBub3QgY29ubmVjdGVkIGV4Y2VwdGlvblxuICAgIC8vaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tdWlhdXRvbWF0b3IyLWRyaXZlci9pc3N1ZXMvMTlcbiAgICB0aGlzLnN0YXJ0U2Vzc2lvblVzaW5nQWRia2l0KCk7XG4gICAgbG9nZ2VyLmluZm8oJ1dhaXRpbmcgZm9yIFVpQXV0b21hdG9yMiB0byBiZSBvbmxpbmUuLi4nKTtcbiAgICAvLyB3YWl0IDIwcyBmb3IgVWlBdXRvbWF0b3IyIHRvIGJlIG9ubGluZVxuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMjAsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvblVzaW5nQWRia2l0ICgpIHtcbiAgICBjbGllbnQubGlzdERldmljZXMoKVxuICAgICAgICAudGhlbihmdW5jdGlvbiAoZGV2aWNlcykge1xuICAgICAgICAgIFByb21pc2UubWFwKGRldmljZXMsIGZ1bmN0aW9uIChkZXZpY2UpIHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKFwicnVubmluZyBjb21tYW5kLi4uXFxuIGFkYiBzaGVsbCBhbSBpbnN0cnVtZW50IC13IGlvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyLnRlc3QvYW5kcm9pZC5zdXBwb3J0LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lci4uLiBcIik7XG4gICAgICAgICAgICBjbGllbnQuc2hlbGwoZGV2aWNlLmlkLCBcImFtIGluc3RydW1lbnQgLXcgaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIudGVzdC9hbmRyb2lkLnN1cHBvcnQudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyXCIpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgZXhlY3V0aW5nIGluc3RydW1lbnQgdGVzdDonLCBlcnIuc3RhY2spO1xuICAgICAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgVWlBdXRvbWF0b3IyIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBVaUF1dG9tYXRvcjIgZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGtpbGxVaUF1dG9tYXRvck9uRGV2aWNlICgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIua2lsbFByb2Nlc3Nlc0J5TmFtZSgnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXInKTtcbiAgICB9IGNhdGNoIChpZ25vcmUpIHtcbiAgICAgIGxvZ2dlci5pbmZvKFwiVW5hYmxlIHRvIGtpbGwgdGhlIGlvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyIHByb2Nlc3MsIGFzc3VtaW5nIGl0IGlzIGFscmVhZHkga2lsbGVkXCIpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBVaUF1dG9tYXRvcjJTZXJ2ZXI7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
