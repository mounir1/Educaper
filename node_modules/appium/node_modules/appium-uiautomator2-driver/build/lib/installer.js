'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

/**
 * UI2_VER, SERVER_DOWNLOAD_SHA512, SERVER_TEST_DOWNLOAD_SHA512 should be updated for every appium-uiautomator2-server release.
 */
var UI2_VER = "v0.0.7";
var SERVER_DOWNLOAD_SHA512 = "159268c91b5bfcd17a0ae83c2bded716a8102c63a33e9b7ab3958ebd2c474b7d9fe687bfd7cefcc2f9840439923851ec457bd0cc0365a01f4b0b3a28587d12d8";
var SERVER_TEST_DOWNLOAD_SHA512 = "fff0fc24a28e99afc96b7589867a5d50cdec9a63790817796d31875fa0765296b1e0b2a90d52708f15bfdf88d958324cc94bf7f665a041203673f04934a887e9";

var UI2_SERVER_DOWNLOAD = 'https://github.com/appium/appium-uiautomator2-server/releases/download' + ('/' + UI2_VER + '/appium-uiautomator2-server-' + UI2_VER + '.apk');
var UI2_SERVER_TEST_DOWNLOAD = 'https://github.com/appium/appium-uiautomator2-server/releases/download' + ('/' + UI2_VER + '/appium-uiautomator2-server-debug-androidTest.apk');
var UI2_DIR = _path2['default'].resolve(__dirname, "..", "..", "uiautomator2");
var UI2_SERVER_APK_PATH = _path2['default'].resolve(UI2_DIR, 'appium-uiautomator2-server-' + UI2_VER + '.apk');
var UI2_TEST_APK_PATH = _path2['default'].resolve(UI2_DIR, 'appium-uiautomator2-server-debug-androidTest.apk');

function setupUiAutomator2() {
  return _regeneratorRuntime.async(function setupUiAutomator2$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(hashCheck(UI2_SERVER_APK_PATH, SERVER_DOWNLOAD_SHA512));

      case 2:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(hashCheck(UI2_TEST_APK_PATH, SERVER_TEST_DOWNLOAD_SHA512));

      case 6:
        context$1$0.t0 = context$1$0.sent;

      case 7:
        if (!context$1$0.t0) {
          context$1$0.next = 12;
          break;
        }

        _logger2['default'].info("UiAutomator2 apk exists and has correct hash, skipping download");
        return context$1$0.abrupt('return');

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(downloadUiAutomator2ServerApk());

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(serverExists());

      case 16:
        if (context$1$0.sent) {
          context$1$0.next = 18;
          break;
        }

        throw new Error("Something went wrong in setting up UiAutomator2");

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function hashCheck(fileName, SHA512) {
  var buffer, fingerprint;
  return _regeneratorRuntime.async(function hashCheck$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(fileName));

      case 2:
        if (!context$1$0.sent) {
          context$1$0.next = 10;
          break;
        }

        buffer = require("fs").readFileSync(fileName);
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(sha512(buffer));

      case 6:
        fingerprint = context$1$0.sent;
        return context$1$0.abrupt('return', fingerprint === SHA512);

      case 10:
        return context$1$0.abrupt('return', false);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function downloadUiAutomator2ServerApk() {
  var serverApk, serverTestApk, serverFingerprint, serverTestFingerprint;
  return _regeneratorRuntime.async(function downloadUiAutomator2ServerApk$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(UI2_DIR));

      case 2:
        _logger2['default'].info('downloading UiAutomator2 Server APK ' + UI2_VER + ' : ' + UI2_SERVER_DOWNLOAD);
        _logger2['default'].info('downloading UiAutomator2 Server test APK ' + UI2_VER + ' : ' + UI2_SERVER_TEST_DOWNLOAD);
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: UI2_SERVER_DOWNLOAD, encoding: null }));

      case 6:
        serverApk = context$1$0.sent;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: UI2_SERVER_TEST_DOWNLOAD, encoding: null }));

      case 9:
        serverTestApk = context$1$0.sent;

        if (!(!serverApk instanceof Buffer)) {
          context$1$0.next = 12;
          break;
        }

        throw new Error(Object.prototype.toString.call(serverApk));

      case 12:
        if (!(!serverTestApk instanceof Buffer)) {
          context$1$0.next = 14;
          break;
        }

        throw new Error(Object.prototype.toString.call(serverTestApk));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(sha512(serverApk));

      case 16:
        serverFingerprint = context$1$0.sent;
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(sha512(serverTestApk));

      case 19:
        serverTestFingerprint = context$1$0.sent;

        if (!(serverFingerprint !== SERVER_DOWNLOAD_SHA512)) {
          context$1$0.next = 24;
          break;
        }

        _logger2['default'].errorAndThrow('bad Server SHA512 fingerprint: ' + serverFingerprint);
        _logger2['default'].error("Stopping the installation");
        return context$1$0.abrupt('return');

      case 24:
        if (!(serverTestFingerprint !== SERVER_TEST_DOWNLOAD_SHA512)) {
          context$1$0.next = 28;
          break;
        }

        _logger2['default'].errorAndThrow('bad Server test SHA512 fingerprint: ' + serverTestFingerprint);
        _logger2['default'].error("Stopping the installation");
        return context$1$0.abrupt('return');

      case 28:
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(UI2_SERVER_APK_PATH, serverApk, { encoding: 'binary' }));

      case 30:
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(UI2_TEST_APK_PATH, serverTestApk, { encoding: 'binary' }));

      case 32:
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(UI2_SERVER_APK_PATH, 420));

      case 34:
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(UI2_TEST_APK_PATH, 420));

      case 36:

        _logger2['default'].info("UiAutomator2 Server APKs downloaded");

      case 37:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function sha512(buffer) {
  var hash;
  return _regeneratorRuntime.async(function sha512$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        hash = _crypto2['default'].createHash('sha512');
        return context$1$0.abrupt('return', hash.update(buffer).digest('hex'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function serverExists() {
  return _regeneratorRuntime.async(function serverExists$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(UI2_SERVER_APK_PATH));

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(UI2_TEST_APK_PATH));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
        context$1$0.prev = 11;
        context$1$0.t1 = context$1$0['catch'](0);

        if (!(context$1$0.t1.code.indexOf("ENOENT") !== -1)) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 15:
        throw context$1$0.t1;

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 11]]);
}

exports.setupUiAutomator2 = setupUiAutomator2;
exports.serverExists = serverExists;
exports.UI2_SERVER_APK_PATH = UI2_SERVER_APK_PATH;
exports.UI2_TEST_APK_PATH = UI2_TEST_APK_PATH;
exports.UI2_VER = UI2_VER;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFaLFlBQVk7UUFBRSxtQkFBbUIsR0FBbkIsbUJBQW1CO1FBQUUsaUJBQWlCLEdBQWpCLGlCQUFpQjtRQUFFLE9BQU8sR0FBUCxPQUFPIiwiZmlsZSI6ImxpYi9pbnN0YWxsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG4vKipcbiAqIFVJMl9WRVIsIFNFUlZFUl9ET1dOTE9BRF9TSEE1MTIsIFNFUlZFUl9URVNUX0RPV05MT0FEX1NIQTUxMiBzaG91bGQgYmUgdXBkYXRlZCBmb3IgZXZlcnkgYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXIgcmVsZWFzZS5cbiAqL1xuY29uc3QgVUkyX1ZFUiA9IFwidjAuMC43XCI7XG5jb25zdCBTRVJWRVJfRE9XTkxPQURfU0hBNTEyID0gXCIxNTkyNjhjOTFiNWJmY2QxN2EwYWU4M2MyYmRlZDcxNmE4MTAyYzYzYTMzZTliN2FiMzk1OGViZDJjNDc0YjdkOWZlNjg3YmZkN2NlZmNjMmY5ODQwNDM5OTIzODUxZWM0NTdiZDBjYzAzNjVhMDFmNGIwYjNhMjg1ODdkMTJkOFwiO1xuY29uc3QgU0VSVkVSX1RFU1RfRE9XTkxPQURfU0hBNTEyID0gXCJmZmYwZmMyNGEyOGU5OWFmYzk2Yjc1ODk4NjdhNWQ1MGNkZWM5YTYzNzkwODE3Nzk2ZDMxODc1ZmEwNzY1Mjk2YjFlMGIyYTkwZDUyNzA4ZjE1YmZkZjg4ZDk1ODMyNGNjOTRiZjdmNjY1YTA0MTIwMzY3M2YwNDkzNGE4ODdlOVwiO1xuXG5cbmNvbnN0IFVJMl9TRVJWRVJfRE9XTkxPQUQgPSBgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tdWlhdXRvbWF0b3IyLXNlcnZlci9yZWxlYXNlcy9kb3dubG9hZGAgK1xuICAgIGAvJHtVSTJfVkVSfS9hcHBpdW0tdWlhdXRvbWF0b3IyLXNlcnZlci0ke1VJMl9WRVJ9LmFwa2A7XG5jb25zdCBVSTJfU0VSVkVSX1RFU1RfRE9XTkxPQUQgPSBgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tdWlhdXRvbWF0b3IyLXNlcnZlci9yZWxlYXNlcy9kb3dubG9hZGAgK1xuICAgIGAvJHtVSTJfVkVSfS9hcHBpdW0tdWlhdXRvbWF0b3IyLXNlcnZlci1kZWJ1Zy1hbmRyb2lkVGVzdC5hcGtgO1xuY29uc3QgVUkyX0RJUiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi5cIiwgXCIuLlwiLCBcInVpYXV0b21hdG9yMlwiKTtcbmNvbnN0IFVJMl9TRVJWRVJfQVBLX1BBVEggPSBwYXRoLnJlc29sdmUoVUkyX0RJUiwgYGFwcGl1bS11aWF1dG9tYXRvcjItc2VydmVyLSR7VUkyX1ZFUn0uYXBrYCk7XG5jb25zdCBVSTJfVEVTVF9BUEtfUEFUSCA9IHBhdGgucmVzb2x2ZShVSTJfRElSLCBgYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXItZGVidWctYW5kcm9pZFRlc3QuYXBrYCk7XG5cblxuXG5hc3luYyBmdW5jdGlvbiBzZXR1cFVpQXV0b21hdG9yMiAoKSB7XG4gIGlmIChhd2FpdCBoYXNoQ2hlY2soVUkyX1NFUlZFUl9BUEtfUEFUSCwgU0VSVkVSX0RPV05MT0FEX1NIQTUxMikgJiYgYXdhaXQgaGFzaENoZWNrKFVJMl9URVNUX0FQS19QQVRILCBTRVJWRVJfVEVTVF9ET1dOTE9BRF9TSEE1MTIpKSB7XG4gICAgbG9nLmluZm8oXCJVaUF1dG9tYXRvcjIgYXBrIGV4aXN0cyBhbmQgaGFzIGNvcnJlY3QgaGFzaCwgc2tpcHBpbmcgZG93bmxvYWRcIik7XG4gICAgcmV0dXJuO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IGRvd25sb2FkVWlBdXRvbWF0b3IyU2VydmVyQXBrKCk7XG4gIH1cblxuICBpZiAoIShhd2FpdCBzZXJ2ZXJFeGlzdHMoKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJTb21ldGhpbmcgd2VudCB3cm9uZyBpbiBzZXR0aW5nIHVwIFVpQXV0b21hdG9yMlwiKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBoYXNoQ2hlY2sgKGZpbGVOYW1lLCBTSEE1MTIpIHtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhmaWxlTmFtZSkpIHtcbiAgICB2YXIgYnVmZmVyID0gcmVxdWlyZShcImZzXCIpLnJlYWRGaWxlU3luYyhmaWxlTmFtZSk7XG4gICAgbGV0IGZpbmdlcnByaW50ID0gIGF3YWl0IHNoYTUxMihidWZmZXIpO1xuICAgIHJldHVybiBmaW5nZXJwcmludCA9PT0gU0hBNTEyO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZFVpQXV0b21hdG9yMlNlcnZlckFwayAoKSB7XG5cbiAgYXdhaXQgZnMubWtkaXIoVUkyX0RJUik7XG4gIGxvZy5pbmZvKGBkb3dubG9hZGluZyBVaUF1dG9tYXRvcjIgU2VydmVyIEFQSyAke1VJMl9WRVJ9IDogJHtVSTJfU0VSVkVSX0RPV05MT0FEfWApO1xuICBsb2cuaW5mbyhgZG93bmxvYWRpbmcgVWlBdXRvbWF0b3IyIFNlcnZlciB0ZXN0IEFQSyAke1VJMl9WRVJ9IDogJHtVSTJfU0VSVkVSX1RFU1RfRE9XTkxPQUR9YCk7XG4gIGxldCBzZXJ2ZXJBcGsgPSBhd2FpdCByZXF1ZXN0LmdldCh7dXJsOiBVSTJfU0VSVkVSX0RPV05MT0FELCBlbmNvZGluZzogbnVsbH0pO1xuICBsZXQgc2VydmVyVGVzdEFwayA9IGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmw6IFVJMl9TRVJWRVJfVEVTVF9ET1dOTE9BRCwgZW5jb2Rpbmc6IG51bGx9KTtcbiAgaWYgKCFzZXJ2ZXJBcGsgaW5zdGFuY2VvZiBCdWZmZXIgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzZXJ2ZXJBcGspKTtcbiAgfVxuICBpZiAoIXNlcnZlclRlc3RBcGsgaW5zdGFuY2VvZiBCdWZmZXIgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzZXJ2ZXJUZXN0QXBrKSk7XG4gIH1cbiAgbGV0IHNlcnZlckZpbmdlcnByaW50ID0gYXdhaXQgc2hhNTEyKHNlcnZlckFwayk7XG4gIGxldCBzZXJ2ZXJUZXN0RmluZ2VycHJpbnQgPSBhd2FpdCBzaGE1MTIoc2VydmVyVGVzdEFwayk7XG5cbiAgaWYgKCBzZXJ2ZXJGaW5nZXJwcmludCAhPT0gU0VSVkVSX0RPV05MT0FEX1NIQTUxMiApIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgYmFkIFNlcnZlciBTSEE1MTIgZmluZ2VycHJpbnQ6ICR7c2VydmVyRmluZ2VycHJpbnR9YCk7XG4gICAgbG9nLmVycm9yKFwiU3RvcHBpbmcgdGhlIGluc3RhbGxhdGlvblwiICk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmICggc2VydmVyVGVzdEZpbmdlcnByaW50ICE9PSBTRVJWRVJfVEVTVF9ET1dOTE9BRF9TSEE1MTIgKXtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgYmFkIFNlcnZlciB0ZXN0IFNIQTUxMiBmaW5nZXJwcmludDogJHtzZXJ2ZXJUZXN0RmluZ2VycHJpbnR9YCk7XG4gICAgbG9nLmVycm9yKFwiU3RvcHBpbmcgdGhlIGluc3RhbGxhdGlvblwiKTtcbiAgICByZXR1cm47XG4gIH1cbiAgYXdhaXQgZnMud3JpdGVGaWxlKFVJMl9TRVJWRVJfQVBLX1BBVEgsIHNlcnZlckFwaywge2VuY29kaW5nOiAnYmluYXJ5J30pO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoVUkyX1RFU1RfQVBLX1BBVEgsIHNlcnZlclRlc3RBcGssIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcblxuICBhd2FpdCBmcy5jaG1vZChVSTJfU0VSVkVSX0FQS19QQVRILCAwbzA2NDQpO1xuICBhd2FpdCBmcy5jaG1vZChVSTJfVEVTVF9BUEtfUEFUSCwgMG8wNjQ0KTtcblxuICBsb2cuaW5mbyhcIlVpQXV0b21hdG9yMiBTZXJ2ZXIgQVBLcyBkb3dubG9hZGVkXCIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaGE1MTIgKGJ1ZmZlcikge1xuICBjb25zdCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTUxMicpO1xuICByZXR1cm4gaGFzaC51cGRhdGUoYnVmZmVyKS5kaWdlc3QoJ2hleCcpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXJ2ZXJFeGlzdHMgKCkge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKFVJMl9TRVJWRVJfQVBLX1BBVEgpICYmXG4gICAgYXdhaXQgZnMuZXhpc3RzKFVJMl9URVNUX0FQS19QQVRIKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5jb2RlLmluZGV4T2YoXCJFTk9FTlRcIikgIT09IC0xKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn1cblxuZXhwb3J0IHsgc2V0dXBVaUF1dG9tYXRvcjIsIHNlcnZlckV4aXN0cywgVUkyX1NFUlZFUl9BUEtfUEFUSCwgVUkyX1RFU1RfQVBLX1BBVEgsIFVJMl9WRVIgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
