'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _desiredCaps = require('./desired-caps');

var _desiredCaps2 = _interopRequireDefault(_desiredCaps);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncbox = require('asyncbox');

// for proxies

var _appiumAndroidDriver = require('appium-android-driver');

var _appiumAndroidDriver2 = _interopRequireDefault(_appiumAndroidDriver);

var _appiumIosDriver = require('appium-ios-driver');

var _appiumIosDriver2 = _interopRequireDefault(_appiumIosDriver);

var _appiumXcuitestDriver = require('appium-xcuitest-driver');

var _appiumXcuitestDriver2 = _interopRequireDefault(_appiumXcuitestDriver);

// Add commands from the following location that should be mapped to existing drivers:
// https://github.com/appium/appium-base-driver/blob/master/lib/mjsonwp/routes.js

var TO_PROXY_COMMON = ['background', 'closeApp', 'getLog', 'getLogTypes', 'getOrientation', 'getStrings', 'getWindowSize', 'launchApp', 'lock', 'removeApp', 'setOrientation'];

var TO_PROXY_IOS_ONLY = ['mobileShake'];

var TO_PROXY_ANDROID_ONLY = ['getNetworkConnection', 'isAppInstalled', 'isLocked', 'longPressKeyCode', 'pressKeyCode', 'setNetworkConnection', 'toggleLocationServices', 'unlock'];

var TO_PROXY_IOS = TO_PROXY_IOS_ONLY.concat(TO_PROXY_COMMON);
var TO_PROXY_ANDROID = TO_PROXY_ANDROID_ONLY.concat(TO_PROXY_COMMON);

var MAX_RETRY_COUNT = 10;
var RETRY_BACKOFF = 3000;

var YouiEngineDriver = (function (_BaseDriver) {
  _inherits(YouiEngineDriver, _BaseDriver);

  _createClass(YouiEngineDriver, [{
    key: 'resetYouiEngine',
    value: function resetYouiEngine() {

      this.ready = false;
      this.socket = null;
      this.locatorStrategies = ['xpath', 'id', 'name', 'class name', 'accessibility id'];
      this.proxydriver = null;
      this.proxyAllowList = '';
    }
  }]);

  function YouiEngineDriver(opts, shouldValidateCaps) {
    _classCallCheck(this, YouiEngineDriver);

    _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

    this.desiredCapConstraints = _desiredCaps2['default'];
    this.resetYouiEngine();
  }

  _createClass(YouiEngineDriver, [{
    key: 'validateLocatorStrategy',
    value: function validateLocatorStrategy(strategy) {
      _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'validateLocatorStrategy', this).call(this, strategy, false);
    }
  }, {
    key: 'createSession',
    value: function createSession(caps) {
      var _ref, _ref2, sessionId, appPlatform;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'createSession', this).call(this, caps));

          case 3:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 1);
            sessionId = _ref2[0];

            if (!(this.opts.platformName !== null)) {
              context$2$0.next = 16;
              break;
            }

            appPlatform = this.opts.platformName.toLowerCase();

            if (!(appPlatform === "ios")) {
              context$2$0.next = 13;
              break;
            }

            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.startIOSSession());

          case 11:
            context$2$0.next = 16;
            break;

          case 13:
            if (!(appPlatform === "android")) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.startAndroidSession());

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(this.connectSocket());

          case 18:
            return context$2$0.abrupt('return', [sessionId, this.opts]);

          case 21:
            context$2$0.prev = 21;
            context$2$0.t0 = context$2$0['catch'](0);
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.deleteSession());

          case 25:
            throw context$2$0.t0;

          case 26:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 21]]);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.ready = false;

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Deleting YouiEngine session");

            if (!(this.proxydriver !== null)) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.proxydriver.deleteSession());

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'deleteSession', this).call(this));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.stop());

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'driverShouldDoProxyCmd',
    value: function driverShouldDoProxyCmd(command) {

      if (!this.proxydriver) return false;

      // only allow white listed commands
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(this.proxyAllowList), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var allowedCommand = _step.value;

          if (allowedCommand === command) {
            return true;
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      return false;
    }
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      var _proxydriver, result, _get2;

      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(cmd === 'receiveAsyncResponse')) {
              context$2$0.next = 7;
              break;
            }

            _logger2['default'].debug('Executing YouiEngineDriver response \'' + cmd + '\'');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.receiveAsyncResponse.apply(this, args));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 7:
            if (!this.ready) {
              context$2$0.next = 20;
              break;
            }

            if (!this.driverShouldDoProxyCmd(cmd)) {
              context$2$0.next = 16;
              break;
            }

            _logger2['default'].debug('Executing proxied WebDriver command \'' + cmd + '\'');

            // There are 2 CommandTimeout (YouiEngineDriver and proxy)
            // Only YouiEngineDriver CommandTimeout is used; Proxy is disabled
            // All proxy commands needs to reset the YouiEngineDriver CommandTimeout
            // Here we manually reset the YouiEngineDriver CommandTimeout for commands that goe to proxy.
            this.clearNewCommandTimeout();
            result = (_proxydriver = this.proxydriver).executeCommand.apply(_proxydriver, [cmd].concat(args));

            this.startNewCommandTimeout(cmd);
            return context$2$0.abrupt('return', result);

          case 16:
            _logger2['default'].debug('Executing YouiEngine WebDriver command \'' + cmd + '\'');
            return context$2$0.abrupt('return', (_get2 = _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'executeCommand', this)).call.apply(_get2, [this, cmd].concat(args)));

          case 18:
            context$2$0.next = 22;
            break;

          case 20:
            _logger2['default'].debug('Command Error \'' + cmd + '\'');
            throw new _appiumBaseDriver.errors.NoSuchDriverError('Driver is not ready, cannot execute ' + cmd + '.');

          case 22:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      // check with the base class, and return if it fails
      var res = _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
      if (!res) return res;

      // using a proxy
      if (caps.platformName.toLowerCase() !== 'noproxy') {
        // make sure that the capabilities has youiEngineAppAddress
        if (!caps.youiEngineAppAddress) {
          var msg = 'The desired capabilities must include youiEngineAppAddress';
          _logger2['default'].errorAndThrow(msg);
        }
        // make sure that the capabilities has app
        if (!caps.app) {
          var msg = 'The desired capabilities must include app';
          _logger2['default'].errorAndThrow(msg);
        }

        //Android emulator with proxy
        if (caps.deviceName.toLowerCase() === 'android') {
          if (!caps.avd) {
            var msg = 'The desired capabilities must include avd';
            _logger2['default'].errorAndThrow(msg);
          }
        }
      }

      // finally, return true since the superclass check passed, as did this
      return true;
    }
  }, {
    key: 'setupNewIOSDriver',
    value: function setupNewIOSDriver(opts) {
      var iosArgs, iosdriver, majorVer, caps;
      return _regeneratorRuntime.async(function setupNewIOSDriver$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            iosArgs = {
              javascriptEnabled: true
            };
            iosdriver = new _appiumIosDriver2['default'](iosArgs);

            // If iOS version is 10 or above we need to use XCUITestDriver (and Xcode 8+)
            if (opts.platformVersion) {
              majorVer = opts.platformVersion.toString().split(".")[0];

              if (parseInt(majorVer, 10) >= 10) {
                iosdriver = new _appiumXcuitestDriver2['default'](iosArgs);
              }
            }

            caps = {
              platformName: "iOS",
              browserName: "",
              app: opts.app,
              udid: opts.udid,
              platformVersion: opts.platformVersion,
              deviceName: opts.deviceName,
              //XCUITest specific (no harm in sending them to IOSDriver)
              noReset: opts.noReset,
              processArguments: opts.processArguments,
              wdaLocalPort: opts.wdaLocalPort,
              showXcodeLog: opts.showXcodeLog,
              realDeviceLogger: opts.realDeviceLogger,
              iosInstallPause: opts.iosInstallPause,
              xcodeConfigFile: opts.xcodeConfigFile,
              // Disabling the proxy CommandTimeout in the iOS driver since we are now handling it in the YouiEngine Driver
              newCommandTimeout: 0
            };
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(iosdriver.createSession(caps));

          case 6:
            return context$2$0.abrupt('return', iosdriver);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startIOSSession',
    value: function startIOSSession() {
      var opts;
      return _regeneratorRuntime.async(function startIOSSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info("Starting an IOS proxy session");
            this.proxyAllowList = TO_PROXY_IOS;
            opts = _lodash2['default'].cloneDeep(this.opts);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.setupNewIOSDriver(opts));

          case 5:
            this.proxydriver = context$2$0.sent;

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupNewAndroidDriver',
    value: function setupNewAndroidDriver(opts) {
      var androidArgs, androiddriver, caps;
      return _regeneratorRuntime.async(function setupNewAndroidDriver$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            androidArgs = {
              javascriptEnabled: true
            };
            androiddriver = new _appiumAndroidDriver2['default'](androidArgs);
            caps = {
              platformName: "android",
              browserName: "",
              app: this.caps.app,
              platformVersion: opts.platformVersion,
              deviceName: opts.deviceName,
              avd: this.caps.avd,
              // Disabling the proxy CommandTimeout in the Android driver since we are now handling it in the YouiEngine Driver
              newCommandTimeout: 0
            };
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(androiddriver.createSession(caps));

          case 5:
            return context$2$0.abrupt('return', androiddriver);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startAndroidSession',
    value: function startAndroidSession() {
      var opts;
      return _regeneratorRuntime.async(function startAndroidSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info("Starting an Android proxy session");
            this.proxyAllowList = TO_PROXY_ANDROID;
            opts = _lodash2['default'].cloneDeep(this.opts);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.setupNewAndroidDriver(opts));

          case 5:
            this.proxydriver = context$2$0.sent;

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // SOCKETS
  }, {
    key: 'connectSocket',
    value: function connectSocket() {
      var retryCount, connected, connectedPromise;
      return _regeneratorRuntime.async(function connectSocket$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            retryCount = 0;
            connected = false;

          case 2:
            if (!(retryCount < MAX_RETRY_COUNT && !connected)) {
              context$2$0.next = 16;
              break;
            }

            if (!(retryCount > 0)) {
              context$2$0.next = 7;
              break;
            }

            _logger2['default'].info("Waiting " + RETRY_BACKOFF / 1000 + " seconds before trying...");
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(RETRY_BACKOFF));

          case 7:
            _logger2['default'].info("Attempt #" + (retryCount + 1));

            connectedPromise = new _bluebird2['default'](function (resolve) {
              var net = require('net');

              var HOST = _this.opts.youiEngineAppAddress;
              var PORT = 12345;

              _logger2['default'].info('Connecting to WebDriver: ' + HOST + ':' + PORT);

              _this.socket = new net.Socket();

              // Add an 'error' event handler for the client socket
              _this.socket.on('error', function (ex) {
                _logger2['default'].error(ex);
                _logger2['default'].error('Check that WebDriver is enabled in application, if a device ensure the proper IP address is used.');
                resolve(false);
              });
              // Add a 'close' event handler for the client socket
              _this.socket.on('close', function () {
                _logger2['default'].info('Connection closed');
              });
              // Add a 'timeout' event handler for the client socket
              _this.socket.on('timeout', function () {
                _logger2['default'].error('Connection timed out');
                resolve(false);
              });
              _this.socket.connect(PORT, HOST, function () {
                _logger2['default'].info('Connected');
                resolve(true);
              });
            });

            retryCount++;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(connectedPromise);

          case 12:
            connected = context$2$0.sent;

            if (!connected && retryCount === MAX_RETRY_COUNT - 1) {
              _logger2['default'].errorAndThrow("Failed to connect " + MAX_RETRY_COUNT + " times. Aborting.");
            }
            context$2$0.next = 2;
            break;

          case 16:
            retryCount = 0;
            this.ready = connected;

          case 18:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // responses to the commands are BINARY
  }, {
    key: 'executeSocketCommand',
    value: function executeSocketCommand(cmd) {
      var cmdPromise;
      return _regeneratorRuntime.async(function executeSocketCommand$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.socket.writable) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].info("Socket is not writable. Trying to reconnect.");
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.connectSocket());

          case 4:
            cmdPromise = new _bluebird2['default'](function (resolve) {
              _logger2['default'].debug('COMMAND: ' + cmd);

              var totaldata = [];
              var endMarker = new Buffer("youiend");
              var socketClient = _this2.socket;

              var dataHandler = function dataHandler(data) {
                _logger2['default'].debug('RESPONSE: ' + data);

                // determine if this includes an end parker
                // get last few values of buffer
                if (data.length >= endMarker.length) {
                  var dataend = new Buffer(endMarker.length);
                  var startIndex = data.length - endMarker.length;
                  data.copy(dataend, 0, startIndex, startIndex + endMarker.length);
                  //logger.debug('DATAEND' + dataend.toString());
                  if (dataend.equals(endMarker)) {
                    // remove data end
                    var lastData = data.slice(0, startIndex);
                    //logger.debug('LAST DATA: ' + lastData.toString());
                    totaldata.push(lastData);

                    //remove handler
                    socketClient.removeListener('data', dataHandler);

                    // resolve
                    resolve(Buffer.concat(totaldata));
                  } else {
                    totaldata.push(data);
                  }
                }
              };

              socketClient.write(cmd + "\n", "UTF8", function () {
                socketClient.on('data', dataHandler);
              });
            });
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(cmdPromise);

          case 7:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return YouiEngineDriver;
})(_appiumBaseDriver.BaseDriver);

var _iteratorNormalCompletion2 = true;
var _didIteratorError2 = false;
var _iteratorError2 = undefined;

try {

  for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(_commandsIndex2['default'])), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
    var _step2$value = _slicedToArray(_step2.value, 2);

    var cmd = _step2$value[0];
    var fn = _step2$value[1];

    YouiEngineDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError2 = true;
  _iteratorError2 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion2 && _iterator2['return']) {
      _iterator2['return']();
    }
  } finally {
    if (_didIteratorError2) {
      throw _iteratorError2;
    }
  }
}

exports.YouiEngineDriver = YouiEngineDriver;

// setup proxies - if platformName is not empty, make it less case sensitive
//# sourceMappingURL=data:application/json;charset=utf8;base64,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LGdCQUFnQixHQUFoQixnQkFBZ0IiLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEcml2ZXIsIGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgZGVzaXJlZENhcENvbnN0cmFpbnRzIGZyb20gJy4vZGVzaXJlZC1jYXBzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGNvbW1hbmRzIGZyb20gJy4vY29tbWFuZHMvaW5kZXgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSAnYXN5bmNib3gnO1xuXG4vLyBmb3IgcHJveGllc1xuaW1wb3J0IEFuZHJvaWREcml2ZXIgZnJvbSAnYXBwaXVtLWFuZHJvaWQtZHJpdmVyJztcbmltcG9ydCBJT1NEcml2ZXIgZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IFhDVUlUZXN0RHJpdmVyIGZyb20gJ2FwcGl1bS14Y3VpdGVzdC1kcml2ZXInO1xuXG5cblxuLy8gQWRkIGNvbW1hbmRzIGZyb20gdGhlIGZvbGxvd2luZyBsb2NhdGlvbiB0aGF0IHNob3VsZCBiZSBtYXBwZWQgdG8gZXhpc3RpbmcgZHJpdmVyczpcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtLWJhc2UtZHJpdmVyL2Jsb2IvbWFzdGVyL2xpYi9tanNvbndwL3JvdXRlcy5qc1xuXG5jb25zdCBUT19QUk9YWV9DT01NT04gPSBbXG4gICdiYWNrZ3JvdW5kJyxcbiAgJ2Nsb3NlQXBwJyxcbiAgJ2dldExvZycsXG4gICdnZXRMb2dUeXBlcycsXG4gICdnZXRPcmllbnRhdGlvbicsXG4gICdnZXRTdHJpbmdzJyxcbiAgJ2dldFdpbmRvd1NpemUnLFxuICAnbGF1bmNoQXBwJyxcbiAgJ2xvY2snLFxuICAncmVtb3ZlQXBwJyxcbiAgJ3NldE9yaWVudGF0aW9uJyxcbl07XG5cbmNvbnN0IFRPX1BST1hZX0lPU19PTkxZID0gW1xuICAnbW9iaWxlU2hha2UnLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfQU5EUk9JRF9PTkxZID0gW1xuICAnZ2V0TmV0d29ya0Nvbm5lY3Rpb24nLFxuICAnaXNBcHBJbnN0YWxsZWQnLFxuICAnaXNMb2NrZWQnLFxuICAnbG9uZ1ByZXNzS2V5Q29kZScsXG4gICdwcmVzc0tleUNvZGUnLFxuICAnc2V0TmV0d29ya0Nvbm5lY3Rpb24nLFxuICAndG9nZ2xlTG9jYXRpb25TZXJ2aWNlcycsXG4gICd1bmxvY2snLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfSU9TID0gVE9fUFJPWFlfSU9TX09OTFkuY29uY2F0KFRPX1BST1hZX0NPTU1PTik7XG5jb25zdCBUT19QUk9YWV9BTkRST0lEID0gVE9fUFJPWFlfQU5EUk9JRF9PTkxZLmNvbmNhdChUT19QUk9YWV9DT01NT04pO1xuXG5jb25zdCBNQVhfUkVUUllfQ09VTlQgPSAxMDtcbmNvbnN0IFJFVFJZX0JBQ0tPRkYgPSAzMDAwO1xuXG5jbGFzcyBZb3VpRW5naW5lRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG4gIHJlc2V0WW91aUVuZ2luZSAoKSB7XG5cbiAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIHRoaXMubG9jYXRvclN0cmF0ZWdpZXMgPSBbJ3hwYXRoJywgJ2lkJywgJ25hbWUnLCAnY2xhc3MgbmFtZScsXG4gICAgICAgICAgJ2FjY2Vzc2liaWxpdHkgaWQnXTtcbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gbnVsbDtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gJyc7XG4gIH1cblxuICBjb25zdHJ1Y3RvciAob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKSB7XG4gICAgc3VwZXIob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuICAgIHRoaXMucmVzZXRZb3VpRW5naW5lKCk7XG5cbiAgfVxuXG4gIHZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IChzdHJhdGVneSkge1xuICAgIHN1cGVyLnZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5KHN0cmF0ZWd5LCBmYWxzZSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVTZXNzaW9uIChjYXBzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBbc2Vzc2lvbklkXSA9IGF3YWl0IHN1cGVyLmNyZWF0ZVNlc3Npb24oY2Fwcyk7XG5cbiAgICAgIC8vIHNldHVwIHByb3hpZXMgLSBpZiBwbGF0Zm9ybU5hbWUgaXMgbm90IGVtcHR5LCBtYWtlIGl0IGxlc3MgY2FzZSBzZW5zaXRpdmVcbiAgICAgIGlmICh0aGlzLm9wdHMucGxhdGZvcm1OYW1lICE9PSBudWxsKSB7XG4gICAgICAgIGxldCBhcHBQbGF0Zm9ybSA9IHRoaXMub3B0cy5wbGF0Zm9ybU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKGFwcFBsYXRmb3JtID09PSBcImlvc1wiKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5zdGFydElPU1Nlc3Npb24oKTtcbiAgICAgICAgfSBlbHNlIGlmIChhcHBQbGF0Zm9ybSA9PT0gXCJhbmRyb2lkXCIpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0QW5kcm9pZFNlc3Npb24oKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3RTb2NrZXQoKTtcbiAgICAgIHJldHVybiBbc2Vzc2lvbklkLCB0aGlzLm9wdHNdO1xuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKCk7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkge1xuICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkRlbGV0aW5nIFlvdWlFbmdpbmUgc2Vzc2lvblwiKTtcbiAgICBpZiAodGhpcy5wcm94eWRyaXZlciAhPT0gbnVsbCkge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eWRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICBhd2FpdCB0aGlzLnN0b3AoKTtcbiAgfVxuXG4gIGRyaXZlclNob3VsZERvUHJveHlDbWQgKGNvbW1hbmQpIHtcblxuICAgIGlmICghdGhpcy5wcm94eWRyaXZlcilcbiAgICAgIHJldHVybiBmYWxzZTtcblxuICAgIC8vIG9ubHkgYWxsb3cgd2hpdGUgbGlzdGVkIGNvbW1hbmRzXG4gICAgZm9yIChsZXQgYWxsb3dlZENvbW1hbmQgb2YgdGhpcy5wcm94eUFsbG93TGlzdCkge1xuICAgICAgaWYgKGFsbG93ZWRDb21tYW5kID09PSBjb21tYW5kKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhc3luYyBleGVjdXRlQ29tbWFuZCAoY21kLCAuLi5hcmdzKSB7XG4gICAgaWYgKGNtZCA9PT0gJ3JlY2VpdmVBc3luY1Jlc3BvbnNlJykge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBFeGVjdXRpbmcgWW91aUVuZ2luZURyaXZlciByZXNwb25zZSAnJHtjbWR9J2ApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVjZWl2ZUFzeW5jUmVzcG9uc2UoLi4uYXJncyk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnJlYWR5KSB7XG5cbiAgICAgIGlmICh0aGlzLmRyaXZlclNob3VsZERvUHJveHlDbWQoY21kKSkge1xuICAgICAgICBsb2dnZXIuZGVidWcoYEV4ZWN1dGluZyBwcm94aWVkIFdlYkRyaXZlciBjb21tYW5kICcke2NtZH0nYCk7XG5cbiAgICAgICAgLy8gVGhlcmUgYXJlIDIgQ29tbWFuZFRpbWVvdXQgKFlvdWlFbmdpbmVEcml2ZXIgYW5kIHByb3h5KVxuICAgICAgICAvLyBPbmx5IFlvdWlFbmdpbmVEcml2ZXIgQ29tbWFuZFRpbWVvdXQgaXMgdXNlZDsgUHJveHkgaXMgZGlzYWJsZWRcbiAgICAgICAgLy8gQWxsIHByb3h5IGNvbW1hbmRzIG5lZWRzIHRvIHJlc2V0IHRoZSBZb3VpRW5naW5lRHJpdmVyIENvbW1hbmRUaW1lb3V0XG4gICAgICAgIC8vIEhlcmUgd2UgbWFudWFsbHkgcmVzZXQgdGhlIFlvdWlFbmdpbmVEcml2ZXIgQ29tbWFuZFRpbWVvdXQgZm9yIGNvbW1hbmRzIHRoYXQgZ29lIHRvIHByb3h5LlxuICAgICAgICB0aGlzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQoKTtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMucHJveHlkcml2ZXIuZXhlY3V0ZUNvbW1hbmQoY21kLCAuLi5hcmdzKTtcbiAgICAgICAgdGhpcy5zdGFydE5ld0NvbW1hbmRUaW1lb3V0KGNtZCk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZGVidWcoYEV4ZWN1dGluZyBZb3VpRW5naW5lIFdlYkRyaXZlciBjb21tYW5kICcke2NtZH0nYCk7XG4gICAgICAgIHJldHVybiBzdXBlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoYENvbW1hbmQgRXJyb3IgJyR7Y21kfSdgKTtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRHJpdmVyRXJyb3IoYERyaXZlciBpcyBub3QgcmVhZHksIGNhbm5vdCBleGVjdXRlICR7Y21kfS5gKTtcbiAgICB9XG4gIH1cblxuICB2YWxpZGF0ZURlc2lyZWRDYXBzIChjYXBzKSB7XG4gICAgLy8gY2hlY2sgd2l0aCB0aGUgYmFzZSBjbGFzcywgYW5kIHJldHVybiBpZiBpdCBmYWlsc1xuICAgIGxldCByZXMgPSBzdXBlci52YWxpZGF0ZURlc2lyZWRDYXBzKGNhcHMpO1xuICAgIGlmICghcmVzKSByZXR1cm4gcmVzO1xuXG4gICAgLy8gdXNpbmcgYSBwcm94eVxuICAgIGlmIChjYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnbm9wcm94eScpIHtcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBjYXBhYmlsaXRpZXMgaGFzIHlvdWlFbmdpbmVBcHBBZGRyZXNzXG4gICAgICBpZiAoIWNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3MpIHtcbiAgICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIHlvdWlFbmdpbmVBcHBBZGRyZXNzJztcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgIH1cbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBjYXBhYmlsaXRpZXMgaGFzIGFwcFxuICAgICAgaWYgKCFjYXBzLmFwcCkge1xuICAgICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgYXBwJztcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgIH1cblxuICAgICAgLy9BbmRyb2lkIGVtdWxhdG9yIHdpdGggcHJveHlcbiAgICAgIGlmIChjYXBzLmRldmljZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2FuZHJvaWQnKSB7XG4gICAgICAgIGlmICghY2Fwcy5hdmQpIHtcbiAgICAgICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgYXZkJztcbiAgICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZmluYWxseSwgcmV0dXJuIHRydWUgc2luY2UgdGhlIHN1cGVyY2xhc3MgY2hlY2sgcGFzc2VkLCBhcyBkaWQgdGhpc1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgc2V0dXBOZXdJT1NEcml2ZXIgKG9wdHMpIHtcbiAgICBsZXQgaW9zQXJncyA9IHtcbiAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlLFxuICAgIH07XG5cbiAgICBsZXQgaW9zZHJpdmVyID0gbmV3IElPU0RyaXZlcihpb3NBcmdzKTtcbiAgICAvLyBJZiBpT1MgdmVyc2lvbiBpcyAxMCBvciBhYm92ZSB3ZSBuZWVkIHRvIHVzZSBYQ1VJVGVzdERyaXZlciAoYW5kIFhjb2RlIDgrKVxuICAgIGlmIChvcHRzLnBsYXRmb3JtVmVyc2lvbikge1xuICAgICAgbGV0IG1ham9yVmVyID0gb3B0cy5wbGF0Zm9ybVZlcnNpb24udG9TdHJpbmcoKS5zcGxpdChcIi5cIilbMF07XG4gICAgICBpZiAocGFyc2VJbnQobWFqb3JWZXIsIDEwKSA+PSAxMCkge1xuICAgICAgICBpb3Nkcml2ZXIgPSBuZXcgWENVSVRlc3REcml2ZXIoaW9zQXJncyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGNhcHMgPSB7XG4gICAgICBwbGF0Zm9ybU5hbWU6IFwiaU9TXCIsXG4gICAgICBicm93c2VyTmFtZTogXCJcIixcbiAgICAgIGFwcDogb3B0cy5hcHAsXG4gICAgICB1ZGlkOiBvcHRzLnVkaWQsXG4gICAgICBwbGF0Zm9ybVZlcnNpb246IG9wdHMucGxhdGZvcm1WZXJzaW9uLFxuICAgICAgZGV2aWNlTmFtZTogb3B0cy5kZXZpY2VOYW1lLFxuICAgICAgLy9YQ1VJVGVzdCBzcGVjaWZpYyAobm8gaGFybSBpbiBzZW5kaW5nIHRoZW0gdG8gSU9TRHJpdmVyKVxuICAgICAgbm9SZXNldDogb3B0cy5ub1Jlc2V0LFxuICAgICAgcHJvY2Vzc0FyZ3VtZW50czogb3B0cy5wcm9jZXNzQXJndW1lbnRzLFxuICAgICAgd2RhTG9jYWxQb3J0OiBvcHRzLndkYUxvY2FsUG9ydCxcbiAgICAgIHNob3dYY29kZUxvZzogb3B0cy5zaG93WGNvZGVMb2csXG4gICAgICByZWFsRGV2aWNlTG9nZ2VyOiBvcHRzLnJlYWxEZXZpY2VMb2dnZXIsXG4gICAgICBpb3NJbnN0YWxsUGF1c2U6IG9wdHMuaW9zSW5zdGFsbFBhdXNlLFxuICAgICAgeGNvZGVDb25maWdGaWxlOiBvcHRzLnhjb2RlQ29uZmlnRmlsZSxcbiAgICAgIC8vIERpc2FibGluZyB0aGUgcHJveHkgQ29tbWFuZFRpbWVvdXQgaW4gdGhlIGlPUyBkcml2ZXIgc2luY2Ugd2UgYXJlIG5vdyBoYW5kbGluZyBpdCBpbiB0aGUgWW91aUVuZ2luZSBEcml2ZXJcbiAgICAgIG5ld0NvbW1hbmRUaW1lb3V0OiAwXG4gICAgfTtcbiAgICBhd2FpdCBpb3Nkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzKTtcblxuICAgIHJldHVybiBpb3Nkcml2ZXI7XG4gIH1cblxuICBhc3luYyBzdGFydElPU1Nlc3Npb24gKCkge1xuICAgIGxvZ2dlci5pbmZvKFwiU3RhcnRpbmcgYW4gSU9TIHByb3h5IHNlc3Npb25cIik7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX0lPUztcbiAgICBsZXQgb3B0cyA9IF8uY2xvbmVEZWVwKHRoaXMub3B0cyk7XG5cbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gYXdhaXQgdGhpcy5zZXR1cE5ld0lPU0RyaXZlcihvcHRzKTtcbiAgfVxuXG4gIGFzeW5jIHNldHVwTmV3QW5kcm9pZERyaXZlciAob3B0cykge1xuICAgIGxldCBhbmRyb2lkQXJncyA9IHtcbiAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgYW5kcm9pZGRyaXZlciA9IG5ldyBBbmRyb2lkRHJpdmVyKGFuZHJvaWRBcmdzKTtcblxuICAgIGxldCBjYXBzID0ge1xuICAgICAgcGxhdGZvcm1OYW1lOiBcImFuZHJvaWRcIixcbiAgICAgIGJyb3dzZXJOYW1lOiBcIlwiLFxuICAgICAgYXBwOiB0aGlzLmNhcHMuYXBwLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uOiBvcHRzLnBsYXRmb3JtVmVyc2lvbixcbiAgICAgIGRldmljZU5hbWU6IG9wdHMuZGV2aWNlTmFtZSxcbiAgICAgIGF2ZDogdGhpcy5jYXBzLmF2ZCxcbiAgICAgIC8vIERpc2FibGluZyB0aGUgcHJveHkgQ29tbWFuZFRpbWVvdXQgaW4gdGhlIEFuZHJvaWQgZHJpdmVyIHNpbmNlIHdlIGFyZSBub3cgaGFuZGxpbmcgaXQgaW4gdGhlIFlvdWlFbmdpbmUgRHJpdmVyXG4gICAgICBuZXdDb21tYW5kVGltZW91dDogMFxuICAgIH07XG4gICAgYXdhaXQgYW5kcm9pZGRyaXZlci5jcmVhdGVTZXNzaW9uKGNhcHMpO1xuXG4gICAgcmV0dXJuIGFuZHJvaWRkcml2ZXI7XG4gIH1cblxuICBhc3luYyBzdGFydEFuZHJvaWRTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuaW5mbyhcIlN0YXJ0aW5nIGFuIEFuZHJvaWQgcHJveHkgc2Vzc2lvblwiKTtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gVE9fUFJPWFlfQU5EUk9JRDtcbiAgICBsZXQgb3B0cyA9IF8uY2xvbmVEZWVwKHRoaXMub3B0cyk7XG5cbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gYXdhaXQgdGhpcy5zZXR1cE5ld0FuZHJvaWREcml2ZXIob3B0cyk7XG4gIH1cblxuLy8gU09DS0VUU1xuICBhc3luYyBjb25uZWN0U29ja2V0ICgpIHtcblxuICAgIHZhciByZXRyeUNvdW50ID0gMDtcbiAgICB2YXIgY29ubmVjdGVkID0gZmFsc2U7XG4gICAgd2hpbGUgKHJldHJ5Q291bnQgPCBNQVhfUkVUUllfQ09VTlQgJiYgIWNvbm5lY3RlZCkge1xuXG4gICAgICBpZiAocmV0cnlDb3VudCA+IDApe1xuICAgICAgICBsb2dnZXIuaW5mbyhcIldhaXRpbmcgXCIgKyAoUkVUUllfQkFDS09GRi8xMDAwKSArIFwiIHNlY29uZHMgYmVmb3JlIHRyeWluZy4uLlwiKTtcbiAgICAgICAgYXdhaXQgc2xlZXAoUkVUUllfQkFDS09GRik7XG4gICAgICB9XG4gICAgICBsb2dnZXIuaW5mbyhcIkF0dGVtcHQgI1wiICsgKHJldHJ5Q291bnQgKyAxKSk7XG5cbiAgICAgIHZhciBjb25uZWN0ZWRQcm9taXNlID0gbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgICAgdmFyIG5ldCA9IHJlcXVpcmUoJ25ldCcpO1xuXG4gICAgICAgIHZhciBIT1NUID0gdGhpcy5vcHRzLnlvdWlFbmdpbmVBcHBBZGRyZXNzO1xuICAgICAgICB2YXIgUE9SVCA9IDEyMzQ1O1xuXG4gICAgICAgIGxvZ2dlci5pbmZvKCdDb25uZWN0aW5nIHRvIFdlYkRyaXZlcjogJyArIEhPU1QgKyAnOicgKyBQT1JUKTtcblxuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KCk7XG5cbiAgICAgICAgLy8gQWRkIGFuICdlcnJvcicgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGNsaWVudCBzb2NrZXRcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCdlcnJvcicsIGZ1bmN0aW9uIChleCkge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcihleCk7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdDaGVjayB0aGF0IFdlYkRyaXZlciBpcyBlbmFibGVkIGluIGFwcGxpY2F0aW9uLCBpZiBhIGRldmljZSBlbnN1cmUgdGhlIHByb3BlciBJUCBhZGRyZXNzIGlzIHVzZWQuJyk7XG4gICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBBZGQgYSAnY2xvc2UnIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBjbGllbnQgc29ja2V0XG4gICAgICAgIHRoaXMuc29ja2V0Lm9uICgnY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oJ0Nvbm5lY3Rpb24gY2xvc2VkJyk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBBZGQgYSAndGltZW91dCcgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGNsaWVudCBzb2NrZXRcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCd0aW1lb3V0JywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignQ29ubmVjdGlvbiB0aW1lZCBvdXQnKTtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QgKFBPUlQsIEhPU1QsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnQ29ubmVjdGVkJyk7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHJ5Q291bnQrKztcbiAgICAgIGNvbm5lY3RlZCA9IGF3YWl0IGNvbm5lY3RlZFByb21pc2U7XG5cbiAgICAgIGlmICghY29ubmVjdGVkICYmIHJldHJ5Q291bnQgPT09IChNQVhfUkVUUllfQ09VTlQgLSAxKSkge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhcIkZhaWxlZCB0byBjb25uZWN0IFwiICsgTUFYX1JFVFJZX0NPVU5UICsgXCIgdGltZXMuIEFib3J0aW5nLlwiKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0cnlDb3VudCA9IDA7XG4gICAgdGhpcy5yZWFkeSA9IGNvbm5lY3RlZDtcbiAgfVxuXG4gIC8vIHJlc3BvbnNlcyB0byB0aGUgY29tbWFuZHMgYXJlIEJJTkFSWVxuICBhc3luYyBleGVjdXRlU29ja2V0Q29tbWFuZCAoY21kKSB7XG5cbiAgICBpZiAoIXRoaXMuc29ja2V0LndyaXRhYmxlKSB7XG4gICAgICBsb2dnZXIuaW5mbyhcIlNvY2tldCBpcyBub3Qgd3JpdGFibGUuIFRyeWluZyB0byByZWNvbm5lY3QuXCIpO1xuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG4gICAgfVxuXG4gICAgbGV0IGNtZFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDT01NQU5EOiAnICsgY21kKTtcblxuICAgICAgdmFyIHRvdGFsZGF0YSA9IFtdO1xuICAgICAgdmFyIGVuZE1hcmtlciA9IG5ldyBCdWZmZXIoXCJ5b3VpZW5kXCIpO1xuICAgICAgbGV0IHNvY2tldENsaWVudCA9IHRoaXMuc29ja2V0O1xuXG5cbiAgICAgIGxldCBkYXRhSGFuZGxlciA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnUkVTUE9OU0U6ICcgKyBkYXRhKTtcblxuICAgICAgICAvLyBkZXRlcm1pbmUgaWYgdGhpcyBpbmNsdWRlcyBhbiBlbmQgcGFya2VyXG4gICAgICAgIC8vIGdldCBsYXN0IGZldyB2YWx1ZXMgb2YgYnVmZmVyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA+PSBlbmRNYXJrZXIubGVuZ3RoKSB7XG4gICAgICAgICAgdmFyIGRhdGFlbmQgPSBuZXcgQnVmZmVyKGVuZE1hcmtlci5sZW5ndGgpO1xuICAgICAgICAgIHZhciBzdGFydEluZGV4ID0gZGF0YS5sZW5ndGggLSBlbmRNYXJrZXIubGVuZ3RoO1xuICAgICAgICAgIGRhdGEuY29weShkYXRhZW5kLCAwLCBzdGFydEluZGV4LCBzdGFydEluZGV4ICsgZW5kTWFya2VyLmxlbmd0aCk7XG4gICAgICAgICAgLy9sb2dnZXIuZGVidWcoJ0RBVEFFTkQnICsgZGF0YWVuZC50b1N0cmluZygpKTtcbiAgICAgICAgICBpZiAoZGF0YWVuZC5lcXVhbHMoZW5kTWFya2VyKSkge1xuICAgICAgICAgICAgLy8gcmVtb3ZlIGRhdGEgZW5kXG4gICAgICAgICAgICB2YXIgbGFzdERhdGEgPSBkYXRhLnNsaWNlKDAsIHN0YXJ0SW5kZXgpO1xuICAgICAgICAgICAgLy9sb2dnZXIuZGVidWcoJ0xBU1QgREFUQTogJyArIGxhc3REYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgdG90YWxkYXRhLnB1c2gobGFzdERhdGEpO1xuXG4gICAgICAgICAgICAvL3JlbW92ZSBoYW5kbGVyXG4gICAgICAgICAgICBzb2NrZXRDbGllbnQucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG5cbiAgICAgICAgICAgIC8vIHJlc29sdmVcbiAgICAgICAgICAgIHJlc29sdmUoQnVmZmVyLmNvbmNhdCh0b3RhbGRhdGEpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdG90YWxkYXRhLnB1c2goZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBzb2NrZXRDbGllbnQud3JpdGUoY21kICsgXCJcXG5cIiwgXCJVVEY4XCIsICgpID0+IHtcbiAgICAgICAgc29ja2V0Q2xpZW50Lm9uKCdkYXRhJywgZGF0YUhhbmRsZXIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IGNtZFByb21pc2U7XG4gIH1cbn1cblxuZm9yIChsZXQgW2NtZCwgZm5dIG9mIF8udG9QYWlycyhjb21tYW5kcykpIHtcbiAgWW91aUVuZ2luZURyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xufVxuXG5leHBvcnQgeyBZb3VpRW5naW5lRHJpdmVyIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
