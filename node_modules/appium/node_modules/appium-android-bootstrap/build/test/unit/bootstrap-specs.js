// transpile :mocha

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _2 = require('../..');

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

var _appiumTestSupport = require('appium-test-support');

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _appiumUiautomator = require('appium-uiautomator');

var _appiumUiautomator2 = _interopRequireDefault(_appiumUiautomator);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('AndroidBootstrap', function callee$0$0() {
  var systemPort, adb, androidBootstrap, uiAutomator;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        systemPort = 4724;
        adb = new _appiumAdb2['default']();
        androidBootstrap = new _2.AndroidBootstrap(adb, systemPort);
        uiAutomator = new _appiumUiautomator2['default'](adb);

        describe("start", (0, _appiumTestSupport.withSandbox)({ mocks: { adb: adb, uiAutomator: uiAutomator, net: _net2['default'], androidBootstrap: androidBootstrap } }, function (S) {
          it("should return a subProcess", function callee$2$0() {
            var conn, appPackage, disableAndroidWatchers;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();
                  appPackage = 'com.example.android.apis', disableAndroidWatchers = false;

                  androidBootstrap.uiAutomator = uiAutomator;
                  S.mocks.androidBootstrap.expects('init').once().returns('');
                  S.mocks.adb.expects('forwardPort').once().withExactArgs(systemPort, systemPort).returns('');
                  S.mocks.uiAutomator.expects("start").once().returns(conn);
                  S.mocks.net.expects('connect').once().returns(conn);
                  setTimeout(function () {
                    conn.emit("connect");
                  }, 1);
                  context$3$0.next = 10;
                  return _regeneratorRuntime.awrap(androidBootstrap.start(appPackage, disableAndroidWatchers));

                case 10:
                  S.verify();

                case 11:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        }));
        describe("sendCommand", function () {
          it("should successfully return after receiving data from bootstrap in parts", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  conn.write = _lodash2['default'].noop;
                  conn.setEncoding = _lodash2['default'].noop;
                  androidBootstrap.socketClient = conn;
                  setTimeout(function () {
                    conn.emit("data", '{"status":0, ');
                    conn.emit("data", '"value": "hello"}');
                  }, 1);
                  context$3$0.next = 7;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_2.COMMAND_TYPES.ACTION, { action: 'getDataDir' }, 1000));

                case 7:
                  context$3$0.sent.should.equal("hello");

                case 8:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
          it("should successfully return after receiving data from bootstrap", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  conn.write = _lodash2['default'].noop;
                  conn.setEncoding = _lodash2['default'].noop;
                  androidBootstrap.socketClient = conn;
                  setTimeout(function () {
                    conn.emit("data", '{"status":0, "value": "hello"}');
                  }, 0);
                  context$3$0.next = 7;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_2.COMMAND_TYPES.ACTION, { action: 'getDataDir' }, 1000));

                case 7:
                  context$3$0.sent.should.equal("hello");

                case 8:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
          it("should throw correct error if status is not zero", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  conn.write = _lodash2['default'].noop;
                  conn.setEncoding = _lodash2['default'].noop;
                  androidBootstrap.socketClient = conn;
                  setTimeout(function () {
                    conn.emit("data", '{"status":7, "value": "not found"}');
                  }, 0);
                  context$3$0.next = 7;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_2.COMMAND_TYPES.ACTION, { action: 'getDataDir' }, 1000).should.eventually.be.rejectedWith(_appiumBaseDriver.errors.NoSuchElementError));

                case 7:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        });
        describe("sendAction", (0, _appiumTestSupport.withSandbox)({ mocks: { androidBootstrap: androidBootstrap } }, function (S) {
          it("should call sendCommand", function callee$2$0() {
            var extra;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  extra = { action: 'wake', params: {} };

                  S.mocks.androidBootstrap.expects('sendCommand').once().withExactArgs('action', extra).returns('');
                  context$3$0.next = 4;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendAction('wake'));

                case 4:
                  S.verify();

                case 5:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        }));
        describe("shutdown", (0, _appiumTestSupport.withSandbox)({ mocks: { androidBootstrap: androidBootstrap, uiAutomator: uiAutomator } }, function (S) {
          it("should call sendCommand", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  androidBootstrap.socketClient = conn;
                  S.mocks.androidBootstrap.expects('sendCommand').once().withExactArgs('shutdown').returns('');
                  S.mocks.uiAutomator.expects("shutdown").once().returns("");
                  context$3$0.next = 6;
                  return _regeneratorRuntime.awrap(androidBootstrap.shutdown());

                case 6:
                  S.verify();

                case 7:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        }));

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9ib290c3RyYXAtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7b0JBRWlCLE1BQU07Ozs7OEJBQ0ksa0JBQWtCOzs7O2lCQUNHLE9BQU87O3lCQUN2QyxZQUFZOzs7O2lDQUNBLHFCQUFxQjs7c0JBQzlCLFFBQVE7Ozs7aUNBQ0gsb0JBQW9COzs7O21CQUM1QixLQUFLOzs7O2dDQUNFLG9CQUFvQjs7c0JBQzdCLFFBQVE7Ozs7QUFHdEIsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixRQUFRLENBQUMsa0JBQWtCLEVBQUU7TUFDckIsVUFBVSxFQUNaLEdBQUcsRUFDSCxnQkFBZ0IsRUFDaEIsV0FBVzs7OztBQUhULGtCQUFVLEdBQUcsSUFBSTtBQUNuQixXQUFHLEdBQUcsNEJBQVM7QUFDZix3QkFBZ0IsR0FBRyx3QkFBcUIsR0FBRyxFQUFFLFVBQVUsQ0FBQztBQUN4RCxtQkFBVyxHQUFHLG1DQUFnQixHQUFHLENBQUM7O0FBRXRDLGdCQUFRLENBQUMsT0FBTyxFQUFFLG9DQUFZLEVBQUMsS0FBSyxFQUFFLEVBQUMsR0FBRyxFQUFILEdBQUcsRUFBRSxXQUFXLEVBQVgsV0FBVyxFQUFFLEdBQUcsa0JBQUEsRUFBRSxnQkFBZ0IsRUFBaEIsZ0JBQWdCLEVBQUMsRUFBQyxFQUFFLFVBQUMsQ0FBQyxFQUFLO0FBQ3ZGLFlBQUUsQ0FBQyw0QkFBNEIsRUFBRTtnQkFDM0IsSUFBSSxFQUNGLFVBQVUsRUFDVixzQkFBc0I7Ozs7QUFGeEIsc0JBQUksR0FBRyxJQUFJLG9CQUFPLFlBQVksRUFBRTtBQUM5Qiw0QkFBVSxHQUFHLDBCQUEwQixFQUN2QyxzQkFBc0IsR0FBRyxLQUFLOztBQUNwQyxrQ0FBZ0IsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0FBQzNDLG1CQUFDLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJ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c0JBQUksR0FBRyxJQUFJLG9CQUFPLFlBQVksRUFBRTs7QUFDcEMsa0NBQWdCLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztBQUNyQyxtQkFBQyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQ25ELGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FDekIsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2YsbUJBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FDcEMsSUFBSSxFQUFFLENBQ04sT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDOzttREFDVCxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUU7OztBQUNqQyxtQkFBQyxDQUFDLE1BQU0sRUFBRSxDQUFDOzs7Ozs7O1dBQ1osQ0FBQyxDQUFDO1NBQ0osQ0FBQyxDQUFDLENBQUM7Ozs7Ozs7Q0FDTCxDQUFDLENBQUMiLCJmaWxlIjoidGVzdC91bml0L2Jvb3RzdHJhcC1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZSA6bW9jaGFcblxuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgeyBBbmRyb2lkQm9vdHN0cmFwLCBDT01NQU5EX1RZUEVTIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IEFEQiBmcm9tICdhcHBpdW0tYWRiJztcbmltcG9ydCB7IHdpdGhTYW5kYm94IH0gZnJvbSAnYXBwaXVtLXRlc3Qtc3VwcG9ydCc7XG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgVWlBdXRvbWF0b3IgZnJvbSAnYXBwaXVtLXVpYXV0b21hdG9yJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCdBbmRyb2lkQm9vdHN0cmFwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICBjb25zdCBzeXN0ZW1Qb3J0ID0gNDcyNDtcbiAgbGV0IGFkYiA9IG5ldyBBREIoKTtcbiAgbGV0IGFuZHJvaWRCb290c3RyYXAgPSBuZXcgQW5kcm9pZEJvb3RzdHJhcChhZGIsIHN5c3RlbVBvcnQpO1xuICBsZXQgdWlBdXRvbWF0b3IgPSBuZXcgVWlBdXRvbWF0b3IoYWRiKTtcblxuICBkZXNjcmliZShcInN0YXJ0XCIsIHdpdGhTYW5kYm94KHttb2Nrczoge2FkYiwgdWlBdXRvbWF0b3IsIG5ldCwgYW5kcm9pZEJvb3RzdHJhcH19LCAoUykgPT4ge1xuICAgIGl0KFwic2hvdWxkIHJldHVybiBhIHN1YlByb2Nlc3NcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGNvbm4gPSBuZXcgZXZlbnRzLkV2ZW50RW1pdHRlcigpO1xuICAgICAgY29uc3QgYXBwUGFja2FnZSA9ICdjb20uZXhhbXBsZS5hbmRyb2lkLmFwaXMnLFxuICAgICAgICAgICAgZGlzYWJsZUFuZHJvaWRXYXRjaGVycyA9IGZhbHNlO1xuICAgICAgYW5kcm9pZEJvb3RzdHJhcC51aUF1dG9tYXRvciA9IHVpQXV0b21hdG9yO1xuICAgICAgUy5tb2Nrcy5hbmRyb2lkQm9vdHN0cmFwLmV4cGVjdHMoJ2luaXQnKS5vbmNlKClcbiAgICAgICAgLnJldHVybnMoJycpO1xuICAgICAgUy5tb2Nrcy5hZGIuZXhwZWN0cygnZm9yd2FyZFBvcnQnKS5vbmNlKClcbiAgICAgICAgLndpdGhFeGFjdEFyZ3Moc3lzdGVtUG9ydCwgc3lzdGVtUG9ydClcbiAgICAgICAgLnJldHVybnMoJycpO1xuICAgICAgUy5tb2Nrcy51aUF1dG9tYXRvci5leHBlY3RzKFwic3RhcnRcIilcbiAgICAgICAgLm9uY2UoKVxuICAgICAgICAucmV0dXJucyhjb25uKTtcbiAgICAgIFMubW9ja3MubmV0LmV4cGVjdHMoJ2Nvbm5lY3QnKS5vbmNlKCkucmV0dXJucyhjb25uKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25uLmVtaXQoXCJjb25uZWN0XCIpO1xuICAgICAgfSwgMSk7XG4gICAgICBhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnN0YXJ0KGFwcFBhY2thZ2UsIGRpc2FibGVBbmRyb2lkV2F0Y2hlcnMpO1xuICAgICAgUy52ZXJpZnkoKTtcbiAgICB9KTtcbiAgfSkpO1xuICBkZXNjcmliZShcInNlbmRDb21tYW5kXCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBzdWNjZXNzZnVsbHkgcmV0dXJuIGFmdGVyIHJlY2VpdmluZyBkYXRhIGZyb20gYm9vdHN0cmFwIGluIHBhcnRzXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBjb25uID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTtcbiAgICAgIGNvbm4ud3JpdGUgPSBfLm5vb3A7XG4gICAgICBjb25uLnNldEVuY29kaW5nID0gXy5ub29wO1xuICAgICAgYW5kcm9pZEJvb3RzdHJhcC5zb2NrZXRDbGllbnQgPSBjb25uO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbm4uZW1pdChcImRhdGFcIiwgJ3tcInN0YXR1c1wiOjAsICcpO1xuICAgICAgICBjb25uLmVtaXQoXCJkYXRhXCIsICdcInZhbHVlXCI6IFwiaGVsbG9cIn0nKTtcbiAgICAgIH0sIDEpO1xuICAgICAgKGF3YWl0IGFuZHJvaWRCb290c3RyYXAuc2VuZENvbW1hbmQoQ09NTUFORF9UWVBFUy5BQ1RJT04sIHthY3Rpb246ICdnZXREYXRhRGlyJ30sIDEwMDApKVxuICAgICAgICAuc2hvdWxkLmVxdWFsKFwiaGVsbG9cIik7XG4gICAgfSk7XG4gICAgaXQoXCJzaG91bGQgc3VjY2Vzc2Z1bGx5IHJldHVybiBhZnRlciByZWNlaXZpbmcgZGF0YSBmcm9tIGJvb3RzdHJhcFwiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgY29ubiA9IG5ldyBldmVudHMuRXZlbnRFbWl0dGVyKCk7XG4gICAgICBjb25uLndyaXRlID0gXy5ub29wO1xuICAgICAgY29ubi5zZXRFbmNvZGluZyA9IF8ubm9vcDtcbiAgICAgIGFuZHJvaWRCb290c3RyYXAuc29ja2V0Q2xpZW50ID0gY29ubjtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25uLmVtaXQoXCJkYXRhXCIsICd7XCJzdGF0dXNcIjowLCBcInZhbHVlXCI6IFwiaGVsbG9cIn0nKTtcbiAgICAgIH0sIDApO1xuICAgICAgKGF3YWl0IGFuZHJvaWRCb290c3RyYXAuc2VuZENvbW1hbmQoQ09NTUFORF9UWVBFUy5BQ1RJT04sIHthY3Rpb246ICdnZXREYXRhRGlyJ30sIDEwMDApKVxuICAgICAgICAuc2hvdWxkLmVxdWFsKFwiaGVsbG9cIik7XG4gICAgfSk7XG4gICAgaXQoXCJzaG91bGQgdGhyb3cgY29ycmVjdCBlcnJvciBpZiBzdGF0dXMgaXMgbm90IHplcm9cIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGNvbm4gPSBuZXcgZXZlbnRzLkV2ZW50RW1pdHRlcigpO1xuICAgICAgY29ubi53cml0ZSA9IF8ubm9vcDtcbiAgICAgIGNvbm4uc2V0RW5jb2RpbmcgPSBfLm5vb3A7XG4gICAgICBhbmRyb2lkQm9vdHN0cmFwLnNvY2tldENsaWVudCA9IGNvbm47XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgY29ubi5lbWl0KFwiZGF0YVwiLCAne1wic3RhdHVzXCI6NywgXCJ2YWx1ZVwiOiBcIm5vdCBmb3VuZFwifScpO1xuICAgICAgfSwgMCk7XG4gICAgICBhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNlbmRDb21tYW5kKENPTU1BTkRfVFlQRVMuQUNUSU9OLCB7YWN0aW9uOiAnZ2V0RGF0YURpcid9LCAxMDAwKVxuICAgICAgICAuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IpO1xuICAgIH0pO1xuICB9KTtcbiAgZGVzY3JpYmUoXCJzZW5kQWN0aW9uXCIsIHdpdGhTYW5kYm94KHttb2Nrczoge2FuZHJvaWRCb290c3RyYXB9fSwgKFMpID0+IHtcbiAgICBpdChcInNob3VsZCBjYWxsIHNlbmRDb21tYW5kXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBleHRyYSA9IHthY3Rpb246ICd3YWtlJywgcGFyYW1zOiB7fX07XG4gICAgICBTLm1vY2tzLmFuZHJvaWRCb290c3RyYXAuZXhwZWN0cygnc2VuZENvbW1hbmQnKS5vbmNlKClcbiAgICAgICAgLndpdGhFeGFjdEFyZ3MoJ2FjdGlvbicsIGV4dHJhKVxuICAgICAgICAucmV0dXJucygnJyk7XG4gICAgICBhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNlbmRBY3Rpb24oJ3dha2UnKTtcbiAgICAgIFMudmVyaWZ5KCk7XG4gICAgfSk7XG4gIH0pKTtcbiAgZGVzY3JpYmUoXCJzaHV0ZG93blwiLCB3aXRoU2FuZGJveCh7bW9ja3M6IHthbmRyb2lkQm9vdHN0cmFwLCB1aUF1dG9tYXRvcn19LCAoUykgPT4ge1xuICAgIGl0KFwic2hvdWxkIGNhbGwgc2VuZENvbW1hbmRcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGNvbm4gPSBuZXcgZXZlbnRzLkV2ZW50RW1pdHRlcigpO1xuICAgICAgYW5kcm9pZEJvb3RzdHJhcC5zb2NrZXRDbGllbnQgPSBjb25uO1xuICAgICAgUy5tb2Nrcy5hbmRyb2lkQm9vdHN0cmFwLmV4cGVjdHMoJ3NlbmRDb21tYW5kJykub25jZSgpXG4gICAgICAgIC53aXRoRXhhY3RBcmdzKCdzaHV0ZG93bicpXG4gICAgICAgIC5yZXR1cm5zKCcnKTtcbiAgICAgIFMubW9ja3MudWlBdXRvbWF0b3IuZXhwZWN0cyhcInNodXRkb3duXCIpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnJldHVybnMoXCJcIik7XG4gICAgICBhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNodXRkb3duKCk7XG4gICAgICBTLnZlcmlmeSgpO1xuICAgIH0pO1xuICB9KSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
