'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var SE_VER = "0.17.0";
var SE_DOWNLOAD = 'http://repo1.maven.org/maven2/io/selendroid/selendroid-standalone/' + SE_VER + '/selendroid-standalone-' + SE_VER + '-with-dependencies.jar';
var SE_DOWNLOAD_SHA256 = "7cf7163ac47f1c46eff95b62f78b58c1dabdec534acc6632da3784739f6e9d82";
var SE_DIR = _path2['default'].resolve(__dirname, "..", "..", "selendroid");
var SE_DOWNLOAD_DIR = _path2['default'].resolve(SE_DIR, "download");
// Use of temporary file means that SE_JAR_PATH can only exist if it has
// verified content.
var SE_JAR_PATH_TMP = _path2['default'].resolve(SE_DOWNLOAD_DIR, "selendroid-server.jar.tmp");
// Putting fingerprint in file name means download triggered if fingerprint changed.
var SE_JAR_PATH = _path2['default'].resolve(SE_DOWNLOAD_DIR, 'selendroid-server-' + SE_DOWNLOAD_SHA256 + '.jar');
var SE_APK_PATH = _path2['default'].resolve(SE_DIR, "selendroid-server.apk");
var SE_MANIFEST_PATH = _path2['default'].resolve(SE_DIR, "AndroidManifest.xml");

function setupSelendroid() {
  var manifestPath, serverPath, extractedManifestPath, extractedServerPath;
  return _regeneratorRuntime.async(function setupSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar'));

      case 3:
        context$1$0.next = 10;
        break;

      case 5:
        context$1$0.prev = 5;
        context$1$0.t0 = context$1$0['catch'](0);

        if (!(context$1$0.t0.message.indexOf("ENOENT") !== -1 || context$1$0.t0.message.indexOf("exited with code 2") !== -1)) {
          context$1$0.next = 10;
          break;
        }

        _logger2['default'].error("Could not find Java's 'jar' executable on your PATH. Please " + "ensure it is present and try running install again");
        return context$1$0.abrupt('return');

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_JAR_PATH));

      case 12:
        if (!context$1$0.sent) {
          context$1$0.next = 16;
          break;
        }

        _logger2['default'].info("Standalone jar exists, skipping download: " + SE_JAR_PATH);
        context$1$0.next = 18;
        break;

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(downloadSelendroid());

      case 18:
        _logger2['default'].info('Determining AndroidManifest location');
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/AndroidManifest.*\.xml$/, SE_JAR_PATH));

      case 21:
        manifestPath = context$1$0.sent;

        _logger2['default'].info('Determining server apk location');
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/selendroid-server.*\.apk$/, SE_JAR_PATH));

      case 25:
        serverPath = context$1$0.sent;

        _logger2['default'].info('Extracting manifest and apk to ' + SE_DOWNLOAD_DIR);
        context$1$0.next = 29;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['xf', SE_JAR_PATH, manifestPath, serverPath], {
          cwd: SE_DOWNLOAD_DIR
        }));

      case 29:
        _logger2['default'].info('Copying manifest and apk to ' + SE_DIR);
        extractedManifestPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, manifestPath);
        extractedServerPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, serverPath);
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedManifestPath, SE_MANIFEST_PATH));

      case 34:
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedServerPath, SE_APK_PATH));

      case 36:
        _logger2['default'].info("Cleaning up temp files");
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedManifestPath));

      case 39:
        context$1$0.next = 41;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedServerPath));

      case 41:
        _logger2['default'].info('Fixing AndroidManifest icon bug');
        context$1$0.next = 44;
        return _regeneratorRuntime.awrap(fixManifestIcons(SE_MANIFEST_PATH));

      case 44:
        context$1$0.next = 46;
        return _regeneratorRuntime.awrap(serverExists());

      case 46:
        if (context$1$0.sent) {
          context$1$0.next = 48;
          break;
        }

        throw new Error("Something went wrong in setting up selendroid");

      case 48:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 5]]);
}

function downloadSelendroid() {
  var body, fingerprint;
  return _regeneratorRuntime.async(function downloadSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Ensuring ' + SE_DOWNLOAD_DIR + ' exists');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DIR));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DOWNLOAD_DIR));

      case 5:
        _logger2['default'].info('Downloading Selendroid standalone server version ' + SE_VER + ' from ' + (SE_DOWNLOAD + ' --> ' + SE_JAR_PATH));
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: SE_DOWNLOAD, encoding: null }));

      case 8:
        body = context$1$0.sent;

        if (!(!body instanceof Buffer)) {
          context$1$0.next = 11;
          break;
        }

        throw new Error(Object.prototype.toString.call(body));

      case 11:
        _logger2['default'].info('Writing binary content to ' + SE_JAR_PATH_TMP);
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(SE_JAR_PATH_TMP, body));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(SE_JAR_PATH_TMP, 420));

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(sha256(body));

      case 18:
        fingerprint = context$1$0.sent;

        if (!(fingerprint === SE_DOWNLOAD_SHA256)) {
          context$1$0.next = 25;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rename(SE_JAR_PATH_TMP, SE_JAR_PATH));

      case 22:
        _logger2['default'].info("Selendroid standalone server downloaded");
        context$1$0.next = 26;
        break;

      case 25:
        _logger2['default'].errorAndThrow("bad SHA256 fingerprint: " + fingerprint + " bytes: " + body.length);

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function sha256(buffer) {
  var hash;
  return _regeneratorRuntime.async(function sha256$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        hash = _crypto2['default'].createHash('sha256');
        return context$1$0.abrupt('return', hash.update(buffer).digest('hex'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getFilePathFromJar(fileRegex, jarPath) {
  var _ref, stdout, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, line;

  return _regeneratorRuntime.async(function getFilePathFromJar$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['tf', jarPath]));

      case 2:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 7;
        _iterator = _getIterator(stdout.split("\n"));

      case 9:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 16;
          break;
        }

        line = _step.value;

        if (!fileRegex.test(line.trim())) {
          context$1$0.next = 13;
          break;
        }

        return context$1$0.abrupt('return', line.trim());

      case 13:
        _iteratorNormalCompletion = true;
        context$1$0.next = 9;
        break;

      case 16:
        context$1$0.next = 22;
        break;

      case 18:
        context$1$0.prev = 18;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 22:
        context$1$0.prev = 22;
        context$1$0.prev = 23;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 25:
        context$1$0.prev = 25;

        if (!_didIteratorError) {
          context$1$0.next = 28;
          break;
        }

        throw _iteratorError;

      case 28:
        return context$1$0.finish(25);

      case 29:
        return context$1$0.finish(22);

      case 30:
        throw new Error('Could not find ' + fileRegex + ' in ' + jarPath);

      case 31:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
}

function serverExists() {
  return _regeneratorRuntime.async(function serverExists$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_APK_PATH));

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_MANIFEST_PATH));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
        context$1$0.prev = 11;
        context$1$0.t1 = context$1$0['catch'](0);

        if (!(context$1$0.t1.code.indexOf("ENOENT") !== -1)) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 15:
        throw context$1$0.t1;

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 11]]);
}

function fixManifestIcons(manifest) {
  var curData, iconRe, newData;
  return _regeneratorRuntime.async(function fixManifestIcons$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(manifest));

      case 2:
        curData = context$1$0.sent.toString('utf8');
        iconRe = /application[\s\S]+android:icon="[^"]+"/;
        newData = curData.replace(iconRe, "application");
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(manifest, newData));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.setupSelendroid = setupSelendroid;
exports.serverExists = serverExists;
exports.SE_APK_PATH = SE_APK_PATH;
exports.SE_MANIFEST_PATH = SE_MANIFEST_PATH;
//# sourceMappingURL=data:application/json;base64,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QUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsYUFBYSxDQUFDOzt5Q0FDOUMsa0JBQUcsU0FBUyxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUM7Ozs7Ozs7Q0FDdEM7O1FBRVEsZUFBZSxHQUFmLGVBQWU7UUFBRSxZQUFZLEdBQVosWUFBWTtRQUFFLFdBQVcsR0FBWCxXQUFXO1FBQUUsZ0JBQWdCLEdBQWhCLGdCQUFnQiIsImZpbGUiOiJsaWIvaW5zdGFsbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5jb25zdCBTRV9WRVIgPSBcIjAuMTcuMFwiO1xuY29uc3QgU0VfRE9XTkxPQUQgPSBgaHR0cDovL3JlcG8xLm1hdmVuLm9yZy9tYXZlbjIvaW8vc2VsZW5kcm9pZC9zZWxlbmRyb2lkLXN0YW5kYWxvbmUvJHtTRV9WRVJ9L3NlbGVuZHJvaWQtc3RhbmRhbG9uZS0ke1NFX1ZFUn0td2l0aC1kZXBlbmRlbmNpZXMuamFyYDtcbmNvbnN0IFNFX0RPV05MT0FEX1NIQTI1NiA9IFwiN2NmNzE2M2FjNDdmMWM0NmVmZjk1YjYyZjc4YjU4YzFkYWJkZWM1MzRhY2M2NjMyZGEzNzg0NzM5ZjZlOWQ4MlwiO1xuY29uc3QgU0VfRElSID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLlwiLCBcIi4uXCIsIFwic2VsZW5kcm9pZFwiKTtcbmNvbnN0IFNFX0RPV05MT0FEX0RJUiA9IHBhdGgucmVzb2x2ZShTRV9ESVIsIFwiZG93bmxvYWRcIik7XG4vLyBVc2Ugb2YgdGVtcG9yYXJ5IGZpbGUgbWVhbnMgdGhhdCBTRV9KQVJfUEFUSCBjYW4gb25seSBleGlzdCBpZiBpdCBoYXNcbi8vIHZlcmlmaWVkIGNvbnRlbnQuXG5jb25zdCBTRV9KQVJfUEFUSF9UTVAgPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBcInNlbGVuZHJvaWQtc2VydmVyLmphci50bXBcIik7XG4vLyBQdXR0aW5nIGZpbmdlcnByaW50IGluIGZpbGUgbmFtZSBtZWFucyBkb3dubG9hZCB0cmlnZ2VyZWQgaWYgZmluZ2VycHJpbnQgY2hhbmdlZC5cbmNvbnN0IFNFX0pBUl9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RPV05MT0FEX0RJUiwgYHNlbGVuZHJvaWQtc2VydmVyLSR7U0VfRE9XTkxPQURfU0hBMjU2fS5qYXJgKTtcbmNvbnN0IFNFX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJzZWxlbmRyb2lkLXNlcnZlci5hcGtcIik7XG5jb25zdCBTRV9NQU5JRkVTVF9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJBbmRyb2lkTWFuaWZlc3QueG1sXCIpO1xuXG5hc3luYyBmdW5jdGlvbiBzZXR1cFNlbGVuZHJvaWQgKCkge1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ2phcicpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihcIkVOT0VOVFwiKSAhPT0gLTEgfHxcbiAgICAgICAgZXJyLm1lc3NhZ2UuaW5kZXhPZihcImV4aXRlZCB3aXRoIGNvZGUgMlwiKSAhPT0gLTEpIHtcbiAgICAgIGxvZy5lcnJvcihcIkNvdWxkIG5vdCBmaW5kIEphdmEncyAnamFyJyBleGVjdXRhYmxlIG9uIHlvdXIgUEFUSC4gUGxlYXNlIFwiICtcbiAgICAgICAgICAgICAgICBcImVuc3VyZSBpdCBpcyBwcmVzZW50IGFuZCB0cnkgcnVubmluZyBpbnN0YWxsIGFnYWluXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuICBpZiAoYXdhaXQgZnMuZXhpc3RzKFNFX0pBUl9QQVRIKSkge1xuICAgIGxvZy5pbmZvKFwiU3RhbmRhbG9uZSBqYXIgZXhpc3RzLCBza2lwcGluZyBkb3dubG9hZDogXCIgKyBTRV9KQVJfUEFUSCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgZG93bmxvYWRTZWxlbmRyb2lkKCk7XG4gIH1cbiAgbG9nLmluZm8oYERldGVybWluaW5nIEFuZHJvaWRNYW5pZmVzdCBsb2NhdGlvbmApO1xuICBsZXQgbWFuaWZlc3RQYXRoID0gYXdhaXQgZ2V0RmlsZVBhdGhGcm9tSmFyKC9BbmRyb2lkTWFuaWZlc3QuKlxcLnhtbCQvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNFX0pBUl9QQVRIKTtcbiAgbG9nLmluZm8oYERldGVybWluaW5nIHNlcnZlciBhcGsgbG9jYXRpb25gKTtcbiAgbGV0IHNlcnZlclBhdGggPSBhd2FpdCBnZXRGaWxlUGF0aEZyb21KYXIoL3NlbGVuZHJvaWQtc2VydmVyLipcXC5hcGskLyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU0VfSkFSX1BBVEgpO1xuICBsb2cuaW5mbyhgRXh0cmFjdGluZyBtYW5pZmVzdCBhbmQgYXBrIHRvICR7U0VfRE9XTkxPQURfRElSfWApO1xuICBhd2FpdCBleGVjKCdqYXInLCBbJ3hmJywgU0VfSkFSX1BBVEgsIG1hbmlmZXN0UGF0aCwgc2VydmVyUGF0aF0sIHtcbiAgICBjd2Q6IFNFX0RPV05MT0FEX0RJUlxuICB9KTtcbiAgbG9nLmluZm8oYENvcHlpbmcgbWFuaWZlc3QgYW5kIGFwayB0byAke1NFX0RJUn1gKTtcbiAgbGV0IGV4dHJhY3RlZE1hbmlmZXN0UGF0aCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIG1hbmlmZXN0UGF0aCk7XG4gIGxldCBleHRyYWN0ZWRTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKFNFX0RPV05MT0FEX0RJUiwgc2VydmVyUGF0aCk7XG4gIGF3YWl0IGZzLmNvcHlGaWxlKGV4dHJhY3RlZE1hbmlmZXN0UGF0aCwgU0VfTUFOSUZFU1RfUEFUSCk7XG4gIGF3YWl0IGZzLmNvcHlGaWxlKGV4dHJhY3RlZFNlcnZlclBhdGgsIFNFX0FQS19QQVRIKTtcbiAgbG9nLmluZm8oXCJDbGVhbmluZyB1cCB0ZW1wIGZpbGVzXCIpO1xuICBhd2FpdCBmcy5yaW1yYWYoZXh0cmFjdGVkTWFuaWZlc3RQYXRoKTtcbiAgYXdhaXQgZnMucmltcmFmKGV4dHJhY3RlZFNlcnZlclBhdGgpO1xuICBsb2cuaW5mbyhgRml4aW5nIEFuZHJvaWRNYW5pZmVzdCBpY29uIGJ1Z2ApO1xuICBhd2FpdCBmaXhNYW5pZmVzdEljb25zKFNFX01BTklGRVNUX1BBVEgpO1xuICBpZiAoIShhd2FpdCBzZXJ2ZXJFeGlzdHMoKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJTb21ldGhpbmcgd2VudCB3cm9uZyBpbiBzZXR0aW5nIHVwIHNlbGVuZHJvaWRcIik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRTZWxlbmRyb2lkICgpIHtcbiAgbG9nLmluZm8oYEVuc3VyaW5nICR7U0VfRE9XTkxPQURfRElSfSBleGlzdHNgKTtcbiAgYXdhaXQgZnMubWtkaXIoU0VfRElSKTtcbiAgYXdhaXQgZnMubWtkaXIoU0VfRE9XTkxPQURfRElSKTtcbiAgbG9nLmluZm8oYERvd25sb2FkaW5nIFNlbGVuZHJvaWQgc3RhbmRhbG9uZSBzZXJ2ZXIgdmVyc2lvbiAke1NFX1ZFUn0gZnJvbSBgICtcbiAgICAgICAgICAgYCR7U0VfRE9XTkxPQUR9IC0tPiAke1NFX0pBUl9QQVRIfWApO1xuICBsZXQgYm9keSA9IGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmw6IFNFX0RPV05MT0FELCBlbmNvZGluZzogbnVsbH0pO1xuICBpZiAoIWJvZHkgaW5zdGFuY2VvZiBCdWZmZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGJvZHkpKTtcbiAgfVxuICBsb2cuaW5mbyhgV3JpdGluZyBiaW5hcnkgY29udGVudCB0byAke1NFX0pBUl9QQVRIX1RNUH1gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKFNFX0pBUl9QQVRIX1RNUCwgYm9keSk7XG4gIGF3YWl0IGZzLmNobW9kKFNFX0pBUl9QQVRIX1RNUCwgMG8wNjQ0KTtcbiAgbGV0IGZpbmdlcnByaW50ID0gYXdhaXQgc2hhMjU2KGJvZHkpO1xuICBpZiAoZmluZ2VycHJpbnQgPT09IFNFX0RPV05MT0FEX1NIQTI1Nikge1xuICAgIGF3YWl0IGZzLnJlbmFtZShTRV9KQVJfUEFUSF9UTVAsIFNFX0pBUl9QQVRIKTtcbiAgICBsb2cuaW5mbyhcIlNlbGVuZHJvaWQgc3RhbmRhbG9uZSBzZXJ2ZXIgZG93bmxvYWRlZFwiKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhcImJhZCBTSEEyNTYgZmluZ2VycHJpbnQ6IFwiICsgZmluZ2VycHJpbnQgKyBcIiBieXRlczogXCIgKyBib2R5Lmxlbmd0aCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2hhMjU2IChidWZmZXIpIHtcbiAgY29uc3QgaGFzaCA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKTtcbiAgcmV0dXJuIGhhc2gudXBkYXRlKGJ1ZmZlcikuZGlnZXN0KCdoZXgnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZVBhdGhGcm9tSmFyIChmaWxlUmVnZXgsIGphclBhdGgpIHtcbiAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnamFyJywgWyd0ZicsIGphclBhdGhdKTtcbiAgZm9yIChsZXQgbGluZSBvZiBzdGRvdXQuc3BsaXQoXCJcXG5cIikpIHtcbiAgICBpZiAoZmlsZVJlZ2V4LnRlc3QobGluZS50cmltKCkpKSB7XG4gICAgICByZXR1cm4gbGluZS50cmltKCk7XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgJHtmaWxlUmVnZXh9IGluICR7amFyUGF0aH1gKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VydmVyRXhpc3RzICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IGZzLmV4aXN0cyhTRV9BUEtfUEFUSCkgJiZcbiAgICAgICAgICAgIGF3YWl0IGZzLmV4aXN0cyhTRV9NQU5JRkVTVF9QQVRIKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5jb2RlLmluZGV4T2YoXCJFTk9FTlRcIikgIT09IC0xKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4TWFuaWZlc3RJY29ucyAobWFuaWZlc3QpIHtcbiAgbGV0IGN1ckRhdGEgPSAoYXdhaXQgZnMucmVhZEZpbGUobWFuaWZlc3QpKS50b1N0cmluZygndXRmOCcpO1xuICBsZXQgaWNvblJlID0gL2FwcGxpY2F0aW9uW1xcc1xcU10rYW5kcm9pZDppY29uPVwiW15cIl0rXCIvO1xuICBsZXQgbmV3RGF0YSA9IGN1ckRhdGEucmVwbGFjZShpY29uUmUsIFwiYXBwbGljYXRpb25cIik7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShtYW5pZmVzdCwgbmV3RGF0YSk7XG59XG5cbmV4cG9ydCB7IHNldHVwU2VsZW5kcm9pZCwgc2VydmVyRXhpc3RzLCBTRV9BUEtfUEFUSCwgU0VfTUFOSUZFU1RfUEFUSCB9O1xuIl19