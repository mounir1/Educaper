require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _2 = require('../..');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumIosSimulator = require('appium-ios-simulator');

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _libUtils = require('../../lib/utils');

var _asyncbox = require('asyncbox');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var LAUNCH_HANDLER_TIMEOUT = 10000;
var TEMP_DIR = _path2['default'].resolve(__dirname, 'tmp');

describe('instruments tests', function () {
  this.timeout(90000);

  function newInstrument(opts) {
    return _regeneratorRuntime.async(function newInstrument$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          _lodash2['default'].extend(opts, {
            app: _path2['default'].resolve(__dirname, '..', '..', '..', 'assets', 'TestApp.app'),
            bootstrap: _path2['default'].resolve(__dirname, '..', 'assets', 'bootstrap.js'),
            simulatorSdkAndDevice: 'iPhone 6 (8.4 Simulator)'
          });
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(_2.Instruments.quickInstruments(opts));

        case 3:
          return context$2$0.abrupt('return', context$2$0.sent);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  }

  function test(appendDesc, opts) {
    var _this = this;

    var checks = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

    checks = checks || {};
    var instruments = undefined;

    it('should launch' + appendDesc, function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(newInstrument(opts));

          case 4:
            instruments = context$3$0.sent;

            if (!checks.afterCreate) {
              context$3$0.next = 8;
              break;
            }

            context$3$0.next = 8;
            return _regeneratorRuntime.awrap(checks.afterCreate(instruments));

          case 8:
            setTimeout(function () {
              if (instruments.launchResultDeferred) {
                instruments.launchResultDeferred.resolve();
              }
            }, LAUNCH_HANDLER_TIMEOUT);
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(instruments.launch());

          case 11:
            if (!checks.afterLaunch) {
              context$3$0.next = 14;
              break;
            }

            context$3$0.next = 14;
            return _regeneratorRuntime.awrap(checks.afterLaunch(instruments));

          case 14:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should shutdown' + appendDesc, function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(instruments.shutdown());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  }

  describe('regular timeout', function () {
    test('', { launchTimeout: 60000 });
  });

  describe('smart timeout', function () {
    test('', { launchTimeout: { global: 60000, afterSimLaunch: 10000 } });
  });

  describe.skip("using different tmp dir", function () {
    var _this2 = this;

    var altTmpDir = _path2['default'].resolve(TEMP_DIR, 'abcd');

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.prev = 0;
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(TEMP_DIR));

          case 3:
            context$3$0.next = 7;
            break;

          case 5:
            context$3$0.prev = 5;
            context$3$0.t0 = context$3$0['catch'](0);

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(altTmpDir));

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[0, 5]]);
    });

    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(TEMP_DIR));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    test(" (1)", {
      launchTimeout: { global: 60000, afterSimLaunch: 10000 },
      tmpDir: altTmpDir
    }, {
      afterCreate: function afterCreate(instruments) {
        instruments.tmpDir.should.equal(altTmpDir);
      },
      afterLaunch: function afterLaunch() {
        return _regeneratorRuntime.async(function afterLaunch$(context$3$0) {
          while (1) switch (context$3$0.prev = context$3$0.next) {
            case 0:
              context$3$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(altTmpDir));

            case 2:
              context$3$0.sent.should.be.ok;
              context$3$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].resolve(altTmpDir, 'instrumentscli0.trace')));

            case 5:
              context$3$0.sent.should.be.ok;

            case 6:
            case 'end':
              return context$3$0.stop();
          }
        }, null, _this2);
      }
    });

    //test(" (2)", {
    //launchTimeout: {global: 60000, afterSimLaunch: 10000},
    //tmpDir: altTmpDir
    //}, {
    //afterCreate: function (instruments) { instruments.tmpDir.should.equal(altTmpDir); },
    //afterLaunch: async function () {
    //(await fs.exists(altTmpDir)).should.be.ok;
    //// tmp dir is deleted at startup so trace file is not incremented
    //(await fs.exists(path.resolve(altTmpDir, 'instrumentscli0.trace'))).should.be.ok;
    //}
    //});
  });

  describe.skip("using different trace dir", function () {
    var _this3 = this;

    var altTraceDir = _path2['default'].resolve(TEMP_DIR, 'abcd');

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.prev = 0;
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(TEMP_DIR));

          case 3:
            context$3$0.next = 7;
            break;

          case 5:
            context$3$0.prev = 5;
            context$3$0.t0 = context$3$0['catch'](0);

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(altTraceDir));

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[0, 5]]);
    });

    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(TEMP_DIR));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    test(" (1)", {
      launchTimeout: { global: 60000, afterSimLaunch: 10000 },
      traceDir: altTraceDir
    }, {
      afterCreate: function afterCreate(instruments) {
        instruments.tmpDir.should.equal('/tmp/appium-instruments');
      },
      afterLaunch: function afterLaunch() {
        return _regeneratorRuntime.async(function afterLaunch$(context$3$0) {
          while (1) switch (context$3$0.prev = context$3$0.next) {
            case 0:
              context$3$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(altTraceDir));

            case 2:
              context$3$0.sent.should.be.ok;
              context$3$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].resolve(altTraceDir, 'instrumentscli0.trace')));

            case 5:
              context$3$0.sent.should.be.ok;

            case 6:
            case 'end':
              return context$3$0.stop();
          }
        }, null, _this3);
      }
    });

    test(" (2)", {
      launchTimeout: { global: 60000, afterSimLaunch: 10000 },
      traceDir: altTraceDir
    }, {
      afterCreate: function afterCreate(instruments) {
        instruments.tmpDir.should.equal('/tmp/appium-instruments');
      },
      afterLaunch: function afterLaunch() {
        return _regeneratorRuntime.async(function afterLaunch$(context$3$0) {
          while (1) switch (context$3$0.prev = context$3$0.next) {
            case 0:
              context$3$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(altTraceDir));

            case 2:
              context$3$0.sent.should.be.ok;
              context$3$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].resolve(altTraceDir, 'instrumentscli1.trace')));

            case 5:
              context$3$0.sent.should.be.ok;

            case 6:
            case 'end':
              return context$3$0.stop();
          }
        }, null, _this3);
      }
    });
  });

  describe("shutdown without startup", function () {
    it('should launch', function callee$2$0() {
      var instruments;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(newInstrument({ launchTimeout: 60000 }));

          case 4:
            instruments = context$3$0.sent;
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(instruments.shutdown());

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });

  describe('getting devices', function () {
    var _this4 = this;

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this4);
    });

    it('should get all available devices', function callee$2$0() {
      var iosVer, _ref, stdout, devices;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            iosVer = undefined;
            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['--sdk', 'iphonesimulator', '--show-sdk-version']));

          case 4:
            _ref = context$3$0.sent;
            stdout = _ref.stdout;

            iosVer = parseFloat(stdout);
            context$3$0.next = 11;
            break;

          case 9:
            context$3$0.prev = 9;
            context$3$0.t0 = context$3$0['catch'](1);

          case 11:
            if (_lodash2['default'].isNumber(iosVer) || isNaN(iosVer)) {
              console.warn('Could not get iOS sdk version, skipping test'); // eslint-disable-line no-console
              this.skip();
            }
            context$3$0.next = 14;
            return _regeneratorRuntime.awrap((0, _asyncbox.retry)(3, _libUtils.getAvailableDevices));

          case 14:
            devices = context$3$0.sent;

            if (iosVer >= 7.1) {
              devices.length.should.be.above(0);
              devices.join('\n').should.include('iPhone 6 (8.4');
            } else {
              devices.length.should.equal(0);
            }

          case 16:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[1, 9]]);
    });
  });
});

// travis can't write to /tmp, so let's create a tmp directory

// travis can't write to /tmp, so let's create a tmp directory
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL2Jhc2ljcy1lMmUtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7aUJBRTRCLE9BQU87O29CQUNsQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztvQkFDNUIsTUFBTTs7OztzQkFDVCxRQUFROzs7O2tDQUNZLHNCQUFzQjs7NkJBQ3JDLGdCQUFnQjs7NEJBQ2QsY0FBYzs7d0JBQ0MsaUJBQWlCOzt3QkFDL0IsVUFBVTs7QUFFaEMsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixJQUFJLHNCQUFzQixHQUFHLEtBQUssQ0FBQztBQUNuQyxJQUFJLFFBQVEsR0FBRyxrQkFBSyxPQUFPLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDOztBQUU5QyxRQUFRLENBQUMsbUJBQW1CLEVBQUUsWUFBWTtBQUN4QyxNQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDOztBQUVwQixXQUFlLGFBQWEsQ0FBRSxJQUFJOzs7O0FBQ2hDLDhCQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUU7QUFDYixlQUFHLEVBQUUsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsYUFBYSxDQUFDO0FBQ3ZFLHFCQUFTLEVBQUUsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLGNBQWMsQ0FBQztBQUNsRSxpQ0FBcUIsRUFBRSwwQkFBMEI7V0FDbEQsQ0FBQyxDQUFDOzsyQ0FDVSxlQUFZLGdCQUFnQixDQUFDLElBQUksQ0FBQzs7Ozs7Ozs7OztHQUNoRDs7QUFFRCxXQUFTLElBQUksQ0FBRSxVQUFVLEVBQUUsSUFBSSxFQUFlOzs7UUFBYixNQUFNLHlEQUFHLEVBQUU7O0FBQzFDLFVBQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO0FBQ3RCLFFBQUksV0FBVyxZQUFBLENBQUM7O0FB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QUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDaEM7Ozs7Ozs7S0FDRixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9lMmUvYmFzaWNzLWUyZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgeyBJbnN0cnVtZW50cyB9IGZyb20gJy4uLy4uJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsga2lsbEFsbFNpbXVsYXRvcnMgfSBmcm9tICdhcHBpdW0taW9zLXNpbXVsYXRvcic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZ2V0QXZhaWxhYmxlRGV2aWNlcyB9IGZyb20gJy4uLy4uL2xpYi91dGlscyc7XG5pbXBvcnQgeyByZXRyeSB9IGZyb20gJ2FzeW5jYm94JztcblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxudmFyIExBVU5DSF9IQU5ETEVSX1RJTUVPVVQgPSAxMDAwMDtcbnZhciBURU1QX0RJUiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICd0bXAnKTtcblxuZGVzY3JpYmUoJ2luc3RydW1lbnRzIHRlc3RzJywgZnVuY3Rpb24gKCkge1xuICB0aGlzLnRpbWVvdXQoOTAwMDApO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIG5ld0luc3RydW1lbnQgKG9wdHMpIHtcbiAgICBfLmV4dGVuZChvcHRzLCB7XG4gICAgICBhcHA6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdhc3NldHMnLCAnVGVzdEFwcC5hcHAnKSxcbiAgICAgIGJvb3RzdHJhcDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ2Fzc2V0cycsICdib290c3RyYXAuanMnKSxcbiAgICAgIHNpbXVsYXRvclNka0FuZERldmljZTogJ2lQaG9uZSA2ICg4LjQgU2ltdWxhdG9yKSdcbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgSW5zdHJ1bWVudHMucXVpY2tJbnN0cnVtZW50cyhvcHRzKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHRlc3QgKGFwcGVuZERlc2MsIG9wdHMsIGNoZWNrcyA9IHt9KSB7XG4gICAgY2hlY2tzID0gY2hlY2tzIHx8IHt9O1xuICAgIGxldCBpbnN0cnVtZW50cztcblxuICAgIGl0KGBzaG91bGQgbGF1bmNoJHthcHBlbmREZXNjfWAsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gICAgICBpbnN0cnVtZW50cyA9IGF3YWl0IG5ld0luc3RydW1lbnQob3B0cyk7XG4gICAgICBpZiAoY2hlY2tzLmFmdGVyQ3JlYXRlKXtcbiAgICAgICAgYXdhaXQgY2hlY2tzLmFmdGVyQ3JlYXRlKGluc3RydW1lbnRzKTtcbiAgICAgIH1cbiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoaW5zdHJ1bWVudHMubGF1bmNoUmVzdWx0RGVmZXJyZWQpIHtcbiAgICAgICAgICBpbnN0cnVtZW50cy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgIH0sIExBVU5DSF9IQU5ETEVSX1RJTUVPVVQpO1xuICAgICAgYXdhaXQgaW5zdHJ1bWVudHMubGF1bmNoKCk7XG4gICAgICBpZiAoY2hlY2tzLmFmdGVyTGF1bmNoKSB7XG4gICAgICAgIGF3YWl0IGNoZWNrcy5hZnRlckxhdW5jaChpbnN0cnVtZW50cyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdChgc2hvdWxkIHNodXRkb3duJHthcHBlbmREZXNjfWAsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGluc3RydW1lbnRzLnNodXRkb3duKCk7XG4gICAgfSk7XG4gIH1cblxuICBkZXNjcmliZSgncmVndWxhciB0aW1lb3V0JywgZnVuY3Rpb24gKCkge1xuICAgIHRlc3QoJycsIHtsYXVuY2hUaW1lb3V0OiA2MDAwMH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc21hcnQgdGltZW91dCcsIGZ1bmN0aW9uICgpIHtcbiAgICB0ZXN0KCcnLCB7bGF1bmNoVGltZW91dDoge2dsb2JhbDogNjAwMDAsIGFmdGVyU2ltTGF1bmNoOiAxMDAwMH19KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUuc2tpcChcInVzaW5nIGRpZmZlcmVudCB0bXAgZGlyXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgYWx0VG1wRGlyID0gcGF0aC5yZXNvbHZlKFRFTVBfRElSLCAnYWJjZCcpO1xuXG4gICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIHRyYXZpcyBjYW4ndCB3cml0ZSB0byAvdG1wLCBzbyBsZXQncyBjcmVhdGUgYSB0bXAgZGlyZWN0b3J5XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcy5ta2RpcihURU1QX0RJUik7XG4gICAgICB9IGNhdGNoIChlKSB7fVxuXG4gICAgICBhd2FpdCBmcy5yaW1yYWYoYWx0VG1wRGlyKTtcbiAgICB9KTtcblxuICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZihURU1QX0RJUik7XG4gICAgfSk7XG5cbiAgICB0ZXN0KFwiICgxKVwiLCB7XG4gICAgICBsYXVuY2hUaW1lb3V0OiB7Z2xvYmFsOiA2MDAwMCwgYWZ0ZXJTaW1MYXVuY2g6IDEwMDAwfSxcbiAgICAgIHRtcERpcjogYWx0VG1wRGlyXG4gICAgfSwge1xuICAgICAgYWZ0ZXJDcmVhdGU6IChpbnN0cnVtZW50cykgPT4geyBpbnN0cnVtZW50cy50bXBEaXIuc2hvdWxkLmVxdWFsKGFsdFRtcERpcik7IH0sXG4gICAgICBhZnRlckxhdW5jaDogYXN5bmMgKCkgPT4ge1xuICAgICAgICAoYXdhaXQgZnMuZXhpc3RzKGFsdFRtcERpcikpLnNob3VsZC5iZS5vaztcbiAgICAgICAgKGF3YWl0IGZzLmV4aXN0cyhwYXRoLnJlc29sdmUoYWx0VG1wRGlyLCAnaW5zdHJ1bWVudHNjbGkwLnRyYWNlJykpKS5zaG91bGQuYmUub2s7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvL3Rlc3QoXCIgKDIpXCIsIHtcbiAgICAgIC8vbGF1bmNoVGltZW91dDoge2dsb2JhbDogNjAwMDAsIGFmdGVyU2ltTGF1bmNoOiAxMDAwMH0sXG4gICAgICAvL3RtcERpcjogYWx0VG1wRGlyXG4gICAgLy99LCB7XG4gICAgICAvL2FmdGVyQ3JlYXRlOiBmdW5jdGlvbiAoaW5zdHJ1bWVudHMpIHsgaW5zdHJ1bWVudHMudG1wRGlyLnNob3VsZC5lcXVhbChhbHRUbXBEaXIpOyB9LFxuICAgICAgLy9hZnRlckxhdW5jaDogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAvLyhhd2FpdCBmcy5leGlzdHMoYWx0VG1wRGlyKSkuc2hvdWxkLmJlLm9rO1xuICAgICAgICAvLy8vIHRtcCBkaXIgaXMgZGVsZXRlZCBhdCBzdGFydHVwIHNvIHRyYWNlIGZpbGUgaXMgbm90IGluY3JlbWVudGVkXG4gICAgICAgIC8vKGF3YWl0IGZzLmV4aXN0cyhwYXRoLnJlc29sdmUoYWx0VG1wRGlyLCAnaW5zdHJ1bWVudHNjbGkwLnRyYWNlJykpKS5zaG91bGQuYmUub2s7XG4gICAgICAvL31cbiAgICAvL30pO1xuICB9KTtcblxuICBkZXNjcmliZS5za2lwKFwidXNpbmcgZGlmZmVyZW50IHRyYWNlIGRpclwiLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGFsdFRyYWNlRGlyID0gcGF0aC5yZXNvbHZlKFRFTVBfRElSLCAnYWJjZCcpO1xuXG4gICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIHRyYXZpcyBjYW4ndCB3cml0ZSB0byAvdG1wLCBzbyBsZXQncyBjcmVhdGUgYSB0bXAgZGlyZWN0b3J5XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcy5ta2RpcihURU1QX0RJUik7XG4gICAgICB9IGNhdGNoIChlKSB7fVxuXG4gICAgICBhd2FpdCBmcy5yaW1yYWYoYWx0VHJhY2VEaXIpO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKFRFTVBfRElSKTtcbiAgICB9KTtcblxuICAgIHRlc3QoXCIgKDEpXCIsIHtcbiAgICAgIGxhdW5jaFRpbWVvdXQ6IHtnbG9iYWw6IDYwMDAwLCBhZnRlclNpbUxhdW5jaDogMTAwMDB9LFxuICAgICAgdHJhY2VEaXI6IGFsdFRyYWNlRGlyXG4gICAgfSwge1xuICAgICAgYWZ0ZXJDcmVhdGU6IChpbnN0cnVtZW50cykgPT4ge1xuICAgICAgICBpbnN0cnVtZW50cy50bXBEaXIuc2hvdWxkLmVxdWFsKCcvdG1wL2FwcGl1bS1pbnN0cnVtZW50cycpO1xuICAgICAgfSxcbiAgICAgIGFmdGVyTGF1bmNoOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIChhd2FpdCBmcy5leGlzdHMoYWx0VHJhY2VEaXIpKS5zaG91bGQuYmUub2s7XG4gICAgICAgIChhd2FpdCBmcy5leGlzdHMocGF0aC5yZXNvbHZlKGFsdFRyYWNlRGlyLCAnaW5zdHJ1bWVudHNjbGkwLnRyYWNlJykpKVxuICAgICAgICAgIC5zaG91bGQuYmUub2s7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0ZXN0KFwiICgyKVwiLCB7XG4gICAgICBsYXVuY2hUaW1lb3V0OiB7Z2xvYmFsOiA2MDAwMCwgYWZ0ZXJTaW1MYXVuY2g6IDEwMDAwfSxcbiAgICAgIHRyYWNlRGlyOiBhbHRUcmFjZURpclxuICAgIH0sIHtcbiAgICAgIGFmdGVyQ3JlYXRlOiAoaW5zdHJ1bWVudHMpID0+IHtcbiAgICAgICAgaW5zdHJ1bWVudHMudG1wRGlyLnNob3VsZC5lcXVhbCgnL3RtcC9hcHBpdW0taW5zdHJ1bWVudHMnKTtcbiAgICAgIH0sXG4gICAgICBhZnRlckxhdW5jaDogYXN5bmMgKCkgPT4ge1xuICAgICAgICAoYXdhaXQgZnMuZXhpc3RzKGFsdFRyYWNlRGlyKSkuc2hvdWxkLmJlLm9rO1xuICAgICAgICAoYXdhaXQgZnMuZXhpc3RzKHBhdGgucmVzb2x2ZShhbHRUcmFjZURpciwgJ2luc3RydW1lbnRzY2xpMS50cmFjZScpKSlcbiAgICAgICAgICAuc2hvdWxkLmJlLm9rO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZShcInNodXRkb3duIHdpdGhvdXQgc3RhcnR1cFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCBsYXVuY2gnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBraWxsQWxsU2ltdWxhdG9ycygpO1xuICAgICAgbGV0IGluc3RydW1lbnRzID0gYXdhaXQgbmV3SW5zdHJ1bWVudCh7bGF1bmNoVGltZW91dDogNjAwMDB9KTtcbiAgICAgIGF3YWl0IGluc3RydW1lbnRzLnNodXRkb3duKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXR0aW5nIGRldmljZXMnLCBmdW5jdGlvbiAoKSB7XG4gICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdldCBhbGwgYXZhaWxhYmxlIGRldmljZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW9zVmVyO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygneGNydW4nLCBbJy0tc2RrJywgJ2lwaG9uZXNpbXVsYXRvcicsICctLXNob3ctc2RrLXZlcnNpb24nXSk7XG4gICAgICAgIGlvc1ZlciA9IHBhcnNlRmxvYXQoc3Rkb3V0KTtcbiAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgIGlmIChfLmlzTnVtYmVyKGlvc1ZlcikgfHwgaXNOYU4oaW9zVmVyKSkge1xuICAgICAgICBjb25zb2xlLndhcm4oJ0NvdWxkIG5vdCBnZXQgaU9TIHNkayB2ZXJzaW9uLCBza2lwcGluZyB0ZXN0Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICAgICAgICB0aGlzLnNraXAoKTtcbiAgICAgIH1cbiAgICAgIGxldCBkZXZpY2VzID0gYXdhaXQgcmV0cnkoMywgZ2V0QXZhaWxhYmxlRGV2aWNlcyk7XG4gICAgICBpZiAoaW9zVmVyID49IDcuMSkge1xuICAgICAgICBkZXZpY2VzLmxlbmd0aC5zaG91bGQuYmUuYWJvdmUoMCk7XG4gICAgICAgIGRldmljZXMuam9pbignXFxuJykuc2hvdWxkLmluY2x1ZGUoJ2lQaG9uZSA2ICg4LjQnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRldmljZXMubGVuZ3RoLnNob3VsZC5lcXVhbCgwKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==