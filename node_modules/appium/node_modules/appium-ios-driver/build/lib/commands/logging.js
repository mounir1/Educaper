'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumIosLog = require('appium-ios-log');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var commands = {},
    helpers = {},
    extensions = {};

var SUPPORTED_LOG_TYPES = {
  'syslog': 'System Logs - Device logs for iOS applications on real devices and simulators',
  'crashlog': 'Crash Logs - Crash reports for iOS applications on real devices and simulators',
  'performance': 'Performance Logs - Debug Timelines on real devices and simulators'
};

commands.getLogTypes = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Retrieving supported log types');
        return context$1$0.abrupt('return', _lodash2['default'].keys(SUPPORTED_LOG_TYPES));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getLog = function callee$0$0(logType) {
  var logs;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Retrieving \'' + logType + '\' logs');
        // Check if passed logType is supported

        if (_lodash2['default'].has(SUPPORTED_LOG_TYPES, logType)) {
          context$1$0.next = 3;
          break;
        }

        throw new Error('Unsupported log type \'' + logType + '\' for this device. Supported types : ' + JSON.stringify(SUPPORTED_LOG_TYPES));

      case 3:
        if (!_lodash2['default'].isEmpty(this.logs)) {
          context$1$0.next = 5;
          break;
        }

        throw new Error('No logs currently available. Is the device/simulator started?');

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.logs[logType].getLogs());

      case 7:
        logs = context$1$0.sent;

        if (!logs) {
          context$1$0.next = 12;
          break;
        }

        return context$1$0.abrupt('return', logs);

      case 12:
        throw new Error('No logs of type \'' + logType + '\' found.');

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.startLogCapture = function callee$0$0(sim) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (_lodash2['default'].isEmpty(this.logs)) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].warn("Trying to start iOS log capture but it's already started!");
        return context$1$0.abrupt('return');

      case 3:
        this.logs.crashlog = new _appiumIosLog.IOSCrashLog();
        this.logs.syslog = new _appiumIosLog.IOSLog({
          sim: sim,
          udid: this.opts.udid,
          showLogs: this.opts.showIOSLog
        });
        context$1$0.prev = 5;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.logs.syslog.startCapture());

      case 8:
        context$1$0.next = 14;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](5);

        _logger2['default'].warn("Could not capture logs from device. Continuing without capturing logs.");
        return context$1$0.abrupt('return');

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.logs.crashlog.startCapture());

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[5, 10]]);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports.SUPPORTED_LOG_TYPES = SUPPORTED_LOG_TYPES;
exports['default'] = extensions;

// make sure that we have logs at all
// otherwise it's not been initialized

// If logs captured successfully send response with data, else send error
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2dnaW5nLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQkFBYyxRQUFROzs7OzRCQUNjLGdCQUFnQjs7c0JBQ2pDLFdBQVc7Ozs7QUFFOUIsSUFBSSxRQUFRLEdBQUcsRUFBRTtJQUFFLE9BQU8sR0FBRyxFQUFFO0lBQUUsVUFBVSxHQUFHLEVBQUUsQ0FBQzs7QUFFakQsSUFBTSxtQkFBbUIsR0FBRztBQUMxQixVQUFRLEVBQUUsK0VBQStFO0FBQ3pGLFlBQVUsRUFBRSxnRkFBZ0Y7QUFDNUYsZUFBYSxFQUFFLG1FQUFtRTtDQUNuRixDQUFDOztBQUVGLFFBQVEsQ0FBQyxXQUFXLEdBQUc7Ozs7QUFDckIsNEJBQU8sS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7NENBQ3hDLG9CQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQzs7Ozs7OztDQUNuQyxDQUFDOztBQUVGLFFBQVEsQ0FBQyxNQUFNLEdBQUcsb0JBQWdCLE9BQU87TUFjbkMsSUFBSTs7OztBQWJSLDRCQUFPLEtBQUssbUJBQWdCLE9BQU8sYUFBUyxDQUFDOzs7WUFFeEMsb0JBQUUsR0FBRyxDQUFDLG1CQUFtQixFQUFFLE9BQU8sQ0FBQzs7Ozs7Y0FDaEMsSUFBSSxLQUFLLDZCQUEwQixPQUFPLDhDQUF3QyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUc7OzthQUs1SCxvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzs7Ozs7Y0FDaEIsSUFBSSxLQUFLLENBQUMsK0RBQStELENBQUM7Ozs7eUNBSWpFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFOzs7QUFBekMsWUFBSTs7YUFDSixJQUFJOzs7Ozs0Q0FDQyxJQUFJOzs7Y0FFTCxJQUFJLEtBQUssd0JBQXFCLE9BQU8sZUFBVzs7Ozs7OztDQUV6RCxDQUFDOztBQUVGLE9BQU8sQ0FBQyxlQUFlLEdBQUcsb0JBQWdCLEdBQUc7Ozs7WUFDdEMsb0JBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7Ozs7O0FBQ3ZCLDRCQUFPLElBQUksQ0FBQywyREFBMkQsQ0FBQyxDQUFDOzs7O0FBRzNFLFlBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLCtCQUFpQixDQUFDO0FBQ3ZDLFlBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLHlCQUFXO0FBQzVCLGFBQUcsRUFBSCxHQUFHO0FBQ0gsY0FBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTtBQUNwQixrQkFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVTtTQUMvQixDQUFDLENBQUM7Ozt5Q0FFSyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7Ozs7Ozs7Ozs7QUFFckMsNEJBQU8sSUFBSSxDQUFDLHdFQUF3RSxDQUFDLENBQUM7Ozs7O3lDQUdsRixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUU7Ozs7Ozs7Q0FDeEMsQ0FBQzs7QUFHRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztRQUFFLG1CQUFtQixHQUFuQixtQkFBbUI7cUJBQ2hDLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2xvZ2dpbmcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgSU9TTG9nLCBJT1NDcmFzaExvZyB9IGZyb20gJ2FwcGl1bS1pb3MtbG9nJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBTVVBQT1JURURfTE9HX1RZUEVTID0ge1xuICAnc3lzbG9nJzogJ1N5c3RlbSBMb2dzIC0gRGV2aWNlIGxvZ3MgZm9yIGlPUyBhcHBsaWNhdGlvbnMgb24gcmVhbCBkZXZpY2VzIGFuZCBzaW11bGF0b3JzJyxcbiAgJ2NyYXNobG9nJzogJ0NyYXNoIExvZ3MgLSBDcmFzaCByZXBvcnRzIGZvciBpT1MgYXBwbGljYXRpb25zIG9uIHJlYWwgZGV2aWNlcyBhbmQgc2ltdWxhdG9ycycsXG4gICdwZXJmb3JtYW5jZSc6ICdQZXJmb3JtYW5jZSBMb2dzIC0gRGVidWcgVGltZWxpbmVzIG9uIHJlYWwgZGV2aWNlcyBhbmQgc2ltdWxhdG9ycydcbn07XG5cbmNvbW1hbmRzLmdldExvZ1R5cGVzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsb2dnZXIuZGVidWcoJ1JldHJpZXZpbmcgc3VwcG9ydGVkIGxvZyB0eXBlcycpO1xuICByZXR1cm4gXy5rZXlzKFNVUFBPUlRFRF9MT0dfVFlQRVMpO1xufTtcblxuY29tbWFuZHMuZ2V0TG9nID0gYXN5bmMgZnVuY3Rpb24gKGxvZ1R5cGUpIHtcbiAgbG9nZ2VyLmRlYnVnKGBSZXRyaWV2aW5nICcke2xvZ1R5cGV9JyBsb2dzYCk7XG4gIC8vIENoZWNrIGlmIHBhc3NlZCBsb2dUeXBlIGlzIHN1cHBvcnRlZFxuICBpZiAoIV8uaGFzKFNVUFBPUlRFRF9MT0dfVFlQRVMsIGxvZ1R5cGUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBsb2cgdHlwZSAnJHtsb2dUeXBlfScgZm9yIHRoaXMgZGV2aWNlLiBTdXBwb3J0ZWQgdHlwZXMgOiAke0pTT04uc3RyaW5naWZ5KFNVUFBPUlRFRF9MT0dfVFlQRVMpfWApO1xuICB9XG5cbiAgLy8gbWFrZSBzdXJlIHRoYXQgd2UgaGF2ZSBsb2dzIGF0IGFsbFxuICAvLyBvdGhlcndpc2UgaXQncyBub3QgYmVlbiBpbml0aWFsaXplZFxuICBpZiAoXy5pc0VtcHR5KHRoaXMubG9ncykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGxvZ3MgY3VycmVudGx5IGF2YWlsYWJsZS4gSXMgdGhlIGRldmljZS9zaW11bGF0b3Igc3RhcnRlZD8nKTtcbiAgfVxuXG4gIC8vIElmIGxvZ3MgY2FwdHVyZWQgc3VjY2Vzc2Z1bGx5IHNlbmQgcmVzcG9uc2Ugd2l0aCBkYXRhLCBlbHNlIHNlbmQgZXJyb3JcbiAgbGV0IGxvZ3MgPSBhd2FpdCB0aGlzLmxvZ3NbbG9nVHlwZV0uZ2V0TG9ncygpO1xuICBpZiAobG9ncykge1xuICAgIHJldHVybiBsb2dzO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgTm8gbG9ncyBvZiB0eXBlICcke2xvZ1R5cGV9JyBmb3VuZC5gKTtcbiAgfVxufTtcblxuaGVscGVycy5zdGFydExvZ0NhcHR1cmUgPSBhc3luYyBmdW5jdGlvbiAoc2ltKSB7XG4gIGlmICghXy5pc0VtcHR5KHRoaXMubG9ncykpIHtcbiAgICBsb2dnZXIud2FybihcIlRyeWluZyB0byBzdGFydCBpT1MgbG9nIGNhcHR1cmUgYnV0IGl0J3MgYWxyZWFkeSBzdGFydGVkIVwiKTtcbiAgICByZXR1cm47XG4gIH1cbiAgdGhpcy5sb2dzLmNyYXNobG9nID0gbmV3IElPU0NyYXNoTG9nKCk7XG4gIHRoaXMubG9ncy5zeXNsb2cgPSBuZXcgSU9TTG9nKHtcbiAgICBzaW0sXG4gICAgdWRpZDogdGhpcy5vcHRzLnVkaWRcbiAgLCBzaG93TG9nczogdGhpcy5vcHRzLnNob3dJT1NMb2dcbiAgfSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5sb2dzLnN5c2xvZy5zdGFydENhcHR1cmUoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLndhcm4oXCJDb3VsZCBub3QgY2FwdHVyZSBsb2dzIGZyb20gZGV2aWNlLiBDb250aW51aW5nIHdpdGhvdXQgY2FwdHVyaW5nIGxvZ3MuXCIpO1xuICAgIHJldHVybjtcbiAgfVxuICBhd2FpdCB0aGlzLmxvZ3MuY3Jhc2hsb2cuc3RhcnRDYXB0dXJlKCk7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMsIFNVUFBPUlRFRF9MT0dfVFlQRVMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
