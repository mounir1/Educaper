require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _libCertificate = require('../../lib/certificate');

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _uuid = require('uuid');

var _uuid2 = _interopRequireDefault(_uuid);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);
var expect = _chai2['default'].expect;

var cwd = process.cwd();
var assetsDir = cwd + '/test/assets';
var keychainsDir = assetsDir + '/Library/Keychains';
var keychainsDirOriginal = undefined;
var certificate = undefined;
var trustStore = undefined;
var testUUID = undefined;

describe('when using TrustStore class', function () {

  beforeEach(function () {
    keychainsDirOriginal = assetsDir + '/Library/Keychains-Original';
    _fsExtra2['default'].emptyDirSync(keychainsDir);
    _fsExtra2['default'].copySync(keychainsDirOriginal, keychainsDir);
    trustStore = new _libCertificate.TrustStore(assetsDir);
    testUUID = _uuid2['default'].v4();
  });

  it('can add a record to the TrustStore tsettings', function callee$1$0() {
    var tsettings;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 2:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length.of(0);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data'));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 8:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length.above(0);
          tsettings[0].subj.should.equal(testUUID);

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add and remove records to in TrustStore tsettings', function callee$1$0() {
    var tsettings;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data'));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 4:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length.above(0);
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(trustStore.removeRecord(testUUID));

        case 8:
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 10:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length(0);

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can update a record in the TrustStore tsettings', function callee$1$0() {
    var tsettings;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data1'));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 4:
          tsettings = context$2$0.sent;

          expect(tsettings[0].data).to.equal('data1');
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data2'));

        case 8:
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 10:
          tsettings = context$2$0.sent;

          expect(tsettings[0].data).to.equal('data2');

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

describe('when using Certificate class', function () {

  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(new _libCertificate.Certificate(assetsDir + '/test-pem.pem'));

        case 2:
          certificate = context$2$0.sent;

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can translate PEM certificate to DER format', function callee$1$0() {
    var derData, testData;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.getDerData());

        case 2:
          derData = context$2$0.sent;
          testData = _fsExtra2['default'].readFileSync(assetsDir + '/Library/certificates/test-data.txt');

          expect(testData.equals(derData));

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can get a fingerprint from a PEM certificate', function callee$1$0() {
    var fingerprint, testFingerprint;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.getFingerPrint());

        case 2:
          fingerprint = context$2$0.sent;
          testFingerprint = _fsExtra2['default'].readFileSync(assetsDir + '/Library/certificates/test-fingerprint.txt');

          expect(fingerprint.equals(testFingerprint));

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can get a subject from a PEM certificate', function callee$1$0() {
    var subject, testSubject;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.getSubject(assetsDir + '/test-pem.pem'));

        case 2:
          subject = context$2$0.sent;
          testSubject = _fsExtra2['default'].readFileSync(assetsDir + '/Library/certificates/test-subj.txt', 'utf-8');

          expect(subject).to.equal(testSubject);

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add a certificate to a sqlite store', function callee$1$0() {
    var hasCert;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.add(assetsDir));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 4:
          hasCert = context$2$0.sent;

          expect(hasCert);

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add and remove a certificate to a sqlite store', function callee$1$0() {
    var hasCert;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.add(assetsDir));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 4:
          hasCert = context$2$0.sent;

          expect(hasCert);
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(certificate.remove(assetsDir));

        case 8:
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 10:
          hasCert = context$2$0.sent;

          expect(!hasCert);

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add a certificate and then remove the same certificate later', function callee$1$0() {
    var hasCert;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.add(assetsDir));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 4:
          hasCert = context$2$0.sent;

          expect(hasCert);

          certificate = new _libCertificate.Certificate(assetsDir + '/test-pem.pem');
          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(certificate.remove(assetsDir));

        case 9:
          context$2$0.next = 11;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 11:
          hasCert = context$2$0.sent;

          expect(!hasCert);

        case 13:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9jZXJ0aWZpY2F0ZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O29CQUVpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7Ozs4QkFDTCx1QkFBdUI7O3VCQUMvQyxVQUFVOzs7O29CQUNULE1BQU07Ozs7QUFFdkIsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDO0FBQ3pCLElBQUksTUFBTSxHQUFHLGtCQUFLLE1BQU0sQ0FBQzs7QUFFekIsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3hCLElBQUksU0FBUyxHQUFNLEdBQUcsaUJBQWMsQ0FBQztBQUNyQyxJQUFJLFlBQVksR0FBTSxTQUFTLHVCQUFvQixDQUFDO0FBQ3BELElBQUksb0JBQW9CLFlBQUEsQ0FBQztBQUN6QixJQUFJLFdBQVcsWUFBQSxDQUFDO0FBQ2hCLElBQUksVUFBVSxZQUFBLENBQUM7QUFDZixJQUFJLFFBQVEsWUFBQSxDQUFDOztBQUViLFFBQVEsQ0FBQyw2QkFBNkIsRUFBRSxZQUFNOztBQUU1QyxZQUFVLENBQUMsWUFBTTtBQUNmLHdCQUFvQixHQUFNLFNBQVMsZ0NBQTZCLENBQUM7QUFDakUseUJBQUksWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQy9CLHlCQUFJLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNqRCxjQUFVLEdBQUcsK0JBQWUsU0FBUyxDQUFDLENBQUM7QUFDdkMsWUFBUSxHQUFHLGtCQUFLLEVBQUUsRUFBRSxDQUFDO0dBQ3RCLENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsOENBQThDLEVBQUU7UUFDN0MsU0FBUzs7Ozs7MkNBQVMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUM7OztBQUFqRCxtQkFBUzs7QUFDYixnQkFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxD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QUFDOzs7OzJDQUNaLFdBQVcsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDOzs7QUFBMUMsaUJBQU87O0FBQ1gsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQzs7QUFFaEIscUJBQVcsR0FBRyxnQ0FBbUIsU0FBUyxtQkFBZ0IsQ0FBQzs7MkNBQ3JELFdBQVcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDOzs7OzJDQUNuQixXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQzs7O0FBQTFDLGlCQUFPOztBQUNQLGdCQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQzs7Ozs7OztHQUNsQixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC91bml0L2NlcnRpZmljYXRlLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHsgQ2VydGlmaWNhdGUsIFRydXN0U3RvcmUgfSBmcm9tICcuLi8uLi9saWIvY2VydGlmaWNhdGUnO1xuaW1wb3J0IGZzZSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgdXVpZCBmcm9tICd1dWlkJztcblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcbmxldCBleHBlY3QgPSBjaGFpLmV4cGVjdDtcblxubGV0IGN3ZCA9IHByb2Nlc3MuY3dkKCk7XG5sZXQgYXNzZXRzRGlyID0gYCR7Y3dkfS90ZXN0L2Fzc2V0c2A7XG5sZXQga2V5Y2hhaW5zRGlyID0gYCR7YXNzZXRzRGlyfS9MaWJyYXJ5L0tleWNoYWluc2A7XG5sZXQga2V5Y2hhaW5zRGlyT3JpZ2luYWw7XG5sZXQgY2VydGlmaWNhdGU7XG5sZXQgdHJ1c3RTdG9yZTtcbmxldCB0ZXN0VVVJRDtcblxuZGVzY3JpYmUoJ3doZW4gdXNpbmcgVHJ1c3RTdG9yZSBjbGFzcycsICgpID0+IHsgXG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAga2V5Y2hhaW5zRGlyT3JpZ2luYWwgPSBgJHthc3NldHNEaXJ9L0xpYnJhcnkvS2V5Y2hhaW5zLU9yaWdpbmFsYDtcbiAgICBmc2UuZW1wdHlEaXJTeW5jKGtleWNoYWluc0Rpcik7XG4gICAgZnNlLmNvcHlTeW5jKGtleWNoYWluc0Rpck9yaWdpbmFsLCBrZXljaGFpbnNEaXIpOyBcbiAgICB0cnVzdFN0b3JlID0gbmV3IFRydXN0U3RvcmUoYXNzZXRzRGlyKTtcbiAgICB0ZXN0VVVJRCA9IHV1aWQudjQoKTtcbiAgfSk7XG5cbiAgaXQoJ2NhbiBhZGQgYSByZWNvcmQgdG8gdGhlIFRydXN0U3RvcmUgdHNldHRpbmdzJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCB0c2V0dGluZ3MgPSBhd2FpdCB0cnVzdFN0b3JlLmdldFJlY29yZHModGVzdFVVSUQpO1xuICAgIGV4cGVjdCh0c2V0dGluZ3MpLnRvLmhhdmUubGVuZ3RoLm9mKDApO1xuICAgIGF3YWl0IHRydXN0U3RvcmUuYWRkUmVjb3JkKHV1aWQudjQoKSwgJ3RzZXQnLCB0ZXN0VVVJRCwgJ2RhdGEnKTtcbiAgICB0c2V0dGluZ3MgPSBhd2FpdCB0cnVzdFN0b3JlLmdldFJlY29yZHModGVzdFVVSUQpOyBcbiAgICBleHBlY3QodHNldHRpbmdzKS50by5oYXZlLmxlbmd0aC5hYm92ZSgwKTtcbiAgICB0c2V0dGluZ3NbMF0uc3Viai5zaG91bGQuZXF1YWwodGVzdFVVSUQpO1xuICB9KTtcblxuICBpdCgnY2FuIGFkZCBhbmQgcmVtb3ZlIHJlY29yZHMgdG8gaW4gVHJ1c3RTdG9yZSB0c2V0dGluZ3MnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdHJ1c3RTdG9yZS5hZGRSZWNvcmQodXVpZC52NCgpLCAndHNldCcsIHRlc3RVVUlELCAnZGF0YScpO1xuICAgIGxldCB0c2V0dGluZ3MgPSBhd2FpdCB0cnVzdFN0b3JlLmdldFJlY29yZHModGVzdFVVSUQpO1xuICAgIGV4cGVjdCh0c2V0dGluZ3MpLnRvLmhhdmUubGVuZ3RoLmFib3ZlKDApO1xuICAgIGF3YWl0IHRydXN0U3RvcmUucmVtb3ZlUmVjb3JkKHRlc3RVVUlEKTtcbiAgICB0c2V0dGluZ3MgPSBhd2FpdCB0cnVzdFN0b3JlLmdldFJlY29yZHModGVzdFVVSUQpO1xuICAgIGV4cGVjdCh0c2V0dGluZ3MpLnRvLmhhdmUubGVuZ3RoKDApOyBcbiAgfSk7XG5cbiAgaXQoJ2NhbiB1cGRhdGUgYSByZWNvcmQgaW4gdGhlIFRydXN0U3RvcmUgdHNldHRpbmdzJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRydXN0U3RvcmUuYWRkUmVjb3JkKHV1aWQudjQoKSwgJ3RzZXQnLCB0ZXN0VVVJRCwgJ2RhdGExJyk7XG4gICAgbGV0IHRzZXR0aW5ncyA9IGF3YWl0IHRydXN0U3RvcmUuZ2V0UmVjb3Jkcyh0ZXN0VVVJRCk7XG4gICAgZXhwZWN0KHRzZXR0aW5nc1swXS5kYXRhKS50by5lcXVhbCgnZGF0YTEnKTtcbiAgICBhd2FpdCB0cnVzdFN0b3JlLmFkZFJlY29yZCh1dWlkLnY0KCksICd0c2V0JywgdGVzdFVVSUQsICdkYXRhMicpO1xuICAgIHRzZXR0aW5ncyA9IGF3YWl0IHRydXN0U3RvcmUuZ2V0UmVjb3Jkcyh0ZXN0VVVJRCk7XG4gICAgZXhwZWN0KHRzZXR0aW5nc1swXS5kYXRhKS50by5lcXVhbCgnZGF0YTInKTsgIFxuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnd2hlbiB1c2luZyBDZXJ0aWZpY2F0ZSBjbGFzcycsICgpID0+IHsgXG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY2VydGlmaWNhdGUgPSBhd2FpdCBuZXcgQ2VydGlmaWNhdGUoYCR7YXNzZXRzRGlyfS90ZXN0LXBlbS5wZW1gKTtcbiAgfSk7XG5cbiAgaXQoJ2NhbiB0cmFuc2xhdGUgUEVNIGNlcnRpZmljYXRlIHRvIERFUiBmb3JtYXQnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGRlckRhdGEgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5nZXREZXJEYXRhKCk7XG4gICAgbGV0IHRlc3REYXRhID0gZnNlLnJlYWRGaWxlU3luYyhgJHthc3NldHNEaXJ9L0xpYnJhcnkvY2VydGlmaWNhdGVzL3Rlc3QtZGF0YS50eHRgKTtcbiAgICBleHBlY3QodGVzdERhdGEuZXF1YWxzKGRlckRhdGEpKTsgXG4gIH0pO1xuIFxuICBpdCgnY2FuIGdldCBhIGZpbmdlcnByaW50IGZyb20gYSBQRU0gY2VydGlmaWNhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGZpbmdlcnByaW50ID0gYXdhaXQgY2VydGlmaWNhdGUuZ2V0RmluZ2VyUHJpbnQoKTtcbiAgICBsZXQgdGVzdEZpbmdlcnByaW50ID0gZnNlLnJlYWRGaWxlU3luYyhgJHthc3NldHNEaXJ9L0xpYnJhcnkvY2VydGlmaWNhdGVzL3Rlc3QtZmluZ2VycHJpbnQudHh0YCk7XG4gICAgZXhwZWN0KGZpbmdlcnByaW50LmVxdWFscyh0ZXN0RmluZ2VycHJpbnQpKTsgICBcbiAgfSk7XG5cbiAgaXQoJ2NhbiBnZXQgYSBzdWJqZWN0IGZyb20gYSBQRU0gY2VydGlmaWNhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IHN1YmplY3QgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5nZXRTdWJqZWN0KGAke2Fzc2V0c0Rpcn0vdGVzdC1wZW0ucGVtYCk7XG4gICAgbGV0IHRlc3RTdWJqZWN0ID0gZnNlLnJlYWRGaWxlU3luYyhgJHthc3NldHNEaXJ9L0xpYnJhcnkvY2VydGlmaWNhdGVzL3Rlc3Qtc3Viai50eHRgLCAndXRmLTgnKTtcbiAgICBleHBlY3Qoc3ViamVjdCkudG8uZXF1YWwodGVzdFN1YmplY3QpO1xuICB9KTtcblxuICBpdCgnY2FuIGFkZCBhIGNlcnRpZmljYXRlIHRvIGEgc3FsaXRlIHN0b3JlJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGNlcnRpZmljYXRlLmFkZChhc3NldHNEaXIpO1xuICAgIGxldCBoYXNDZXJ0ID0gYXdhaXQgY2VydGlmaWNhdGUuaGFzKGFzc2V0c0Rpcik7XG4gICAgZXhwZWN0KGhhc0NlcnQpO1xuICB9KTsgIFxuXG4gIGl0KCdjYW4gYWRkIGFuZCByZW1vdmUgYSBjZXJ0aWZpY2F0ZSB0byBhIHNxbGl0ZSBzdG9yZScsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBjZXJ0aWZpY2F0ZS5hZGQoYXNzZXRzRGlyKTtcbiAgICBsZXQgaGFzQ2VydCA9IGF3YWl0IGNlcnRpZmljYXRlLmhhcyhhc3NldHNEaXIpO1xuICAgIGV4cGVjdChoYXNDZXJ0KTtcbiAgICBhd2FpdCBjZXJ0aWZpY2F0ZS5yZW1vdmUoYXNzZXRzRGlyKTtcbiAgICBoYXNDZXJ0ID0gYXdhaXQgY2VydGlmaWNhdGUuaGFzKGFzc2V0c0Rpcik7XG4gICAgZXhwZWN0KCFoYXNDZXJ0KTtcbiAgfSk7XG5cbiAgaXQoJ2NhbiBhZGQgYSBjZXJ0aWZpY2F0ZSBhbmQgdGhlbiByZW1vdmUgdGhlIHNhbWUgY2VydGlmaWNhdGUgbGF0ZXInLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgY2VydGlmaWNhdGUuYWRkKGFzc2V0c0Rpcik7XG4gICAgbGV0IGhhc0NlcnQgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5oYXMoYXNzZXRzRGlyKTtcbiAgICBleHBlY3QoaGFzQ2VydCk7XG5cbiAgICBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZShgJHthc3NldHNEaXJ9L3Rlc3QtcGVtLnBlbWApO1xuICAgIGF3YWl0IGNlcnRpZmljYXRlLnJlbW92ZShhc3NldHNEaXIpO1xuICAgIGhhc0NlcnQgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5oYXMoYXNzZXRzRGlyKTtcbiAgICBleHBlY3QoIWhhc0NlcnQpO1xuICB9KTtcbn0pOyJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
