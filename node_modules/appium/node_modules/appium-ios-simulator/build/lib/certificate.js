'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var sqlite3 = _bluebird2['default'].promisifyAll(require('sqlite3'));
var openssl = _bluebird2['default'].promisify(require('openssl-wrapper').exec);

var tset = '<?xml version="1.0" encoding="UTF-8"?>\n\n    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n    <plist version="1.0">\n    <array/>\n</plist>';

/**
 * Library for programatically adding certificates 
 */

var Certificate = (function () {
  function Certificate(pemFilename) {
    _classCallCheck(this, Certificate);

    this.pemFilename = pemFilename;
  }

  /**
   * Interface for adding and removing records to TrustStore.sqlite3 databases that Keychains use
   */

  /**
   * Add a certificate to the TrustStore
   */

  _createClass(Certificate, [{
    key: 'add',
    value: function add(dir) {
      var data, subject, fingerprint, trustStore;
      return _regeneratorRuntime.async(function add$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getDerData(this.pemFilename));

          case 2:
            data = context$2$0.sent;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 5:
            subject = context$2$0.sent;
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.getFingerPrint(this.data));

          case 8:
            fingerprint = context$2$0.sent;
            trustStore = new TrustStore(dir);
            return context$2$0.abrupt('return', trustStore.addRecord(fingerprint, tset, subject, data));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Checks if keychain at given directory has this certificate
     */
  }, {
    key: 'has',
    value: function has(dir) {
      var subject, trustStore, records;
      return _regeneratorRuntime.async(function has$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 2:
            subject = context$2$0.sent;
            trustStore = new TrustStore(dir);
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(trustStore.getRecords(subject));

          case 6:
            records = context$2$0.sent;
            return context$2$0.abrupt('return', records.length > 0);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Remove certificate from the TrustStore
     */
  }, {
    key: 'remove',
    value: function remove(dir) {
      var subject, trustStore;
      return _regeneratorRuntime.async(function remove$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 2:
            subject = context$2$0.sent;
            trustStore = new TrustStore(dir);
            return context$2$0.abrupt('return', trustStore.removeRecord(subject));

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Translate PEM file to DER buffer
     */
  }, {
    key: 'getDerData',
    value: function getDerData() {
      return _regeneratorRuntime.async(function getDerData$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.data) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.data);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(openssl('x509', {
              outform: 'der',
              'in': this.pemFilename
            }));

          case 4:
            this.data = context$2$0.sent;
            return context$2$0.abrupt('return', this.data);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get SHA1 fingerprint from der data before
     */
  }, {
    key: 'getFingerPrint',
    value: function getFingerPrint() {
      var data, shasum;
      return _regeneratorRuntime.async(function getFingerPrint$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.fingerprint) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.fingerprint);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getDerData());

          case 4:
            data = context$2$0.sent;
            shasum = _crypto2['default'].createHash('sha1');

            shasum.update(data);
            this.fingerprint = shasum.digest();
            return context$2$0.abrupt('return', this.fingerprint);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Parse the subject from the der data
     */
  }, {
    key: 'getSubject',
    value: function getSubject() {
      var subject, subRegex;
      return _regeneratorRuntime.async(function getSubject$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.subject) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.subject);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(openssl('x509', {
              noout: true,
              subject: true,
              'in': this.pemFilename
            }));

          case 4:
            subject = context$2$0.sent;
            subRegex = /^subject[\w\W]*\/CN=([\w\W]*)(\n)?/;

            this.subject = subject.toString().match(subRegex)[1];
            return context$2$0.abrupt('return', this.subject);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return Certificate;
})();

var TrustStore = (function () {
  function TrustStore(sharedResourceDir) {
    _classCallCheck(this, TrustStore);

    this.sqliteDBPath = _path2['default'].resolve(sharedResourceDir, 'Library/Keychains/TrustStore.sqlite3');
    this.db = new sqlite3.Database(this.sqliteDBPath);
  }

  /**
   * Add record to tsettings
   */

  _createClass(TrustStore, [{
    key: 'addRecord',
    value: function addRecord(sha1, tset, subj, data) {
      var existingRecords;
      return _regeneratorRuntime.async(function addRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getRecords(subj));

          case 2:
            existingRecords = context$2$0.sent;

            if (!(existingRecords.length > 0)) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.db.runAsync('UPDATE tsettings SET sha1=?, tset=?, data=? WHERE subj=?', [sha1, tset, data, subj]));

          case 6:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.db.runAsync('INSERT INTO tsettings (sha1, subj, tset, data) VALUES (?, ?, ?, ?)', [sha1, subj, tset, data]));

          case 11:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Remove record from tsettings
     */
  }, {
    key: 'removeRecord',
    value: function removeRecord(subj) {
      return _regeneratorRuntime.async(function removeRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', this.db.runAsync('DELETE FROM tsettings WHERE subj = ?', [subj]));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get a record from tsettings
     */
  }, {
    key: 'getRecords',
    value: function getRecords(subj) {
      return _regeneratorRuntime.async(function getRecords$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', this.db.allAsync('SELECT * FROM tsettings WHERE subj = ?', [subj]));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return TrustStore;
})();

exports['default'] = Certificate;
exports.Certificate = Certificate;
exports.TrustStore = TrustStore;

// Convert 'pem' file to 'der'

// Convert 'pem' file to 'der'
//# sourceMappingURL=data:application/json;charset=utf8;base64,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ZixJQUFJLENBQUMsRUFBRSxDQUFDLFFBQVEseUNBQXlDLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7Ozs7S0FDeEU7Ozs7Ozs7V0FLZ0Isb0JBQUMsSUFBSTs7OztnREFDYixJQUFJLENBQUMsRUFBRSxDQUFDLFFBQVEsMkNBQTJDLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7Ozs7S0FDMUU7OztTQTlCRyxVQUFVOzs7cUJBaUNELFdBQVc7UUFDakIsV0FBVyxHQUFYLFdBQVc7UUFBRSxVQUFVLEdBQVYsVUFBVSIsImZpbGUiOiJsaWIvY2VydGlmaWNhdGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuY29uc3Qgc3FsaXRlMyA9IEIucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ3NxbGl0ZTMnKSk7XG5jb25zdCBvcGVuc3NsID0gQi5wcm9taXNpZnkocmVxdWlyZSgnb3BlbnNzbC13cmFwcGVyJykuZXhlYyk7XG5cbmxldCB0c2V0ID0gYDw/eG1sIHZlcnNpb249XFxcIjEuMFxcXCIgZW5jb2Rpbmc9XFxcIlVURi04XFxcIj8+XFxuXG4gICAgPCFET0NUWVBFIHBsaXN0IFBVQkxJQyBcXFwiLS8vQXBwbGUvL0RURCBQTElTVCAxLjAvL0VOXFxcIiBcXFwiaHR0cDovL3d3dy5hcHBsZS5jb20vRFREcy9Qcm9wZXJ0eUxpc3QtMS4wLmR0ZFxcXCI+XG4gICAgPHBsaXN0IHZlcnNpb249XFxcIjEuMFxcXCI+XG4gICAgPGFycmF5Lz5cbjwvcGxpc3Q+YDtcblxuLyoqXG4gKiBMaWJyYXJ5IGZvciBwcm9ncmFtYXRpY2FsbHkgYWRkaW5nIGNlcnRpZmljYXRlcyBcbiAqL1xuY2xhc3MgQ2VydGlmaWNhdGUge1xuXG4gIGNvbnN0cnVjdG9yIChwZW1GaWxlbmFtZSkgeyBcbiAgICB0aGlzLnBlbUZpbGVuYW1lID0gcGVtRmlsZW5hbWU7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgY2VydGlmaWNhdGUgdG8gdGhlIFRydXN0U3RvcmVcbiAgICovXG4gIGFzeW5jIGFkZCAoZGlyKSB7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCB0aGlzLmdldERlckRhdGEodGhpcy5wZW1GaWxlbmFtZSk7XG4gICAgbGV0IHN1YmplY3QgPSBhd2FpdCB0aGlzLmdldFN1YmplY3QodGhpcy5wZW1GaWxlbmFtZSk7XG4gICAgbGV0IGZpbmdlcnByaW50ID0gYXdhaXQgdGhpcy5nZXRGaW5nZXJQcmludCh0aGlzLmRhdGEpO1xuXG4gICAgbGV0IHRydXN0U3RvcmUgPSBuZXcgVHJ1c3RTdG9yZShkaXIpO1xuICAgIHJldHVybiB0cnVzdFN0b3JlLmFkZFJlY29yZChmaW5nZXJwcmludCwgdHNldCwgc3ViamVjdCwgZGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGtleWNoYWluIGF0IGdpdmVuIGRpcmVjdG9yeSBoYXMgdGhpcyBjZXJ0aWZpY2F0ZVxuICAgKi9cbiAgYXN5bmMgaGFzIChkaXIpIHtcbiAgICBsZXQgc3ViamVjdCA9IGF3YWl0IHRoaXMuZ2V0U3ViamVjdCh0aGlzLnBlbUZpbGVuYW1lKTtcblxuICAgIGxldCB0cnVzdFN0b3JlID0gbmV3IFRydXN0U3RvcmUoZGlyKTtcbiAgICBsZXQgcmVjb3JkcyA9IGF3YWl0IHRydXN0U3RvcmUuZ2V0UmVjb3JkcyhzdWJqZWN0KTtcbiAgICByZXR1cm4gcmVjb3Jkcy5sZW5ndGggPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBjZXJ0aWZpY2F0ZSBmcm9tIHRoZSBUcnVzdFN0b3JlXG4gICAqL1xuICBhc3luYyByZW1vdmUgKGRpcikgeyBcbiAgICBsZXQgc3ViamVjdCA9IGF3YWl0IHRoaXMuZ2V0U3ViamVjdCh0aGlzLnBlbUZpbGVuYW1lKTtcbiAgICBsZXQgdHJ1c3RTdG9yZSA9IG5ldyBUcnVzdFN0b3JlKGRpcik7XG4gICAgcmV0dXJuIHRydXN0U3RvcmUucmVtb3ZlUmVjb3JkKHN1YmplY3QpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zbGF0ZSBQRU0gZmlsZSB0byBERVIgYnVmZmVyXG4gICAqL1xuICBhc3luYyBnZXREZXJEYXRhICgpIHtcbiAgICBpZiAodGhpcy5kYXRhKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgJ3BlbScgZmlsZSB0byAnZGVyJ1xuICAgIHRoaXMuZGF0YSA9IGF3YWl0IG9wZW5zc2woJ3g1MDknLCB7IFxuICAgICAgb3V0Zm9ybTogJ2RlcicsXG4gICAgICBpbjogdGhpcy5wZW1GaWxlbmFtZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgU0hBMSBmaW5nZXJwcmludCBmcm9tIGRlciBkYXRhIGJlZm9yZVxuICAgKi9cbiAgYXN5bmMgZ2V0RmluZ2VyUHJpbnQgKCkge1xuICAgIGlmICh0aGlzLmZpbmdlcnByaW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5maW5nZXJwcmludDtcbiAgICB9XG5cbiAgICBsZXQgZGF0YSA9IGF3YWl0IHRoaXMuZ2V0RGVyRGF0YSgpO1xuICAgIGxldCBzaGFzdW0gPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpO1xuICAgIHNoYXN1bS51cGRhdGUoZGF0YSk7XG4gICAgdGhpcy5maW5nZXJwcmludCA9IHNoYXN1bS5kaWdlc3QoKTtcbiAgICByZXR1cm4gdGhpcy5maW5nZXJwcmludDtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSB0aGUgc3ViamVjdCBmcm9tIHRoZSBkZXIgZGF0YVxuICAgKi9cbiAgYXN5bmMgZ2V0U3ViamVjdCAoKSB7XG4gICAgaWYgKHRoaXMuc3ViamVjdCkge1xuICAgICAgcmV0dXJuIHRoaXMuc3ViamVjdDtcbiAgICB9XG4gICAgICBcbiAgICAvLyBDb252ZXJ0ICdwZW0nIGZpbGUgdG8gJ2RlcidcbiAgICBsZXQgc3ViamVjdCA9IGF3YWl0IG9wZW5zc2woJ3g1MDknLCB7XG4gICAgICBub291dDogdHJ1ZSxcbiAgICAgIHN1YmplY3Q6IHRydWUsXG4gICAgICBpbjogdGhpcy5wZW1GaWxlbmFtZVxuICAgIH0pO1xuICAgIGxldCBzdWJSZWdleCA9IC9ec3ViamVjdFtcXHdcXFddKlxcL0NOPShbXFx3XFxXXSopKFxcbik/LztcbiAgICB0aGlzLnN1YmplY3QgPSBzdWJqZWN0LnRvU3RyaW5nKCkubWF0Y2goc3ViUmVnZXgpWzFdOyBcbiAgICByZXR1cm4gdGhpcy5zdWJqZWN0O1xuICB9XG5cbn1cblxuLyoqXG4gKiBJbnRlcmZhY2UgZm9yIGFkZGluZyBhbmQgcmVtb3ZpbmcgcmVjb3JkcyB0byBUcnVzdFN0b3JlLnNxbGl0ZTMgZGF0YWJhc2VzIHRoYXQgS2V5Y2hhaW5zIHVzZVxuICovXG5jbGFzcyBUcnVzdFN0b3JlIHtcbiAgY29uc3RydWN0b3IgKHNoYXJlZFJlc291cmNlRGlyKSB7XG4gICAgdGhpcy5zcWxpdGVEQlBhdGggPSBwYXRoLnJlc29sdmUoc2hhcmVkUmVzb3VyY2VEaXIsICdMaWJyYXJ5L0tleWNoYWlucy9UcnVzdFN0b3JlLnNxbGl0ZTMnKTtcbiAgICB0aGlzLmRiID0gbmV3IHNxbGl0ZTMuRGF0YWJhc2UodGhpcy5zcWxpdGVEQlBhdGgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCByZWNvcmQgdG8gdHNldHRpbmdzXG4gICAqL1xuICBhc3luYyBhZGRSZWNvcmQgKHNoYTEsIHRzZXQsIHN1YmosIGRhdGEpIHtcbiAgICBsZXQgZXhpc3RpbmdSZWNvcmRzID0gYXdhaXQgdGhpcy5nZXRSZWNvcmRzKHN1YmopO1xuICAgIGlmIChleGlzdGluZ1JlY29yZHMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZGIucnVuQXN5bmMoYFVQREFURSB0c2V0dGluZ3MgU0VUIHNoYTE9PywgdHNldD0/LCBkYXRhPT8gV0hFUkUgc3Viaj0/YCwgW3NoYTEsIHRzZXQsIGRhdGEsIHN1YmpdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZGIucnVuQXN5bmMoYElOU0VSVCBJTlRPIHRzZXR0aW5ncyAoc2hhMSwgc3ViaiwgdHNldCwgZGF0YSkgVkFMVUVTICg/LCA/LCA/LCA/KWAsIFtzaGExLCBzdWJqLCB0c2V0LCBkYXRhXSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSByZWNvcmQgZnJvbSB0c2V0dGluZ3NcbiAgICovXG4gIGFzeW5jIHJlbW92ZVJlY29yZCAoc3Viaikge1xuICAgIHJldHVybiB0aGlzLmRiLnJ1bkFzeW5jKGBERUxFVEUgRlJPTSB0c2V0dGluZ3MgV0hFUkUgc3ViaiA9ID9gLCBbc3Vial0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHJlY29yZCBmcm9tIHRzZXR0aW5nc1xuICAgKi9cbiAgYXN5bmMgZ2V0UmVjb3JkcyAoc3Viaikge1xuICAgIHJldHVybiB0aGlzLmRiLmFsbEFzeW5jKGBTRUxFQ1QgKiBGUk9NIHRzZXR0aW5ncyBXSEVSRSBzdWJqID0gP2AsIFtzdWJqXSk7XG4gIH0gXG59XG5cbmV4cG9ydCBkZWZhdWx0IENlcnRpZmljYXRlO1xuZXhwb3J0IHsgQ2VydGlmaWNhdGUsIFRydXN0U3RvcmUgfTsgIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
