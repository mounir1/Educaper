'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _nodeSimctl = require('node-simctl');

var simctl = _interopRequireWildcard(_nodeSimctl);

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _utilsJs = require('./utils.js');

var _asyncbox = require('asyncbox');

var _settings = require('./settings');

var settings = _interopRequireWildcard(_settings);

var _teen_process = require('teen_process');

var _tailUntilJs = require('./tail-until.js');

var _extensionsIndex = require('./extensions/index');

var _extensionsIndex2 = _interopRequireDefault(_extensionsIndex);

var OPEN_TIMEOUT = 3000;
var STARTUP_TIMEOUT = 60 * 1000;
var EXTRA_STARTUP_TIME = 2000;

var SimulatorXcode6 = (function () {
  function SimulatorXcode6(udid, xcodeVersion) {
    _classCallCheck(this, SimulatorXcode6);

    this.udid = String(udid);
    this.xcodeVersion = xcodeVersion;

    // platformVersion cannot be found initially, since getting it has side effects for
    // our logic for figuring out if a sim has been run
    // it will be set when it is needed
    this._platformVersion = null;

    this.keychainPath = _path2['default'].resolve(this.getDir(), 'Library', 'Keychains');
    this.simulatorApp = 'iOS Simulator.app';

    this.scaleFactor = null;

    this.appDataBundlePaths = {};

    // list of files to check for when seeing if a simulator is "fresh"
    // (meaning it has never been booted).
    // If these files are present, we assume it's been successfully booted
    this.isFreshFiles = ['Library/ConfigurationProfiles', 'Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];

    // extra time to wait for simulator to be deemed booted
    this.extraStartupTime = EXTRA_STARTUP_TIME;
  }

  _createClass(SimulatorXcode6, [{
    key: 'setScaleFactor',
    value: function setScaleFactor(newScaleFactor) {
      var supportedScales = ['1.0', '0.75', '0.5', '0.33', '0.25'];
      if (supportedScales.indexOf(newScaleFactor) < 0) {
        var msg = 'Only "' + supportedScales + '" values are supported as scale factors. "' + newScaleFactor + '" is passed instead.';
        _logger2['default'].errorAndThrow(msg);
      }
      this.scaleFactor = newScaleFactor;
    }
  }, {
    key: 'getPlatformVersion',
    value: function getPlatformVersion() {
      var _ref, sdk;

      return _regeneratorRuntime.async(function getPlatformVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this._platformVersion) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.stat());

          case 3:
            _ref = context$2$0.sent;
            sdk = _ref.sdk;

            this._platformVersion = sdk;

          case 6:
            return context$2$0.abrupt('return', this._platformVersion);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getRootDir',
    value: function getRootDir() {
      var home = process.env.HOME;
      return _path2['default'].resolve(home, 'Library', 'Developer', 'CoreSimulator', 'Devices');
    }
  }, {
    key: 'getDir',
    value: function getDir() {
      return _path2['default'].resolve(this.getRootDir(), this.udid, 'data');
    }
  }, {
    key: 'getLogDir',
    value: function getLogDir() {
      var home = process.env.HOME;
      return _path2['default'].resolve(home, 'Library', 'Logs', 'CoreSimulator', this.udid);
    }

    /*
     * takes an `id`, which is either a bundleId (e.g., com.apple.mobilesafari)
     * or, for iOS 7.1, the app name without `.app` (e.g., MobileSafari)
     */
  }, {
    key: 'getAppDir',
    value: function getAppDir(id) {
      var subDir = arguments.length <= 1 || arguments[1] === undefined ? 'Data' : arguments[1];
      return _regeneratorRuntime.async(function getAppDir$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.isFresh());

          case 2:
            if (!context$2$0.sent) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].info('Attempted to get an app path from a fresh simulator ' + 'quickly launching the sim to populate its directories');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.launchAndQuit());

          case 6:
            if (this.appDataBundlePaths[subDir]) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.buildBundlePathMap(subDir));

          case 9:
            this.appDataBundlePaths[subDir] = context$2$0.sent;

          case 10:
            return context$2$0.abrupt('return', this.appDataBundlePaths[subDir][id]);

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * the xcode 6 simulators are really annoying, and bury the main app
     * directories inside directories just named with Hashes.
     * This function finds the proper directory by traversing all of them
     * and reading a metadata plist (Mobile Container Manager) to get the
     * bundle id.
     */
  }, {
    key: 'buildBundlePathMap',
    value: function buildBundlePathMap() {
      var subDir = arguments.length <= 0 || arguments[0] === undefined ? 'Data' : arguments[0];
      var applicationList, pathBundlePair, bundlePathDirs, bundlePathPairs;
      return _regeneratorRuntime.async(function buildBundlePathMap$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Building bundle path map');
            applicationList = undefined;
            pathBundlePair = undefined;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 5:
            context$2$0.t0 = context$2$0.sent;

            if (!(context$2$0.t0 === '7.1')) {
              context$2$0.next = 11;
              break;
            }

            // apps available
            //   Web.app,
            //   WebViewService.app,
            //   MobileSafari.app,
            //   WebContentAnalysisUI.app,
            //   DDActionsService.app,
            //   StoreKitUIService.app
            applicationList = _path2['default'].resolve(this.getDir(), 'Applications');
            pathBundlePair = function callee$2$0(dir) {
              var appFiles, bundleId;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    dir = _path2['default'].resolve(applicationList, dir);
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.glob(dir + '/*.app'));

                  case 3:
                    appFiles = context$3$0.sent;
                    bundleId = appFiles[0].match(/.*\/(.*)\.app/)[1];
                    return context$3$0.abrupt('return', { path: dir, bundleId: bundleId });

                  case 6:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            };
            context$2$0.next = 12;
            break;

          case 11:
            (function () {
              applicationList = _path2['default'].resolve(_this.getDir(), 'Containers', subDir, 'Application');
              // given a directory, find the plist file and pull the bundle id from it
              var readBundleId = function readBundleId(dir) {
                var plist, metadata;
                return _regeneratorRuntime.async(function readBundleId$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      plist = _path2['default'].resolve(dir, '.com.apple.mobile_container_manager.metadata.plist');
                      context$4$0.next = 3;
                      return _regeneratorRuntime.awrap(settings.read(plist));

                    case 3:
                      metadata = context$4$0.sent;
                      return context$4$0.abrupt('return', metadata.MCMMetadataIdentifier);

                    case 5:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this);
              };
              // given a directory, return the path and bundle id associated with it
              pathBundlePair = function callee$3$0(dir) {
                var bundleId;
                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      dir = _path2['default'].resolve(applicationList, dir);
                      context$4$0.next = 3;
                      return _regeneratorRuntime.awrap(readBundleId(dir));

                    case 3:
                      bundleId = context$4$0.sent;
                      return context$4$0.abrupt('return', { path: dir, bundleId: bundleId });

                    case 5:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this);
              };
            })();

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.readdir(applicationList));

          case 14:
            bundlePathDirs = context$2$0.sent;
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap((0, _asyncbox.asyncmap)(bundlePathDirs, function callee$2$0(dir) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(pathBundlePair(dir));

                  case 2:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 3:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }, false));

          case 17:
            bundlePathPairs = context$2$0.sent;
            return context$2$0.abrupt('return', bundlePathPairs.reduce(function (bundleMap, bundlePath) {
              bundleMap[bundlePath.bundleId] = bundlePath.path;
              return bundleMap;
            }, {}));

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // returns state and specifics of this sim.
    // { name: 'iPhone 4s',
    //   udid: 'C09B34E5-7DCB-442E-B79C-AB6BC0357417',
    //   state: 'Shutdown',
    //   sdk: '8.3'
    // }
  }, {
    key: 'stat',
    value: function stat() {
      var devices, normalizedDevices, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _loop, _iterator, _step;

      return _regeneratorRuntime.async(function stat$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.getDevices());

          case 2:
            devices = context$2$0.sent;
            normalizedDevices = [];
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            context$2$0.prev = 7;

            _loop = function () {
              var _step$value = _slicedToArray(_step.value, 2);

              var sdk = _step$value[0];
              var deviceArr = _step$value[1];

              deviceArr = deviceArr.map(function (device) {
                device.sdk = sdk;
                return device;
              });
              normalizedDevices = normalizedDevices.concat(deviceArr);
            };

            // add sdk attribute to all entries, add to normalizedDevices
            for (_iterator = _getIterator(_lodash2['default'].toPairs(devices)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              _loop();
            }

            context$2$0.next = 16;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](7);
            _didIteratorError = true;
            _iteratorError = context$2$0.t0;

          case 16:
            context$2$0.prev = 16;
            context$2$0.prev = 17;

            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }

          case 19:
            context$2$0.prev = 19;

            if (!_didIteratorError) {
              context$2$0.next = 22;
              break;
            }

            throw _iteratorError;

          case 22:
            return context$2$0.finish(19);

          case 23:
            return context$2$0.finish(16);

          case 24:
            return context$2$0.abrupt('return', _lodash2['default'].find(normalizedDevices, { udid: this.udid }));

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 12, 16, 24], [17,, 19, 23]]);
    }
  }, {
    key: 'isFresh',
    value: function isFresh() {
      var files, pv, existences, fresh;
      return _regeneratorRuntime.async(function isFresh$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // this is a best-bet heuristic for whether or not a sim has been booted
            // before. We usually want to start a simulator to "warm" it up, have
            // Xcode populate it with plists for us to manipulate before a real
            // test run.

            // if the following files don't exist, it hasn't been booted.
            // THIS IS NOT AN EXHAUSTIVE LIST
            _logger2['default'].debug('Checking whether simulator has been run before');
            files = this.isFreshFiles;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 4:
            pv = context$2$0.sent;

            if (pv !== '7.1') {
              files.push('Library/Preferences/com.apple.Preferences.plist');
            } else {
              files.push('Applications');
            }

            files = files.map(function (s) {
              return _path2['default'].resolve(_this2.getDir(), s);
            });

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.asyncmap)(files, function callee$2$0(f) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(f));

                  case 2:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 3:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 9:
            existences = context$2$0.sent;
            fresh = _lodash2['default'].compact(existences).length !== files.length;

            _logger2['default'].debug('Simulator ' + (fresh ? 'has not' : 'has') + ' been run before');
            return context$2$0.abrupt('return', fresh);

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'isRunning',
    value: function isRunning() {
      var stat;
      return _regeneratorRuntime.async(function isRunning$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stat());

          case 2:
            stat = context$2$0.sent;
            return context$2$0.abrupt('return', stat.state === 'Booted');

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForBoot',
    value: function waitForBoot(startupTimeout) {
      var bootedIndicator;
      return _regeneratorRuntime.async(function waitForBoot$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getBootedIndicatorString());

          case 2:
            bootedIndicator = context$2$0.sent;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.tailLogsUntil(bootedIndicator, startupTimeout));

          case 5:

            // so sorry, but we should wait another two seconds, just to make sure we've really started
            // we can't look for another magic log line, because they seem to be app-dependent (not system dependent)
            _logger2['default'].debug('Waiting an extra ' + this.extraStartupTime + 'ms for the simulator to really finish booting');
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(this.extraStartupTime));

          case 8:
            _logger2['default'].debug('Done waiting extra time for simulator');

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getBootedIndicatorString',
    value: function getBootedIndicatorString() {
      var indicator, platformVersion;
      return _regeneratorRuntime.async(function getBootedIndicatorString$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            indicator = undefined;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 3:
            platformVersion = context$2$0.sent;
            context$2$0.t0 = platformVersion;
            context$2$0.next = context$2$0.t0 === '7.1' ? 7 : context$2$0.t0 === '8.1' ? 7 : context$2$0.t0 === '8.2' ? 7 : context$2$0.t0 === '8.3' ? 7 : context$2$0.t0 === '8.4' ? 7 : context$2$0.t0 === '9.0' ? 9 : context$2$0.t0 === '9.1' ? 9 : context$2$0.t0 === '9.2' ? 9 : context$2$0.t0 === '9.3' ? 9 : context$2$0.t0 === '10.0' ? 11 : 13;
            break;

          case 7:
            indicator = 'profiled: Service starting...';
            return context$2$0.abrupt('break', 15);

          case 9:
            indicator = 'System app "com.apple.springboard" finished startup';
            return context$2$0.abrupt('break', 15);

          case 11:
            indicator = 'Switching to keyboard';
            return context$2$0.abrupt('break', 15);

          case 13:
            _logger2['default'].warn('No boot indicator case for platform version \'' + platformVersion + '\'');
            indicator = 'no boot indicator string available';

          case 15:
            return context$2$0.abrupt('return', indicator);

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'run',
    value: function run() {
      var startupTimeout = arguments.length <= 0 || arguments[0] === undefined ? STARTUP_TIMEOUT : arguments[0];
      var simulatorApp, args, stat, formattedDeviceName, argumentName, startTime;
      return _regeneratorRuntime.async(function run$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _path2['default'];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _appiumXcode.getPath)());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = this.simulatorApp;
            simulatorApp = context$2$0.t0.resolve.call(context$2$0.t0, context$2$0.t1, 'Applications', context$2$0.t2);
            args = ['-Fn', simulatorApp, '--args', '-CurrentDeviceUDID', this.udid];

            if (!this.scaleFactor) {
              context$2$0.next = 14;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.stat());

          case 10:
            stat = context$2$0.sent;
            formattedDeviceName = stat.name.replace(/\s+/g, '-');
            argumentName = '-SimulatorWindowLastScale-com.apple.CoreSimulator.SimDeviceType.' + formattedDeviceName;

            args.push(argumentName, this.scaleFactor);

          case 14:
            _logger2['default'].info('Starting simulator with command: open ' + args.join(' '));
            startTime = Date.now();
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('open', args, { timeout: OPEN_TIMEOUT }));

          case 18:
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.waitForBoot(startupTimeout));

          case 20:

            _logger2['default'].info('Simulator booted in ' + (Date.now() - startTime) + 'ms');

          case 21:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // TODO keep keychains
  }, {
    key: 'clean',
    value: function clean() {
      return _regeneratorRuntime.async(function clean$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.endSimulatorDaemon());

          case 2:
            _logger2['default'].info('Cleaning simulator ' + this.udid);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(simctl.eraseDevice(this.udid, 10000));

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'cleanCustomApp',
    value: function cleanCustomApp(appFile, appBundleId) {
      var appDirs, deletePromises, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, dir, relRmPath, rmPath;

      return _regeneratorRuntime.async(function cleanCustomApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Cleaning app data files for \'' + appFile + '\', \'' + appBundleId + '\'');

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getAppDirs(appFile, appBundleId));

          case 3:
            appDirs = context$2$0.sent;

            if (!(appDirs.length === 0)) {
              context$2$0.next = 7;
              break;
            }

            _logger2['default'].debug("Could not find app directories to delete. It is probably not installed");
            return context$2$0.abrupt('return');

          case 7:
            deletePromises = [];
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 11;

            for (_iterator2 = _getIterator(appDirs); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              dir = _step2.value;

              _logger2['default'].debug('Deleting directory: \'' + dir + '\'');
              deletePromises.push(_appiumSupport.fs.rimraf(dir));
            }

            context$2$0.next = 19;
            break;

          case 15:
            context$2$0.prev = 15;
            context$2$0.t0 = context$2$0['catch'](11);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t0;

          case 19:
            context$2$0.prev = 19;
            context$2$0.prev = 20;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 22:
            context$2$0.prev = 22;

            if (!_didIteratorError2) {
              context$2$0.next = 25;
              break;
            }

            throw _iteratorError2;

          case 25:
            return context$2$0.finish(22);

          case 26:
            return context$2$0.finish(19);

          case 27:
            context$2$0.next = 29;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 29:
            context$2$0.t1 = context$2$0.sent;

            if (!(context$2$0.t1 >= 8)) {
              context$2$0.next = 35;
              break;
            }

            relRmPath = 'Library/Preferences/' + appBundleId + '.plist';
            rmPath = _path2['default'].resolve(this.getRootDir(), relRmPath);

            _logger2['default'].debug('Deleting file: \'' + rmPath + '\'');
            deletePromises.push(_appiumSupport.fs.rimraf(rmPath));

          case 35:
            context$2$0.next = 37;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(deletePromises));

          case 37:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[11, 15, 19, 27], [20,, 22, 26]]);
    }
  }, {
    key: 'getAppDirs',
    value: function getAppDirs(appFile, appBundleId) {
      var dirs, data, bundle;
      return _regeneratorRuntime.async(function getAppDirs$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            dirs = [];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 3:
            context$2$0.t0 = context$2$0.sent;

            if (!(context$2$0.t0 >= 8)) {
              context$2$0.next = 15;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.getAppDir(appBundleId));

          case 7:
            data = context$2$0.sent;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.getAppDir(appBundleId, 'Bundle'));

          case 10:
            bundle = context$2$0.sent;

            if (data) {
              dirs.push(data);
            }
            if (bundle) {
              dirs.push(bundle);
            }
            context$2$0.next = 19;
            break;

          case 15:
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.getAppDir(appFile));

          case 17:
            data = context$2$0.sent;

            if (data) {
              dirs.push(data);
            }

          case 19:
            return context$2$0.abrupt('return', dirs);

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launchAndQuit',
    value: function launchAndQuit() {
      var safari = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
      return _regeneratorRuntime.async(function launchAndQuit$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Attempting to launch and quit the simulator, to create directory structure');
            _logger2['default'].debug('Will launch with Safari? ' + safari);

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.run());

          case 4:
            if (!safari) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.openUrl('http://www.appium.io'));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 250, function callee$2$0() {
              var msg;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.isFresh());

                  case 2:
                    if (!context$3$0.sent) {
                      context$3$0.next = 6;
                      break;
                    }

                    msg = 'Simulator files not fully created. Waiting a bit';

                    _logger2['default'].debug(msg);
                    throw new Error(msg);

                  case 6:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            }));

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.shutdown());

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'endSimulatorDaemon',
    value: function endSimulatorDaemon() {
      var launchctlCmd, stopCmd, removeCmd;
      return _regeneratorRuntime.async(function endSimulatorDaemon$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // Looks for launchd daemons corresponding to the sim udid and tries to stop them cleanly
            // This prevents xcrun simctl erase hangs.
            _logger2['default'].debug('Killing any simulator daemons for ' + this.udid);

            launchctlCmd = 'launchctl list | grep ' + this.udid + ' | cut -f 3 | xargs -n 1 launchctl';
            context$2$0.prev = 2;
            stopCmd = launchctlCmd + ' stop';
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', stopCmd]));

          case 6:
            context$2$0.next = 12;
            break;

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](2);

            _logger2['default'].warn('Could not stop simulator daemons: ' + context$2$0.t0.message);
            _logger2['default'].debug('Carrying on anyway!');

          case 12:
            context$2$0.prev = 12;
            removeCmd = launchctlCmd + ' remove';
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', removeCmd]));

          case 16:
            context$2$0.next = 22;
            break;

          case 18:
            context$2$0.prev = 18;
            context$2$0.t1 = context$2$0['catch'](12);

            _logger2['default'].warn('Could not remove simulator daemons: ' + context$2$0.t1.message);
            _logger2['default'].debug('Carrying on anyway!');

          case 22:
            context$2$0.prev = 22;
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$2$0() {
              var _ref2, stdout;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', 'ps -e  | grep ' + this.udid + ' | grep launchd_sim | grep -v bash | grep -v grep | awk {\'print$1\'}']));

                  case 2:
                    _ref2 = context$3$0.sent;
                    stdout = _ref2.stdout;
                    return context$3$0.abrupt('return', stdout.trim().length === 0);

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this4);
            }, { waitMs: 10000, intervalMs: 500 }));

          case 25:
            context$2$0.next = 31;
            break;

          case 27:
            context$2$0.prev = 27;
            context$2$0.t2 = context$2$0['catch'](22);

            _logger2['default'].warn('Could not end simulator daemon for ' + this.udid + ': ' + context$2$0.t2.message);
            _logger2['default'].debug('Carrying on anyway!');

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 8], [12, 18], [22, 27]]);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAllSimulators)());

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'delete',
    value: function _delete() {
      return _regeneratorRuntime.async(function _delete$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.deleteDevice(this.udid));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateSettings',
    value: function updateSettings(plist, updates) {
      return _regeneratorRuntime.async(function updateSettings$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateSettings(this, plist, updates));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateLocationSettings',
    value: function updateLocationSettings(bundleId, authorized) {
      return _regeneratorRuntime.async(function updateLocationSettings$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateLocationSettings(this, bundleId, authorized));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateSafariSettings',
    value: function updateSafariSettings(updates) {
      return _regeneratorRuntime.async(function updateSafariSettings$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateSafariUserSettings(this, updates));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(settings.updateSettings(this, 'mobileSafari', updates));

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateLocale',
    value: function updateLocale(language, locale, calendarFormat) {
      return _regeneratorRuntime.async(function updateLocale$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateLocale(this, language, locale, calendarFormat));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSafari',
    value: function deleteSafari() {
      var dirs, pv, deletePromises, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, dir;

      return _regeneratorRuntime.async(function deleteSafari$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting Safari apps from simulator');

            dirs = [];
            context$2$0.t0 = dirs;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.getAppDir('com.apple.mobilesafari'));

          case 5:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t0.push.call(context$2$0.t0, context$2$0.t1);
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 9:
            pv = context$2$0.sent;

            if (!(pv >= 8)) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.t2 = dirs;
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.getAppDir('com.apple.mobilesafari', 'Bundle'));

          case 14:
            context$2$0.t3 = context$2$0.sent;
            context$2$0.t2.push.call(context$2$0.t2, context$2$0.t3);

          case 16:
            deletePromises = [];
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 20;

            for (_iterator3 = _getIterator(dirs); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
              dir = _step3.value;

              _logger2['default'].debug('Deleting directory: \'' + dir + '\'');
              deletePromises.push(_appiumSupport.fs.rimraf(dir));
            }
            context$2$0.next = 28;
            break;

          case 24:
            context$2$0.prev = 24;
            context$2$0.t4 = context$2$0['catch'](20);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t4;

          case 28:
            context$2$0.prev = 28;
            context$2$0.prev = 29;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 31:
            context$2$0.prev = 31;

            if (!_didIteratorError3) {
              context$2$0.next = 34;
              break;
            }

            throw _iteratorError3;

          case 34:
            return context$2$0.finish(31);

          case 35:
            return context$2$0.finish(28);

          case 36:
            context$2$0.next = 38;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(deletePromises));

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[20, 24, 28, 36], [29,, 31, 35]]);
    }
  }, {
    key: 'cleanSafari',
    value: function cleanSafari() {
      var keepPrefs = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

      var libraryDir, safariLibraryDir, filesToDelete, deletePromises, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, file;

      return _regeneratorRuntime.async(function cleanSafari$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Cleaning mobile safari data files');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.isFresh());

          case 3:
            if (!context$2$0.sent) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].info('Could not find Safari support directories to clean out old ' + 'data. Probably there is nothing to clean out');
            return context$2$0.abrupt('return');

          case 6:
            libraryDir = _path2['default'].resolve(this.getDir(), 'Library');
            context$2$0.t0 = _path2['default'];
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.getAppDir('com.apple.mobilesafari'));

          case 10:
            context$2$0.t1 = context$2$0.sent;
            safariLibraryDir = context$2$0.t0.resolve.call(context$2$0.t0, context$2$0.t1, 'Library');
            filesToDelete = ['Caches/Snapshots/com.apple.mobilesafari', 'Caches/com.apple.mobilesafari/Cache.db*', 'Caches/com.apple.WebAppCache/*.db', 'Safari', 'WebKit/LocalStorage/*.*', 'WebKit/GeolocationSites.plist', 'Cookies/*.binarycookies'];
            deletePromises = [];
            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            context$2$0.prev = 17;

            for (_iterator4 = _getIterator(filesToDelete); !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
              file = _step4.value;

              deletePromises.push(_appiumSupport.fs.rimraf(_path2['default'].resolve(libraryDir, file)));
              deletePromises.push(_appiumSupport.fs.rimraf(_path2['default'].resolve(safariLibraryDir, file)));
            }

            context$2$0.next = 25;
            break;

          case 21:
            context$2$0.prev = 21;
            context$2$0.t2 = context$2$0['catch'](17);
            _didIteratorError4 = true;
            _iteratorError4 = context$2$0.t2;

          case 25:
            context$2$0.prev = 25;
            context$2$0.prev = 26;

            if (!_iteratorNormalCompletion4 && _iterator4['return']) {
              _iterator4['return']();
            }

          case 28:
            context$2$0.prev = 28;

            if (!_didIteratorError4) {
              context$2$0.next = 31;
              break;
            }

            throw _iteratorError4;

          case 31:
            return context$2$0.finish(28);

          case 32:
            return context$2$0.finish(25);

          case 33:
            if (!keepPrefs) {
              deletePromises.push(_appiumSupport.fs.rimraf(_path2['default'].resolve(safariLibraryDir, 'Preferences/*.plist')));
            }

            context$2$0.next = 36;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(deletePromises));

          case 36:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[17, 21, 25, 33], [26,, 28, 32]]);
    }
  }, {
    key: 'removeApp',
    value: function removeApp(bundleId) {
      return _regeneratorRuntime.async(function removeApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.removeApp(this.udid, bundleId));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'moveBuiltInApp',
    value: function moveBuiltInApp(appName, appPath, newAppPath) {
      return _regeneratorRuntime.async(function moveBuiltInApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _utilsJs.safeRimRaf)(newAppPath));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(appPath, newAppPath));

          case 4:
            _logger2['default'].debug('Copied \'' + appName + '\' to \'' + newAppPath + '\'');

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(appPath));

          case 7:
            _logger2['default'].debug('Temporarily deleted original app at \'' + appPath + '\'');

            return context$2$0.abrupt('return', [newAppPath, appPath]);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'openUrl',
    value: function openUrl(url) {
      var SAFARI_BOOTED_INDICATOR, SAFARI_STARTUP_TIMEOUT, EXTRA_STARTUP_TIME;
      return _regeneratorRuntime.async(function openUrl$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            SAFARI_BOOTED_INDICATOR = 'MobileSafari[';
            SAFARI_STARTUP_TIMEOUT = 15 * 1000;
            EXTRA_STARTUP_TIME = 3 * 1000;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.isRunning());

          case 5:
            if (!context$2$0.sent) {
              context$2$0.next = 17;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _asyncbox.retry)(5000, simctl.openUrl, this.udid, url));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.tailLogsUntil(SAFARI_BOOTED_INDICATOR, SAFARI_STARTUP_TIMEOUT));

          case 10:
            // So sorry, but the logs have nothing else for Safari starting.. just delay a little bit
            _logger2['default'].debug('Safari started, waiting ' + EXTRA_STARTUP_TIME + 'ms for it to fully start');
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(EXTRA_STARTUP_TIME));

          case 13:
            _logger2['default'].debug('Done waiting for Safari');
            return context$2$0.abrupt('return');

          case 17:
            throw new Error('Tried to open a url, but the Simulator is not Booted');

          case 18:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // returns a promise that resolves when the ios simulator logs output a line matching `bootedIndicator`
    // times out after timeoutMs
  }, {
    key: 'tailLogsUntil',
    value: function tailLogsUntil(bootedIndicator, timeoutMs) {
      var simLog;
      return _regeneratorRuntime.async(function tailLogsUntil$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            simLog = _path2['default'].resolve(this.getLogDir(), 'system.log');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(200, 200, function callee$2$0() {
              var exists;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(simLog));

                  case 2:
                    exists = context$3$0.sent;

                    if (exists) {
                      context$3$0.next = 5;
                      break;
                    }

                    throw new Error('Could not find Simulator log: \'' + simLog + '\'');

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5);
            }));

          case 3:

            _logger2['default'].info('Simulator log at \'' + simLog + '\'');
            _logger2['default'].info('Tailing simulator logs until we encounter the string "' + bootedIndicator + '"');
            _logger2['default'].info('We will time out after ' + timeoutMs + 'ms');
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _tailUntilJs.tailUntil)(simLog, bootedIndicator, timeoutMs));

          case 9:
            context$2$0.next = 14;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].debug('Simulator startup timed out. Continuing anyway.');

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 11]]);
    }
  }], [{
    key: '_getDeviceStringPlatformVersion',
    value: function _getDeviceStringPlatformVersion(platformVersion) {
      var reqVersion;
      return _regeneratorRuntime.async(function _getDeviceStringPlatformVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            reqVersion = platformVersion;

            if (reqVersion) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

          case 4:
            reqVersion = context$2$0.sent;

            _logger2['default'].warn('No platform version set. Using max SDK version: ' + reqVersion);
            // this will be a number, and possibly an integer (e.g., if max iOS SDK is 9)
            // so turn it into a string and add a .0 if necessary
            if (!_lodash2['default'].isString(reqVersion)) {
              reqVersion = reqVersion % 1 ? String(reqVersion) : reqVersion + '.0';
            }

          case 7:
            return context$2$0.abrupt('return', reqVersion);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // change the format in subclasses, as necessary
  }, {
    key: '_getDeviceStringVersionString',
    value: function _getDeviceStringVersionString(platformVersion) {
      var reqVersion;
      return _regeneratorRuntime.async(function _getDeviceStringVersionString$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this._getDeviceStringPlatformVersion(platformVersion));

          case 2:
            reqVersion = context$2$0.sent;
            return context$2$0.abrupt('return', '(' + reqVersion + ' Simulator)');

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // change the format in subclasses, as necessary
  }, {
    key: '_getDeviceStringConfigFix',
    value: function _getDeviceStringConfigFix() {
      // some devices need to be updated
      return {
        'iPad Simulator (7.1 Simulator)': 'iPad 2 (7.1 Simulator)',
        'iPad Simulator (8.0 Simulator)': 'iPad 2 (8.0 Simulator)',
        'iPad Simulator (8.1 Simulator)': 'iPad 2 (8.1 Simulator)',
        'iPad Simulator (8.2 Simulator)': 'iPad 2 (8.2 Simulator)',
        'iPad Simulator (8.3 Simulator)': 'iPad 2 (8.3 Simulator)',
        'iPad Simulator (8.4 Simulator)': 'iPad 2 (8.4 Simulator)',
        'iPhone Simulator (7.1 Simulator)': 'iPhone 5s (7.1 Simulator)',
        'iPhone Simulator (8.4 Simulator)': 'iPhone 6 (8.4 Simulator)',
        'iPhone Simulator (8.3 Simulator)': 'iPhone 6 (8.3 Simulator)',
        'iPhone Simulator (8.2 Simulator)': 'iPhone 6 (8.2 Simulator)',
        'iPhone Simulator (8.1 Simulator)': 'iPhone 6 (8.1 Simulator)',
        'iPhone Simulator (8.0 Simulator)': 'iPhone 6 (8.0 Simulator)'
      };
    }
  }, {
    key: 'getDeviceString',
    value: function getDeviceString(opts) {
      var logOpts, isiPhone, device, iosDeviceString, CONFIG_FIX, configFix;
      return _regeneratorRuntime.async(function getDeviceString$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            opts = _Object$assign({}, {
              deviceName: null,
              platformVersion: null,
              forceIphone: false,
              forceIpad: false
            }, opts);
            logOpts = {
              deviceName: opts.deviceName,
              platformVersion: opts.platformVersion,
              forceIphone: opts.forceIphone,
              forceIpad: opts.forceIpad
            };

            _logger2['default'].debug('Getting device string from options: ' + JSON.stringify(logOpts));

            // short circuit if we already have a device name

            if (!((opts.deviceName || '')[0] === '=')) {
              context$2$0.next = 5;
              break;
            }

            return context$2$0.abrupt('return', opts.deviceName.substring(1));

          case 5:
            isiPhone = !!opts.forceIphone || !opts.forceIpad;

            if (opts.deviceName) {
              device = opts.deviceName.toLowerCase();

              if (device.indexOf('iphone') !== -1) {
                isiPhone = true;
              } else if (device.indexOf('ipad') !== -1) {
                isiPhone = false;
              }
            }

            iosDeviceString = opts.deviceName || (isiPhone ? 'iPhone Simulator' : 'iPad Simulator');

            // if someone passes in just "iPhone", make that "iPhone Simulator" to
            // conform to all the logic below
            if (/^(iPhone|iPad)$/.test(iosDeviceString)) {
              iosDeviceString += " Simulator";
            }

            // we support deviceName: "iPhone Simulator", and also want to support
            // "iPhone XYZ Simulator", but these strings aren't in the device list.
            // So, if someone sent in "iPhone XYZ Simulator", strip off " Simulator"
            // in order to allow the default "iPhone XYZ" match
            if (/[^(iPhone|iPad)] Simulator/.test(iosDeviceString)) {
              iosDeviceString = iosDeviceString.replace(" Simulator", "");
            }
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this._getDeviceStringVersionString(opts.platformVersion));

          case 12:
            context$2$0.t0 = context$2$0.sent;
            iosDeviceString += ' ' + context$2$0.t0;
            CONFIG_FIX = this._getDeviceStringConfigFix();
            configFix = CONFIG_FIX;

            if (configFix[iosDeviceString]) {
              iosDeviceString = configFix[iosDeviceString];
              _logger2['default'].debug('Fixing device. Changed from \'' + opts.deviceName + '\' ' + ('to \'' + iosDeviceString + '\''));
            }

            _logger2['default'].debug('Final device string is \'' + iosDeviceString + '\'');
            return context$2$0.abrupt('return', iosDeviceString);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return SimulatorXcode6;
})();

var _iteratorNormalCompletion5 = true;
var _didIteratorError5 = false;
var _iteratorError5 = undefined;

try {

  for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(_extensionsIndex2['default'])), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
    var _step5$value = _slicedToArray(_step5.value, 2);

    var cmd = _step5$value[0];
    var fn = _step5$value[1];

    SimulatorXcode6.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError5 = true;
  _iteratorError5 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion5 && _iterator5['return']) {
      _iterator5['return']();
    }
  } finally {
    if (_didIteratorError5) {
      throw _iteratorError5;
    }
  }
}

exports['default'] = SimulatorXcode6;
module.exports = exports['default'];

// reduce the list of path-bundle pairs to an object where bundleIds are mapped to paths

// wait for the simulator to boot
// waiting for the simulator status to be 'booted' isn't good enough
// it claims to be booted way before finishing loading
// let's tail the simulator system log until we see a magic line (this.bootedIndicator)

// start simulator

// iOS 8+ stores app data in two places,
// iOS 7.1 has only one directory

// wait for the system to create the files we will manipulate
// need quite a high retry number, in order to accommodate iOS 7.1
// locally, 7.1 averages 8.5 retries (from 6 - 12)
//          8 averages 0.6 retries (from 0 - 2)
//          9 averages 14 retries

// and quit

// Waits 10 sec for the simulator launchd services to stop.

// get the data directory

// get the bundle directory

// we need to make sure log file exists before we can tail it
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtNi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUFpQixNQUFNOzs7OzBCQUNDLGFBQWE7O0lBQXpCLE1BQU07OzJCQUN3QyxjQUFjOzs7O3NCQUN4RCxVQUFVOzs7OzZCQUNQLGdCQUFnQjs7d0JBQ3JCLFVBQVU7Ozs7c0JBQ1YsUUFBUTs7Ozt1QkFDd0IsWUFBWTs7d0JBQ08sVUFBVTs7d0JBQ2pELFlBQVk7O0lBQTFCLFFBQVE7OzRCQUNDLGNBQWM7OzJCQUNULGlCQUFpQjs7K0JBQ3BCLG9CQUFvQjs7OztBQUczQyxJQUFNLFlBQVksR0FBRyxJQUFJLENBQUM7QUFDMUIsSUFBTSxlQUFlLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUNsQyxJQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQzs7SUFFMUIsZUFBZTtBQUNQLFdBRFIsZUFBZSxDQUNOLElBQUksRUFBRSxZQUFZLEVBQUU7MEJBRDdCLGVBQWU7O0FBRWpCLFFBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pCLFFBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDOzs7OztBQUtqQyxRQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDOztBQUU3QixRQUFJLENBQUMsWUFBWSxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUUsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ3hFLFFBQUksQ0FBQyxZQUFZLEdBQUcsbUJBQW1CLENBQUM7O0FBRXhDLFFBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDOztBQUV4QixRQUFJLENBQUMsa0JBQWtCLEdBQUcsRUFBRSxDQUFDOzs7OztBQUs3QixRQUFJLENBQUMsWUFBWSxHQUFHLENBQ2xCLCtCQUErQixFQUMvQixpQkFBaUIsRUFDakIsOENBQThDLEVBQzlDLGlEQUFpRCxFQUNqRCxvQkFB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SUFBSSxZQUFZLENBQUM7YUFDakM7Ozs7OztBQU1ELGdCQUFJLDRCQUE0QixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRTtBQUN0RCw2QkFBZSxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQzdEOzs2Q0FDNEIsSUFBSSxDQUFDLDZCQUE2QixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7Ozs7QUFBckYsMkJBQWU7QUFFWCxzQkFBVSxHQUFHLElBQUksQ0FBQyx5QkFBeUIsRUFBRTtBQUU3QyxxQkFBUyxHQUFHLFVBQVU7O0FBQzFCLGdCQUFJLFNBQVMsQ0FBQyxlQUFlLENBQUMsRUFBRTtBQUM5Qiw2QkFBZSxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUM3QyxrQ0FBSSxLQUFLLENBQUMsbUNBQWdDLElBQUksQ0FBQyxVQUFVLHNCQUNyQyxlQUFlLFFBQUcsQ0FBQyxDQUFDO2FBQ3pDOztBQUVELGdDQUFJLEtBQUssK0JBQTRCLGVBQWUsUUFBSSxDQUFDO2dEQUNsRCxlQUFlOzs7Ozs7O0tBQ3ZCOzs7U0ExbEJHLGVBQWU7Ozs7Ozs7OztBQTZsQnJCLHFDQUFzQixvQkFBRSxPQUFPLDhCQUFZLGlIQUFFOzs7UUFBbkMsR0FBRztRQUFFLEVBQUU7O0FBQ2YsbUJBQWUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0dBQ3JDOzs7Ozs7Ozs7Ozs7Ozs7O3FCQUVjLGVBQWUiLCJmaWxlIjoibGliL3NpbXVsYXRvci14Y29kZS02LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBzaW1jdGwgZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IHsgZGVmYXVsdCBhcyB4Y29kZSwgZ2V0UGF0aCBhcyBnZXRYY29kZVBhdGggfSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBraWxsQWxsU2ltdWxhdG9ycywgc2FmZVJpbVJhZiB9IGZyb20gJy4vdXRpbHMuanMnO1xuaW1wb3J0IHsgYXN5bmNtYXAsIHdhaXRGb3JDb25kaXRpb24sIHJldHJ5SW50ZXJ2YWwsIHJldHJ5IH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0ICogYXMgc2V0dGluZ3MgZnJvbSAnLi9zZXR0aW5ncyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IHRhaWxVbnRpbCB9IGZyb20gJy4vdGFpbC11bnRpbC5qcyc7XG5pbXBvcnQgZXh0ZW5zaW9ucyBmcm9tICcuL2V4dGVuc2lvbnMvaW5kZXgnO1xuXG5cbmNvbnN0IE9QRU5fVElNRU9VVCA9IDMwMDA7XG5jb25zdCBTVEFSVFVQX1RJTUVPVVQgPSA2MCAqIDEwMDA7XG5jb25zdCBFWFRSQV9TVEFSVFVQX1RJTUUgPSAyMDAwO1xuXG5jbGFzcyBTaW11bGF0b3JYY29kZTYge1xuICBjb25zdHJ1Y3RvciAodWRpZCwgeGNvZGVWZXJzaW9uKSB7XG4gICAgdGhpcy51ZGlkID0gU3RyaW5nKHVkaWQpO1xuICAgIHRoaXMueGNvZGVWZXJzaW9uID0geGNvZGVWZXJzaW9uO1xuXG4gICAgLy8gcGxhdGZvcm1WZXJzaW9uIGNhbm5vdCBiZSBmb3VuZCBpbml0aWFsbHksIHNpbmNlIGdldHRpbmcgaXQgaGFzIHNpZGUgZWZmZWN0cyBmb3JcbiAgICAvLyBvdXIgbG9naWMgZm9yIGZpZ3VyaW5nIG91dCBpZiBhIHNpbSBoYXMgYmVlbiBydW5cbiAgICAvLyBpdCB3aWxsIGJlIHNldCB3aGVuIGl0IGlzIG5lZWRlZFxuICAgIHRoaXMuX3BsYXRmb3JtVmVyc2lvbiA9IG51bGw7XG5cbiAgICB0aGlzLmtleWNoYWluUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLmdldERpcigpLCAnTGlicmFyeScsICdLZXljaGFpbnMnKTtcbiAgICB0aGlzLnNpbXVsYXRvckFwcCA9ICdpT1MgU2ltdWxhdG9yLmFwcCc7XG5cbiAgICB0aGlzLnNjYWxlRmFjdG9yID0gbnVsbDtcblxuICAgIHRoaXMuYXBwRGF0YUJ1bmRsZVBhdGhzID0ge307XG5cbiAgICAvLyBsaXN0IG9mIGZpbGVzIHRvIGNoZWNrIGZvciB3aGVuIHNlZWluZyBpZiBhIHNpbXVsYXRvciBpcyBcImZyZXNoXCJcbiAgICAvLyAobWVhbmluZyBpdCBoYXMgbmV2ZXIgYmVlbiBib290ZWQpLlxuICAgIC8vIElmIHRoZXNlIGZpbGVzIGFyZSBwcmVzZW50LCB3ZSBhc3N1bWUgaXQncyBiZWVuIHN1Y2Nlc3NmdWxseSBib290ZWRcbiAgICB0aGlzLmlzRnJlc2hGaWxlcyA9IFtcbiAgICAgICdMaWJyYXJ5L0NvbmZpZ3VyYXRpb25Qcm9maWxlcycsXG4gICAgICAnTGlicmFyeS9Db29raWVzJyxcbiAgICAgICdMaWJyYXJ5L1ByZWZlcmVuY2VzLy5HbG9iYWxQcmVmZXJlbmNlcy5wbGlzdCcsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy9jb20uYXBwbGUuc3ByaW5nYm9hcmQucGxpc3QnLFxuICAgICAgJ3Zhci9ydW4vc3lzbG9nLnBpZCdcbiAgICBdO1xuXG4gICAgLy8gZXh0cmEgdGltZSB0byB3YWl0IGZvciBzaW11bGF0b3IgdG8gYmUgZGVlbWVkIGJvb3RlZFxuICAgIHRoaXMuZXh0cmFTdGFydHVwVGltZSA9IEVYVFJBX1NUQVJUVVBfVElNRTtcbiAgfVxuXG4gIHNldFNjYWxlRmFjdG9yIChuZXdTY2FsZUZhY3Rvcikge1xuICAgIGxldCBzdXBwb3J0ZWRTY2FsZXMgPSBbJzEuMCcsICcwLjc1JywgJzAuNScsICcwLjMzJywgJzAuMjUnXTtcbiAgICBpZiAoc3VwcG9ydGVkU2NhbGVzLmluZGV4T2YobmV3U2NhbGVGYWN0b3IpIDwgMCkge1xuICAgICAgbGV0IG1zZyA9IGBPbmx5IFwiJHtzdXBwb3J0ZWRTY2FsZXN9XCIgdmFsdWVzIGFyZSBzdXBwb3J0ZWQgYXMgc2NhbGUgZmFjdG9ycy4gXCIke25ld1NjYWxlRmFjdG9yfVwiIGlzIHBhc3NlZCBpbnN0ZWFkLmA7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cbiAgICB0aGlzLnNjYWxlRmFjdG9yID0gbmV3U2NhbGVGYWN0b3I7XG4gIH1cblxuICBhc3luYyBnZXRQbGF0Zm9ybVZlcnNpb24gKCkge1xuICAgIGlmICghdGhpcy5fcGxhdGZvcm1WZXJzaW9uKSB7XG4gICAgICBsZXQge3Nka30gPSBhd2FpdCB0aGlzLnN0YXQoKTtcbiAgICAgIHRoaXMuX3BsYXRmb3JtVmVyc2lvbiA9IHNkaztcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3BsYXRmb3JtVmVyc2lvbjtcbiAgfVxuXG4gIGdldFJvb3REaXIgKCkge1xuICAgIGxldCBob21lID0gcHJvY2Vzcy5lbnYuSE9NRTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGhvbWUsICdMaWJyYXJ5JywgJ0RldmVsb3BlcicsICdDb3JlU2ltdWxhdG9yJywgJ0RldmljZXMnKTtcbiAgfVxuXG4gIGdldERpciAoKSB7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZSh0aGlzLmdldFJvb3REaXIoKSwgdGhpcy51ZGlkLCAnZGF0YScpO1xuICB9XG5cbiAgZ2V0TG9nRGlyICgpIHtcbiAgICBsZXQgaG9tZSA9IHByb2Nlc3MuZW52LkhPTUU7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShob21lLCAnTGlicmFyeScsICdMb2dzJywgJ0NvcmVTaW11bGF0b3InLCB0aGlzLnVkaWQpO1xuICB9XG5cbiAgLypcbiAgICogdGFrZXMgYW4gYGlkYCwgd2hpY2ggaXMgZWl0aGVyIGEgYnVuZGxlSWQgKGUuZy4sIGNvbS5hcHBsZS5tb2JpbGVzYWZhcmkpXG4gICAqIG9yLCBmb3IgaU9TIDcuMSwgdGhlIGFwcCBuYW1lIHdpdGhvdXQgYC5hcHBgIChlLmcuLCBNb2JpbGVTYWZhcmkpXG4gICAqL1xuICBhc3luYyBnZXRBcHBEaXIgKGlkLCBzdWJEaXIgPSAnRGF0YScpIHtcbiAgICBpZiAoYXdhaXQgdGhpcy5pc0ZyZXNoKCkpIHtcbiAgICAgIGxvZy5pbmZvKCdBdHRlbXB0ZWQgdG8gZ2V0IGFuIGFwcCBwYXRoIGZyb20gYSBmcmVzaCBzaW11bGF0b3IgJyArXG4gICAgICAgICAgICAgICAncXVpY2tseSBsYXVuY2hpbmcgdGhlIHNpbSB0byBwb3B1bGF0ZSBpdHMgZGlyZWN0b3JpZXMnKTtcbiAgICAgIGF3YWl0IHRoaXMubGF1bmNoQW5kUXVpdCgpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5hcHBEYXRhQnVuZGxlUGF0aHNbc3ViRGlyXSkge1xuICAgICAgdGhpcy5hcHBEYXRhQnVuZGxlUGF0aHNbc3ViRGlyXSA9IGF3YWl0IHRoaXMuYnVpbGRCdW5kbGVQYXRoTWFwKHN1YkRpcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYXBwRGF0YUJ1bmRsZVBhdGhzW3N1YkRpcl1baWRdO1xuICB9XG5cbiAgLypcbiAgICogdGhlIHhjb2RlIDYgc2ltdWxhdG9ycyBhcmUgcmVhbGx5IGFubm95aW5nLCBhbmQgYnVyeSB0aGUgbWFpbiBhcHBcbiAgICogZGlyZWN0b3JpZXMgaW5zaWRlIGRpcmVjdG9yaWVzIGp1c3QgbmFtZWQgd2l0aCBIYXNoZXMuXG4gICAqIFRoaXMgZnVuY3Rpb24gZmluZHMgdGhlIHByb3BlciBkaXJlY3RvcnkgYnkgdHJhdmVyc2luZyBhbGwgb2YgdGhlbVxuICAgKiBhbmQgcmVhZGluZyBhIG1ldGFkYXRhIHBsaXN0IChNb2JpbGUgQ29udGFpbmVyIE1hbmFnZXIpIHRvIGdldCB0aGVcbiAgICogYnVuZGxlIGlkLlxuICAgKi9cbiAgYXN5bmMgYnVpbGRCdW5kbGVQYXRoTWFwIChzdWJEaXIgPSAnRGF0YScpIHtcbiAgICBsb2cuZGVidWcoJ0J1aWxkaW5nIGJ1bmRsZSBwYXRoIG1hcCcpO1xuICAgIGxldCBhcHBsaWNhdGlvbkxpc3Q7XG4gICAgbGV0IHBhdGhCdW5kbGVQYWlyO1xuICAgIGlmIChhd2FpdCB0aGlzLmdldFBsYXRmb3JtVmVyc2lvbigpID09PSAnNy4xJykge1xuICAgICAgLy8gYXBwcyBhdmFpbGFibGVcbiAgICAgIC8vICAgV2ViLmFwcCxcbiAgICAgIC8vICAgV2ViVmlld1NlcnZpY2UuYXBwLFxuICAgICAgLy8gICBNb2JpbGVTYWZhcmkuYXBwLFxuICAgICAgLy8gICBXZWJDb250ZW50QW5hbHlzaXNVSS5hcHAsXG4gICAgICAvLyAgIEREQWN0aW9uc1NlcnZpY2UuYXBwLFxuICAgICAgLy8gICBTdG9yZUtpdFVJU2VydmljZS5hcHBcbiAgICAgIGFwcGxpY2F0aW9uTGlzdCA9IHBhdGgucmVzb2x2ZSh0aGlzLmdldERpcigpLCAnQXBwbGljYXRpb25zJyk7XG4gICAgICBwYXRoQnVuZGxlUGFpciA9IGFzeW5jIChkaXIpID0+IHtcbiAgICAgICAgZGlyID0gcGF0aC5yZXNvbHZlKGFwcGxpY2F0aW9uTGlzdCwgZGlyKTtcbiAgICAgICAgbGV0IGFwcEZpbGVzID0gYXdhaXQgZnMuZ2xvYihgJHtkaXJ9LyouYXBwYCk7XG4gICAgICAgIGxldCBidW5kbGVJZCA9IGFwcEZpbGVzWzBdLm1hdGNoKC8uKlxcLyguKilcXC5hcHAvKVsxXTtcbiAgICAgICAgcmV0dXJuIHtwYXRoOiBkaXIsIGJ1bmRsZUlkfTtcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGFwcGxpY2F0aW9uTGlzdCA9IHBhdGgucmVzb2x2ZSh0aGlzLmdldERpcigpLCAnQ29udGFpbmVycycsIHN1YkRpciwgJ0FwcGxpY2F0aW9uJyk7XG4gICAgICAvLyBnaXZlbiBhIGRpcmVjdG9yeSwgZmluZCB0aGUgcGxpc3QgZmlsZSBhbmQgcHVsbCB0aGUgYnVuZGxlIGlkIGZyb20gaXRcbiAgICAgIGxldCByZWFkQnVuZGxlSWQgPSBhc3luYyAoZGlyKSA9PiB7XG4gICAgICAgIGxldCBwbGlzdCA9IHBhdGgucmVzb2x2ZShkaXIsICcuY29tLmFwcGxlLm1vYmlsZV9jb250YWluZXJfbWFuYWdlci5tZXRhZGF0YS5wbGlzdCcpO1xuICAgICAgICBsZXQgbWV0YWRhdGEgPSBhd2FpdCBzZXR0aW5ncy5yZWFkKHBsaXN0KTtcbiAgICAgICAgcmV0dXJuIG1ldGFkYXRhLk1DTU1ldGFkYXRhSWRlbnRpZmllcjtcbiAgICAgIH07XG4gICAgICAvLyBnaXZlbiBhIGRpcmVjdG9yeSwgcmV0dXJuIHRoZSBwYXRoIGFuZCBidW5kbGUgaWQgYXNzb2NpYXRlZCB3aXRoIGl0XG4gICAgICBwYXRoQnVuZGxlUGFpciA9IGFzeW5jIChkaXIpID0+IHtcbiAgICAgICAgZGlyID0gcGF0aC5yZXNvbHZlKGFwcGxpY2F0aW9uTGlzdCwgZGlyKTtcbiAgICAgICAgbGV0IGJ1bmRsZUlkID0gYXdhaXQgcmVhZEJ1bmRsZUlkKGRpcik7XG4gICAgICAgIHJldHVybiB7cGF0aDogZGlyLCBidW5kbGVJZH07XG4gICAgICB9O1xuICAgIH1cblxuICAgIGxldCBidW5kbGVQYXRoRGlycyA9IGF3YWl0IGZzLnJlYWRkaXIoYXBwbGljYXRpb25MaXN0KTtcbiAgICBsZXQgYnVuZGxlUGF0aFBhaXJzID0gYXdhaXQgYXN5bmNtYXAoYnVuZGxlUGF0aERpcnMsIGFzeW5jIChkaXIpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCBwYXRoQnVuZGxlUGFpcihkaXIpO1xuICAgIH0sIGZhbHNlKTtcblxuICAgIC8vIHJlZHVjZSB0aGUgbGlzdCBvZiBwYXRoLWJ1bmRsZSBwYWlycyB0byBhbiBvYmplY3Qgd2hlcmUgYnVuZGxlSWRzIGFyZSBtYXBwZWQgdG8gcGF0aHNcbiAgICByZXR1cm4gYnVuZGxlUGF0aFBhaXJzLnJlZHVjZSgoYnVuZGxlTWFwLCBidW5kbGVQYXRoKSA9PiB7XG4gICAgICBidW5kbGVNYXBbYnVuZGxlUGF0aC5idW5kbGVJZF0gPSBidW5kbGVQYXRoLnBhdGg7XG4gICAgICByZXR1cm4gYnVuZGxlTWFwO1xuICAgIH0sIHt9KTtcbiAgfVxuXG4gIC8vIHJldHVybnMgc3RhdGUgYW5kIHNwZWNpZmljcyBvZiB0aGlzIHNpbS5cbiAgLy8geyBuYW1lOiAnaVBob25lIDRzJyxcbiAgLy8gICB1ZGlkOiAnQzA5QjM0RTUtN0RDQi00NDJFLUI3OUMtQUI2QkMwMzU3NDE3JyxcbiAgLy8gICBzdGF0ZTogJ1NodXRkb3duJyxcbiAgLy8gICBzZGs6ICc4LjMnXG4gIC8vIH1cbiAgYXN5bmMgc3RhdCAoKSB7XG4gICAgbGV0IGRldmljZXMgPSBhd2FpdCBzaW1jdGwuZ2V0RGV2aWNlcygpO1xuICAgIGxldCBub3JtYWxpemVkRGV2aWNlcyA9IFtdO1xuXG4gICAgLy8gYWRkIHNkayBhdHRyaWJ1dGUgdG8gYWxsIGVudHJpZXMsIGFkZCB0byBub3JtYWxpemVkRGV2aWNlc1xuICAgIGZvciAobGV0IFtzZGssIGRldmljZUFycl0gb2YgXy50b1BhaXJzKGRldmljZXMpKSB7XG4gICAgICBkZXZpY2VBcnIgPSBkZXZpY2VBcnIubWFwKChkZXZpY2UpID0+IHtcbiAgICAgICAgZGV2aWNlLnNkayA9IHNkaztcbiAgICAgICAgcmV0dXJuIGRldmljZTtcbiAgICAgIH0pO1xuICAgICAgbm9ybWFsaXplZERldmljZXMgPSBub3JtYWxpemVkRGV2aWNlcy5jb25jYXQoZGV2aWNlQXJyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gXy5maW5kKG5vcm1hbGl6ZWREZXZpY2VzLCB7dWRpZDogdGhpcy51ZGlkfSk7XG4gIH1cblxuICBhc3luYyBpc0ZyZXNoICgpIHtcbiAgICAvLyB0aGlzIGlzIGEgYmVzdC1iZXQgaGV1cmlzdGljIGZvciB3aGV0aGVyIG9yIG5vdCBhIHNpbSBoYXMgYmVlbiBib290ZWRcbiAgICAvLyBiZWZvcmUuIFdlIHVzdWFsbHkgd2FudCB0byBzdGFydCBhIHNpbXVsYXRvciB0byBcIndhcm1cIiBpdCB1cCwgaGF2ZVxuICAgIC8vIFhjb2RlIHBvcHVsYXRlIGl0IHdpdGggcGxpc3RzIGZvciB1cyB0byBtYW5pcHVsYXRlIGJlZm9yZSBhIHJlYWxcbiAgICAvLyB0ZXN0IHJ1bi5cblxuICAgIC8vIGlmIHRoZSBmb2xsb3dpbmcgZmlsZXMgZG9uJ3QgZXhpc3QsIGl0IGhhc24ndCBiZWVuIGJvb3RlZC5cbiAgICAvLyBUSElTIElTIE5PVCBBTiBFWEhBVVNUSVZFIExJU1RcbiAgICBsb2cuZGVidWcoJ0NoZWNraW5nIHdoZXRoZXIgc2ltdWxhdG9yIGhhcyBiZWVuIHJ1biBiZWZvcmUnKTtcbiAgICBsZXQgZmlsZXMgPSB0aGlzLmlzRnJlc2hGaWxlcztcblxuICAgIGxldCBwdiA9IGF3YWl0IHRoaXMuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XG4gICAgaWYgKHB2ICE9PSAnNy4xJykge1xuICAgICAgZmlsZXMucHVzaCgnTGlicmFyeS9QcmVmZXJlbmNlcy9jb20uYXBwbGUuUHJlZmVyZW5jZXMucGxpc3QnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsZXMucHVzaCgnQXBwbGljYXRpb25zJyk7XG4gICAgfVxuXG4gICAgZmlsZXMgPSBmaWxlcy5tYXAoKHMpID0+IHtcbiAgICAgIHJldHVybiBwYXRoLnJlc29sdmUodGhpcy5nZXREaXIoKSwgcyk7XG4gICAgfSk7XG5cbiAgICBsZXQgZXhpc3RlbmNlcyA9IGF3YWl0IGFzeW5jbWFwKGZpbGVzLCBhc3luYyAoZikgPT4geyByZXR1cm4gYXdhaXQgZnMuaGFzQWNjZXNzKGYpOyB9KTtcbiAgICBsZXQgZnJlc2ggPSBfLmNvbXBhY3QoZXhpc3RlbmNlcykubGVuZ3RoICE9PSBmaWxlcy5sZW5ndGg7XG4gICAgbG9nLmRlYnVnKGBTaW11bGF0b3IgJHtmcmVzaCA/ICdoYXMgbm90JyA6ICdoYXMnfSBiZWVuIHJ1biBiZWZvcmVgKTtcbiAgICByZXR1cm4gZnJlc2g7XG4gIH1cblxuICBhc3luYyBpc1J1bm5pbmcgKCkge1xuICAgIGxldCBzdGF0ID0gYXdhaXQgdGhpcy5zdGF0KCk7XG4gICAgcmV0dXJuIHN0YXQuc3RhdGUgPT09ICdCb290ZWQnO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvckJvb3QgKHN0YXJ0dXBUaW1lb3V0KSB7XG4gICAgLy8gd2FpdCBmb3IgdGhlIHNpbXVsYXRvciB0byBib290XG4gICAgLy8gd2FpdGluZyBmb3IgdGhlIHNpbXVsYXRvciBzdGF0dXMgdG8gYmUgJ2Jvb3RlZCcgaXNuJ3QgZ29vZCBlbm91Z2hcbiAgICAvLyBpdCBjbGFpbXMgdG8gYmUgYm9vdGVkIHdheSBiZWZvcmUgZmluaXNoaW5nIGxvYWRpbmdcbiAgICAvLyBsZXQncyB0YWlsIHRoZSBzaW11bGF0b3Igc3lzdGVtIGxvZyB1bnRpbCB3ZSBzZWUgYSBtYWdpYyBsaW5lICh0aGlzLmJvb3RlZEluZGljYXRvcilcbiAgICBsZXQgYm9vdGVkSW5kaWNhdG9yID0gYXdhaXQgdGhpcy5nZXRCb290ZWRJbmRpY2F0b3JTdHJpbmcoKTtcbiAgICBhd2FpdCB0aGlzLnRhaWxMb2dzVW50aWwoYm9vdGVkSW5kaWNhdG9yLCBzdGFydHVwVGltZW91dCk7XG5cbiAgICAvLyBzbyBzb3JyeSwgYnV0IHdlIHNob3VsZCB3YWl0IGFub3RoZXIgdHdvIHNlY29uZHMsIGp1c3QgdG8gbWFrZSBzdXJlIHdlJ3ZlIHJlYWxseSBzdGFydGVkXG4gICAgLy8gd2UgY2FuJ3QgbG9vayBmb3IgYW5vdGhlciBtYWdpYyBsb2cgbGluZSwgYmVjYXVzZSB0aGV5IHNlZW0gdG8gYmUgYXBwLWRlcGVuZGVudCAobm90IHN5c3RlbSBkZXBlbmRlbnQpXG4gICAgbG9nLmRlYnVnKGBXYWl0aW5nIGFuIGV4dHJhICR7dGhpcy5leHRyYVN0YXJ0dXBUaW1lfW1zIGZvciB0aGUgc2ltdWxhdG9yIHRvIHJlYWxseSBmaW5pc2ggYm9vdGluZ2ApO1xuICAgIGF3YWl0IEIuZGVsYXkodGhpcy5leHRyYVN0YXJ0dXBUaW1lKTtcbiAgICBsb2cuZGVidWcoJ0RvbmUgd2FpdGluZyBleHRyYSB0aW1lIGZvciBzaW11bGF0b3InKTtcbiAgfVxuXG4gIGFzeW5jIGdldEJvb3RlZEluZGljYXRvclN0cmluZyAoKSB7XG4gICAgbGV0IGluZGljYXRvcjtcbiAgICBsZXQgcGxhdGZvcm1WZXJzaW9uID0gYXdhaXQgdGhpcy5nZXRQbGF0Zm9ybVZlcnNpb24oKTtcbiAgICBzd2l0Y2ggKHBsYXRmb3JtVmVyc2lvbikge1xuICAgICAgY2FzZSAnNy4xJzpcbiAgICAgIGNhc2UgJzguMSc6XG4gICAgICBjYXNlICc4LjInOlxuICAgICAgY2FzZSAnOC4zJzpcbiAgICAgIGNhc2UgJzguNCc6XG4gICAgICAgIGluZGljYXRvciA9ICdwcm9maWxlZDogU2VydmljZSBzdGFydGluZy4uLic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnOS4wJzpcbiAgICAgIGNhc2UgJzkuMSc6XG4gICAgICBjYXNlICc5LjInOlxuICAgICAgY2FzZSAnOS4zJzpcbiAgICAgICAgaW5kaWNhdG9yID0gJ1N5c3RlbSBhcHAgXCJjb20uYXBwbGUuc3ByaW5nYm9hcmRcIiBmaW5pc2hlZCBzdGFydHVwJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICcxMC4wJzpcbiAgICAgICAgaW5kaWNhdG9yID0gJ1N3aXRjaGluZyB0byBrZXlib2FyZCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgbG9nLndhcm4oYE5vIGJvb3QgaW5kaWNhdG9yIGNhc2UgZm9yIHBsYXRmb3JtIHZlcnNpb24gJyR7cGxhdGZvcm1WZXJzaW9ufSdgKTtcbiAgICAgICAgaW5kaWNhdG9yID0gJ25vIGJvb3QgaW5kaWNhdG9yIHN0cmluZyBhdmFpbGFibGUnO1xuICAgIH1cbiAgICByZXR1cm4gaW5kaWNhdG9yO1xuICB9XG5cbiAgYXN5bmMgcnVuIChzdGFydHVwVGltZW91dCA9IFNUQVJUVVBfVElNRU9VVCkge1xuICAgIC8vIHN0YXJ0IHNpbXVsYXRvclxuICAgIGxldCBzaW11bGF0b3JBcHAgPSBwYXRoLnJlc29sdmUoYXdhaXQgZ2V0WGNvZGVQYXRoKCksICdBcHBsaWNhdGlvbnMnLCB0aGlzLnNpbXVsYXRvckFwcCk7XG4gICAgbGV0IGFyZ3MgPSBbJy1GbicsIHNpbXVsYXRvckFwcCwgJy0tYXJncycsICctQ3VycmVudERldmljZVVESUQnLCB0aGlzLnVkaWRdO1xuICAgIGlmICh0aGlzLnNjYWxlRmFjdG9yKSB7XG4gICAgICBsZXQgc3RhdCA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgICAgbGV0IGZvcm1hdHRlZERldmljZU5hbWUgPSBzdGF0Lm5hbWUucmVwbGFjZSgvXFxzKy9nLCAnLScpO1xuICAgICAgbGV0IGFyZ3VtZW50TmFtZSA9IGAtU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlLWNvbS5hcHBsZS5Db3JlU2ltdWxhdG9yLlNpbURldmljZVR5cGUuJHtmb3JtYXR0ZWREZXZpY2VOYW1lfWA7XG4gICAgICBhcmdzLnB1c2goYXJndW1lbnROYW1lLCB0aGlzLnNjYWxlRmFjdG9yKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYFN0YXJ0aW5nIHNpbXVsYXRvciB3aXRoIGNvbW1hbmQ6IG9wZW4gJHthcmdzLmpvaW4oJyAnKX1gKTtcbiAgICBsZXQgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBhd2FpdCBleGVjKCdvcGVuJywgYXJncywge3RpbWVvdXQ6IE9QRU5fVElNRU9VVH0pO1xuXG4gICAgYXdhaXQgdGhpcy53YWl0Rm9yQm9vdChzdGFydHVwVGltZW91dCk7XG5cbiAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIGJvb3RlZCBpbiAke0RhdGUubm93KCkgLSBzdGFydFRpbWV9bXNgKTtcbiAgfVxuXG4gIC8vIFRPRE8ga2VlcCBrZXljaGFpbnNcbiAgYXN5bmMgY2xlYW4gKCkge1xuICAgIGF3YWl0IHRoaXMuZW5kU2ltdWxhdG9yRGFlbW9uKCk7XG4gICAgbG9nLmluZm8oYENsZWFuaW5nIHNpbXVsYXRvciAke3RoaXMudWRpZH1gKTtcbiAgICBhd2FpdCBzaW1jdGwuZXJhc2VEZXZpY2UodGhpcy51ZGlkLCAxMDAwMCk7XG4gIH1cblxuICBhc3luYyBjbGVhbkN1c3RvbUFwcCAoYXBwRmlsZSwgYXBwQnVuZGxlSWQpIHtcbiAgICBsb2cuZGVidWcoYENsZWFuaW5nIGFwcCBkYXRhIGZpbGVzIGZvciAnJHthcHBGaWxlfScsICcke2FwcEJ1bmRsZUlkfSdgKTtcblxuICAgIGxldCBhcHBEaXJzID0gYXdhaXQgdGhpcy5nZXRBcHBEaXJzKGFwcEZpbGUsIGFwcEJ1bmRsZUlkKTtcblxuICAgIGlmIChhcHBEaXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgbG9nLmRlYnVnKFwiQ291bGQgbm90IGZpbmQgYXBwIGRpcmVjdG9yaWVzIHRvIGRlbGV0ZS4gSXQgaXMgcHJvYmFibHkgbm90IGluc3RhbGxlZFwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZGVsZXRlUHJvbWlzZXMgPSBbXTtcblxuICAgIGZvciAobGV0IGRpciBvZiBhcHBEaXJzKSB7XG4gICAgICBsb2cuZGVidWcoYERlbGV0aW5nIGRpcmVjdG9yeTogJyR7ZGlyfSdgKTtcbiAgICAgIGRlbGV0ZVByb21pc2VzLnB1c2goZnMucmltcmFmKGRpcikpO1xuICAgIH1cblxuICAgIGlmIChhd2FpdCB0aGlzLmdldFBsYXRmb3JtVmVyc2lvbigpID49IDgpIHtcbiAgICAgIGxldCByZWxSbVBhdGggPSBgTGlicmFyeS9QcmVmZXJlbmNlcy8ke2FwcEJ1bmRsZUlkfS5wbGlzdGA7XG4gICAgICBsZXQgcm1QYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuZ2V0Um9vdERpcigpLCByZWxSbVBhdGgpO1xuICAgICAgbG9nLmRlYnVnKGBEZWxldGluZyBmaWxlOiAnJHtybVBhdGh9J2ApO1xuICAgICAgZGVsZXRlUHJvbWlzZXMucHVzaChmcy5yaW1yYWYocm1QYXRoKSk7XG4gICAgfVxuXG4gICAgYXdhaXQgQi5hbGwoZGVsZXRlUHJvbWlzZXMpO1xuICB9XG5cbiAgYXN5bmMgZ2V0QXBwRGlycyAoYXBwRmlsZSwgYXBwQnVuZGxlSWQpIHtcbiAgICBsZXQgZGlycyA9IFtdO1xuICAgIC8vIGlPUyA4KyBzdG9yZXMgYXBwIGRhdGEgaW4gdHdvIHBsYWNlcyxcbiAgICAvLyBpT1MgNy4xIGhhcyBvbmx5IG9uZSBkaXJlY3RvcnlcbiAgICBpZiAoYXdhaXQgdGhpcy5nZXRQbGF0Zm9ybVZlcnNpb24oKSA+PSA4KSB7XG4gICAgICBsZXQgZGF0YSA9IGF3YWl0IHRoaXMuZ2V0QXBwRGlyKGFwcEJ1bmRsZUlkKTtcbiAgICAgIGxldCBidW5kbGUgPSBhd2FpdCB0aGlzLmdldEFwcERpcihhcHBCdW5kbGVJZCwgJ0J1bmRsZScpO1xuICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgZGlycy5wdXNoKGRhdGEpO1xuICAgICAgfVxuICAgICAgaWYgKGJ1bmRsZSkge1xuICAgICAgICBkaXJzLnB1c2goYnVuZGxlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGRhdGEgPSBhd2FpdCB0aGlzLmdldEFwcERpcihhcHBGaWxlKTtcbiAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgIGRpcnMucHVzaChkYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRpcnM7XG4gIH1cblxuICBhc3luYyBsYXVuY2hBbmRRdWl0IChzYWZhcmkgPSBmYWxzZSkge1xuICAgIGxvZy5kZWJ1ZygnQXR0ZW1wdGluZyB0byBsYXVuY2ggYW5kIHF1aXQgdGhlIHNpbXVsYXRvciwgdG8gY3JlYXRlIGRpcmVjdG9yeSBzdHJ1Y3R1cmUnKTtcbiAgICBsb2cuZGVidWcoYFdpbGwgbGF1bmNoIHdpdGggU2FmYXJpPyAke3NhZmFyaX1gKTtcblxuICAgIGF3YWl0IHRoaXMucnVuKCk7XG5cbiAgICBpZiAoc2FmYXJpKSB7XG4gICAgICBhd2FpdCB0aGlzLm9wZW5VcmwoJ2h0dHA6Ly93d3cuYXBwaXVtLmlvJyk7XG4gICAgfVxuXG4gICAgLy8gd2FpdCBmb3IgdGhlIHN5c3RlbSB0byBjcmVhdGUgdGhlIGZpbGVzIHdlIHdpbGwgbWFuaXB1bGF0ZVxuICAgIC8vIG5lZWQgcXVpdGUgYSBoaWdoIHJldHJ5IG51bWJlciwgaW4gb3JkZXIgdG8gYWNjb21tb2RhdGUgaU9TIDcuMVxuICAgIC8vIGxvY2FsbHksIDcuMSBhdmVyYWdlcyA4LjUgcmV0cmllcyAoZnJvbSA2IC0gMTIpXG4gICAgLy8gICAgICAgICAgOCBhdmVyYWdlcyAwLjYgcmV0cmllcyAoZnJvbSAwIC0gMilcbiAgICAvLyAgICAgICAgICA5IGF2ZXJhZ2VzIDE0IHJldHJpZXNcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAyNTAsIGFzeW5jICgpID0+IHtcbiAgICAgIGlmIChhd2FpdCB0aGlzLmlzRnJlc2goKSkge1xuICAgICAgICBsZXQgbXNnID0gJ1NpbXVsYXRvciBmaWxlcyBub3QgZnVsbHkgY3JlYXRlZC4gV2FpdGluZyBhIGJpdCc7XG4gICAgICAgIGxvZy5kZWJ1Zyhtc2cpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIGFuZCBxdWl0XG4gICAgYXdhaXQgdGhpcy5zaHV0ZG93bigpO1xuICB9XG5cbiAgYXN5bmMgZW5kU2ltdWxhdG9yRGFlbW9uICgpIHtcbiAgICAvLyBMb29rcyBmb3IgbGF1bmNoZCBkYWVtb25zIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHNpbSB1ZGlkIGFuZCB0cmllcyB0byBzdG9wIHRoZW0gY2xlYW5seVxuICAgIC8vIFRoaXMgcHJldmVudHMgeGNydW4gc2ltY3RsIGVyYXNlIGhhbmdzLlxuICAgIGxvZy5kZWJ1ZyhgS2lsbGluZyBhbnkgc2ltdWxhdG9yIGRhZW1vbnMgZm9yICR7dGhpcy51ZGlkfWApO1xuXG4gICAgbGV0IGxhdW5jaGN0bENtZCA9IGBsYXVuY2hjdGwgbGlzdCB8IGdyZXAgJHt0aGlzLnVkaWR9IHwgY3V0IC1mIDMgfCB4YXJncyAtbiAxIGxhdW5jaGN0bGA7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBzdG9wQ21kID0gYCR7bGF1bmNoY3RsQ21kfSBzdG9wYDtcbiAgICAgIGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJywgc3RvcENtZF0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENvdWxkIG5vdCBzdG9wIHNpbXVsYXRvciBkYWVtb25zOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nLmRlYnVnKCdDYXJyeWluZyBvbiBhbnl3YXkhJyk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVtb3ZlQ21kID0gYCR7bGF1bmNoY3RsQ21kfSByZW1vdmVgO1xuICAgICAgYXdhaXQgZXhlYygnYmFzaCcsIFsnLWMnLCByZW1vdmVDbWRdKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBDb3VsZCBub3QgcmVtb3ZlIHNpbXVsYXRvciBkYWVtb25zOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nLmRlYnVnKCdDYXJyeWluZyBvbiBhbnl3YXkhJyk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICAvLyBXYWl0cyAxMCBzZWMgZm9yIHRoZSBzaW11bGF0b3IgbGF1bmNoZCBzZXJ2aWNlcyB0byBzdG9wLlxuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJyxcbiAgICAgICAgICBgcHMgLWUgIHwgZ3JlcCAke3RoaXMudWRpZH0gfCBncmVwIGxhdW5jaGRfc2ltIHwgZ3JlcCAtdiBiYXNoIHwgZ3JlcCAtdiBncmVwIHwgYXdrIHsncHJpbnQkMSd9YF0pO1xuICAgICAgICByZXR1cm4gc3Rkb3V0LnRyaW0oKS5sZW5ndGggPT09IDA7XG4gICAgICB9LCB7d2FpdE1zOiAxMDAwMCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ291bGQgbm90IGVuZCBzaW11bGF0b3IgZGFlbW9uIGZvciAke3RoaXMudWRpZH06ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBsb2cuZGVidWcoJ0NhcnJ5aW5nIG9uIGFueXdheSEnKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgYXdhaXQga2lsbEFsbFNpbXVsYXRvcnMoKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZSAoKSB7XG4gICAgYXdhaXQgc2ltY3RsLmRlbGV0ZURldmljZSh0aGlzLnVkaWQpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlU2V0dGluZ3MgKHBsaXN0LCB1cGRhdGVzKSB7XG4gICAgcmV0dXJuIGF3YWl0IHNldHRpbmdzLnVwZGF0ZVNldHRpbmdzKHRoaXMsIHBsaXN0LCB1cGRhdGVzKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MgKGJ1bmRsZUlkLCBhdXRob3JpemVkKSB7XG4gICAgcmV0dXJuIGF3YWl0IHNldHRpbmdzLnVwZGF0ZUxvY2F0aW9uU2V0dGluZ3ModGhpcywgYnVuZGxlSWQsIGF1dGhvcml6ZWQpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlU2FmYXJpU2V0dGluZ3MgKHVwZGF0ZXMpIHtcbiAgICBhd2FpdCBzZXR0aW5ncy51cGRhdGVTYWZhcmlVc2VyU2V0dGluZ3ModGhpcywgdXBkYXRlcyk7XG4gICAgYXdhaXQgc2V0dGluZ3MudXBkYXRlU2V0dGluZ3ModGhpcywgJ21vYmlsZVNhZmFyaScsIHVwZGF0ZXMpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlTG9jYWxlIChsYW5ndWFnZSwgbG9jYWxlLCBjYWxlbmRhckZvcm1hdCkge1xuICAgIHJldHVybiBhd2FpdCBzZXR0aW5ncy51cGRhdGVMb2NhbGUodGhpcywgbGFuZ3VhZ2UsIGxvY2FsZSwgY2FsZW5kYXJGb3JtYXQpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2FmYXJpICgpIHtcbiAgICBsb2cuZGVidWcoJ0RlbGV0aW5nIFNhZmFyaSBhcHBzIGZyb20gc2ltdWxhdG9yJyk7XG5cbiAgICBsZXQgZGlycyA9IFtdO1xuXG4gICAgLy8gZ2V0IHRoZSBkYXRhIGRpcmVjdG9yeVxuICAgIGRpcnMucHVzaChhd2FpdCB0aGlzLmdldEFwcERpcignY29tLmFwcGxlLm1vYmlsZXNhZmFyaScpKTtcblxuICAgIGxldCBwdiA9IGF3YWl0IHRoaXMuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XG4gICAgaWYgKHB2ID49IDgpIHtcbiAgICAgIC8vIGdldCB0aGUgYnVuZGxlIGRpcmVjdG9yeVxuICAgICAgZGlycy5wdXNoKGF3YWl0IHRoaXMuZ2V0QXBwRGlyKCdjb20uYXBwbGUubW9iaWxlc2FmYXJpJywgJ0J1bmRsZScpKTtcbiAgICB9XG5cbiAgICBsZXQgZGVsZXRlUHJvbWlzZXMgPSBbXTtcbiAgICBmb3IgKGxldCBkaXIgb2YgZGlycykge1xuICAgICAgbG9nLmRlYnVnKGBEZWxldGluZyBkaXJlY3Rvcnk6ICcke2Rpcn0nYCk7XG4gICAgICBkZWxldGVQcm9taXNlcy5wdXNoKGZzLnJpbXJhZihkaXIpKTtcbiAgICB9XG4gICAgYXdhaXQgQi5hbGwoZGVsZXRlUHJvbWlzZXMpO1xuICB9XG5cbiAgYXN5bmMgY2xlYW5TYWZhcmkgKGtlZXBQcmVmcyA9IHRydWUpIHtcbiAgICBsb2cuZGVidWcoJ0NsZWFuaW5nIG1vYmlsZSBzYWZhcmkgZGF0YSBmaWxlcycpO1xuICAgIGlmIChhd2FpdCB0aGlzLmlzRnJlc2goKSkge1xuICAgICAgbG9nLmluZm8oJ0NvdWxkIG5vdCBmaW5kIFNhZmFyaSBzdXBwb3J0IGRpcmVjdG9yaWVzIHRvIGNsZWFuIG91dCBvbGQgJyArXG4gICAgICAgICAgICAgICAnZGF0YS4gUHJvYmFibHkgdGhlcmUgaXMgbm90aGluZyB0byBjbGVhbiBvdXQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgbGlicmFyeURpciA9IHBhdGgucmVzb2x2ZSh0aGlzLmdldERpcigpLCAnTGlicmFyeScpO1xuICAgIGxldCBzYWZhcmlMaWJyYXJ5RGlyID0gcGF0aC5yZXNvbHZlKGF3YWl0IHRoaXMuZ2V0QXBwRGlyKCdjb20uYXBwbGUubW9iaWxlc2FmYXJpJyksICdMaWJyYXJ5Jyk7XG4gICAgbGV0IGZpbGVzVG9EZWxldGUgPSBbXG4gICAgICAnQ2FjaGVzL1NuYXBzaG90cy9jb20uYXBwbGUubW9iaWxlc2FmYXJpJyxcbiAgICAgICdDYWNoZXMvY29tLmFwcGxlLm1vYmlsZXNhZmFyaS9DYWNoZS5kYionLFxuICAgICAgJ0NhY2hlcy9jb20uYXBwbGUuV2ViQXBwQ2FjaGUvKi5kYicsXG4gICAgICAnU2FmYXJpJyxcbiAgICAgICdXZWJLaXQvTG9jYWxTdG9yYWdlLyouKicsXG4gICAgICAnV2ViS2l0L0dlb2xvY2F0aW9uU2l0ZXMucGxpc3QnLFxuICAgICAgJ0Nvb2tpZXMvKi5iaW5hcnljb29raWVzJ1xuICAgIF07XG4gICAgbGV0IGRlbGV0ZVByb21pc2VzID0gW107XG5cbiAgICBmb3IgKGxldCBmaWxlIG9mIGZpbGVzVG9EZWxldGUpIHtcbiAgICAgIGRlbGV0ZVByb21pc2VzLnB1c2goZnMucmltcmFmKHBhdGgucmVzb2x2ZShsaWJyYXJ5RGlyLCBmaWxlKSkpO1xuICAgICAgZGVsZXRlUHJvbWlzZXMucHVzaChmcy5yaW1yYWYocGF0aC5yZXNvbHZlKHNhZmFyaUxpYnJhcnlEaXIsIGZpbGUpKSk7XG4gICAgfVxuXG4gICAgaWYgKCFrZWVwUHJlZnMpIHtcbiAgICAgIGRlbGV0ZVByb21pc2VzLnB1c2goZnMucmltcmFmKHBhdGgucmVzb2x2ZShzYWZhcmlMaWJyYXJ5RGlyLCAnUHJlZmVyZW5jZXMvKi5wbGlzdCcpKSk7XG4gICAgfVxuXG4gICAgYXdhaXQgQi5hbGwoZGVsZXRlUHJvbWlzZXMpO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlQXBwIChidW5kbGVJZCkge1xuICAgIGF3YWl0IHNpbWN0bC5yZW1vdmVBcHAodGhpcy51ZGlkLCBidW5kbGVJZCk7XG4gIH1cblxuICBhc3luYyBtb3ZlQnVpbHRJbkFwcCAoYXBwTmFtZSwgYXBwUGF0aCwgbmV3QXBwUGF0aCkge1xuICAgIGF3YWl0IHNhZmVSaW1SYWYobmV3QXBwUGF0aCk7XG4gICAgYXdhaXQgZnMuY29weUZpbGUoYXBwUGF0aCwgbmV3QXBwUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBDb3BpZWQgJyR7YXBwTmFtZX0nIHRvICcke25ld0FwcFBhdGh9J2ApO1xuXG4gICAgYXdhaXQgZnMucmltcmFmKGFwcFBhdGgpO1xuICAgIGxvZy5kZWJ1ZyhgVGVtcG9yYXJpbHkgZGVsZXRlZCBvcmlnaW5hbCBhcHAgYXQgJyR7YXBwUGF0aH0nYCk7XG5cbiAgICByZXR1cm4gW25ld0FwcFBhdGgsIGFwcFBhdGhdO1xuICB9XG5cbiAgYXN5bmMgb3BlblVybCAodXJsKSB7XG4gICAgY29uc3QgU0FGQVJJX0JPT1RFRF9JTkRJQ0FUT1IgPSAnTW9iaWxlU2FmYXJpWyc7XG4gICAgY29uc3QgU0FGQVJJX1NUQVJUVVBfVElNRU9VVCA9IDE1ICogMTAwMDtcbiAgICBjb25zdCBFWFRSQV9TVEFSVFVQX1RJTUUgPSAzICogMTAwMDtcblxuICAgIGlmIChhd2FpdCB0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICBhd2FpdCByZXRyeSg1MDAwLCBzaW1jdGwub3BlblVybCwgdGhpcy51ZGlkLCB1cmwpO1xuICAgICAgYXdhaXQgdGhpcy50YWlsTG9nc1VudGlsKFNBRkFSSV9CT09URURfSU5ESUNBVE9SLCBTQUZBUklfU1RBUlRVUF9USU1FT1VUKTtcbiAgICAgIC8vIFNvIHNvcnJ5LCBidXQgdGhlIGxvZ3MgaGF2ZSBub3RoaW5nIGVsc2UgZm9yIFNhZmFyaSBzdGFydGluZy4uIGp1c3QgZGVsYXkgYSBsaXR0bGUgYml0XG4gICAgICBsb2cuZGVidWcoYFNhZmFyaSBzdGFydGVkLCB3YWl0aW5nICR7RVhUUkFfU1RBUlRVUF9USU1FfW1zIGZvciBpdCB0byBmdWxseSBzdGFydGApO1xuICAgICAgYXdhaXQgQi5kZWxheShFWFRSQV9TVEFSVFVQX1RJTUUpO1xuICAgICAgbG9nLmRlYnVnKCdEb25lIHdhaXRpbmcgZm9yIFNhZmFyaScpO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyaWVkIHRvIG9wZW4gYSB1cmwsIGJ1dCB0aGUgU2ltdWxhdG9yIGlzIG5vdCBCb290ZWQnKTtcbiAgICB9XG4gIH1cblxuICAvLyByZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdoZW4gdGhlIGlvcyBzaW11bGF0b3IgbG9ncyBvdXRwdXQgYSBsaW5lIG1hdGNoaW5nIGBib290ZWRJbmRpY2F0b3JgXG4gIC8vIHRpbWVzIG91dCBhZnRlciB0aW1lb3V0TXNcbiAgYXN5bmMgdGFpbExvZ3NVbnRpbCAoYm9vdGVkSW5kaWNhdG9yLCB0aW1lb3V0TXMpIHtcbiAgICBsZXQgc2ltTG9nID0gcGF0aC5yZXNvbHZlKHRoaXMuZ2V0TG9nRGlyKCksICdzeXN0ZW0ubG9nJyk7XG5cbiAgICAvLyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSBsb2cgZmlsZSBleGlzdHMgYmVmb3JlIHdlIGNhbiB0YWlsIGl0XG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMDAsIDIwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGV4aXN0cyA9IGF3YWl0IGZzLmV4aXN0cyhzaW1Mb2cpO1xuICAgICAgaWYgKCFleGlzdHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBTaW11bGF0b3IgbG9nOiAnJHtzaW1Mb2d9J2ApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbG9nLmluZm8oYFNpbXVsYXRvciBsb2cgYXQgJyR7c2ltTG9nfSdgKTtcbiAgICBsb2cuaW5mbyhgVGFpbGluZyBzaW11bGF0b3IgbG9ncyB1bnRpbCB3ZSBlbmNvdW50ZXIgdGhlIHN0cmluZyBcIiR7Ym9vdGVkSW5kaWNhdG9yfVwiYCk7XG4gICAgbG9nLmluZm8oYFdlIHdpbGwgdGltZSBvdXQgYWZ0ZXIgJHt0aW1lb3V0TXN9bXNgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGFpbFVudGlsKHNpbUxvZywgYm9vdGVkSW5kaWNhdG9yLCB0aW1lb3V0TXMpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKCdTaW11bGF0b3Igc3RhcnR1cCB0aW1lZCBvdXQuIENvbnRpbnVpbmcgYW55d2F5LicpO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBhc3luYyBfZ2V0RGV2aWNlU3RyaW5nUGxhdGZvcm1WZXJzaW9uIChwbGF0Zm9ybVZlcnNpb24pIHtcbiAgICBsZXQgcmVxVmVyc2lvbiA9IHBsYXRmb3JtVmVyc2lvbjtcbiAgICBpZiAoIXJlcVZlcnNpb24pIHtcbiAgICAgIHJlcVZlcnNpb24gPSBhd2FpdCB4Y29kZS5nZXRNYXhJT1NTREsoKTtcbiAgICAgIGxvZy53YXJuKGBObyBwbGF0Zm9ybSB2ZXJzaW9uIHNldC4gVXNpbmcgbWF4IFNESyB2ZXJzaW9uOiAke3JlcVZlcnNpb259YCk7XG4gICAgICAvLyB0aGlzIHdpbGwgYmUgYSBudW1iZXIsIGFuZCBwb3NzaWJseSBhbiBpbnRlZ2VyIChlLmcuLCBpZiBtYXggaU9TIFNESyBpcyA5KVxuICAgICAgLy8gc28gdHVybiBpdCBpbnRvIGEgc3RyaW5nIGFuZCBhZGQgYSAuMCBpZiBuZWNlc3NhcnlcbiAgICAgIGlmICghXy5pc1N0cmluZyhyZXFWZXJzaW9uKSkge1xuICAgICAgICByZXFWZXJzaW9uID0gKHJlcVZlcnNpb24gJSAxKSA/IFN0cmluZyhyZXFWZXJzaW9uKSA6IGAke3JlcVZlcnNpb259LjBgO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVxVmVyc2lvbjtcbiAgfVxuXG4gIC8vIGNoYW5nZSB0aGUgZm9ybWF0IGluIHN1YmNsYXNzZXMsIGFzIG5lY2Vzc2FyeVxuICBzdGF0aWMgYXN5bmMgX2dldERldmljZVN0cmluZ1ZlcnNpb25TdHJpbmcgKHBsYXRmb3JtVmVyc2lvbikge1xuICAgIGxldCByZXFWZXJzaW9uID0gYXdhaXQgdGhpcy5fZ2V0RGV2aWNlU3RyaW5nUGxhdGZvcm1WZXJzaW9uKHBsYXRmb3JtVmVyc2lvbik7XG5cbiAgICByZXR1cm4gYCgke3JlcVZlcnNpb259IFNpbXVsYXRvcilgO1xuICB9XG5cbiAgLy8gY2hhbmdlIHRoZSBmb3JtYXQgaW4gc3ViY2xhc3NlcywgYXMgbmVjZXNzYXJ5XG4gIHN0YXRpYyBfZ2V0RGV2aWNlU3RyaW5nQ29uZmlnRml4ICgpIHtcbiAgICAvLyBzb21lIGRldmljZXMgbmVlZCB0byBiZSB1cGRhdGVkXG4gICAgcmV0dXJuIHtcbiAgICAgICdpUGFkIFNpbXVsYXRvciAoNy4xIFNpbXVsYXRvciknOiAnaVBhZCAyICg3LjEgU2ltdWxhdG9yKScsXG4gICAgICAnaVBhZCBTaW11bGF0b3IgKDguMCBTaW11bGF0b3IpJzogJ2lQYWQgMiAoOC4wIFNpbXVsYXRvciknLFxuICAgICAgJ2lQYWQgU2ltdWxhdG9yICg4LjEgU2ltdWxhdG9yKSc6ICdpUGFkIDIgKDguMSBTaW11bGF0b3IpJyxcbiAgICAgICdpUGFkIFNpbXVsYXRvciAoOC4yIFNpbXVsYXRvciknOiAnaVBhZCAyICg4LjIgU2ltdWxhdG9yKScsXG4gICAgICAnaVBhZCBTaW11bGF0b3IgKDguMyBTaW11bGF0b3IpJzogJ2lQYWQgMiAoOC4zIFNpbXVsYXRvciknLFxuICAgICAgJ2lQYWQgU2ltdWxhdG9yICg4LjQgU2ltdWxhdG9yKSc6ICdpUGFkIDIgKDguNCBTaW11bGF0b3IpJyxcbiAgICAgICdpUGhvbmUgU2ltdWxhdG9yICg3LjEgU2ltdWxhdG9yKSc6ICdpUGhvbmUgNXMgKDcuMSBTaW11bGF0b3IpJyxcbiAgICAgICdpUGhvbmUgU2ltdWxhdG9yICg4LjQgU2ltdWxhdG9yKSc6ICdpUGhvbmUgNiAoOC40IFNpbXVsYXRvciknLFxuICAgICAgJ2lQaG9uZSBTaW11bGF0b3IgKDguMyBTaW11bGF0b3IpJzogJ2lQaG9uZSA2ICg4LjMgU2ltdWxhdG9yKScsXG4gICAgICAnaVBob25lIFNpbXVsYXRvciAoOC4yIFNpbXVsYXRvciknOiAnaVBob25lIDYgKDguMiBTaW11bGF0b3IpJyxcbiAgICAgICdpUGhvbmUgU2ltdWxhdG9yICg4LjEgU2ltdWxhdG9yKSc6ICdpUGhvbmUgNiAoOC4xIFNpbXVsYXRvciknLFxuICAgICAgJ2lQaG9uZSBTaW11bGF0b3IgKDguMCBTaW11bGF0b3IpJzogJ2lQaG9uZSA2ICg4LjAgU2ltdWxhdG9yKSdcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGdldERldmljZVN0cmluZyAob3B0cykge1xuICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKHt9LCB7XG4gICAgICBkZXZpY2VOYW1lOiBudWxsLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uOiBudWxsLFxuICAgICAgZm9yY2VJcGhvbmU6IGZhbHNlLFxuICAgICAgZm9yY2VJcGFkOiBmYWxzZVxuICAgIH0sIG9wdHMpO1xuICAgIGxldCBsb2dPcHRzID0ge1xuICAgICAgZGV2aWNlTmFtZTogb3B0cy5kZXZpY2VOYW1lLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uOiBvcHRzLnBsYXRmb3JtVmVyc2lvbixcbiAgICAgIGZvcmNlSXBob25lOiBvcHRzLmZvcmNlSXBob25lLFxuICAgICAgZm9yY2VJcGFkOiBvcHRzLmZvcmNlSXBhZFxuICAgIH07XG4gICAgbG9nLmRlYnVnKGBHZXR0aW5nIGRldmljZSBzdHJpbmcgZnJvbSBvcHRpb25zOiAke0pTT04uc3RyaW5naWZ5KGxvZ09wdHMpfWApO1xuXG4gICAgLy8gc2hvcnQgY2lyY3VpdCBpZiB3ZSBhbHJlYWR5IGhhdmUgYSBkZXZpY2UgbmFtZVxuICAgIGlmICgob3B0cy5kZXZpY2VOYW1lIHx8ICcnKVswXSA9PT0gJz0nKSB7XG4gICAgICByZXR1cm4gb3B0cy5kZXZpY2VOYW1lLnN1YnN0cmluZygxKTtcbiAgICB9XG5cbiAgICBsZXQgaXNpUGhvbmUgPSAhIW9wdHMuZm9yY2VJcGhvbmUgfHwgIW9wdHMuZm9yY2VJcGFkO1xuXG4gICAgaWYgKG9wdHMuZGV2aWNlTmFtZSkge1xuICAgICAgbGV0IGRldmljZSA9IG9wdHMuZGV2aWNlTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKGRldmljZS5pbmRleE9mKCdpcGhvbmUnKSAhPT0gLTEpIHtcbiAgICAgICAgaXNpUGhvbmUgPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChkZXZpY2UuaW5kZXhPZignaXBhZCcpICE9PSAtMSkge1xuICAgICAgICBpc2lQaG9uZSA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBpb3NEZXZpY2VTdHJpbmcgPSBvcHRzLmRldmljZU5hbWUgfHwgKGlzaVBob25lID8gJ2lQaG9uZSBTaW11bGF0b3InIDogJ2lQYWQgU2ltdWxhdG9yJyk7XG5cbiAgICAvLyBpZiBzb21lb25lIHBhc3NlcyBpbiBqdXN0IFwiaVBob25lXCIsIG1ha2UgdGhhdCBcImlQaG9uZSBTaW11bGF0b3JcIiB0b1xuICAgIC8vIGNvbmZvcm0gdG8gYWxsIHRoZSBsb2dpYyBiZWxvd1xuICAgIGlmICgvXihpUGhvbmV8aVBhZCkkLy50ZXN0KGlvc0RldmljZVN0cmluZykpIHtcbiAgICAgIGlvc0RldmljZVN0cmluZyArPSBcIiBTaW11bGF0b3JcIjtcbiAgICB9XG5cbiAgICAvLyB3ZSBzdXBwb3J0IGRldmljZU5hbWU6IFwiaVBob25lIFNpbXVsYXRvclwiLCBhbmQgYWxzbyB3YW50IHRvIHN1cHBvcnRcbiAgICAvLyBcImlQaG9uZSBYWVogU2ltdWxhdG9yXCIsIGJ1dCB0aGVzZSBzdHJpbmdzIGFyZW4ndCBpbiB0aGUgZGV2aWNlIGxpc3QuXG4gICAgLy8gU28sIGlmIHNvbWVvbmUgc2VudCBpbiBcImlQaG9uZSBYWVogU2ltdWxhdG9yXCIsIHN0cmlwIG9mZiBcIiBTaW11bGF0b3JcIlxuICAgIC8vIGluIG9yZGVyIHRvIGFsbG93IHRoZSBkZWZhdWx0IFwiaVBob25lIFhZWlwiIG1hdGNoXG4gICAgaWYgKC9bXihpUGhvbmV8aVBhZCldIFNpbXVsYXRvci8udGVzdChpb3NEZXZpY2VTdHJpbmcpKSB7XG4gICAgICBpb3NEZXZpY2VTdHJpbmcgPSBpb3NEZXZpY2VTdHJpbmcucmVwbGFjZShcIiBTaW11bGF0b3JcIiwgXCJcIik7XG4gICAgfVxuICAgIGlvc0RldmljZVN0cmluZyArPSBgICR7YXdhaXQgdGhpcy5fZ2V0RGV2aWNlU3RyaW5nVmVyc2lvblN0cmluZyhvcHRzLnBsYXRmb3JtVmVyc2lvbil9YDtcblxuICAgIGxldCBDT05GSUdfRklYID0gdGhpcy5fZ2V0RGV2aWNlU3RyaW5nQ29uZmlnRml4KCk7XG5cbiAgICBsZXQgY29uZmlnRml4ID0gQ09ORklHX0ZJWDtcbiAgICBpZiAoY29uZmlnRml4W2lvc0RldmljZVN0cmluZ10pIHtcbiAgICAgIGlvc0RldmljZVN0cmluZyA9IGNvbmZpZ0ZpeFtpb3NEZXZpY2VTdHJpbmddO1xuICAgICAgbG9nLmRlYnVnKGBGaXhpbmcgZGV2aWNlLiBDaGFuZ2VkIGZyb20gJyR7b3B0cy5kZXZpY2VOYW1lfScgYCtcbiAgICAgICAgICAgICAgICAgICBgdG8gJyR7aW9zRGV2aWNlU3RyaW5nfSdgKTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYEZpbmFsIGRldmljZSBzdHJpbmcgaXMgJyR7aW9zRGV2aWNlU3RyaW5nfSdgKTtcbiAgICByZXR1cm4gaW9zRGV2aWNlU3RyaW5nO1xuICB9XG59XG5cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoZXh0ZW5zaW9ucykpIHtcbiAgU2ltdWxhdG9yWGNvZGU2LnByb3RvdHlwZVtjbWRdID0gZm47XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNpbXVsYXRvclhjb2RlNjtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
