'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _teen_process = require('teen_process');

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumLogger = require('appium-logger');

var _simulatorManagementJs = require('./simulator-management.js');

var _utilsJs = require('./utils.js');

var agentLog = (0, _appiumLogger.getLogger)('WebDriverAgent');
var xcodeLog = (0, _appiumLogger.getLogger)('Xcode');
var iproxyLog = (0, _appiumLogger.getLogger)('iProxy');

var BOOTSTRAP_PATH = _path2['default'].resolve(__dirname, '..', '..', 'WebDriverAgent');
var AGENT_LOG_PREFIX = 'XCTStubApps[';
var AGENT_RUNNER_LOG_PREFIX = 'XCTRunner[';
var SIM_BRIDGE_LOG_PREFIX = 'CoreSimulatorBridge[';
var AGENT_STARTED_REGEX = /ServerURLHere->(.*)<-ServerURLHere/;
var REAL_DEVICE_BUILD_LOG_STARTTIME_REGEX = /Built at (\w{3} [\d\s]\d \d{4} \d{2}:\d{2}:\d{2})/;
var REAL_DEVICE_LOGGER_PATH = 'idevicesyslog';
var WDA_BUNDLE_ID = 'com.apple.test.WebDriverAgentRunner-Runner';

var WebDriverAgent = (function () {

  // agentPath (optional): Path to WebdriverAgent Executable (inside WebDriverAgent.app)

  function WebDriverAgent(xcodeVersion) {
    var args = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    _classCallCheck(this, WebDriverAgent);

    this.xcodeVersion = xcodeVersion;

    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;

    this.setWDAPaths(args.bootstrapPath, args.agentPath);

    this.realDeviceLogger = args.realDeviceLogger || REAL_DEVICE_LOGGER_PATH;
    this.wdaLocalPort = args.wdaLocalPort;
    this.iosLogAlreadyShown = args.showIOSLog;
    this.showXcodeLog = !!args.showXcodeLog;
    this.xcodeConfigFile = args.xcodeConfigFile;
    this.keychainPath = args.keychainPath;
    this.keychainPassword = args.keychainPassword;

    this.usePrebuiltWDA = args.usePrebuiltWDA;
  }

  _createClass(WebDriverAgent, [{
    key: 'setWDAPaths',
    value: function setWDAPaths(bootstrapPath, agentPath) {
      // allow the user to specify a place for WDA. This is undocumented and
      // only here for the purposes of testing development of WDA
      this.bootstrapPath = bootstrapPath || BOOTSTRAP_PATH;
      _logger2['default'].info('Using WDA path: \'' + this.bootstrapPath + '\'');

      // for backward compatibility we need to be able to specify agentPath too
      this.agentPath = agentPath || _path2['default'].resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');
      _logger2['default'].info('Using WDA agent: \'' + this.agentPath + '\'');
    }
  }, {
    key: 'uninstall',
    value: function uninstall() {
      return _regeneratorRuntime.async(function uninstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Removing WDA application from device');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.device.removeApp(WDA_BUNDLE_ID));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launch',
    value: function launch(sessionId) {
      var agentUrl, localport;
      return _regeneratorRuntime.async(function launch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Launching WebDriverAgent on the device');

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.agentPath));

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 5;
              break;
            }

            throw new Error('Trying to use WebDriverAgent project at \'' + this.agentPath + '\' but the ' + 'file does not exist');

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.checkForDependencies());

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.killHangingProcesses());

          case 9:
            if (!this.realDevice) {
              context$2$0.next = 15;
              break;
            }

            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.createRealDeviceLogsSubProcess());

          case 12:
            this.deviceLogs = context$2$0.sent;
            context$2$0.next = 18;
            break;

          case 15:
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.createSimLogsSubProcess());

          case 17:
            this.deviceLogs = context$2$0.sent;

          case 18:
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.createXcodeBuildSubProcess());

          case 20:
            this.xcodebuild = context$2$0.sent;
            context$2$0.next = 23;
            return _regeneratorRuntime.awrap(this.startXcodebuild());

          case 23:
            agentUrl = context$2$0.sent;

            this.url = _url2['default'].parse(agentUrl);

            this.url.hostname = 'localhost';

            if (!this.realDevice) {
              context$2$0.next = 32;
              break;
            }

            localport = this.wdaLocalPort || this.url.port;

            this.iproxy = this.createiProxySubProcess(localport, this.url.port);
            context$2$0.next = 31;
            return _regeneratorRuntime.awrap(this.startiproxy());

          case 31:
            this.url.port = localport;

          case 32:

            this.setupProxy(sessionId);

            return context$2$0.abrupt('return', agentUrl);

          case 34:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupProxy',
    value: function setupProxy(sessionId) {
      this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.url.hostname, port: this.url.port, base: '' });
      this.jwproxy.sessionId = sessionId;
      this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    }
  }, {
    key: 'checkForDependencies',
    value: function checkForDependencies() {
      var carthagePath;
      return _regeneratorRuntime.async(function checkForDependencies$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.which('carthage'));

          case 3:
            carthagePath = context$2$0.sent;

            _logger2['default'].debug('Carthage found: ' + carthagePath);
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].info('Carthage not found. Install using `brew install carthage`');

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Carthage'));

          case 12:
            if (context$2$0.sent) {
              context$2$0.next = 16;
              break;
            }

            _logger2['default'].debug('Running WebDriverAgent bootstrap script to install dependencies');
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('/bin/bash', ['Scripts/bootstrap.sh', '-d'], { cwd: this.bootstrapPath }));

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources'));

          case 18:
            if (context$2$0.sent) {
              context$2$0.next = 22;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resources directory');
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources'));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 24:
            if (context$2$0.sent) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resource bundle directory');
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 7]]);
    }
  }, {
    key: 'getXcodeBuildCommand',
    value: function getXcodeBuildCommand() {
      var cmd = 'xcodebuild';
      var args = undefined;

      var GENERIC_ARGS = ['-project', this.agentPath, '-scheme', 'WebDriverAgentRunner', '-destination', 'id=' + this.device.udid, '-configuration', 'Debug'];

      if (this.realDevice) {
        var _args;

        args = ['build', 'test'];
        (_args = args).push.apply(_args, GENERIC_ARGS);
        if (this.xcodeConfigFile) {
          _logger2['default'].debug('Using Xcode configuration file: \'' + this.xcodeConfigFile + '\'');
          args.push('-xcconfig', this.xcodeConfigFile);
        }

        if (this.usePrebuiltWDA) {
          _logger2['default'].warn('\'usePrebuiltWDA\' set, but on real device, so skipping');
        }
      } else {
        var _args2;

        if (this.xcodeVersion.major < 8) {
          args = ['build', 'test'];
        } else {
          args = this.usePrebuiltWDA ? ['test-without-building'] : ['build-for-testing', 'test-without-building'];
        }
        (_args2 = args).push.apply(_args2, GENERIC_ARGS);
      }
      return { cmd: cmd, args: args };
    }
  }, {
    key: 'setRealDeviceSecurity',
    value: function setRealDeviceSecurity(keychainPath, keychainPassword) {
      return _regeneratorRuntime.async(function setRealDeviceSecurity$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Setting security for iOS device');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]));

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createXcodeBuildSubProcess',
    value: function createXcodeBuildSubProcess() {
      var _getXcodeBuildCommand, cmd, args, xcodebuild, logXcodeOutput;

      return _regeneratorRuntime.async(function createXcodeBuildSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.realDevice) {
              context$2$0.next = 4;
              break;
            }

            if (!(this.keychainPath && this.keychainPassword)) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.setRealDeviceSecurity(this.keychainPath, this.keychainPassword));

          case 4:
            _getXcodeBuildCommand = this.getXcodeBuildCommand();
            cmd = _getXcodeBuildCommand.cmd;
            args = _getXcodeBuildCommand.args;

            _logger2['default'].debug('Beginning test with command \'' + cmd + ' ' + args.join(' ') + '\' ' + ('in directory \'' + this.bootstrapPath + '\''));
            xcodebuild = new _teen_process.SubProcess(cmd, args, { cwd: this.bootstrapPath });
            logXcodeOutput = this.showXcodeLog;

            xcodebuild.on('output', function (stdout, stderr) {
              var out = stdout || stderr;
              // we want to pull out the log file that is created, and highlight it
              // for diagnostic purposes
              if (out.indexOf('Writing diagnostic log for test session to') !== -1) {
                // pull out the first line that begins with the path separator
                // which *should* be the line indicating the log file generated
                var logLocation = _lodash2['default'].first(_lodash2['default'].remove(out.trim().split('\n'), function (v) {
                  return v.indexOf(_path2['default'].sep) === 0;
                }));
                _logger2['default'].debug('Log file for xcodebuild test: ' + logLocation);
              }

              // if we have an error we want to output the logs
              // otherwise the failure is inscrutible
              if (out.indexOf('Error Domain=') !== -1) {
                logXcodeOutput = true;
              }

              if (logXcodeOutput) {
                xcodeLog.info(out);

                // terrible hack to handle case where xcode return 0 but is failing
                xcodebuild._wda_error_occurred = true;
              }
            });

            return context$2$0.abrupt('return', xcodebuild);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSimLogsSubProcess',
    value: function createSimLogsSubProcess() {
      var args, logs;
      return _regeneratorRuntime.async(function createSimLogsSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['-f', '-n', '0', _path2['default'].resolve(this.device.getLogDir(), 'system.log')];
            logs = new _teen_process.SubProcess('tail', args);

            this.setupLogging(logs, 'Sim');
            return context$2$0.abrupt('return', logs);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createiProxySubProcess',
    value: function createiProxySubProcess(localport, deviceport) {
      _logger2['default'].debug('Starting iproxy to forward traffic from local port ' + localport + ' to device port ' + deviceport + ' over USB');
      return new _teen_process.SubProcess('iproxy', [localport, deviceport, this.device.udid]);
    }
  }, {
    key: 'createRealDeviceLogsSubProcess',
    value: function createRealDeviceLogsSubProcess() {
      var checkForLogger, stat, logs;
      return _regeneratorRuntime.async(function createRealDeviceLogsSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            checkForLogger = function checkForLogger(logger) {
              return _regeneratorRuntime.async(function checkForLogger$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.which(logger));

                  case 3:
                    context$3$0.next = 10;
                    break;

                  case 5:
                    context$3$0.prev = 5;
                    context$3$0.t0 = context$3$0['catch'](0);
                    context$3$0.next = 9;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(logger));

                  case 9:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 10:
                    return context$3$0.abrupt('return', true);

                  case 11:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[0, 5]]);
            };

            context$2$0.t0 = this.realDeviceLogger.indexOf('deviceconsole') !== -1;

            if (!context$2$0.t0) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.realDeviceLogger));

          case 5:
            context$2$0.t0 = context$2$0.sent;

          case 6:
            if (!context$2$0.t0) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.stat(this.realDeviceLogger));

          case 9:
            stat = context$2$0.sent;

            if (stat.isDirectory()) {
              _logger2['default'].warn('Real device logger \'' + this.realDeviceLogger + '\' is a directory. Appending \'deviceconsole\' executable');
              this.realDeviceLogger = _path2['default'].resolve(this.realDeviceLogger, 'deviceconsole');
            }

          case 11:
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(checkForLogger(this.realDeviceLogger));

          case 13:
            if (context$2$0.sent) {
              context$2$0.next = 15;
              break;
            }

            throw new Error('Unable to find real device logging program \'' + this.realDeviceLogger + '\'');

          case 15:
            _logger2['default'].debug('Using real device logger \'' + this.realDeviceLogger + '\'');

            logs = new _teen_process.SubProcess(this.realDeviceLogger, ['-u', this.device.udid]);

            this.setupLogging(logs, 'Device');
            return context$2$0.abrupt('return', logs);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupLogging',
    value: function setupLogging(logs, prefix) {
      var _this = this;

      var loggingStarted = !this.realDevice;
      var startTime = new Date();
      function shouldStartLogging(row) {
        var logRowParts = row.split(/\s+/);
        var logRowDate = new Date(startTime.getFullYear() + ' ' + logRowParts[0] + ' ' + logRowParts[1] + ' ' + logRowParts[2]);
        loggingStarted = logRowDate.isAfter(startTime);
        return loggingStarted;
      }

      function isPertinentLogLine(line) {
        return line.length && (line.indexOf(AGENT_LOG_PREFIX) !== -1 || line.indexOf(AGENT_RUNNER_LOG_PREFIX) !== -1 || line.indexOf(SIM_BRIDGE_LOG_PREFIX) !== -1);
      }

      if (this.realDevice && this.realDeviceLogger.indexOf('idevicesyslog') !== -1) {
        // we are using idevicesyslog, which sometimes cannot connect to the device
        // at which time the system will not be able to figure out that the process
        // has started
        logs.on('output', function (stdout, stderr) {
          var errorString = 'Could not start logger for udid';
          if (stdout.indexOf(errorString) !== -1 || stderr.indexOf(errorString) !== -1) {
            // unfortunately we have no way to stopping the process, so just log overtly
            var msg = 'The real device logger \'' + _this.realDeviceLogger + '\' was ' + 'unable to start log capture. Please try installing ' + '\'deviceconsole\' (\'npm install -g deviceconsole\') and ' + 'specify the path to it using the \'realDeviceLogger\' capability.';
            _logger2['default'].error(msg);
          }
        });
      }

      if (!this.iosLogAlreadyShown) {
        logs.on('output', function (stdout, stderr) {
          var out = stdout || stderr;
          // make sure we are not reading logs from before this test run
          if (!loggingStarted && !shouldStartLogging(out)) {
            return;
          }
          if (isPertinentLogLine(out)) {
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = _getIterator(out.split("\n").filter(Boolean)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var line = _step.value;

                agentLog.debug(prefix + ': ' + line);
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator['return']) {
                  _iterator['return']();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }
          }
        });
      }
    }
  }, {
    key: 'startXcodebuild',
    value: function startXcodebuild() {
      return _regeneratorRuntime.async(function startXcodebuild$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var startTime, agentUrl, msg;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.xcodebuild.on('exit', function (code, signal) {
                      _logger2['default'].info('xcodebuild exited with code \'' + code + '\' and signal \'' + signal + '\'');
                      if (_this2.xcodebuild._wda_error_occurred || !signal && code !== 0) {
                        return reject(new Error('xcodebuild failed with code ' + code));
                      }
                    });

                    this.deviceLogs.on('exit', function (code) {
                      var msg = (_this2.realDevice ? 'System' : 'Simulator') + ' log exited with code \'' + code + '\'';
                      _logger2['default'].info(msg);
                      if (code) {
                        return reject(msg);
                      }
                    });

                    context$3$0.prev = 2;
                    startTime = new Date();
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap(this.xcodebuild.start());

                  case 6:
                    context$3$0.next = 8;
                    return _regeneratorRuntime.awrap(this.waitForStart(startTime));

                  case 8:
                    agentUrl = context$3$0.sent;

                    resolve(agentUrl);
                    context$3$0.next = 17;
                    break;

                  case 12:
                    context$3$0.prev = 12;
                    context$3$0.t0 = context$3$0['catch'](2);
                    msg = 'Unable to start WebDriverAgent: ' + context$3$0.t0;

                    _logger2['default'].error(msg);
                    return context$3$0.abrupt('return', reject(msg));

                  case 17:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[2, 12]]);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForStart',
    value: function waitForStart(startTime) {
      var agentUrl, lineCount, reachedEnd, showWaitingMessage, startDetector;
      return _regeneratorRuntime.async(function waitForStart$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.realDevice) {
              context$2$0.next = 3;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _simulatorManagementJs.systemLogExists)(this.device));

          case 3:
            agentUrl = undefined;
            lineCount = 0;
            reachedEnd = !this.realDevice;
            showWaitingMessage = true;

            startDetector = function startDetector(stdout) {
              // on a real device there may already be system logs that need to be
              // passed before we get to the real startup logs, otherwise
              // we expect two lines, one after another
              //     Jul 20 13:03:57 iamPhone XCTRunner[296] <Warning>: Built at Jul 20 2016 13:03:50
              //     Jul 20 13:03:57 iamPhone XCTRunner[296] <Warning>: ServerURLHere->http://10.35.4.122:8100<-ServerURLHere
              if (!reachedEnd) {
                var dateMatch = REAL_DEVICE_BUILD_LOG_STARTTIME_REGEX.exec(stdout);
                if (dateMatch) {
                  var buildTime = new Date(dateMatch[1]);
                  if (buildTime.isAfter(startTime)) {
                    reachedEnd = true;
                  }
                }
              }

              if (reachedEnd) {
                var match = AGENT_STARTED_REGEX.exec(stdout);
                if (match) {
                  agentUrl = match[1];
                  _logger2['default'].info('Detected that WebDriverAgent is running at url \'' + agentUrl + '\'');
                  if (!agentUrl) {
                    _logger2['default'].errorAndThrow(new Error('No url detected from WebDriverAgent'));
                  }
                  showWaitingMessage = false;
                  return true;
                }
              }

              // periodically log, so it does not look like everything died
              lineCount++;
              var threshold = _this4.realDevice ? 5000 : 200;
              if (showWaitingMessage && lineCount % threshold === 0) {
                _logger2['default'].debug('Waiting for WebDriverAgent server to finish loading...');
              }

              return false;
            };

            _logger2['default'].info('Waiting for WebDriverAgent to start on device');
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.deviceLogs.start(startDetector));

          case 11:
            _logger2['default'].info('WebDriverAgent started at url \'' + agentUrl + '\'');

            return context$2$0.abrupt('return', agentUrl);

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startiproxy',
    value: function startiproxy() {
      return _regeneratorRuntime.async(function startiproxy$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function callee$2$0(resolve, reject) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.iproxy.on('exit', function (code) {
                      _logger2['default'].warn('iproxy exited with code \'' + code + '\'');
                      if (code) {
                        return reject(new Error('iproxy exited with code \'' + code + '\''));
                      }
                    });
                    this.iproxy.on('output', function (stdout, stderr) {
                      var out = stdout || stderr;
                      var _iteratorNormalCompletion2 = true;
                      var _didIteratorError2 = false;
                      var _iteratorError2 = undefined;

                      try {
                        for (var _iterator2 = _getIterator(out.split('\n')), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                          var line = _step2.value;

                          if (!line.length) continue;
                          iproxyLog.debug(line);
                        }
                      } catch (err) {
                        _didIteratorError2 = true;
                        _iteratorError2 = err;
                      } finally {
                        try {
                          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                            _iterator2['return']();
                          }
                        } finally {
                          if (_didIteratorError2) {
                            throw _iteratorError2;
                          }
                        }
                      }
                    });

                    context$3$0.prev = 2;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(this.iproxy.start(5000));

                  case 5:
                    resolve();
                    context$3$0.next = 12;
                    break;

                  case 8:
                    context$3$0.prev = 8;
                    context$3$0.t0 = context$3$0['catch'](2);

                    _logger2['default'].error('Error starting iproxy: \'' + context$3$0.t0.message + '\'');
                    reject('Unable to start iproxy. Is it installed?');

                  case 12:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5, [[2, 8]]);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'killHangingProcesses',
    value: function killHangingProcesses() {
      var procNames, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, proc;

      return _regeneratorRuntime.async(function killHangingProcesses$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Killing hanging processes');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAppUsingAppName)(this.device.udid, 'xcodebuild'));

          case 3:
            procNames = this.realDevice ? [this.realDeviceLogger, 'iproxy'] : ['tail', 'XCTRunner'];
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 7;
            _iterator3 = _getIterator(procNames);

          case 9:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              context$2$0.next = 16;
              break;
            }

            proc = _step3.value;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAppUsingAppName)(this.device.udid, proc));

          case 13:
            _iteratorNormalCompletion3 = true;
            context$2$0.next = 9;
            break;

          case 16:
            context$2$0.next = 22;
            break;

          case 18:
            context$2$0.prev = 18;
            context$2$0.t0 = context$2$0['catch'](7);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t0;

          case 22:
            context$2$0.prev = 22;
            context$2$0.prev = 23;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 25:
            context$2$0.prev = 25;

            if (!_didIteratorError3) {
              context$2$0.next = 28;
              break;
            }

            throw _iteratorError3;

          case 28:
            return context$2$0.finish(25);

          case 29:
            return context$2$0.finish(22);

          case 30:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
    }
  }, {
    key: 'quit',
    value: function quit() {
      var killProcess;
      return _regeneratorRuntime.async(function quit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            killProcess = function killProcess(name, proc) {
              return _regeneratorRuntime.async(function killProcess$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!(proc && proc.proc)) {
                      context$3$0.next = 22;
                      break;
                    }

                    _logger2['default'].info('Shutting down ' + name + ' process (pid ' + proc.proc.pid + ')');
                    context$3$0.prev = 2;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(proc.stop('SIGTERM'));

                  case 5:
                    context$3$0.next = 22;
                    break;

                  case 7:
                    context$3$0.prev = 7;
                    context$3$0.t0 = context$3$0['catch'](2);

                    if (!(context$3$0.t0.message.indexOf('Process didn\'t end after') === -1)) {
                      context$3$0.next = 11;
                      break;
                    }

                    throw context$3$0.t0;

                  case 11:
                    _logger2['default'].debug(name + ' process did not end in a timely fashion: \'' + context$3$0.t0.message + '\'. ' + 'Sending \'SIGKILL\'...');
                    context$3$0.prev = 12;
                    context$3$0.next = 15;
                    return _regeneratorRuntime.awrap(proc.stop('SIGKILL'));

                  case 15:
                    context$3$0.next = 22;
                    break;

                  case 17:
                    context$3$0.prev = 17;
                    context$3$0.t1 = context$3$0['catch'](12);

                    if (!(context$3$0.t1.message.indexOf('not currently running') !== -1)) {
                      context$3$0.next = 21;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 21:
                    throw context$3$0.t1;

                  case 22:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[2, 7], [12, 17]]);
            };

            _logger2['default'].info('Shutting down sub-processes');

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(killProcess('xcodebuild', this.xcodebuild));

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(killProcess('Logger', this.deviceLogs));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(killProcess('iproxy', this.iproxy));

          case 8:

            if (this.jwproxy) {
              this.jwproxy.sessionId = null;
            }

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return WebDriverAgent;
})();

exports['default'] = WebDriverAgent;
exports.WebDriverAgent = WebDriverAgent;
exports.WDA_BUNDLE_ID = WDA_BUNDLE_ID;

// make sure that the WDA library has been built

//kill all hanging processes

// start the logging process

// start the xcodebuild process

// the logger can be the name of a program on the PATH
// or a path to the program

// not on the PATH, so see if it is an accessible path itself

// no error thrown, so all is well

// the user might have passed in the directory for `deviceconsole`, in which case we want to
// make sure we use the executable

// we have no logger

// wrap the start procedure in a promise so that we can catch, and report,
// any startup errors that are thrown as events

// we have to wait for the sim to start before we can tail the log file
// simulator does not need to wait, since we are tailing
// turn off logging once we have hit the end

// the process ended but for some reason we were not informed
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxTQUFTLENBQUM7Ozs7Ozs7Ozs7MEJBRXRCLGVBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztBQWhCL0QsZ0NBQUksSUFBSSxDQUFDLDZCQUE2QixDQUFDLENBQUM7Ozs2Q0EwQmxDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQzs7Ozs2Q0FDMUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDOzs7OzZDQUN0QyxXQUFXLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUM7Ozs7QUFFeEMsZ0JBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtBQUNoQixrQkFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO2FBQy9COzs7Ozs7O0tBQ0Y7OztTQTFjRyxjQUFjOzs7cUJBNmNMLGNBQWM7UUFDcEIsY0FBYyxHQUFkLGNBQWM7UUFBRSxhQUFhLEdBQWIsYUFBYSIsImZpbGUiOiJsaWIvd2ViZHJpdmVyYWdlbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBTdWJQcm9jZXNzLCBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGdldExvZ2dlciB9IGZyb20gJ2FwcGl1bS1sb2dnZXInO1xuaW1wb3J0IHsgc3lzdGVtTG9nRXhpc3RzIH0gZnJvbSAnLi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyc7XG5pbXBvcnQgeyBraWxsQXBwVXNpbmdBcHBOYW1lIH0gZnJvbSAnLi91dGlscy5qcyc7XG5cbmNvbnN0IGFnZW50TG9nID0gZ2V0TG9nZ2VyKCdXZWJEcml2ZXJBZ2VudCcpO1xuY29uc3QgeGNvZGVMb2cgPSBnZXRMb2dnZXIoJ1hjb2RlJyk7XG5jb25zdCBpcHJveHlMb2cgPSBnZXRMb2dnZXIoJ2lQcm94eScpO1xuXG5jb25zdCBCT09UU1RSQVBfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdXZWJEcml2ZXJBZ2VudCcpO1xuY29uc3QgQUdFTlRfTE9HX1BSRUZJWCA9ICdYQ1RTdHViQXBwc1snO1xuY29uc3QgQUdFTlRfUlVOTkVSX0xPR19QUkVGSVggPSAnWENUUnVubmVyWyc7XG5jb25zdCBTSU1fQlJJREdFX0xPR19QUkVGSVggPSAnQ29yZVNpbXVsYXRvckJyaWRnZVsnO1xuY29uc3QgQUdFTlRfU1RBUlRFRF9SRUdFWCA9IC9TZXJ2ZXJVUkxIZXJlLT4oLiopPC1TZXJ2ZXJVUkxIZXJlLztcbmNvbnN0IFJFQUxfREVWSUNFX0JVSUxEX0xPR19TVEFSVFRJTUVfUkVHRVggPSAvQnVpbHQgYXQgKFxcd3szfSBbXFxkXFxzXVxcZCBcXGR7NH0gXFxkezJ9OlxcZHsyfTpcXGR7Mn0pLztcbmNvbnN0IFJFQUxfREVWSUNFX0xPR0dFUl9QQVRIID0gJ2lkZXZpY2VzeXNsb2cnO1xuY29uc3QgV0RBX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUudGVzdC5XZWJEcml2ZXJBZ2VudFJ1bm5lci1SdW5uZXInO1xuXG5jbGFzcyBXZWJEcml2ZXJBZ2VudCB7XG5cbiAgLy8gYWdlbnRQYXRoIChvcHRpb25hbCk6IFBhdGggdG8gV2ViZHJpdmVyQWdlbnQgRXhlY3V0YWJsZSAoaW5zaWRlIFdlYkRyaXZlckFnZW50LmFwcClcbiAgY29uc3RydWN0b3IgKHhjb2RlVmVyc2lvbiwgYXJncyA9IHt9KSB7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSB4Y29kZVZlcnNpb247XG5cbiAgICB0aGlzLmRldmljZSA9IGFyZ3MuZGV2aWNlO1xuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gYXJncy5wbGF0Zm9ybVZlcnNpb247XG4gICAgdGhpcy5ob3N0ID0gYXJncy5ob3N0O1xuICAgIHRoaXMucmVhbERldmljZSA9ICEhYXJncy5yZWFsRGV2aWNlO1xuXG4gICAgdGhpcy5zZXRXREFQYXRocyhhcmdzLmJvb3RzdHJhcFBhdGgsIGFyZ3MuYWdlbnRQYXRoKTtcblxuICAgIHRoaXMucmVhbERldmljZUxvZ2dlciA9IGFyZ3MucmVhbERldmljZUxvZ2dlciB8fCBSRUFMX0RFVklDRV9MT0dHRVJfUEFUSDtcbiAgICB0aGlzLndkYUxvY2FsUG9ydCA9IGFyZ3Mud2RhTG9jYWxQb3J0O1xuICAgIHRoaXMuaW9zTG9nQWxyZWFkeVNob3duID0gYXJncy5zaG93SU9TTG9nO1xuICAgIHRoaXMuc2hvd1hjb2RlTG9nID0gISFhcmdzLnNob3dYY29kZUxvZztcbiAgICB0aGlzLnhjb2RlQ29uZmlnRmlsZSA9IGFyZ3MueGNvZGVDb25maWdGaWxlO1xuICAgIHRoaXMua2V5Y2hhaW5QYXRoID0gYXJncy5rZXljaGFpblBhdGg7XG4gICAgdGhpcy5rZXljaGFpblBhc3N3b3JkID0gYXJncy5rZXljaGFpblBhc3N3b3JkO1xuXG4gICAgdGhpcy51c2VQcmVidWlsdFdEQSA9IGFyZ3MudXNlUHJlYnVpbHRXREE7XG4gIH1cblxuICBzZXRXREFQYXRocyAoYm9vdHN0cmFwUGF0aCwgYWdlbnRQYXRoKSB7XG4gICAgLy8gYWxsb3cgdGhlIHVzZXIgdG8gc3BlY2lmeSBhIHBsYWNlIGZvciBXREEuIFRoaXMgaXMgdW5kb2N1bWVudGVkIGFuZFxuICAgIC8vIG9ubHkgaGVyZSBmb3IgdGhlIHB1cnBvc2VzIG9mIHRlc3RpbmcgZGV2ZWxvcG1lbnQgb2YgV0RBXG4gICAgdGhpcy5ib290c3RyYXBQYXRoID0gYm9vdHN0cmFwUGF0aCB8fCBCT09UU1RSQVBfUEFUSDtcbiAgICBsb2cuaW5mbyhgVXNpbmcgV0RBIHBhdGg6ICcke3RoaXMuYm9vdHN0cmFwUGF0aH0nYCk7XG5cbiAgICAvLyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3ZSBuZWVkIHRvIGJlIGFibGUgdG8gc3BlY2lmeSBhZ2VudFBhdGggdG9vXG4gICAgdGhpcy5hZ2VudFBhdGggPSBhZ2VudFBhdGggfHwgcGF0aC5yZXNvbHZlKHRoaXMuYm9vdHN0cmFwUGF0aCwgJ1dlYkRyaXZlckFnZW50Lnhjb2RlcHJvaicpO1xuICAgIGxvZy5pbmZvKGBVc2luZyBXREEgYWdlbnQ6ICcke3RoaXMuYWdlbnRQYXRofSdgKTtcbiAgfVxuXG4gIGFzeW5jIHVuaW5zdGFsbCAoKSB7XG4gICAgbG9nLmRlYnVnKGBSZW1vdmluZyBXREEgYXBwbGljYXRpb24gZnJvbSBkZXZpY2VgKTtcbiAgICBhd2FpdCB0aGlzLmRldmljZS5yZW1vdmVBcHAoV0RBX0JVTkRMRV9JRCk7XG4gIH1cblxuICBhc3luYyBsYXVuY2ggKHNlc3Npb25JZCkge1xuICAgIGxvZy5pbmZvKCdMYXVuY2hpbmcgV2ViRHJpdmVyQWdlbnQgb24gdGhlIGRldmljZScpO1xuXG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHModGhpcy5hZ2VudFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyeWluZyB0byB1c2UgV2ViRHJpdmVyQWdlbnQgcHJvamVjdCBhdCAnJHt0aGlzLmFnZW50UGF0aH0nIGJ1dCB0aGUgYCArXG4gICAgICAgICAgICAgICAgICAgICAgJ2ZpbGUgZG9lcyBub3QgZXhpc3QnKTtcbiAgICB9XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgV0RBIGxpYnJhcnkgaGFzIGJlZW4gYnVpbHRcbiAgICBhd2FpdCB0aGlzLmNoZWNrRm9yRGVwZW5kZW5jaWVzKCk7XG5cbiAgICAvL2tpbGwgYWxsIGhhbmdpbmcgcHJvY2Vzc2VzXG4gICAgYXdhaXQgdGhpcy5raWxsSGFuZ2luZ1Byb2Nlc3NlcygpO1xuXG4gICAgLy8gc3RhcnQgdGhlIGxvZ2dpbmcgcHJvY2Vzc1xuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIHRoaXMuZGV2aWNlTG9ncyA9IGF3YWl0IHRoaXMuY3JlYXRlUmVhbERldmljZUxvZ3NTdWJQcm9jZXNzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGV2aWNlTG9ncyA9IGF3YWl0IHRoaXMuY3JlYXRlU2ltTG9nc1N1YlByb2Nlc3MoKTtcbiAgICB9XG5cbiAgICB0aGlzLnhjb2RlYnVpbGQgPSBhd2FpdCB0aGlzLmNyZWF0ZVhjb2RlQnVpbGRTdWJQcm9jZXNzKCk7XG5cbiAgICAvLyBzdGFydCB0aGUgeGNvZGVidWlsZCBwcm9jZXNzXG4gICAgbGV0IGFnZW50VXJsID0gYXdhaXQgdGhpcy5zdGFydFhjb2RlYnVpbGQoKTtcblxuICAgIHRoaXMudXJsID0gdXJsLnBhcnNlKGFnZW50VXJsKTtcblxuICAgIHRoaXMudXJsLmhvc3RuYW1lID0gJ2xvY2FsaG9zdCc7XG4gICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgbGV0IGxvY2FscG9ydCA9IHRoaXMud2RhTG9jYWxQb3J0IHx8IHRoaXMudXJsLnBvcnQ7XG4gICAgICB0aGlzLmlwcm94eSA9IHRoaXMuY3JlYXRlaVByb3h5U3ViUHJvY2Vzcyhsb2NhbHBvcnQsIHRoaXMudXJsLnBvcnQpO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydGlwcm94eSgpO1xuICAgICAgdGhpcy51cmwucG9ydCA9IGxvY2FscG9ydDtcbiAgICB9XG5cbiAgICB0aGlzLnNldHVwUHJveHkoc2Vzc2lvbklkKTtcblxuICAgIHJldHVybiBhZ2VudFVybDtcbiAgfVxuXG4gIHNldHVwUHJveHkgKHNlc3Npb25JZCkge1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMudXJsLmhvc3RuYW1lLCBwb3J0OiB0aGlzLnVybC5wb3J0LCBiYXNlOiAnJ30pO1xuICAgIHRoaXMuandwcm94eS5zZXNzaW9uSWQgPSBzZXNzaW9uSWQ7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG4gIH1cblxuICBhc3luYyBjaGVja0ZvckRlcGVuZGVuY2llcyAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBjYXJ0aGFnZVBhdGggPSBhd2FpdCBmcy53aGljaCgnY2FydGhhZ2UnKTtcbiAgICAgIGxvZy5kZWJ1ZyhgQ2FydGhhZ2UgZm91bmQ6ICR7Y2FydGhhZ2VQYXRofWApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmluZm8oJ0NhcnRoYWdlIG5vdCBmb3VuZC4gSW5zdGFsbCB1c2luZyBgYnJldyBpbnN0YWxsIGNhcnRoYWdlYCcpO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHt0aGlzLmJvb3RzdHJhcFBhdGh9L0NhcnRoYWdlYCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnUnVubmluZyBXZWJEcml2ZXJBZ2VudCBib290c3RyYXAgc2NyaXB0IHRvIGluc3RhbGwgZGVwZW5kZW5jaWVzJyk7XG4gICAgICBhd2FpdCBleGVjKCcvYmluL2Jhc2gnLCBbJ1NjcmlwdHMvYm9vdHN0cmFwLnNoJywgJy1kJ10sIHtjd2Q6IHRoaXMuYm9vdHN0cmFwUGF0aH0pO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHt0aGlzLmJvb3RzdHJhcFBhdGh9L1Jlc291cmNlc2ApKSB7XG4gICAgICBsb2cuZGVidWcoJ0NyZWF0aW5nIFdlYkRyaXZlckFnZW50IHJlc291cmNlcyBkaXJlY3RvcnknKTtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzYCk7XG4gICAgfVxuICAgIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApKSB7XG4gICAgICBsb2cuZGVidWcoJ0NyZWF0aW5nIFdlYkRyaXZlckFnZW50IHJlc291cmNlIGJ1bmRsZSBkaXJlY3RvcnknKTtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApO1xuICAgIH1cbiAgfVxuXG4gIGdldFhjb2RlQnVpbGRDb21tYW5kICgpIHtcbiAgICBsZXQgY21kID0gJ3hjb2RlYnVpbGQnO1xuICAgIGxldCBhcmdzO1xuXG4gICAgY29uc3QgR0VORVJJQ19BUkdTID0gW1xuICAgICAgJy1wcm9qZWN0JywgdGhpcy5hZ2VudFBhdGgsXG4gICAgICAnLXNjaGVtZScsICdXZWJEcml2ZXJBZ2VudFJ1bm5lcicsXG4gICAgICAnLWRlc3RpbmF0aW9uJywgYGlkPSR7dGhpcy5kZXZpY2UudWRpZH1gLFxuICAgICAgJy1jb25maWd1cmF0aW9uJywgJ0RlYnVnJ1xuICAgIF07XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICBhcmdzID0gWydidWlsZCcsICd0ZXN0J107XG4gICAgICBhcmdzLnB1c2goLi4uR0VORVJJQ19BUkdTKTtcbiAgICAgIGlmICh0aGlzLnhjb2RlQ29uZmlnRmlsZSkge1xuICAgICAgICBsb2cuZGVidWcoYFVzaW5nIFhjb2RlIGNvbmZpZ3VyYXRpb24gZmlsZTogJyR7dGhpcy54Y29kZUNvbmZpZ0ZpbGV9J2ApO1xuICAgICAgICBhcmdzLnB1c2goJy14Y2NvbmZpZycsIHRoaXMueGNvZGVDb25maWdGaWxlKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMudXNlUHJlYnVpbHRXREEpIHtcbiAgICAgICAgbG9nLndhcm4oYCd1c2VQcmVidWlsdFdEQScgc2V0LCBidXQgb24gcmVhbCBkZXZpY2UsIHNvIHNraXBwaW5nYCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLnhjb2RlVmVyc2lvbi5tYWpvciA8IDgpIHtcbiAgICAgICAgYXJncyA9W1xuICAgICAgICAgICdidWlsZCcsXG4gICAgICAgICAgJ3Rlc3QnLFxuICAgICAgICBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXJncyA9IHRoaXMudXNlUHJlYnVpbHRXREEgPyBbXG4gICAgICAgICAgJ3Rlc3Qtd2l0aG91dC1idWlsZGluZydcbiAgICAgICAgXSA6IFtcbiAgICAgICAgICAnYnVpbGQtZm9yLXRlc3RpbmcnLFxuICAgICAgICAgICd0ZXN0LXdpdGhvdXQtYnVpbGRpbmcnXG4gICAgICAgIF07XG4gICAgICB9XG4gICAgICBhcmdzLnB1c2goLi4uR0VORVJJQ19BUkdTKTtcbiAgICB9XG4gICAgcmV0dXJuIHtjbWQsIGFyZ3N9O1xuICB9XG5cbiAgYXN5bmMgc2V0UmVhbERldmljZVNlY3VyaXR5IChrZXljaGFpblBhdGgsIGtleWNoYWluUGFzc3dvcmQpIHtcbiAgICBsb2cuZGVidWcoJ1NldHRpbmcgc2VjdXJpdHkgZm9yIGlPUyBkZXZpY2UnKTtcbiAgICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnLXYnLCAnbGlzdC1rZXljaGFpbnMnLCAnLXMnLCBrZXljaGFpblBhdGhdKTtcbiAgICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnLXYnLCAndW5sb2NrLWtleWNoYWluJywgJy1wJywga2V5Y2hhaW5QYXNzd29yZCwga2V5Y2hhaW5QYXRoXSk7XG4gICAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJ3NldC1rZXljaGFpbi1zZXR0aW5ncycsICctdCcsICczNjAwJywgJy1sJywga2V5Y2hhaW5QYXRoXSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVYY29kZUJ1aWxkU3ViUHJvY2VzcyAoKSB7XG4gICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgaWYgKHRoaXMua2V5Y2hhaW5QYXRoICYmIHRoaXMua2V5Y2hhaW5QYXNzd29yZCkge1xuICAgICAgICBhd2FpdCB0aGlzLnNldFJlYWxEZXZpY2VTZWN1cml0eSh0aGlzLmtleWNoYWluUGF0aCwgdGhpcy5rZXljaGFpblBhc3N3b3JkKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IHtjbWQsIGFyZ3N9ID0gdGhpcy5nZXRYY29kZUJ1aWxkQ29tbWFuZCgpO1xuICAgIGxvZy5kZWJ1ZyhgQmVnaW5uaW5nIHRlc3Qgd2l0aCBjb21tYW5kICcke2NtZH0gJHthcmdzLmpvaW4oJyAnKX0nIGAgK1xuICAgICAgICAgICAgICBgaW4gZGlyZWN0b3J5ICcke3RoaXMuYm9vdHN0cmFwUGF0aH0nYCk7XG4gICAgbGV0IHhjb2RlYnVpbGQgPSBuZXcgU3ViUHJvY2VzcyhjbWQsIGFyZ3MsIHtjd2Q6IHRoaXMuYm9vdHN0cmFwUGF0aH0pO1xuXG4gICAgbGV0IGxvZ1hjb2RlT3V0cHV0ID0gdGhpcy5zaG93WGNvZGVMb2c7XG4gICAgeGNvZGVidWlsZC5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBsZXQgb3V0ID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgIC8vIHdlIHdhbnQgdG8gcHVsbCBvdXQgdGhlIGxvZyBmaWxlIHRoYXQgaXMgY3JlYXRlZCwgYW5kIGhpZ2hsaWdodCBpdFxuICAgICAgLy8gZm9yIGRpYWdub3N0aWMgcHVycG9zZXNcbiAgICAgIGlmIChvdXQuaW5kZXhPZignV3JpdGluZyBkaWFnbm9zdGljIGxvZyBmb3IgdGVzdCBzZXNzaW9uIHRvJykgIT09IC0xKSB7XG4gICAgICAgIC8vIHB1bGwgb3V0IHRoZSBmaXJzdCBsaW5lIHRoYXQgYmVnaW5zIHdpdGggdGhlIHBhdGggc2VwYXJhdG9yXG4gICAgICAgIC8vIHdoaWNoICpzaG91bGQqIGJlIHRoZSBsaW5lIGluZGljYXRpbmcgdGhlIGxvZyBmaWxlIGdlbmVyYXRlZFxuICAgICAgICBsZXQgbG9nTG9jYXRpb24gPSBfLmZpcnN0KF8ucmVtb3ZlKG91dC50cmltKCkuc3BsaXQoJ1xcbicpLCAodikgPT4gdi5pbmRleE9mKHBhdGguc2VwKSA9PT0gMCkpO1xuICAgICAgICBsb2cuZGVidWcoYExvZyBmaWxlIGZvciB4Y29kZWJ1aWxkIHRlc3Q6ICR7bG9nTG9jYXRpb259YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHdlIGhhdmUgYW4gZXJyb3Igd2Ugd2FudCB0byBvdXRwdXQgdGhlIGxvZ3NcbiAgICAgIC8vIG90aGVyd2lzZSB0aGUgZmFpbHVyZSBpcyBpbnNjcnV0aWJsZVxuICAgICAgaWYgKG91dC5pbmRleE9mKCdFcnJvciBEb21haW49JykgIT09IC0xKSB7XG4gICAgICAgIGxvZ1hjb2RlT3V0cHV0ID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGxvZ1hjb2RlT3V0cHV0KSB7XG4gICAgICAgIHhjb2RlTG9nLmluZm8ob3V0KTtcblxuICAgICAgICAvLyB0ZXJyaWJsZSBoYWNrIHRvIGhhbmRsZSBjYXNlIHdoZXJlIHhjb2RlIHJldHVybiAwIGJ1dCBpcyBmYWlsaW5nXG4gICAgICAgIHhjb2RlYnVpbGQuX3dkYV9lcnJvcl9vY2N1cnJlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4geGNvZGVidWlsZDtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNpbUxvZ3NTdWJQcm9jZXNzICgpIHtcbiAgICBsZXQgYXJncyA9IFtcbiAgICAgICctZicsXG4gICAgICAnLW4nLCAnMCcsXG4gICAgICBwYXRoLnJlc29sdmUodGhpcy5kZXZpY2UuZ2V0TG9nRGlyKCksICdzeXN0ZW0ubG9nJylcbiAgICBdO1xuXG4gICAgbGV0IGxvZ3MgPSBuZXcgU3ViUHJvY2VzcygndGFpbCcsIGFyZ3MpO1xuICAgIHRoaXMuc2V0dXBMb2dnaW5nKGxvZ3MsICdTaW0nKTtcbiAgICByZXR1cm4gbG9ncztcbiAgfVxuXG4gIGNyZWF0ZWlQcm94eVN1YlByb2Nlc3MgKGxvY2FscG9ydCwgZGV2aWNlcG9ydCkge1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgaXByb3h5IHRvIGZvcndhcmQgdHJhZmZpYyBmcm9tIGxvY2FsIHBvcnQgJHtsb2NhbHBvcnR9IHRvIGRldmljZSBwb3J0ICR7ZGV2aWNlcG9ydH0gb3ZlciBVU0JgKTtcbiAgICByZXR1cm4gbmV3IFN1YlByb2Nlc3MoYGlwcm94eWAsIFtsb2NhbHBvcnQsIGRldmljZXBvcnQsIHRoaXMuZGV2aWNlLnVkaWRdKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVJlYWxEZXZpY2VMb2dzU3ViUHJvY2VzcyAoKSB7XG4gICAgYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JMb2dnZXIgKGxvZ2dlcikge1xuICAgICAgLy8gdGhlIGxvZ2dlciBjYW4gYmUgdGhlIG5hbWUgb2YgYSBwcm9ncmFtIG9uIHRoZSBQQVRIXG4gICAgICAvLyBvciBhIHBhdGggdG8gdGhlIHByb2dyYW1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLndoaWNoKGxvZ2dlcik7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gbm90IG9uIHRoZSBQQVRILCBzbyBzZWUgaWYgaXQgaXMgYW4gYWNjZXNzaWJsZSBwYXRoIGl0c2VsZlxuICAgICAgICByZXR1cm4gYXdhaXQgZnMuZXhpc3RzKGxvZ2dlcik7XG4gICAgICB9XG5cbiAgICAgIC8vIG5vIGVycm9yIHRocm93biwgc28gYWxsIGlzIHdlbGxcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlYWxEZXZpY2VMb2dnZXIuaW5kZXhPZignZGV2aWNlY29uc29sZScpICE9PSAtMSAmJiBhd2FpdCBmcy5leGlzdHModGhpcy5yZWFsRGV2aWNlTG9nZ2VyKSkge1xuICAgICAgLy8gdGhlIHVzZXIgbWlnaHQgaGF2ZSBwYXNzZWQgaW4gdGhlIGRpcmVjdG9yeSBmb3IgYGRldmljZWNvbnNvbGVgLCBpbiB3aGljaCBjYXNlIHdlIHdhbnQgdG9cbiAgICAgIC8vIG1ha2Ugc3VyZSB3ZSB1c2UgdGhlIGV4ZWN1dGFibGVcbiAgICAgIGxldCBzdGF0ID0gYXdhaXQgZnMuc3RhdCh0aGlzLnJlYWxEZXZpY2VMb2dnZXIpO1xuICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICBsb2cud2FybihgUmVhbCBkZXZpY2UgbG9nZ2VyICcke3RoaXMucmVhbERldmljZUxvZ2dlcn0nIGlzIGEgZGlyZWN0b3J5LiBBcHBlbmRpbmcgJ2RldmljZWNvbnNvbGUnIGV4ZWN1dGFibGVgKTtcbiAgICAgICAgdGhpcy5yZWFsRGV2aWNlTG9nZ2VyID0gcGF0aC5yZXNvbHZlKHRoaXMucmVhbERldmljZUxvZ2dlciwgJ2RldmljZWNvbnNvbGUnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IGNoZWNrRm9yTG9nZ2VyKHRoaXMucmVhbERldmljZUxvZ2dlcikpIHtcbiAgICAgIC8vIHdlIGhhdmUgbm8gbG9nZ2VyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIHJlYWwgZGV2aWNlIGxvZ2dpbmcgcHJvZ3JhbSAnJHt0aGlzLnJlYWxEZXZpY2VMb2dnZXJ9J2ApO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFVzaW5nIHJlYWwgZGV2aWNlIGxvZ2dlciAnJHt0aGlzLnJlYWxEZXZpY2VMb2dnZXJ9J2ApO1xuXG4gICAgbGV0IGxvZ3MgPSBuZXcgU3ViUHJvY2Vzcyh0aGlzLnJlYWxEZXZpY2VMb2dnZXIsIFsnLXUnLCB0aGlzLmRldmljZS51ZGlkXSk7XG4gICAgdGhpcy5zZXR1cExvZ2dpbmcobG9ncywgJ0RldmljZScpO1xuICAgIHJldHVybiBsb2dzO1xuICB9XG5cbiAgc2V0dXBMb2dnaW5nIChsb2dzLCBwcmVmaXgpIHtcbiAgICBsZXQgbG9nZ2luZ1N0YXJ0ZWQgPSAhdGhpcy5yZWFsRGV2aWNlO1xuICAgIGxldCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgIGZ1bmN0aW9uIHNob3VsZFN0YXJ0TG9nZ2luZyAocm93KSB7XG4gICAgICBsZXQgbG9nUm93UGFydHMgPSByb3cuc3BsaXQoL1xccysvKTtcbiAgICAgIGxldCBsb2dSb3dEYXRlID0gbmV3IERhdGUoYCR7c3RhcnRUaW1lLmdldEZ1bGxZZWFyKCl9ICR7bG9nUm93UGFydHNbMF19ICR7bG9nUm93UGFydHNbMV19ICR7bG9nUm93UGFydHNbMl19YCk7XG4gICAgICBsb2dnaW5nU3RhcnRlZCA9IGxvZ1Jvd0RhdGUuaXNBZnRlcihzdGFydFRpbWUpO1xuICAgICAgcmV0dXJuIGxvZ2dpbmdTdGFydGVkO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGlzUGVydGluZW50TG9nTGluZSAobGluZSkge1xuICAgICAgcmV0dXJuIGxpbmUubGVuZ3RoICYmXG4gICAgICAgICAgICAobGluZS5pbmRleE9mKEFHRU5UX0xPR19QUkVGSVgpICE9PSAtMSB8fFxuICAgICAgICAgICAgIGxpbmUuaW5kZXhPZihBR0VOVF9SVU5ORVJfTE9HX1BSRUZJWCkgIT09IC0xIHx8XG4gICAgICAgICAgICAgbGluZS5pbmRleE9mKFNJTV9CUklER0VfTE9HX1BSRUZJWCkgIT09IC0xKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlICYmIHRoaXMucmVhbERldmljZUxvZ2dlci5pbmRleE9mKCdpZGV2aWNlc3lzbG9nJykgIT09IC0xKSB7XG4gICAgICAvLyB3ZSBhcmUgdXNpbmcgaWRldmljZXN5c2xvZywgd2hpY2ggc29tZXRpbWVzIGNhbm5vdCBjb25uZWN0IHRvIHRoZSBkZXZpY2VcbiAgICAgIC8vIGF0IHdoaWNoIHRpbWUgdGhlIHN5c3RlbSB3aWxsIG5vdCBiZSBhYmxlIHRvIGZpZ3VyZSBvdXQgdGhhdCB0aGUgcHJvY2Vzc1xuICAgICAgLy8gaGFzIHN0YXJ0ZWRcbiAgICAgIGxvZ3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgZXJyb3JTdHJpbmcgPSAnQ291bGQgbm90IHN0YXJ0IGxvZ2dlciBmb3IgdWRpZCc7XG4gICAgICAgIGlmIChzdGRvdXQuaW5kZXhPZihlcnJvclN0cmluZykgIT09IC0xIHx8IHN0ZGVyci5pbmRleE9mKGVycm9yU3RyaW5nKSAhPT0gLTEpIHtcbiAgICAgICAgICAvLyB1bmZvcnR1bmF0ZWx5IHdlIGhhdmUgbm8gd2F5IHRvIHN0b3BwaW5nIHRoZSBwcm9jZXNzLCBzbyBqdXN0IGxvZyBvdmVydGx5XG4gICAgICAgICAgbGV0IG1zZyA9IGBUaGUgcmVhbCBkZXZpY2UgbG9nZ2VyICcke3RoaXMucmVhbERldmljZUxvZ2dlcn0nIHdhcyBgICtcbiAgICAgICAgICAgICAgICAgICAgYHVuYWJsZSB0byBzdGFydCBsb2cgY2FwdHVyZS4gUGxlYXNlIHRyeSBpbnN0YWxsaW5nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgJ2RldmljZWNvbnNvbGUnICgnbnBtIGluc3RhbGwgLWcgZGV2aWNlY29uc29sZScpIGFuZCBgICtcbiAgICAgICAgICAgICAgICAgICAgYHNwZWNpZnkgdGhlIHBhdGggdG8gaXQgdXNpbmcgdGhlICdyZWFsRGV2aWNlTG9nZ2VyJyBjYXBhYmlsaXR5LmA7XG4gICAgICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pb3NMb2dBbHJlYWR5U2hvd24pIHtcbiAgICAgIGxvZ3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgb3V0ID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGFyZSBub3QgcmVhZGluZyBsb2dzIGZyb20gYmVmb3JlIHRoaXMgdGVzdCBydW5cbiAgICAgICAgaWYgKCFsb2dnaW5nU3RhcnRlZCAmJiAhc2hvdWxkU3RhcnRMb2dnaW5nKG91dCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzUGVydGluZW50TG9nTGluZShvdXQpKSB7XG4gICAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXQuc3BsaXQoXCJcXG5cIikuZmlsdGVyKEJvb2xlYW4pKSB7XG4gICAgICAgICAgICBhZ2VudExvZy5kZWJ1ZyhgJHtwcmVmaXh9OiAke2xpbmV9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFhjb2RlYnVpbGQgKCkge1xuICAgIC8vIHdyYXAgdGhlIHN0YXJ0IHByb2NlZHVyZSBpbiBhIHByb21pc2Ugc28gdGhhdCB3ZSBjYW4gY2F0Y2gsIGFuZCByZXBvcnQsXG4gICAgLy8gYW55IHN0YXJ0dXAgZXJyb3JzIHRoYXQgYXJlIHRocm93biBhcyBldmVudHNcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy54Y29kZWJ1aWxkLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBsb2cuaW5mbyhgeGNvZGVidWlsZCBleGl0ZWQgd2l0aCBjb2RlICcke2NvZGV9JyBhbmQgc2lnbmFsICcke3NpZ25hbH0nYCk7XG4gICAgICAgIGlmICh0aGlzLnhjb2RlYnVpbGQuX3dkYV9lcnJvcl9vY2N1cnJlZCB8fCAoIXNpZ25hbCAmJiBjb2RlICE9PSAwKSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGB4Y29kZWJ1aWxkIGZhaWxlZCB3aXRoIGNvZGUgJHtjb2RlfWApKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuZGV2aWNlTG9ncy5vbignZXhpdCcsIChjb2RlKSA9PiB7XG4gICAgICAgIGxldCBtc2cgPSBgJHt0aGlzLnJlYWxEZXZpY2UgPyAnU3lzdGVtJyA6ICdTaW11bGF0b3InfSBsb2cgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfSdgO1xuICAgICAgICBsb2cuaW5mbyhtc2cpO1xuICAgICAgICBpZiAoY29kZSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobXNnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuc3RhcnQoKTtcbiAgICAgICAgbGV0IGFnZW50VXJsID0gYXdhaXQgdGhpcy53YWl0Rm9yU3RhcnQoc3RhcnRUaW1lKTtcbiAgICAgICAgcmVzb2x2ZShhZ2VudFVybCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbGV0IG1zZyA9IGBVbmFibGUgdG8gc3RhcnQgV2ViRHJpdmVyQWdlbnQ6ICR7ZXJyfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgICByZXR1cm4gcmVqZWN0KG1zZyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyB3YWl0Rm9yU3RhcnQgKHN0YXJ0VGltZSkge1xuICAgIC8vIHdlIGhhdmUgdG8gd2FpdCBmb3IgdGhlIHNpbSB0byBzdGFydCBiZWZvcmUgd2UgY2FuIHRhaWwgdGhlIGxvZyBmaWxlXG4gICAgaWYgKCF0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIGF3YWl0IHN5c3RlbUxvZ0V4aXN0cyh0aGlzLmRldmljZSk7XG4gICAgfVxuXG4gICAgbGV0IGFnZW50VXJsO1xuICAgIGxldCBsaW5lQ291bnQgPSAwO1xuICAgIGxldCByZWFjaGVkRW5kID0gIXRoaXMucmVhbERldmljZTsgLy8gc2ltdWxhdG9yIGRvZXMgbm90IG5lZWQgdG8gd2FpdCwgc2luY2Ugd2UgYXJlIHRhaWxpbmdcbiAgICBsZXQgc2hvd1dhaXRpbmdNZXNzYWdlID0gdHJ1ZTsgLy8gdHVybiBvZmYgbG9nZ2luZyBvbmNlIHdlIGhhdmUgaGl0IHRoZSBlbmRcblxuICAgIGxldCBzdGFydERldGVjdG9yID0gKHN0ZG91dCkgPT4ge1xuICAgICAgLy8gb24gYSByZWFsIGRldmljZSB0aGVyZSBtYXkgYWxyZWFkeSBiZSBzeXN0ZW0gbG9ncyB0aGF0IG5lZWQgdG8gYmVcbiAgICAgIC8vIHBhc3NlZCBiZWZvcmUgd2UgZ2V0IHRvIHRoZSByZWFsIHN0YXJ0dXAgbG9ncywgb3RoZXJ3aXNlXG4gICAgICAvLyB3ZSBleHBlY3QgdHdvIGxpbmVzLCBvbmUgYWZ0ZXIgYW5vdGhlclxuICAgICAgLy8gICAgIEp1bCAyMCAxMzowMzo1NyBpYW1QaG9uZSBYQ1RSdW5uZXJbMjk2XSA8V2FybmluZz46IEJ1aWx0IGF0IEp1bCAyMCAyMDE2IDEzOjAzOjUwXG4gICAgICAvLyAgICAgSnVsIDIwIDEzOjAzOjU3IGlhbVBob25lIFhDVFJ1bm5lclsyOTZdIDxXYXJuaW5nPjogU2VydmVyVVJMSGVyZS0+aHR0cDovLzEwLjM1LjQuMTIyOjgxMDA8LVNlcnZlclVSTEhlcmVcbiAgICAgIGlmICghcmVhY2hlZEVuZCkge1xuICAgICAgICBsZXQgZGF0ZU1hdGNoID0gUkVBTF9ERVZJQ0VfQlVJTERfTE9HX1NUQVJUVElNRV9SRUdFWC5leGVjKHN0ZG91dCk7XG4gICAgICAgIGlmIChkYXRlTWF0Y2gpIHtcbiAgICAgICAgICBsZXQgYnVpbGRUaW1lID0gbmV3IERhdGUoZGF0ZU1hdGNoWzFdKTtcbiAgICAgICAgICBpZiAoYnVpbGRUaW1lLmlzQWZ0ZXIoc3RhcnRUaW1lKSkge1xuICAgICAgICAgICAgcmVhY2hlZEVuZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChyZWFjaGVkRW5kKSB7XG4gICAgICAgIGxldCBtYXRjaCA9IEFHRU5UX1NUQVJURURfUkVHRVguZXhlYyhzdGRvdXQpO1xuICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICBhZ2VudFVybCA9IG1hdGNoWzFdO1xuICAgICAgICAgIGxvZy5pbmZvKGBEZXRlY3RlZCB0aGF0IFdlYkRyaXZlckFnZW50IGlzIHJ1bm5pbmcgYXQgdXJsICcke2FnZW50VXJsfSdgKTtcbiAgICAgICAgICBpZiAoIWFnZW50VXJsKSB7XG4gICAgICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhuZXcgRXJyb3IoJ05vIHVybCBkZXRlY3RlZCBmcm9tIFdlYkRyaXZlckFnZW50JykpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBzaG93V2FpdGluZ01lc3NhZ2UgPSBmYWxzZTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBwZXJpb2RpY2FsbHkgbG9nLCBzbyBpdCBkb2VzIG5vdCBsb29rIGxpa2UgZXZlcnl0aGluZyBkaWVkXG4gICAgICBsaW5lQ291bnQrKztcbiAgICAgIGxldCB0aHJlc2hvbGQgPSB0aGlzLnJlYWxEZXZpY2UgPyA1MDAwIDogMjAwO1xuICAgICAgaWYgKHNob3dXYWl0aW5nTWVzc2FnZSAmJiBsaW5lQ291bnQgJSB0aHJlc2hvbGQgPT09IDApIHtcbiAgICAgICAgbG9nLmRlYnVnKCdXYWl0aW5nIGZvciBXZWJEcml2ZXJBZ2VudCBzZXJ2ZXIgdG8gZmluaXNoIGxvYWRpbmcuLi4nKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBsb2cuaW5mbygnV2FpdGluZyBmb3IgV2ViRHJpdmVyQWdlbnQgdG8gc3RhcnQgb24gZGV2aWNlJyk7XG4gICAgYXdhaXQgdGhpcy5kZXZpY2VMb2dzLnN0YXJ0KHN0YXJ0RGV0ZWN0b3IpO1xuICAgIGxvZy5pbmZvKGBXZWJEcml2ZXJBZ2VudCBzdGFydGVkIGF0IHVybCAnJHthZ2VudFVybH0nYCk7XG5cbiAgICByZXR1cm4gYWdlbnRVcmw7XG4gIH1cblxuICBhc3luYyBzdGFydGlwcm94eSAoKSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuaXByb3h5Lm9uKCdleGl0JywgKGNvZGUpID0+IHtcbiAgICAgICAgbG9nLndhcm4oYGlwcm94eSBleGl0ZWQgd2l0aCBjb2RlICcke2NvZGV9J2ApO1xuICAgICAgICBpZiAoY29kZSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGBpcHJveHkgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfSdgKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5pcHJveHkub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgb3V0ID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXQuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgaWYgKCFsaW5lLmxlbmd0aCkgY29udGludWU7XG4gICAgICAgICAgaXByb3h5TG9nLmRlYnVnKGxpbmUpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5pcHJveHkuc3RhcnQoNTAwMCk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cuZXJyb3IoYEVycm9yIHN0YXJ0aW5nIGlwcm94eTogJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgICByZWplY3QoJ1VuYWJsZSB0byBzdGFydCBpcHJveHkuIElzIGl0IGluc3RhbGxlZD8nKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxIYW5naW5nUHJvY2Vzc2VzICgpIHtcbiAgICBsb2cuZGVidWcoJ0tpbGxpbmcgaGFuZ2luZyBwcm9jZXNzZXMnKTtcbiAgICBhd2FpdCBraWxsQXBwVXNpbmdBcHBOYW1lKHRoaXMuZGV2aWNlLnVkaWQsIGB4Y29kZWJ1aWxkYCk7XG4gICAgbGV0IHByb2NOYW1lcyA9IHRoaXMucmVhbERldmljZSA/IFt0aGlzLnJlYWxEZXZpY2VMb2dnZXIsICdpcHJveHknXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBbJ3RhaWwnLCAnWENUUnVubmVyJ107XG4gICAgZm9yIChsZXQgcHJvYyBvZiBwcm9jTmFtZXMpIHtcbiAgICAgIGF3YWl0IGtpbGxBcHBVc2luZ0FwcE5hbWUodGhpcy5kZXZpY2UudWRpZCwgcHJvYyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcXVpdCAoKSB7XG4gICAgbG9nLmluZm8oJ1NodXR0aW5nIGRvd24gc3ViLXByb2Nlc3NlcycpO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24ga2lsbFByb2Nlc3MgKG5hbWUsIHByb2MpIHtcbiAgICAgIGlmIChwcm9jICYmIHByb2MucHJvYykge1xuICAgICAgICBsb2cuaW5mbyhgU2h1dHRpbmcgZG93biAke25hbWV9IHByb2Nlc3MgKHBpZCAke3Byb2MucHJvYy5waWR9KWApO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHByb2Muc3RvcCgnU0lHVEVSTScpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyYCkgPT09IC0xKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZy5kZWJ1ZyhgJHtuYW1lfSBwcm9jZXNzIGRpZCBub3QgZW5kIGluIGEgdGltZWx5IGZhc2hpb246ICcke2Vyci5tZXNzYWdlfScuIGAgK1xuICAgICAgICAgICAgICAgICAgICBgU2VuZGluZyAnU0lHS0lMTCcuLi5gKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignbm90IGN1cnJlbnRseSBydW5uaW5nJykgIT09IC0xKSB7XG4gICAgICAgICAgICAgIC8vIHRoZSBwcm9jZXNzIGVuZGVkIGJ1dCBmb3Igc29tZSByZWFzb24gd2Ugd2VyZSBub3QgaW5mb3JtZWRcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IGtpbGxQcm9jZXNzKCd4Y29kZWJ1aWxkJywgdGhpcy54Y29kZWJ1aWxkKTtcbiAgICBhd2FpdCBraWxsUHJvY2VzcygnTG9nZ2VyJywgdGhpcy5kZXZpY2VMb2dzKTtcbiAgICBhd2FpdCBraWxsUHJvY2VzcygnaXByb3h5JywgdGhpcy5pcHJveHkpO1xuXG4gICAgaWYgKHRoaXMuandwcm94eSkge1xuICAgICAgdGhpcy5qd3Byb3h5LnNlc3Npb25JZCA9IG51bGw7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFdlYkRyaXZlckFnZW50O1xuZXhwb3J0IHsgV2ViRHJpdmVyQWdlbnQsIFdEQV9CVU5ETEVfSUQgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
