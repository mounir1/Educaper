'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _appiumIosDriver = require('appium-ios-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var helpers = {},
    extensions = {},
    commands = {};

commands.moveTo = _appiumIosDriver.iosCommands.gesture.moveTo;

commands.click = function callee$0$0(el) {
  var atomsElement;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');

      case 2:
        el = _appiumSupport.util.unwrapElement(el);

        if (!(this.opts.nativeWebTap && !this.isRealDevice())) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.nativeWebTap(el));

      case 6:
        context$1$0.next = 12;
        break;

      case 8:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.executeAtom('click', [atomsElement]));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.performTouch = function callee$0$0(gestures) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Received the following touch action: ' + _lodash2['default'].map(gestures, 'action').join('-'));

        if (!isDoubleTap(gestures)) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.handleDoubleTap(gestures));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        if (!isTap(gestures)) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.handleTap(gestures[0]));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 13:
        if (!isLongPress(gestures)) {
          context$1$0.next = 19;
          break;
        }

        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.handleLongPress(gestures));

      case 16:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 19:
        if (!isDrag(gestures)) {
          context$1$0.next = 25;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.handleDrag(gestures));

      case 22:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 25:
        if (!isScroll(gestures)) {
          context$1$0.next = 29;
          break;
        }

        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(this.handleScroll(gestures));

      case 28:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 29:
        throw new _appiumBaseDriver.errors.NotYetImplementedError('Support for this gesture is not yet implemented. Please contact an Appium dev');

      case 30:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.performMultiAction = function callee$0$0(actions) {
  var i;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Received the following multi touch action:');
        for (i in actions) {
          _logger2['default'].debug('    ' + (i + 1) + ': ' + _lodash2['default'].map(actions[i], 'action').join('-'));
        }

        if (!isPinchOrZoom(actions)) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.handlePinchOrZoom(actions));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        throw new _appiumBaseDriver.errors.NotYetImplementedError('Support for this multi-action is not yet implemented. Please contact an Appium dev.');

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.nativeClick = function callee$0$0(el) {
  var endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = _appiumSupport.util.unwrapElement(el);
        endpoint = '/element/' + el + '/click';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', {}));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function isDrag(gestures) {
  return gestures.length === 4 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'moveTo' && gestures[3].action === 'release';
}

function isDoubleTap(gestures) {
  if (gestures.length === 1 && gestures[0].action.toLowerCase() === 'doubletap') {
    return true;
  } else if (gestures.length === 1 && gestures[0].action === 'tap' && (gestures[0].options || {}).count === 2) {
    return true;
  }
  return false;
}

function isTap(gestures) {
  if (gestures.length === 1 && gestures[0].action === 'tap') {
    return true;
  } else if (gestures.length === 2 && gestures[0].action === 'press' && gestures[1].action === 'release') {
    return true;
  }
  return false;
}

function isLongPress(gestures) {
  if (gestures.length === 1 && gestures[0].action.toLowerCase() === 'longpress') {
    return true;
  } else if (gestures.length === 3 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'release') {
    return true;
  }
  return false;
}

function isScroll(gestures) {
  if (gestures.length === 3 && gestures[0].action === 'press' && gestures[1].action === 'moveTo' && gestures[2].action === 'release') {
    return true;
  }
  return false;
}

function isPinchOrZoom() {
  var actions = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];

  // symmetric two-finger action consisting of press-moveto-release
  if (actions.length === 2) {
    if (actions[0].length === 3 && actions[1].length === 3) {
      return _lodash2['default'].every(actions, function (gestures) {
        return isScroll(gestures);
      });
    }
  }
  return false;
}

helpers.handleScroll = function callee$0$0(gestures) {
  var dragGestures;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!gestures[1].options.element) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.mobileScroll({
          element: gestures[1].options.element,
          toVisible: true
        }));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
        dragGestures = [gestures[0], { action: 'wait', options: { ms: 0 } }, gestures[1], gestures[2]];
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.handleDrag(dragGestures));

      case 7:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleDrag = function callee$0$0(gestures) {
  var press, wait, moveTo, pressCoordinates, duration, moveToCoordinates, params, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        press = gestures[0];
        wait = gestures[1];
        moveTo = gestures[2];
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getCoordinates(press));

      case 5:
        pressCoordinates = context$1$0.sent;
        duration = parseInt(wait.options.ms, 10) / 1000;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getCoordinates(moveTo));

      case 9:
        moveToCoordinates = context$1$0.sent;

        // update moveTo coordinates with offset
        moveToCoordinates = this.applyMoveToOffset(pressCoordinates, moveToCoordinates);

        // build drag command
        params = {};

        params.fromX = pressCoordinates.x;
        params.fromY = pressCoordinates.y;
        params.toX = moveToCoordinates.x;
        params.toY = moveToCoordinates.y;
        params.duration = duration;

        endpoint = '/uiaTarget/0/dragfromtoforduration';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 20:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 21:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleTap = function callee$0$0(gesture) {
  var options, params, el, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        options = gesture.options || {};
        params = {};

        if (_appiumSupport.util.hasValue(options.x) && _appiumSupport.util.hasValue(options.y)) {
          params.x = options.x;
          params.y = options.y;
        }

        el = _appiumSupport.util.hasValue(options.element) ? options.element : '0';
        endpoint = '/tap/' + el;

        if (_appiumSupport.util.hasValue(this.opts.tapWithShortPressDuration)) {
          // in some cases `tap` is too slow, so allow configurable long press
          _logger2['default'].debug('Translating tap into long press with \'' + this.opts.tapWithShortPressDuration + '\' duration');
          params.duration = parseFloat(this.opts.tapWithShortPressDuration);
          endpoint = '/uiaElement/' + el + '/touchAndHold';
          params.duration = parseFloat(this.opts.tapWithShortPressDuration);
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleDoubleTap = function callee$0$0(gestures) {
  var gesture, opts, el, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        gesture = gestures[0];
        opts = gesture.options || {};

        if (!opts.element) {
          _logger2['default'].errorAndThrow('WDA double tap needs an element');
        }

        el = _appiumSupport.util.unwrapElement(opts.element);
        endpoint = '/uiaElement/' + el + '/doubleTap';
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST'));

      case 7:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.handleLongPress = function callee$0$0(gestures) {
  var pressOpts, el, duration, params, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        pressOpts = gestures[0].options || {};
        el = _appiumSupport.util.unwrapElement(pressOpts.element);
        duration = undefined;

        if (gestures.length === 1 && _appiumSupport.util.hasValue(pressOpts.duration)) {
          duration = pressOpts.duration;
        } else if (gestures.length === 3) {
          // duration is the `wait` action
          // upstream system expects seconds not milliseconds
          duration = parseFloat(gestures[1].options.ms) / 1000;
        } else {
          // give a sane default duration
          duration = 0.8;
        }

        params = {
          duration: duration,
          x: pressOpts.x,
          y: pressOpts.y
        };
        endpoint = undefined;

        if (el) {
          endpoint = '/uiaElement/' + el + '/touchAndHold';
        } else {
          params.x = pressOpts.x;
          params.y = pressOpts.y;

          endpoint = '/touchAndHold';
        }
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function determinePinchScale(x, y, pinch) {
  var scale = x > y ? x - y : y - x;
  if (pinch) {
    // TODO: revisit this when pinching actually works, since it is impossible to
    // know what the scale factor does at this point (Xcode 8.1)
    scale = 1 / scale;
    if (scale < 0.02) {
      // this is the minimum that Apple will allow
      // but WDA will not throw an error if it is too low
      scale = 0.02;
    }
  } else {
    // for zoom, each 10px is one scale factor
    scale = scale / 10;
  }
  return scale;
}

helpers.handlePinchOrZoom = function callee$0$0(actions) {
  var el, scale, velocity, thumb, forefinger, params;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        // currently we can only do this action on an element
        if (!actions[0][0].options.element || actions[0][0].options.element !== actions[1][0].options.element) {
          _logger2['default'].errorAndThrow('Pinch/zoom actions must be done on a single element');
        }
        el = actions[0][0].options.element;
        scale = undefined, velocity = undefined;

        if (actions[0][0].options.y === actions[0][1].options.y) {
          thumb = actions[0][0].options.x <= actions[1][0].options.x ? actions[0] : actions[1];

          // now decipher pinch vs. zoom,
          //   pinch: thumb moving from left to right
          //   zoom: thumb moving from right to left
          scale = determinePinchScale(thumb[0].options.x, thumb[1].options.x, thumb[0].options.x <= thumb[1].options.x);
        } else {
          forefinger = actions[0][0].options.y <= actions[1][0].options.y ? actions[0] : actions[1];

          // now decipher pinch vs. zoom
          //   pinch: forefinger moving from top to bottom
          //   zoom: forefinger moving from bottom to top
          scale = determinePinchScale(forefinger[0].options.y, forefinger[1].options.y, forefinger[0].options.y <= forefinger[1].options.y);
        }
        velocity = scale < 1 ? -1 : 1;

        _logger2['default'].debug('Decoded ' + (scale < 1 ? 'pinch' : 'zoom') + ' action with scale \'' + scale + '\' and velocity \'' + velocity + '\'');
        if (scale < 1) {
          _logger2['default'].warn('Pinch actions may not work, due to Apple issue.');
        }

        params = {
          scale: scale,
          velocity: velocity
        };
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.proxyCommand('/element/' + el + '/pinch', 'POST', params));

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.mobileScroll = function callee$0$0() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var params, msg, element, endpoint;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (opts.element) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.findElement('class name', 'XCUIElementTypeApplication'));

      case 3:
        opts.element = context$1$0.sent;

      case 4:
        params = {};

        if (opts.name) {
          params.name = opts.name;
        } else if (opts.direction) {
          params.direction = opts.direction;
        } else if (opts.predicateString) {
          params.predicateString = opts.predicateString;
        } else if (opts.toVisible) {
          params.toVisible = opts.toVisible;
        } else {
          msg = 'Mobile scroll supports the following strategies: name, ' + 'direction, predicateString, and toVisible. Specify one of these';

          _logger2['default'].errorAndThrow(msg);
        }

        element = opts.element.ELEMENT ? opts.element.ELEMENT : opts.element;
        endpoint = '/uiaElement/' + element + '/scroll';
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.proxyCommand(endpoint, 'POST', params));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getCoordinates = function callee$0$0(gesture) {
  var el, coordinates, rect, pos, size, offsetX, offsetY;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        el = gesture.options.element;
        coordinates = { x: 0, y: 0, areOffsets: false };

        if (!el) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getRect(el));

      case 5:
        rect = context$1$0.sent;
        pos = { x: rect.x, y: rect.y };
        size = { w: rect.width, h: rect.height };
        offsetX = 0;
        offsetY = 0;

        // get the real offsets
        if (gesture.options.x || gesture.options.y) {
          offsetX = gesture.options.x || 0;
          offsetY = gesture.options.y || 0;
        } else {
          offsetX = size.w / 2;
          offsetY = size.h / 2;
        }

        // apply the offsets
        coordinates.x = pos.x + offsetX;
        coordinates.y = pos.y + offsetY;
        context$1$0.next = 18;
        break;

      case 15:
        // moveTo coordinates are passed in as offsets
        coordinates.areOffsets = gesture.action === 'moveTo';
        coordinates.x = gesture.options.x || 0;
        coordinates.y = gesture.options.y || 0;

      case 18:
        return context$1$0.abrupt('return', coordinates);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.applyMoveToOffset = function (firstCoordinates, secondCoordinates) {
  if (secondCoordinates.areOffsets) {
    return {
      x: firstCoordinates.x + secondCoordinates.x,
      y: firstCoordinates.y + secondCoordinates.y
    };
  } else {
    return secondCoordinates;
  }
};

_Object$assign(extensions, helpers, commands);
exports.extensions = extensions;
exports.helpers = helpers;
exports.commands = commands;
exports['default'] = extensions;

// atoms-based clicks don't always work in safari 7

// use the to-visible option of scrolling in WDA

// otherwise, for now, just translate into a drag with short duration

// get gestures

// get drag data

// assume that action is in a single plane (x or y, not horizontal at all)
// terminology all assuming right handedness

// horizontal, since y offset is the same in press and moveTo

// vertical

// WDA supports four scrolling strategies: predication based on name, direction,
// predicateString, and toVisible, in that order.

// defaults

// figure out the element coordinates.

// defaults
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZXN0dXJlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COzs2QkFDdEIsZ0JBQWdCOzsrQkFDVCxtQkFBbUI7O3NCQUNqQyxRQUFROzs7O3NCQUNOLFdBQVc7Ozs7QUFHM0IsSUFBSSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFO0lBQUUsUUFBUSxHQUFHLEVBQUUsQ0FBQzs7QUFFakQsUUFBUSxDQUFDLE1BQU0sR0FBRyw2QkFBWSxPQUFPLENBQUMsTUFBTSxDQUFDOztBQUU3QyxRQUFRLENBQUMsS0FBSyxHQUFHLG9CQUFnQixFQUFFO01BUzNCLFlBQVk7Ozs7WUFSYixJQUFJLENBQUMsWUFBWSxFQUFFOzs7OztjQUNoQixJQUFJLHlCQUFPLFlBQVksQ0FBQyxrQ0FBa0MsQ0FBQzs7O0FBRW5FLFVBQUUsR0FBRyxvQkFBSyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7O2NBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBOzs7Ozs7eUNBRTFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDOzs7Ozs7O0FBRXZCLG9CQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7O3lDQUM5QixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLFlBQVksQ0FBQyxDQUFDOzs7Ozs7Ozs7O0NBRXpELENBQUM7O0FBRUYsUUFBUSxDQUFDLFlBQVksR0FBRyxvQkFBZ0IsUUFBUTs7OztBQUM5Qyw0QkFBSSxLQUFLLDJDQUF5QyxvQkFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBRyxDQUFDOzthQUVyRixXQUFXLENBQUMsUUFBUSxDQUFDOzs7Ozs7eUNBQ1YsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUM7Ozs7OzthQUNsQyxLQUFLLENBQUMsUUFBUSxDQUFDOzs7Ozs7eUNBQ1gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Ozs7OzthQUMvQixXQUFXLENBQUMsUUFBUSxDQUFDOzs7Ozs7eUNBQ2pCLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDOzs7Ozs7YUFDbEMsTUFBTSxDQUFDLFFBQVEsQ0FBQzs7Ozs7O3lDQUNaLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDOzs7Ozs7YUFDN0IsUUFBUSxDQUFDLFFBQVEsQ0FBQzs7Ozs7O3lDQUNkLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDOzs7Ozs7Y0FFcEMsSUFBSSx5QkFBTyxzQkFBc0IsQ0FBQywrRUFBK0UsQ0FBQzs7Ozs7OztDQUN6SCxDQUFDOztBQUVGLFFBQVEsQ0FBQyxrQkFBa0IsR0FBRyxvQkFBZ0IsT0FBTztNQUUxQyxDQUFDOzs7O0FBRFYsNEJBQUksS0FBSyw4Q0FBOEMsQ0FBQztBQUN4RCxhQUFTLENBQUMsSUFBSSxPQUFPLEVBQUU7QUFDckIsOEJBQUksS0FBSyxXQUFRLENBQUMsR0FBQyxDQUFDLENBQUEsVUFBSyxvQkFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBRyxDQUFDO1NBQ25FOzthQUVHLGFBQWEsQ0FBQyxPQUFPLENBQUM7Ozs7Ozt5Q0FDWCxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDOzs7Ozs7Y0FFeEMsSUFBSSx5QkFBTyxzQkFBc0IsQ0FBQyxxRkFBcUYsQ0FBQzs7Ozs7OztDQUMvSCxDQUFDOztBQUVGLFFBQVEsQ0FBQyxXQUFXLEdBQUcsb0JBQWdCLEVBQUU7TUFFbkMsUUFBUTs7OztBQURaLFVBQUUsR0FBRyxvQkFBSyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEIsZ0JBQVEsaUJBQWUsRUFBRTs7eUNBQ2hCLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUM7Ozs7Ozs7Ozs7Q0FDckQsQ0FBQzs7QUFFRixTQUFTLE1BQU0sQ0FBRSxRQUFRLEVBQUU7QUFDekIsU0FDSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsSUFDckIsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxPQUFPLElBQzlCLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssTUFBTSxJQUM3QixRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLFFBQVEsSUFDL0IsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQ2xDO0NBQ0g7O0FBRUQsU0FBUyxXQUFXLENBQUUsUUFBUSxFQUFFO0FBQzlCLE1BQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsS0FBSyxXQUFXLEVBQUU7QUFDN0UsV0FBTyxJQUFJLENBQUM7R0FDYixNQUFNLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQ3JCLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssS0FBSyxJQUM1QixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFBLENBQUUsS0FBSyxLQUFLLENBQUMsRUFBRTtBQUNsRCxXQUFPLElBQUksQ0FBQztHQUNiO0FBQ0QsU0FBTyxLQUFLLENBQUM7Q0FDZDs7QUFFRCxTQUFTLEtBQUssQ0FBRSxRQUFRLEVBQUU7QUFDeEIsTUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLEtBQUssRUFBRTtBQUN6RCxXQUFPLElBQUksQ0FBQztHQUNiLE1BQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsSUFDcEIsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxP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Q0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDOzs7OztBQUsxRixlQUFLLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMvRyxNQUFNO0FBRUQsb0JBQVUsR0FBRyxBQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDOzs7OztBQUsvRixlQUFLLEdBQUcsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuSTtBQUNELGdCQUFRLEdBQUcsS0FBSyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRTlCLDRCQUFJLEtBQUssZUFBWSxLQUFLLEdBQUcsQ0FBQyxHQUFHLE9BQU8sR0FBRyxNQUFN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QUFBQyxDQUFDO0FBQ3ZCLGlCQUFPLEdBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEFBQUMsQ0FBQztTQUN4Qjs7O0FBR0QsbUJBQVcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUM7QUFDaEMsbUJBQVcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUM7Ozs7OztBQUdoQyxtQkFBVyxDQUFDLFVBQVUsR0FBSSxPQUFPLENBQUMsTUFBTSxLQUFLLFFBQVEsQUFBQyxDQUFDO0FBQ3ZELG1CQUFXLENBQUMsQ0FBQyxHQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQUFBQyxDQUFDO0FBQ3pDLG1CQUFXLENBQUMsQ0FBQyxHQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQUFBQyxDQUFDOzs7NENBRXBDLFdBQVc7Ozs7Ozs7Q0FDbkIsQ0FBQzs7QUFFRixPQUFPLENBQUMsaUJBQWlCLEdBQUcsVUFBVSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRTtBQUN6RSxNQUFJLGlCQUFpQixDQUFDLFVBQVUsRUFBRTtBQUNoQyxXQUFPO0FBQ0wsT0FBQyxFQUFFLGdCQUFnQixDQUFDLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzNDLE9BQUMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDLEdBQUcsaUJBQWlCLENBQUMsQ0FBQztLQUM1QyxDQUFDO0dBQ0gsTUFBTTtBQUNMLFdBQU8saUJBQWlCLENBQUM7R0FDMUI7Q0FDRixDQUFDOztBQUVGLGVBQWMsVUFBVSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNwQyxVQUFVLEdBQVYsVUFBVTtRQUFFLE9BQU8sR0FBUCxPQUFPO1FBQUUsUUFBUSxHQUFSLFFBQVE7cUJBQ3ZCLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2dlc3R1cmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxuXG5sZXQgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge30sIGNvbW1hbmRzID0ge307XG5cbmNvbW1hbmRzLm1vdmVUbyA9IGlvc0NvbW1hbmRzLmdlc3R1cmUubW92ZVRvO1xuXG5jb21tYW5kcy5jbGljayA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcignQ29tbWFuZCBzaG91bGQgYmUgcHJveGllZCB0byBXREEnKTtcbiAgfVxuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLm9wdHMubmF0aXZlV2ViVGFwICYmICF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgLy8gYXRvbXMtYmFzZWQgY2xpY2tzIGRvbid0IGFsd2F5cyB3b3JrIGluIHNhZmFyaSA3XG4gICAgYXdhaXQgdGhpcy5uYXRpdmVXZWJUYXAoZWwpO1xuICB9IGVsc2Uge1xuICAgIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2NsaWNrJywgW2F0b21zRWxlbWVudF0pO1xuICB9XG59O1xuXG5jb21tYW5kcy5wZXJmb3JtVG91Y2ggPSBhc3luYyBmdW5jdGlvbiAoZ2VzdHVyZXMpIHtcbiAgbG9nLmRlYnVnKGBSZWNlaXZlZCB0aGUgZm9sbG93aW5nIHRvdWNoIGFjdGlvbjogJHtfLm1hcChnZXN0dXJlcywgJ2FjdGlvbicpLmpvaW4oJy0nKX1gKTtcblxuICBpZiAoaXNEb3VibGVUYXAoZ2VzdHVyZXMpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuaGFuZGxlRG91YmxlVGFwKGdlc3R1cmVzKTtcbiAgfSBlbHNlIGlmIChpc1RhcChnZXN0dXJlcykpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5oYW5kbGVUYXAoZ2VzdHVyZXNbMF0pO1xuICB9IGVsc2UgaWYgKGlzTG9uZ1ByZXNzKGdlc3R1cmVzKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmhhbmRsZUxvbmdQcmVzcyhnZXN0dXJlcyk7XG4gIH0gZWxzZSBpZiAoaXNEcmFnKGdlc3R1cmVzKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmhhbmRsZURyYWcoZ2VzdHVyZXMpO1xuICB9IGVsc2UgaWYgKGlzU2Nyb2xsKGdlc3R1cmVzKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmhhbmRsZVNjcm9sbChnZXN0dXJlcyk7XG4gIH1cbiAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCdTdXBwb3J0IGZvciB0aGlzIGdlc3R1cmUgaXMgbm90IHlldCBpbXBsZW1lbnRlZC4gUGxlYXNlIGNvbnRhY3QgYW4gQXBwaXVtIGRldicpO1xufTtcblxuY29tbWFuZHMucGVyZm9ybU11bHRpQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gKGFjdGlvbnMpIHtcbiAgbG9nLmRlYnVnKGBSZWNlaXZlZCB0aGUgZm9sbG93aW5nIG11bHRpIHRvdWNoIGFjdGlvbjpgKTtcbiAgZm9yIChsZXQgaSBpbiBhY3Rpb25zKSB7XG4gICAgbG9nLmRlYnVnKGAgICAgJHtpKzF9OiAke18ubWFwKGFjdGlvbnNbaV0sICdhY3Rpb24nKS5qb2luKCctJyl9YCk7XG4gIH1cblxuICBpZiAoaXNQaW5jaE9yWm9vbShhY3Rpb25zKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmhhbmRsZVBpbmNoT3Jab29tKGFjdGlvbnMpO1xuICB9XG4gIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcignU3VwcG9ydCBmb3IgdGhpcyBtdWx0aS1hY3Rpb24gaXMgbm90IHlldCBpbXBsZW1lbnRlZC4gUGxlYXNlIGNvbnRhY3QgYW4gQXBwaXVtIGRldi4nKTtcbn07XG5cbmNvbW1hbmRzLm5hdGl2ZUNsaWNrID0gYXN5bmMgZnVuY3Rpb24gKGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgbGV0IGVuZHBvaW50ID0gYC9lbGVtZW50LyR7ZWx9L2NsaWNrYDtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGVuZHBvaW50LCAnUE9TVCcsIHt9KTtcbn07XG5cbmZ1bmN0aW9uIGlzRHJhZyAoZ2VzdHVyZXMpIHtcbiAgcmV0dXJuIChcbiAgICAgIGdlc3R1cmVzLmxlbmd0aCA9PT0gNCAmJlxuICAgICAgZ2VzdHVyZXNbMF0uYWN0aW9uID09PSAncHJlc3MnICYmXG4gICAgICBnZXN0dXJlc1sxXS5hY3Rpb24gPT09ICd3YWl0JyAmJlxuICAgICAgZ2VzdHVyZXNbMl0uYWN0aW9uID09PSAnbW92ZVRvJyAmJlxuICAgICAgZ2VzdHVyZXNbM10uYWN0aW9uID09PSAncmVsZWFzZSdcbiAgKTtcbn1cblxuZnVuY3Rpb24gaXNEb3VibGVUYXAgKGdlc3R1cmVzKSB7XG4gIGlmIChnZXN0dXJlcy5sZW5ndGggPT09IDEgJiYgZ2VzdHVyZXNbMF0uYWN0aW9uLnRvTG93ZXJDYXNlKCkgPT09ICdkb3VibGV0YXAnKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gZWxzZSBpZiAoZ2VzdHVyZXMubGVuZ3RoID09PSAxICYmXG4gICAgICAgICAgICAgZ2VzdHVyZXNbMF0uYWN0aW9uID09PSAndGFwJyAmJlxuICAgICAgICAgICAgIChnZXN0dXJlc1swXS5vcHRpb25zIHx8IHt9KS5jb3VudCA9PT0gMikge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gaXNUYXAgKGdlc3R1cmVzKSB7XG4gIGlmIChnZXN0dXJlcy5sZW5ndGggPT09IDEgJiYgZ2VzdHVyZXNbMF0uYWN0aW9uID09PSAndGFwJykge1xuICAgIHJldHVybiB0cnVlO1xuICB9IGVsc2UgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gMiAmJlxuICAgICAgICAgICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPT09ICdwcmVzcycgJiZcbiAgICAgICAgICAgICAgZ2VzdHVyZXNbMV0uYWN0aW9uID09PSAncmVsZWFzZScpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGlzTG9uZ1ByZXNzIChnZXN0dXJlcykge1xuICBpZiAoZ2VzdHVyZXMubGVuZ3RoID09PSAxICYmIGdlc3R1cmVzWzBdLmFjdGlvbi50b0xvd2VyQ2FzZSgpID09PSAnbG9uZ3ByZXNzJykge1xuICAgIHJldHVybiB0cnVlO1xuICB9IGVsc2UgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gMyAmJlxuICAgICAgICAgICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPT09ICdwcmVzcycgJiZcbiAgICAgICAgICAgICAgZ2VzdHVyZXNbMV0uYWN0aW9uID09PSAnd2FpdCcgJiZcbiAgICAgICAgICAgICAgZ2VzdHVyZXNbMl0uYWN0aW9uID09PSAncmVsZWFzZScpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGlzU2Nyb2xsIChnZXN0dXJlcykge1xuICBpZiAoZ2VzdHVyZXMubGVuZ3RoID09PSAzICYmXG4gICAgICAgIGdlc3R1cmVzWzBdLmFjdGlvbiA9PT0gJ3ByZXNzJyAmJlxuICAgICAgICBnZXN0dXJlc1sxXS5hY3Rpb24gPT09ICdtb3ZlVG8nICYmXG4gICAgICAgIGdlc3R1cmVzWzJdLmFjdGlvbiA9PT0gJ3JlbGVhc2UnKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBpc1BpbmNoT3Jab29tIChhY3Rpb25zID0gW10pIHtcbiAgLy8gc3ltbWV0cmljIHR3by1maW5nZXIgYWN0aW9uIGNvbnNpc3Rpbmcgb2YgcHJlc3MtbW92ZXRvLXJlbGVhc2VcbiAgaWYgKGFjdGlvbnMubGVuZ3RoID09PSAyKSB7XG4gICAgaWYgKGFjdGlvbnNbMF0ubGVuZ3RoID09PSAzICYmIGFjdGlvbnNbMV0ubGVuZ3RoID09PSAzKSB7XG4gICAgICByZXR1cm4gXy5ldmVyeShhY3Rpb25zLCAoZ2VzdHVyZXMpID0+IGlzU2Nyb2xsKGdlc3R1cmVzKSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuaGVscGVycy5oYW5kbGVTY3JvbGwgPSBhc3luYyBmdW5jdGlvbiAoZ2VzdHVyZXMpIHtcbiAgaWYgKGdlc3R1cmVzWzFdLm9wdGlvbnMuZWxlbWVudCkge1xuICAgIC8vIHVzZSB0aGUgdG8tdmlzaWJsZSBvcHRpb24gb2Ygc2Nyb2xsaW5nIGluIFdEQVxuICAgIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZVNjcm9sbCh7XG4gICAgICBlbGVtZW50OiBnZXN0dXJlc1sxXS5vcHRpb25zLmVsZW1lbnQsXG4gICAgICB0b1Zpc2libGU6IHRydWVcbiAgICB9KTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgZm9yIG5vdywganVzdCB0cmFuc2xhdGUgaW50byBhIGRyYWcgd2l0aCBzaG9ydCBkdXJhdGlvblxuICBsZXQgZHJhZ0dlc3R1cmVzID0gW1xuICAgIGdlc3R1cmVzWzBdLFxuICAgIHthY3Rpb246ICd3YWl0Jywgb3B0aW9uczoge21zOiAwfX0sXG4gICAgZ2VzdHVyZXNbMV0sXG4gICAgZ2VzdHVyZXNbMl1cbiAgXTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuaGFuZGxlRHJhZyhkcmFnR2VzdHVyZXMpO1xufTtcblxuaGVscGVycy5oYW5kbGVEcmFnID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzKSB7XG4gIC8vIGdldCBnZXN0dXJlc1xuICBsZXQgcHJlc3MgPSBnZXN0dXJlc1swXTtcbiAgbGV0IHdhaXQgPSBnZXN0dXJlc1sxXTtcbiAgbGV0IG1vdmVUbyA9IGdlc3R1cmVzWzJdO1xuXG4gIC8vIGdldCBkcmFnIGRhdGFcbiAgbGV0IHByZXNzQ29vcmRpbmF0ZXMgPSBhd2FpdCB0aGlzLmdldENvb3JkaW5hdGVzKHByZXNzKTtcbiAgbGV0IGR1cmF0aW9uID0gKHBhcnNlSW50KHdhaXQub3B0aW9ucy5tcywgMTApIC8gMTAwMCk7XG4gIGxldCBtb3ZlVG9Db29yZGluYXRlcyA9IGF3YWl0IHRoaXMuZ2V0Q29vcmRpbmF0ZXMobW92ZVRvKTtcblxuICAvLyB1cGRhdGUgbW92ZVRvIGNvb3JkaW5hdGVzIHdpdGggb2Zmc2V0XG4gIG1vdmVUb0Nvb3JkaW5hdGVzID0gdGhpcy5hcHBseU1vdmVUb09mZnNldChwcmVzc0Nvb3JkaW5hdGVzLCBtb3ZlVG9Db29yZGluYXRlcyk7XG5cbiAgLy8gYnVpbGQgZHJhZyBjb21tYW5kXG4gIGxldCBwYXJhbXMgPSB7fTtcbiAgcGFyYW1zLmZyb21YID0gcHJlc3NDb29yZGluYXRlcy54O1xuICBwYXJhbXMuZnJvbVkgPSBwcmVzc0Nvb3JkaW5hdGVzLnk7XG4gIHBhcmFtcy50b1ggPSBtb3ZlVG9Db29yZGluYXRlcy54O1xuICBwYXJhbXMudG9ZID0gbW92ZVRvQ29vcmRpbmF0ZXMueTtcbiAgcGFyYW1zLmR1cmF0aW9uID0gZHVyYXRpb247XG5cbiAgbGV0IGVuZHBvaW50ID0gYC91aWFUYXJnZXQvMC9kcmFnZnJvbXRvZm9yZHVyYXRpb25gO1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsICdQT1NUJywgcGFyYW1zKTtcbn07XG5cbmhlbHBlcnMuaGFuZGxlVGFwID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmUpIHtcbiAgbGV0IG9wdGlvbnMgPSBnZXN0dXJlLm9wdGlvbnMgfHwge307XG5cbiAgbGV0IHBhcmFtcyA9IHt9O1xuICBpZiAodXRpbC5oYXNWYWx1ZShvcHRpb25zLngpICYmIHV0aWwuaGFzVmFsdWUob3B0aW9ucy55KSkge1xuICAgIHBhcmFtcy54ID0gb3B0aW9ucy54O1xuICAgIHBhcmFtcy55ID0gb3B0aW9ucy55O1xuICB9XG5cbiAgbGV0IGVsID0gdXRpbC5oYXNWYWx1ZShvcHRpb25zLmVsZW1lbnQpID8gb3B0aW9ucy5lbGVtZW50IDogJzAnO1xuICBsZXQgZW5kcG9pbnQgPSBgL3RhcC8ke2VsfWA7XG5cbiAgaWYgKHV0aWwuaGFzVmFsdWUodGhpcy5vcHRzLnRhcFdpdGhTaG9ydFByZXNzRHVyYXRpb24pKSB7XG4gICAgLy8gaW4gc29tZSBjYXNlcyBgdGFwYCBpcyB0b28gc2xvdywgc28gYWxsb3cgY29uZmlndXJhYmxlIGxvbmcgcHJlc3NcbiAgICBsb2cuZGVidWcoYFRyYW5zbGF0aW5nIHRhcCBpbnRvIGxvbmcgcHJlc3Mgd2l0aCAnJHt0aGlzLm9wdHMudGFwV2l0aFNob3J0UHJlc3NEdXJhdGlvbn0nIGR1cmF0aW9uYCk7XG4gICAgcGFyYW1zLmR1cmF0aW9uID0gcGFyc2VGbG9hdCh0aGlzLm9wdHMudGFwV2l0aFNob3J0UHJlc3NEdXJhdGlvbik7XG4gICAgZW5kcG9pbnQgPSBgL3VpYUVsZW1lbnQvJHtlbH0vdG91Y2hBbmRIb2xkYDtcbiAgICBwYXJhbXMuZHVyYXRpb24gPSBwYXJzZUZsb2F0KHRoaXMub3B0cy50YXBXaXRoU2hvcnRQcmVzc0R1cmF0aW9uKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChlbmRwb2ludCwgJ1BPU1QnLCBwYXJhbXMpO1xufTtcblxuaGVscGVycy5oYW5kbGVEb3VibGVUYXAgPSBhc3luYyBmdW5jdGlvbiAoZ2VzdHVyZXMpIHtcbiAgbGV0IGdlc3R1cmUgPSBnZXN0dXJlc1swXTtcbiAgbGV0IG9wdHMgPSBnZXN0dXJlLm9wdGlvbnMgfHwge307XG5cbiAgaWYgKCFvcHRzLmVsZW1lbnQpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnV0RBIGRvdWJsZSB0YXAgbmVlZHMgYW4gZWxlbWVudCcpO1xuICB9XG5cbiAgbGV0IGVsID0gdXRpbC51bndyYXBFbGVtZW50KG9wdHMuZWxlbWVudCk7XG4gIGxldCBlbmRwb2ludCA9IGAvdWlhRWxlbWVudC8ke2VsfS9kb3VibGVUYXBgO1xuXG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChlbmRwb2ludCwgJ1BPU1QnKTtcbn07XG5cbmhlbHBlcnMuaGFuZGxlTG9uZ1ByZXNzID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzKSB7XG4gIGxldCBwcmVzc09wdHMgPSBnZXN0dXJlc1swXS5vcHRpb25zIHx8IHt9O1xuXG4gIGxldCBlbCA9IHV0aWwudW53cmFwRWxlbWVudChwcmVzc09wdHMuZWxlbWVudCk7XG4gIGxldCBkdXJhdGlvbjtcbiAgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gMSAmJiB1dGlsLmhhc1ZhbHVlKHByZXNzT3B0cy5kdXJhdGlvbikpIHtcbiAgICBkdXJhdGlvbiA9IHByZXNzT3B0cy5kdXJhdGlvbjtcbiAgfSBlbHNlIGlmIChnZXN0dXJlcy5sZW5ndGggPT09IDMpIHtcbiAgICAvLyBkdXJhdGlvbiBpcyB0aGUgYHdhaXRgIGFjdGlvblxuICAgIC8vIHVwc3RyZWFtIHN5c3RlbSBleHBlY3RzIHNlY29uZHMgbm90IG1pbGxpc2Vjb25kc1xuICAgIGR1cmF0aW9uID0gcGFyc2VGbG9hdChnZXN0dXJlc1sxXS5vcHRpb25zLm1zKSAvIDEwMDA7XG4gIH0gZWxzZSB7XG4gICAgLy8gZ2l2ZSBhIHNhbmUgZGVmYXVsdCBkdXJhdGlvblxuICAgIGR1cmF0aW9uID0gMC44O1xuICB9XG5cbiAgbGV0IHBhcmFtcyA9IHtcbiAgICBkdXJhdGlvbixcbiAgICB4OiBwcmVzc09wdHMueCxcbiAgICB5OiBwcmVzc09wdHMueSxcbiAgfTtcblxuICBsZXQgZW5kcG9pbnQ7XG4gIGlmIChlbCkge1xuICAgIGVuZHBvaW50ID0gYC91aWFFbGVtZW50LyR7ZWx9L3RvdWNoQW5kSG9sZGA7XG4gIH0gZWxzZSB7XG4gICAgcGFyYW1zLnggPSBwcmVzc09wdHMueDtcbiAgICBwYXJhbXMueSA9IHByZXNzT3B0cy55O1xuXG4gICAgZW5kcG9pbnQgPSAnL3RvdWNoQW5kSG9sZCc7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGVuZHBvaW50LCAnUE9TVCcsIHBhcmFtcyk7XG59O1xuXG5mdW5jdGlvbiBkZXRlcm1pbmVQaW5jaFNjYWxlICh4LCB5LCBwaW5jaCkge1xuICBsZXQgc2NhbGUgPSB4ID4geSA/IHggLSB5IDogeSAtIHg7XG4gIGlmIChwaW5jaCkge1xuICAgIC8vIFRPRE86IHJldmlzaXQgdGhpcyB3aGVuIHBpbmNoaW5nIGFjdHVhbGx5IHdvcmtzLCBzaW5jZSBpdCBpcyBpbXBvc3NpYmxlIHRvXG4gICAgLy8ga25vdyB3aGF0IHRoZSBzY2FsZSBmYWN0b3IgZG9lcyBhdCB0aGlzIHBvaW50IChYY29kZSA4LjEpXG4gICAgc2NhbGUgPSAxIC8gc2NhbGU7XG4gICAgaWYgKHNjYWxlIDwgMC4wMikge1xuICAgICAgLy8gdGhpcyBpcyB0aGUgbWluaW11bSB0aGF0IEFwcGxlIHdpbGwgYWxsb3dcbiAgICAgIC8vIGJ1dCBXREEgd2lsbCBub3QgdGhyb3cgYW4gZXJyb3IgaWYgaXQgaXMgdG9vIGxvd1xuICAgICAgc2NhbGUgPSAwLjAyO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAvLyBmb3Igem9vbSwgZWFjaCAxMHB4IGlzIG9uZSBzY2FsZSBmYWN0b3JcbiAgICBzY2FsZSA9IHNjYWxlIC8gMTA7XG4gIH1cbiAgcmV0dXJuIHNjYWxlO1xufVxuXG5oZWxwZXJzLmhhbmRsZVBpbmNoT3Jab29tID0gYXN5bmMgZnVuY3Rpb24gKGFjdGlvbnMpIHtcbiAgLy8gY3VycmVudGx5IHdlIGNhbiBvbmx5IGRvIHRoaXMgYWN0aW9uIG9uIGFuIGVsZW1lbnRcbiAgaWYgKCFhY3Rpb25zWzBdWzBdLm9wdGlvbnMuZWxlbWVudCB8fFxuICAgICAgYWN0aW9uc1swXVswXS5vcHRpb25zLmVsZW1lbnQgIT09IGFjdGlvbnNbMV1bMF0ub3B0aW9ucy5lbGVtZW50KSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ1BpbmNoL3pvb20gYWN0aW9ucyBtdXN0IGJlIGRvbmUgb24gYSBzaW5nbGUgZWxlbWVudCcpO1xuICB9XG4gIGxldCBlbCA9IGFjdGlvbnNbMF1bMF0ub3B0aW9ucy5lbGVtZW50O1xuXG4gIC8vIGFzc3VtZSB0aGF0IGFjdGlvbiBpcyBpbiBhIHNpbmdsZSBwbGFuZSAoeCBvciB5LCBub3QgaG9yaXpvbnRhbCBhdCBhbGwpXG4gIC8vIHRlcm1pbm9sb2d5IGFsbCBhc3N1bWluZyByaWdodCBoYW5kZWRuZXNzXG4gIGxldCBzY2FsZSwgdmVsb2NpdHk7XG4gIGlmIChhY3Rpb25zWzBdWzBdLm9wdGlvbnMueSA9PT0gYWN0aW9uc1swXVsxXS5vcHRpb25zLnkpIHtcbiAgICAvLyBob3Jpem9udGFsLCBzaW5jZSB5IG9mZnNldCBpcyB0aGUgc2FtZSBpbiBwcmVzcyBhbmQgbW92ZVRvXG4gICAgbGV0IHRodW1iID0gKGFjdGlvbnNbMF1bMF0ub3B0aW9ucy54IDw9IGFjdGlvbnNbMV1bMF0ub3B0aW9ucy54KSA/IGFjdGlvbnNbMF0gOiBhY3Rpb25zWzFdO1xuXG4gICAgLy8gbm93IGRlY2lwaGVyIHBpbmNoIHZzLiB6b29tLFxuICAgIC8vICAgcGluY2g6IHRodW1iIG1vdmluZyBmcm9tIGxlZnQgdG8gcmlnaHRcbiAgICAvLyAgIHpvb206IHRodW1iIG1vdmluZyBmcm9tIHJpZ2h0IHRvIGxlZnRcbiAgICBzY2FsZSA9IGRldGVybWluZVBpbmNoU2NhbGUodGh1bWJbMF0ub3B0aW9ucy54LCB0aHVtYlsxXS5vcHRpb25zLngsIHRodW1iWzBdLm9wdGlvbnMueCA8PSB0aHVtYlsxXS5vcHRpb25zLngpO1xuICB9IGVsc2Uge1xuICAgIC8vIHZlcnRpY2FsXG4gICAgbGV0IGZvcmVmaW5nZXIgPSAoYWN0aW9uc1swXVswXS5vcHRpb25zLnkgPD0gYWN0aW9uc1sxXVswXS5vcHRpb25zLnkpID8gYWN0aW9uc1swXSA6IGFjdGlvbnNbMV07XG5cbiAgICAvLyBub3cgZGVjaXBoZXIgcGluY2ggdnMuIHpvb21cbiAgICAvLyAgIHBpbmNoOiBmb3JlZmluZ2VyIG1vdmluZyBmcm9tIHRvcCB0byBib3R0b21cbiAgICAvLyAgIHpvb206IGZvcmVmaW5nZXIgbW92aW5nIGZyb20gYm90dG9tIHRvIHRvcFxuICAgIHNjYWxlID0gZGV0ZXJtaW5lUGluY2hTY2FsZShmb3JlZmluZ2VyWzBdLm9wdGlvbnMueSwgZm9yZWZpbmdlclsxXS5vcHRpb25zLnksIGZvcmVmaW5nZXJbMF0ub3B0aW9ucy55IDw9IGZvcmVmaW5nZXJbMV0ub3B0aW9ucy55KTtcbiAgfVxuICB2ZWxvY2l0eSA9IHNjYWxlIDwgMSA/IC0xIDogMTtcblxuICBsb2cuZGVidWcoYERlY29kZWQgJHtzY2FsZSA8IDEgPyAncGluY2gnIDogJ3pvb20nfSBhY3Rpb24gd2l0aCBzY2FsZSAnJHtzY2FsZX0nIGFuZCB2ZWxvY2l0eSAnJHt2ZWxvY2l0eX0nYCk7XG4gIGlmIChzY2FsZSA8IDEpIHtcbiAgICBsb2cud2FybignUGluY2ggYWN0aW9ucyBtYXkgbm90IHdvcmssIGR1ZSB0byBBcHBsZSBpc3N1ZS4nKTtcbiAgfVxuXG4gIGxldCBwYXJhbXMgPSB7XG4gICAgc2NhbGUsXG4gICAgdmVsb2NpdHlcbiAgfTtcbiAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3BpbmNoYCwgJ1BPU1QnLCBwYXJhbXMpO1xufTtcblxuaGVscGVycy5tb2JpbGVTY3JvbGwgPSBhc3luYyBmdW5jdGlvbiAob3B0cz17fSkge1xuICBpZiAoIW9wdHMuZWxlbWVudCkge1xuICAgIG9wdHMuZWxlbWVudCA9IGF3YWl0IHRoaXMuZmluZEVsZW1lbnQoYGNsYXNzIG5hbWVgLCBgWENVSUVsZW1lbnRUeXBlQXBwbGljYXRpb25gKTtcbiAgfVxuICAvLyBXREEgc3VwcG9ydHMgZm91ciBzY3JvbGxpbmcgc3RyYXRlZ2llczogcHJlZGljYXRpb24gYmFzZWQgb24gbmFtZSwgZGlyZWN0aW9uLFxuICAvLyBwcmVkaWNhdGVTdHJpbmcsIGFuZCB0b1Zpc2libGUsIGluIHRoYXQgb3JkZXIuXG4gIGxldCBwYXJhbXMgPSB7fTtcbiAgaWYgKG9wdHMubmFtZSkge1xuICAgIHBhcmFtcy5uYW1lID0gb3B0cy5uYW1lO1xuICB9IGVsc2UgaWYgKG9wdHMuZGlyZWN0aW9uKSB7XG4gICAgcGFyYW1zLmRpcmVjdGlvbiA9IG9wdHMuZGlyZWN0aW9uO1xuICB9IGVsc2UgaWYgKG9wdHMucHJlZGljYXRlU3RyaW5nKSB7XG4gICAgcGFyYW1zLnByZWRpY2F0ZVN0cmluZyA9IG9wdHMucHJlZGljYXRlU3RyaW5nO1xuICB9IGVsc2UgaWYgKG9wdHMudG9WaXNpYmxlKSB7XG4gICAgcGFyYW1zLnRvVmlzaWJsZSA9IG9wdHMudG9WaXNpYmxlO1xuICB9IGVsc2Uge1xuICAgIGxldCBtc2cgPSAnTW9iaWxlIHNjcm9sbCBzdXBwb3J0cyB0aGUgZm9sbG93aW5nIHN0cmF0ZWdpZXM6IG5hbWUsICcgK1xuICAgICAgICAgICAgICAnZGlyZWN0aW9uLCBwcmVkaWNhdGVTdHJpbmcsIGFuZCB0b1Zpc2libGUuIFNwZWNpZnkgb25lIG9mIHRoZXNlJztcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICB9XG5cbiAgbGV0IGVsZW1lbnQgPSBvcHRzLmVsZW1lbnQuRUxFTUVOVCA/IG9wdHMuZWxlbWVudC5FTEVNRU5UIDogb3B0cy5lbGVtZW50O1xuICBsZXQgZW5kcG9pbnQgPSBgL3VpYUVsZW1lbnQvJHtlbGVtZW50fS9zY3JvbGxgO1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsICdQT1NUJywgcGFyYW1zKTtcbn07XG5cbmhlbHBlcnMuZ2V0Q29vcmRpbmF0ZXMgPSBhc3luYyBmdW5jdGlvbihnZXN0dXJlKSB7XG4gIGxldCBlbCA9IGdlc3R1cmUub3B0aW9ucy5lbGVtZW50O1xuXG4gIC8vIGRlZmF1bHRzXG4gIGxldCBjb29yZGluYXRlcyA9IHt4OiAwLCB5OiAwLCBhcmVPZmZzZXRzOiBmYWxzZX07XG5cbiAgLy8gZmlndXJlIG91dCB0aGUgZWxlbWVudCBjb29yZGluYXRlcy5cbiAgaWYgKGVsKSB7XG4gICAgbGV0IHJlY3QgPSBhd2FpdCB0aGlzLmdldFJlY3QoZWwpO1xuICAgIGxldCBwb3MgPSB7eDogcmVjdC54LCB5OiByZWN0Lnl9O1xuICAgIGxldCBzaXplID0ge3c6IHJlY3Qud2lkdGgsIGg6IHJlY3QuaGVpZ2h0fTtcblxuICAgIC8vIGRlZmF1bHRzXG4gICAgbGV0IG9mZnNldFggPSAwO1xuICAgIGxldCBvZmZzZXRZID0gMDtcblxuICAgIC8vIGdldCB0aGUgcmVhbCBvZmZzZXRzXG4gICAgaWYgKGdlc3R1cmUub3B0aW9ucy54IHx8IGdlc3R1cmUub3B0aW9ucy55KSB7XG4gICAgICBvZmZzZXRYID0gKGdlc3R1cmUub3B0aW9ucy54IHx8IDApO1xuICAgICAgb2Zmc2V0WSA9IChnZXN0dXJlLm9wdGlvbnMueSB8fCAwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgb2Zmc2V0WCA9IChzaXplLncgLyAyKTtcbiAgICAgIG9mZnNldFkgPSAoc2l6ZS5oIC8gMik7XG4gICAgfVxuXG4gICAgLy8gYXBwbHkgdGhlIG9mZnNldHNcbiAgICBjb29yZGluYXRlcy54ID0gcG9zLnggKyBvZmZzZXRYO1xuICAgIGNvb3JkaW5hdGVzLnkgPSBwb3MueSArIG9mZnNldFk7XG4gIH0gZWxzZSB7XG4gICAgLy8gbW92ZVRvIGNvb3JkaW5hdGVzIGFyZSBwYXNzZWQgaW4gYXMgb2Zmc2V0c1xuICAgIGNvb3JkaW5hdGVzLmFyZU9mZnNldHMgPSAoZ2VzdHVyZS5hY3Rpb24gPT09ICdtb3ZlVG8nKTtcbiAgICBjb29yZGluYXRlcy54ID0gKGdlc3R1cmUub3B0aW9ucy54IHx8IDApO1xuICAgIGNvb3JkaW5hdGVzLnkgPSAoZ2VzdHVyZS5vcHRpb25zLnkgfHwgMCk7XG4gIH1cbiAgcmV0dXJuIGNvb3JkaW5hdGVzO1xufTtcblxuaGVscGVycy5hcHBseU1vdmVUb09mZnNldCA9IGZ1bmN0aW9uIChmaXJzdENvb3JkaW5hdGVzLCBzZWNvbmRDb29yZGluYXRlcykge1xuICBpZiAoc2Vjb25kQ29vcmRpbmF0ZXMuYXJlT2Zmc2V0cykge1xuICAgIHJldHVybiB7XG4gICAgICB4OiBmaXJzdENvb3JkaW5hdGVzLnggKyBzZWNvbmRDb29yZGluYXRlcy54LFxuICAgICAgeTogZmlyc3RDb29yZGluYXRlcy55ICsgc2Vjb25kQ29vcmRpbmF0ZXMueSxcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBzZWNvbmRDb29yZGluYXRlcztcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBoZWxwZXJzLCBjb21tYW5kcyk7XG5leHBvcnQgeyBleHRlbnNpb25zLCBoZWxwZXJzLCBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
