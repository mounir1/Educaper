'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _nodeSimctl = require('node-simctl');

var _iosAppUtils = require('ios-app-utils');

var _webdriveragent = require('./webdriveragent');

var _webdriveragent2 = _interopRequireDefault(_webdriveragent);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _simulatorManagement = require('./simulator-management');

var _appiumIosSimulator = require('appium-ios-simulator');

var _asyncbox = require('asyncbox');

var _appiumIosDriver = require('appium-ios-driver');

var _desiredCaps = require('./desired-caps');

var _desiredCaps2 = _interopRequireDefault(_desiredCaps);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _utils = require('./utils');

var _realDeviceManagement = require('./real-device-management');

var _iosDeploy = require('./ios-deploy');

var _iosDeploy2 = _interopRequireDefault(_iosDeploy);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _packageJson = require('../../package.json');

// eslint-disable-line import/no-unresolved

var SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';

var NO_PROXY_NATIVE_LIST = [['GET', /context/], ['POST', /context/], ['GET', /window/], ['POST', /window/], ['DELETE', /window/], ['POST', /execute/], ['POST', /element$/], ['POST', /elements$/], ['POST', /timeouts/], ['GET', /alert_text/], ['POST', /alert_text/], ['POST', /accept_alert/], ['POST', /dismiss_alert/], ['GET', /source/], ['POST', /appium/], ['GET', /appium/], ['POST', /touch/], ['GET', /log/], ['POST', /log/], ['POST', /moveto/], ['POST', /receive_async_response/], // always, in case context switches while waiting
['GET', /location/], ['GET', /size/], ['POST', /value/], ['POST', /keys/], ['POST', /back/], ['POST', /session\/[^\/]+\/location/], // geo location, but not element location
['POST', /appium\/device\/lock/], ['POST', /shake/]];
var NO_PROXY_WEB_LIST = [['GET', /title/], ['GET', /url/], ['POST', /url/], ['POST', /element/], ['POST', /forward/], ['GET', /attribute/], ['GET', /text/], ['POST', /clear/], ['GET', /element/], ['POST', /click/], ['POST', /refresh/], ['GET', /cookie/], ['POST', /cookie/], ['DELETE', /cookie/], ['POST', /frame/]].concat(NO_PROXY_NATIVE_LIST);

var XCUITestDriver = (function (_BaseDriver) {
  _inherits(XCUITestDriver, _BaseDriver);

  function XCUITestDriver() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
    var shouldValidateCaps = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    _classCallCheck(this, XCUITestDriver);

    _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

    _logger2['default'].debug('XCUITestDriver version: ' + _packageJson.version);

    this.desiredCapConstraints = _desiredCaps2['default'];

    this.locatorStrategies = ['xpath', 'id', 'name', 'class name', '-ios predicate string', 'accessibility id'];
    this.webLocatorStrategies = ['link text', 'css selector', 'tag name', 'link text', 'partial link text'];

    this.resetIos();
  }

  _createClass(XCUITestDriver, [{
    key: 'resetIos',
    value: function resetIos() {
      this.opts = this.opts || {};
      this.wda = null;
      this.opts.device = null;
      this.jwpProxyActive = false;
      this.proxyReqRes = null;
      this.jwpProxyAvoid = [];
      this.safari = false;

      // some things that commands imported from appium-ios-driver need
      this.curWebFrames = [];
      this.webElementIds = [];
      this._currentUrl = null;
      this.curContext = null;
      this.xcodeVersion = null;
      this.iosSdkVersion = null;
      this.contexts = [];
      this.implicitWaitMs = 0;
      this.asynclibWaitMs = 0;
      this.pageLoadMs = 6000;
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      var wdaStatus;
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxyCommand('/status', 'GET'));

          case 2:
            wdaStatus = context$2$0.sent;
            return context$2$0.abrupt('return', { wda: wdaStatus });

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSession',
    value: function createSession(caps) {
      var _ref, _ref2, sessionId;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.lifecycleData = {}; // this is used for keeping track of the state we start so when we delete the session we can put things back
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'createSession', this).call(this, caps));

          case 4:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 1);
            sessionId = _ref2[0];

            this.opts.sessionId = sessionId;

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.start());

          case 10:

            // merge server capabilities + desired capabilities
            caps = _Object$assign({}, _appiumIosDriver.defaultServerCaps, caps);
            return context$2$0.abrupt('return', [sessionId, caps]);

          case 14:
            context$2$0.prev = 14;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].error(context$2$0.t0);
            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(this.deleteSession());

          case 19:
            throw context$2$0.t0;

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 14]]);
    }
  }, {
    key: 'start',
    value: function start() {
      var _ref3, device, udid, realDevice, msg;

      return _regeneratorRuntime.async(function start$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.opts.noReset = !!this.opts.noReset;
            this.opts.fullReset = !!this.opts.fullReset;

            if (this.xcodeVersion) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _utils.getAndCheckXcodeVersion)());

          case 5:
            this.xcodeVersion = context$2$0.sent;

            _logger2['default'].debug('Xcode version set to \'' + this.xcodeVersion.versionString + '\'');

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _utils.getAndCheckIosSdkVersion)());

          case 9:
            this.iosSdkVersion = context$2$0.sent;

            _logger2['default'].debug('iOS SDK Version set to \'' + this.iosSdkVersion + '\'');

            if (!(this.opts.platformVersion && parseFloat(this.opts.platformVersion) < 9.3)) {
              context$2$0.next = 13;
              break;
            }

            throw Error('Platform version must be 9.3 or above. \'' + this.opts.platformVersion + '\' is not supported.');

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.determineDevice());

          case 15:
            _ref3 = context$2$0.sent;
            device = _ref3.device;
            udid = _ref3.udid;
            realDevice = _ref3.realDevice;

            _logger2['default'].info('Determining device to run tests on: udid: \'' + udid + '\', real device: ' + realDevice);
            this.opts.device = device;
            this.opts.udid = udid;
            this.opts.realDevice = realDevice;

            if (!(this.isSimulator() && this.opts.customSSLCert)) {
              context$2$0.next = 26;
              break;
            }

            context$2$0.next = 26;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.installSSLCert)(this.opts.customSSLCert, this.opts.udid));

          case 26:
            if (this.opts.platformVersion) {
              context$2$0.next = 34;
              break;
            }

            if (!(this.opts.device && _lodash2['default'].isFunction(this.opts.device.getPlatformVersion))) {
              context$2$0.next = 34;
              break;
            }

            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.opts.device.getPlatformVersion());

          case 30:
            this.opts.platformVersion = context$2$0.sent;

            _logger2['default'].info('No platformVersion specified. Using device version: \'' + this.opts.platformVersion + '\'');
            context$2$0.next = 34;
            break;

          case 34:
            // TODO: this is when it is a real device. when we have a real object wire it in

            // make sure that the xcode we are using can handle the platform
            if (parseFloat(this.opts.platformVersion) > parseFloat(this.iosSdkVersion)) {
              msg = 'Xcode ' + this.xcodeVersion.versionString + ' has a maximum SDK version of ' + this.iosSdkVersion + '. ' + ('It does not support iOS version ' + this.opts.platformVersion);

              _logger2['default'].errorAndThrow(msg);
            }

            if (!((this.opts.browserName || '').toLowerCase() === 'safari')) {
              context$2$0.next = 45;
              break;
            }

            _logger2['default'].info('Safari test requested');
            this.safari = true;
            this.opts.app = undefined;
            this.opts.processArguments = this.opts.processArguments || {};
            this.opts.bundleId = SAFARI_BUNDLE_ID;
            this._currentUrl = this.opts.safariInitialUrl || (this.isRealDevice() ? 'http://appium.io' : 'http://' + this.opts.address + ':' + this.opts.port + '/welcome');
            this.opts.processArguments.args = ['-u', this._currentUrl];
            context$2$0.next = 47;
            break;

          case 45:
            context$2$0.next = 47;
            return _regeneratorRuntime.awrap(this.configureApp());

          case 47:
            if (!this.opts.app) {
              context$2$0.next = 50;
              break;
            }

            context$2$0.next = 50;
            return _regeneratorRuntime.awrap(this.checkAppPresent());

          case 50:
            if (this.opts.bundleId) {
              context$2$0.next = 54;
              break;
            }

            context$2$0.next = 53;
            return _regeneratorRuntime.awrap(this.extractBundleId(this.opts.app));

          case 53:
            this.opts.bundleId = context$2$0.sent;

          case 54:

            if (!this.opts.realDevice && this.opts.scaleFactor !== undefined) {
              _logger2['default'].info('Settings non-default Simulator scale factor ' + this.opts.scaleFactor);
              device.setScaleFactor(this.opts.scaleFactor);
            }

            // handle logging
            this.logs = {};
            context$2$0.next = 58;
            return _regeneratorRuntime.awrap(this.startLogCapture());

          case 58:

            _logger2['default'].info('Setting up ' + (this.isRealDevice() ? 'real device' : 'simulator'));

            if (this.isRealDevice()) {
              context$2$0.next = 67;
              break;
            }

            context$2$0.next = 62;
            return _regeneratorRuntime.awrap(_appiumIosDriver.settings.setLocale(this.opts.device, this.opts, {}, this.isSafari()));

          case 62:
            this.localeConfig = context$2$0.sent;
            context$2$0.next = 65;
            return _regeneratorRuntime.awrap(_appiumIosDriver.settings.setPreferences(this.opts.device, this.opts, this.isSafari()));

          case 65:
            context$2$0.next = 67;
            return _regeneratorRuntime.awrap(this.startSim());

          case 67:
            if (!this.opts.app) {
              context$2$0.next = 70;
              break;
            }

            context$2$0.next = 70;
            return _regeneratorRuntime.awrap(this.installApp());

          case 70:
            context$2$0.next = 72;
            return _regeneratorRuntime.awrap(this.startWda(this.opts.sessionId, realDevice));

          case 72:
            context$2$0.next = 74;
            return _regeneratorRuntime.awrap(this.setInitialOrientation(this.opts.orientation));

          case 74:
            if (!(this.isSafari() || this.opts.autoWebview)) {
              context$2$0.next = 78;
              break;
            }

            _logger2['default'].debug('Waiting for initial webview');
            context$2$0.next = 78;
            return _regeneratorRuntime.awrap(this.navToInitialWebview());

          case 78:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startWda',
    value: function startWda(sessionId, realDevice) {
      var tries = arguments.length <= 2 || arguments[2] === undefined ? 0 : arguments[2];
      return _regeneratorRuntime.async(function startWda$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            tries++;
            this.wda = new _webdriveragent2['default'](this.xcodeVersion, this.opts);

            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.wda.launch(sessionId, realDevice));

          case 5:
            context$2$0.next = 18;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](2);

            if (!((context$2$0.t0.message || '').indexOf('xcodebuild failed with code 65') === -1)) {
              context$2$0.next = 11;
              break;
            }

            throw context$2$0.t0;

          case 11:
            // Xcode error code 65 means that the WDA app is still being installed
            // and xcodebuild can't do its business, so it is reasonable to retry
            _logger2['default'].debug('xcodebuild failure warrants retry. Retrying...');
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.wda.quit());

          case 14:
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.wda.uninstall());

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(this.wda.launch(sessionId, realDevice));

          case 18:

            this.proxyReqRes = this.wda.proxyReqRes.bind(this.wda);
            this.jwpProxyActive = true;

            context$2$0.prev = 20;
            context$2$0.next = 23;
            return _regeneratorRuntime.awrap(this.startWdaSession(this.opts.bundleId, this.opts.processArguments));

          case 23:
            context$2$0.next = 37;
            break;

          case 25:
            context$2$0.prev = 25;
            context$2$0.t1 = context$2$0['catch'](20);

            _logger2['default'].debug('Unable to start WebDriverAgent session: ' + context$2$0.t1.message);

            if (!(tries > 2)) {
              context$2$0.next = 30;
              break;
            }

            throw context$2$0.t1;

          case 30:

            _logger2['default'].debug('Quitting and uninstalling WebDriverAgent, then retrying');
            context$2$0.next = 33;
            return _regeneratorRuntime.awrap(this.wda.quit());

          case 33:
            context$2$0.next = 35;
            return _regeneratorRuntime.awrap(this.wda.uninstall());

          case 35:
            context$2$0.next = 37;
            return _regeneratorRuntime.awrap(this.startWda(sessionId, realDevice, tries));

          case 37:
            if (!(typeof this.opts.preventWDAAttachments !== 'undefined')) {
              context$2$0.next = 40;
              break;
            }

            context$2$0.next = 40;
            return _regeneratorRuntime.awrap((0, _utils.adjustWDAAttachmentsPermissions)(this.opts.preventWDAAttachments ? '555' : '755'));

          case 40:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 7], [20, 25]]);
    }

    // create an alias so we can actually unit test createSession by stubbing
    // this
  }, {
    key: 'extractBundleId',
    value: function extractBundleId(app) {
      return _regeneratorRuntime.async(function extractBundleId$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _iosAppUtils.extractBundleId)(app));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stop());

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'deleteSession', this).call(this));

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.jwpProxyActive = false;
            this.proxyReqRes = null;

            if (!this.wda) {
              context$2$0.next = 8;
              break;
            }

            if (!this.wda.jwproxy) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.proxyCommand('/session/' + this.sessionId, 'DELETE'));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.wda.quit());

          case 8:
            if (!this.isWebContext()) {
              context$2$0.next = 12;
              break;
            }

            _logger2['default'].debug('In a web session. Removing remote debugger');
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.stopRemote());

          case 12:
            if (!this.isRealDevice()) {
              context$2$0.next = 17;
              break;
            }

            context$2$0.next = 15;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.runRealDeviceReset)(this.opts.device, this.opts));

          case 15:
            context$2$0.next = 19;
            break;

          case 17:
            context$2$0.next = 19;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.runSimulatorReset)(this.opts.device, this.opts));

          case 19:
            if (!(this.isSimulator() && this.opts.udid && this.opts.customSSLCert)) {
              context$2$0.next = 22;
              break;
            }

            context$2$0.next = 22;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.uninstallSSLCert)(this.opts.customSSLCert, this.opts.udid));

          case 22:
            if (!(!this.opts.noReset && !!this.opts.device)) {
              context$2$0.next = 32;
              break;
            }

            _logger2['default'].debug('Resetting simulator');

            if (!this.lifecycleData.bootSim) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Shutting down simulator');
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.opts.device.shutdown());

          case 28:
            if (!this.lifecycleData.createSim) {
              context$2$0.next = 32;
              break;
            }

            _logger2['default'].debug('Deleting simulator created for this run');
            context$2$0.next = 32;
            return _regeneratorRuntime.awrap(this.opts.device['delete']());

          case 32:

            if (!_lodash2['default'].isEmpty(this.logs)) {
              this.logs.syslog.stopCapture();
              this.logs = {};
            }

            this.resetIos();

          case 34:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      var _get2;

      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Executing command \'' + cmd + '\'');

            if (!(cmd === 'receiveAsyncResponse')) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.receiveAsyncResponse.apply(this, args));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((_get2 = _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'executeCommand', this)).call.apply(_get2, [this, cmd].concat(args)));

          case 7:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkAppPresent',
    value: function checkAppPresent() {
      return _regeneratorRuntime.async(function checkAppPresent$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Checking whether app \'' + this.opts.app + '\' is actually present');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.opts.app));

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].errorAndThrow('Could not find app at ' + this.opts.app);

          case 5:
            _logger2['default'].debug('App is present');

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'configureApp',
    value: function configureApp() {
      var appIsPackageOrBundle;
      return _regeneratorRuntime.async(function configureApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            appIsPackageOrBundle = function appIsPackageOrBundle(app) {
              return (/^([a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+)+$/.test(app)
              );
            };

            // the app name is a bundleId assign it to the bundleId property
            if (!this.opts.bundleId && appIsPackageOrBundle(this.opts.app)) {
              this.opts.bundleId = this.opts.app;
              this.opts.app = '';
            }
            // we have a bundle ID, but no app, or app is also a bundle

            if (!(this.opts.bundleId && appIsPackageOrBundle(this.opts.bundleId) && (this.opts.app === '' || appIsPackageOrBundle(this.opts.app)))) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].debug('App is an iOS bundle, will attempt to run as pre-existing');
            return context$2$0.abrupt('return');

          case 5:
            if (!(this.opts.app && this.opts.app.toLowerCase() === 'settings')) {
              context$2$0.next = 11;
              break;
            }

            this.opts.bundleId = 'com.apple.Preferences';
            this.opts.app = null;
            return context$2$0.abrupt('return');

          case 11:
            if (!(this.opts.app && this.opts.app.toLowerCase() === 'calendar')) {
              context$2$0.next = 15;
              break;
            }

            this.opts.bundleId = 'com.apple.mobilecal';
            this.opts.app = null;
            return context$2$0.abrupt('return');

          case 15:
            context$2$0.prev = 15;
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(this.helpers.configureApp(this.opts.app, '.app', this.opts.mountRoot, this.opts.windowsShareUserName, this.opts.windowsSharePassword));

          case 18:
            this.opts.app = context$2$0.sent;
            context$2$0.next = 25;
            break;

          case 21:
            context$2$0.prev = 21;
            context$2$0.t0 = context$2$0['catch'](15);

            _logger2['default'].error(context$2$0.t0);
            throw new Error('Bad app: ' + this.opts.app + '. App paths need to be absolute, or relative to the appium ' + 'server install dir, or a URL to compressed file, or a special app name.');

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[15, 21]]);
    }
  }, {
    key: 'determineDevice',
    value: function determineDevice() {
      var _device, devices, _device2, device;

      return _regeneratorRuntime.async(function determineDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // in the one case where we create a sim, we will set this state
            this.lifecycleData.createSim = false;

            // if we get generic names, translate them
            this.opts.deviceName = (function translateDeviceName() {
              var dn = arguments.length <= 0 || arguments[0] === undefined ? '' : arguments[0];

              var deviceName = dn;
              if (dn.toLowerCase() === 'iphone simulator') {
                deviceName = 'iPhone 6';
              } else if (dn.toLowerCase() === 'ipad simulator') {
                deviceName = 'iPad Retina';
              }
              if (deviceName !== dn) {
                _logger2['default'].debug('Changing deviceName from \'' + dn + '\' to \'' + deviceName + '\'');
              }
              return deviceName;
            })(this.opts.deviceName);

            // check for a particular simulator
            context$2$0.t0 = this.opts.udid;

            if (!context$2$0.t0) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.simExists)(this.opts.udid));

          case 6:
            context$2$0.t0 = context$2$0.sent;

          case 7:
            if (!context$2$0.t0) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.getSimulator)(this.opts.udid));

          case 10:
            _device = context$2$0.sent;
            return context$2$0.abrupt('return', { device: _device, realDevice: false, udid: this.opts.udid });

          case 12:
            if (!this.opts.udid) {
              context$2$0.next = 29;
              break;
            }

            if (!(this.opts.udid.toLowerCase() === 'auto')) {
              context$2$0.next = 19;
              break;
            }

            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _utils.detectUdid)());

          case 16:
            this.opts.udid = context$2$0.sent;
            context$2$0.next = 25;
            break;

          case 19:
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.getConnectedDevices)());

          case 21:
            devices = context$2$0.sent;

            _logger2['default'].debug('Available devices: ' + devices.join(', '));

            if (!(devices.indexOf(this.opts.udid) === -1)) {
              context$2$0.next = 25;
              break;
            }

            throw new Error('Unknown device or simulator UDID: \'' + this.opts.udid + '\'');

          case 25:
            context$2$0.next = 27;
            return _regeneratorRuntime.awrap(this.getIDeviceObj());

          case 27:
            _device2 = context$2$0.sent;
            return context$2$0.abrupt('return', { device: _device2, realDevice: true, udid: this.opts.udid });

          case 29:
            context$2$0.next = 31;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.getExistingSim)(this.opts.deviceName, this.opts.platformVersion));

          case 31:
            device = context$2$0.sent;

            if (!device) {
              context$2$0.next = 40;
              break;
            }

            if (!(this.opts.reset || this.opts.fullReset)) {
              context$2$0.next = 39;
              break;
            }

            _logger2['default'].debug('Full reset requested. Cleaning and stopping simulator');
            context$2$0.next = 37;
            return _regeneratorRuntime.awrap(device.clean());

          case 37:
            context$2$0.next = 39;
            return _regeneratorRuntime.awrap(device.shutdown());

          case 39:
            return context$2$0.abrupt('return', { device: device, realDevice: false, udid: device.udid });

          case 40:

            // no device of this type exists, so create one
            _logger2['default'].info('Simluator udid not provided, using desired caps to create a new simulator');
            if (!this.opts.platformVersion) {
              _logger2['default'].info('No platformVersion specified. Using latest version Xcode supports: \'' + this.iosSdkVersion + '\' ' + 'This may cause problems if a simulator does not exist for this platform version.');
              this.opts.platformVersion = this.iosSdkVersion;
            }
            context$2$0.next = 44;
            return _regeneratorRuntime.awrap(this.createSim());

          case 44:
            device = context$2$0.sent;
            return context$2$0.abrupt('return', { device: device, realDevice: false, udid: device.udid });

          case 46:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSim',
    value: function startSim() {
      return _regeneratorRuntime.async(function startSim$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.simBooted)(this.opts.device));

          case 2:
            if (context$2$0.sent) {
              context$2$0.next = 11;
              break;
            }

            _logger2['default'].info('Simulator with udid \'' + this.opts.udid + '\' not booted. Booting up now');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.opts.device.run());

          case 8:
            this.lifecycleData.bootSim = true;
            context$2$0.next = 13;
            break;

          case 11:
            _logger2['default'].info('Simulator with udid \'' + this.opts.udid + '\' already booted');
            this.lifecycleData.bootSim = false;

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSim',
    value: function createSim() {
      var sim;
      return _regeneratorRuntime.async(function createSim$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.lifecycleData.createSim = true;

            // create sim for caps
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.createSim)(this.opts, this.sessionId));

          case 3:
            sim = context$2$0.sent;

            _logger2['default'].info('Created simulator with udid \'' + sim.udid + '\'.');

            return context$2$0.abrupt('return', sim);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launchApp',
    value: function launchApp() {
      var APP_LAUNCH_TIMEOUT, checkStatus, retries;
      return _regeneratorRuntime.async(function launchApp$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            APP_LAUNCH_TIMEOUT = 20 * 1000;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.launch)(this.opts.device.udid, this.opts.bundleId));

          case 3:
            checkStatus = function checkStatus() {
              var response, currentApp;
              return _regeneratorRuntime.async(function checkStatus$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.proxyCommand('/status', 'GET'));

                  case 2:
                    response = context$3$0.sent;
                    currentApp = response.currentApp.bundleID;

                    if (!(currentApp !== this.opts.bundleId)) {
                      context$3$0.next = 6;
                      break;
                    }

                    throw new Error(this.opts.bundleId + ' not in foreground. ' + currentApp + ' is in foreground');

                  case 6:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            };

            _logger2['default'].info('Waiting for \'' + this.opts.bundleId + '\' to be in foreground');
            retries = parseInt(APP_LAUNCH_TIMEOUT / 200, 10);
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(retries, 200, checkStatus));

          case 8:
            _logger2['default'].info(this.opts.bundleId + ' is in foreground');

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startWdaSession',
    value: function startWdaSession(bundleId, processArguments) {
      var args, env, desired;
      return _regeneratorRuntime.async(function startWdaSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = processArguments ? processArguments.args : [];
            env = processArguments ? processArguments.env : {};
            desired = {
              desiredCapabilities: {
                bundleId: bundleId,
                arguments: args,
                environment: env,
                shouldWaitForQuiescence: true
              }
            };
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand('/session', 'POST', desired));

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // Override Proxy methods from BaseDriver
  }, {
    key: 'proxyActive',
    value: function proxyActive() {
      return this.jwpProxyActive;
    }
  }, {
    key: 'getProxyAvoidList',
    value: function getProxyAvoidList() {
      if (this.isWebview()) {
        return NO_PROXY_WEB_LIST;
      }
      return NO_PROXY_NATIVE_LIST;
    }
  }, {
    key: 'canProxy',
    value: function canProxy() {
      return true;
    }
  }, {
    key: 'isSafari',
    value: function isSafari() {
      return !!this.safari;
    }
  }, {
    key: 'isRealDevice',
    value: function isRealDevice() {
      return this.opts.realDevice;
    }
  }, {
    key: 'isSimulator',
    value: function isSimulator() {
      return !this.opts.realDevice;
    }
  }, {
    key: 'isWebview',
    value: function isWebview() {
      return this.isSafari() || this.isWebContext();
    }
  }, {
    key: 'validateLocatorStrategy',
    value: function validateLocatorStrategy(strategy) {
      _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'validateLocatorStrategy', this).call(this, strategy, this.isWebContext());
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      // check with the base class, and return if it fails
      var res = _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
      if (!res) return res;

      // make sure that the capabilities have one of `app` or `bundleId`
      if ((caps.browserName || '').toLowerCase() !== 'safari' && !caps.app && !caps.bundleId) {
        var msg = 'The desired capabilities must include either an app or a bundleId for iOS';
        _logger2['default'].errorAndThrow(msg);
      }

      var verifyProcessArgument = function verifyProcessArgument(processArguments) {
        if (!_lodash2['default'].isNil(processArguments.args) && !_lodash2['default'].isArray(processArguments.args)) {
          _logger2['default'].errorAndThrow('processArguments.args must be an array of string');
        }

        if (!_lodash2['default'].isNil(processArguments.env) && !_lodash2['default'].isObject(caps.processArguments.env)) {
          _logger2['default'].errorAndThrow('processArguments.env must be an object <key,value> pair {a:b, c:d}');
        }
      };

      // `processArguments` should be JSON string or an object with arguments and/ environment details
      if (caps.processArguments) {
        if (_lodash2['default'].isString(caps.processArguments)) {
          try {
            // try to parse the string as JSON
            caps.processArguments = JSON.parse(caps.processArguments);
            verifyProcessArgument(caps.processArguments);
          } catch (err) {
            _logger2['default'].errorAndThrow('processArguments must be a json format or an object with format {args : [], env : {a:b, c:d}}. Both environment and argument can be null. Error: ' + err);
          }
        } else if (_lodash2['default'].isObject(caps.processArguments)) {
          verifyProcessArgument(caps.processArguments);
        } else {
          _logger2['default'].errorAndThrow('processArguments must be an object, or a string JSON object with format {args : [], env : {a:b, c:d}}. Both environment and argument can be null.');
        }
      }

      // there is no point in having `keychainPath` without `keychainPassword`
      if (caps.keychainPath && !caps.keychainPassword || !caps.keychainPath && caps.keychainPassword) {
        _logger2['default'].errorAndThrow('If \'keychainPath\' is set, \'keychainPassword\' must also be set (and vice versa).');
      }

      // finally, return true since the superclass check passed, as did this
      return true;
    }
  }, {
    key: 'installApp',
    value: function installApp() {
      var pause;
      return _regeneratorRuntime.async(function installApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.isSafari()) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return');

          case 2:
            if (!(this.opts.autoLaunch === false)) {
              context$2$0.next = 4;
              break;
            }

            return context$2$0.abrupt('return');

          case 4:
            if (!this.isRealDevice()) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.installToRealDevice());

          case 7:
            context$2$0.next = 11;
            break;

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.installToSimulator());

          case 11:
            if (!_appiumSupport.util.hasValue(this.opts.iosInstallPause)) {
              context$2$0.next = 15;
              break;
            }

            pause = parseInt(this.opts.iosInstallPause, 10);
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(pause));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'installToSimulator',
    value: function installToSimulator() {
      return _regeneratorRuntime.async(function installToSimulator$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.opts.fullReset && this.opts.bundleId)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('Full reset requested. Removing app from device');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.removeApp)(this.opts.device.udid, this.opts.bundleId));

          case 4:
            _logger2['default'].debug('Installing app \'' + this.opts.app + '\' on device');
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.installApp)(this.opts.device.udid, this.opts.app));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'installToRealDevice',
    value: function installToRealDevice() {
      return _regeneratorRuntime.async(function installToRealDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.opts.udid) {
              context$2$0.next = 25;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.opts.device.isInstalled(this.opts.bundleId));

          case 3:
            if (!context$2$0.sent) {
              context$2$0.next = 15;
              break;
            }

            _logger2['default'].debug("App is already installed.");

            if (!this.opts.fullReset) {
              context$2$0.next = 11;
              break;
            }

            _logger2['default'].debug('Full reset requested. Forcing app install after uninstall app');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.opts.device.remove(this.opts.bundleId));

          case 9:
            context$2$0.next = 13;
            break;

          case 11:
            _logger2['default'].debug('Full reset not requested. No need to install.');
            return context$2$0.abrupt('return');

          case 13:
            context$2$0.next = 16;
            break;

          case 15:
            _logger2['default'].debug('App is not installed. Will try to install.');

          case 16:
            if (!this.opts.app) {
              context$2$0.next = 22;
              break;
            }

            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(this.opts.device.install(this.opts.app));

          case 19:
            _logger2['default'].debug('App installed successfully.');
            context$2$0.next = 23;
            break;

          case 22:
            _logger2['default'].debug("Real device specified but no ipa or app path, assuming bundle ID is " + "on device");

          case 23:
            context$2$0.next = 26;
            break;

          case 25:
            _logger2['default'].debug("No device id or app, not installing to real device.");

          case 26:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getIDeviceObj',
    value: function getIDeviceObj() {
      var iDevice, msg;
      return _regeneratorRuntime.async(function getIDeviceObj$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Creating iDevice object with udid ' + this.opts.udid);
            context$2$0.prev = 1;
            iDevice = new _iosDeploy2['default'](this.opts.udid);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(iDevice.checkStatus());

          case 5:
            return context$2$0.abrupt('return', iDevice);

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](1);
            msg = "Could not initialize ios-deploy make sure it is " + "installed and works on your system";

            _logger2['default'].error(msg);
            throw new Error(msg);

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 8]]);
    }
  }, {
    key: 'setInitialOrientation',
    value: function setInitialOrientation(orientation) {
      return _regeneratorRuntime.async(function setInitialOrientation$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (typeof orientation !== 'string') {
              orientation = 'PORTRAIT';
            }
            orientation = orientation.toUpperCase();

            if (_lodash2['default'].includes(['LANDSCAPE', 'PORTRAIT'], orientation)) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].debug('Unable to set initial orientation to \'' + orientation + '\'');
            return context$2$0.abrupt('return');

          case 5:
            _logger2['default'].debug('Setting initial orientation to \'' + orientation + '\'');
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.proxyCommand('/orientation', 'POST', { orientation: orientation }));

          case 9:
            this.opts.curOrientation = orientation;
            context$2$0.next = 15;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].warn('Setting initial orientation failed with: ' + context$2$0.t0);

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 12]]);
    }
  }, {
    key: 'driverData',
    get: function get() {
      // TODO fill out resource info here
      return {};
    }
  }]);

  return XCUITestDriver;
})(_appiumBaseDriver.BaseDriver);

var _iteratorNormalCompletion = true;
var _didIteratorError = false;
var _iteratorError = undefined;

try {

  for (var _iterator = _getIterator(_lodash2['default'].toPairs(_commandsIndex2['default'])), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
    var _step$value = _slicedToArray(_step.value, 2);

    var cmd = _step$value[0];
    var fn = _step$value[1];

    XCUITestDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError = true;
  _iteratorError = err;
} finally {
  try {
    if (!_iteratorNormalCompletion && _iterator['return']) {
      _iterator['return']();
    }
  } finally {
    if (_didIteratorError) {
      throw _iteratorError;
    }
  }
}

exports['default'] = XCUITestDriver;
exports.XCUITestDriver = XCUITestDriver;

// TODO add validation on caps
// TODO handle otherSessionData for multiple sessions

// at this point if there is no platformVersion, get it from the device

// fail very early if the app doesn't actually exist

// check for supported build-in apps

// download if necessary

// check for a particular real device

// make sure it is a connected device. If not, the udid passed in is invalid

// figure out the correct simulator to use, given the desired capabilities

// check for an existing simulator

// TODO for now just kill all sims unless specified udid is booted.
// if booted, use it. if not booted, start it up
// if no udid, well lets see if we can start one up based on desired caps
// if we support multiple sims we need to change this

// if user has passed in desiredCaps.autoLaunch = false
// meaning they will manage app install / launching

// https://github.com/appium/appium/issues/6889

//This iDevice object could be ideviceinstaller (node-idevice) for future once we have ideviceinstaller working for ios 10
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0dBQ3BDOzs7Ozs7Ozs7Ozs7Ozs7O3FCQUdjLGNBQWM7UUFDcEIsY0FBYyxHQUFkLGNBQWMiLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEcml2ZXIgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbGF1bmNoLCBpbnN0YWxsQXBwLCByZW1vdmVBcHAgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyBleHRyYWN0QnVuZGxlSWQgfSBmcm9tICdpb3MtYXBwLXV0aWxzJztcbmltcG9ydCBXZWJEcml2ZXJBZ2VudCBmcm9tICcuL3dlYmRyaXZlcmFnZW50JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgc2ltQm9vdGVkLCBjcmVhdGVTaW0sIGdldEV4aXN0aW5nU2ltLCBydW5TaW11bGF0b3JSZXNldCB9IGZyb20gJy4vc2ltdWxhdG9yLW1hbmFnZW1lbnQnO1xuaW1wb3J0IHsga2lsbEFsbFNpbXVsYXRvcnMsIHNpbUV4aXN0cywgZ2V0U2ltdWxhdG9yLCBpbnN0YWxsU1NMQ2VydCwgdW5pbnN0YWxsU1NMQ2VydCB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBzZXR0aW5ncyBhcyBpb3NTZXR0aW5ncywgZGVmYXVsdFNlcnZlckNhcHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgZGVzaXJlZENhcENvbnN0cmFpbnRzIGZyb20gJy4vZGVzaXJlZC1jYXBzJztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCB7IGRldGVjdFVkaWQsIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uLCBnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24sIGFkanVzdFdEQUF0dGFjaG1lbnRzUGVybWlzc2lvbnMgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IGdldENvbm5lY3RlZERldmljZXMsIHJ1blJlYWxEZXZpY2VSZXNldCB9IGZyb20gJy4vcmVhbC1kZXZpY2UtbWFuYWdlbWVudCc7XG5pbXBvcnQgSU9TRGVwbG95IGZyb20gJy4vaW9zLWRlcGxveSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB2ZXJzaW9uIH0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBpbXBvcnQvbm8tdW5yZXNvbHZlZFxuXG5cbmNvbnN0IFNBRkFSSV9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLm1vYmlsZXNhZmFyaSc7XG5cbmNvbnN0IE5PX1BST1hZX05BVElWRV9MSVNUID0gW1xuICBbJ0dFVCcsIC9jb250ZXh0L10sXG4gIFsnUE9TVCcsIC9jb250ZXh0L10sXG4gIFsnR0VUJywgL3dpbmRvdy9dLFxuICBbJ1BPU1QnLCAvd2luZG93L10sXG4gIFsnREVMRVRFJywgL3dpbmRvdy9dLFxuICBbJ1BPU1QnLCAvZXhlY3V0ZS9dLFxuICBbJ1BPU1QnLCAvZWxlbWVudCQvXSxcbiAgWydQT1NUJywgL2VsZW1lbnRzJC9dLFxuICBbJ1BPU1QnLCAvdGltZW91dHMvXSxcbiAgWydHRVQnLCAvYWxlcnRfdGV4dC9dLFxuICBbJ1BPU1QnLCAvYWxlcnRfdGV4dC9dLFxuICBbJ1BPU1QnLCAvYWNjZXB0X2FsZXJ0L10sXG4gIFsnUE9TVCcsIC9kaXNtaXNzX2FsZXJ0L10sXG4gIFsnR0VUJywgL3NvdXJjZS9dLFxuICBbJ1BPU1QnLCAvYXBwaXVtL10sXG4gIFsnR0VUJywgL2FwcGl1bS9dLFxuICBbJ1BPU1QnLCAvdG91Y2gvXSxcbiAgWydHRVQnLCAvbG9nL10sXG4gIFsnUE9TVCcsIC9sb2cvXSxcbiAgWydQT1NUJywgL21vdmV0by9dLFxuICBbJ1BPU1QnLCAvcmVjZWl2ZV9hc3luY19yZXNwb25zZS9dLCAvLyBhbHdheXMsIGluIGNhc2UgY29udGV4dCBzd2l0Y2hlcyB3aGlsZSB3YWl0aW5nXG4gIFsnR0VUJywgL2xvY2F0aW9uL10sXG4gIFsnR0VUJywgL3NpemUvXSxcbiAgWydQT1NUJywgL3ZhbHVlL10sXG4gIFsnUE9TVCcsIC9rZXlzL10sXG4gIFsnUE9TVCcsIC9iYWNrL10sXG4gIFsnUE9TVCcsIC9zZXNzaW9uXFwvW15cXC9dK1xcL2xvY2F0aW9uL10sIC8vIGdlbyBsb2NhdGlvbiwgYnV0IG5vdCBlbGVtZW50IGxvY2F0aW9uXG4gIFsnUE9TVCcsIC9hcHBpdW1cXC9kZXZpY2VcXC9sb2NrL10sXG4gIFsnUE9TVCcsIC9zaGFrZS9dLFxuXTtcbmNvbnN0IE5PX1BST1hZX1dFQl9MSVNUID0gW1xuICBbJ0dFVCcsIC90aXRsZS9dLFxuICBbJ0dFVCcsIC91cmwvXSxcbiAgWydQT1NUJywgL3VybC9dLFxuICBbJ1BPU1QnLCAvZWxlbWVudC9dLFxuICBbJ1BPU1QnLCAvZm9yd2FyZC9dLFxuICBbJ0dFVCcsIC9hdHRyaWJ1dGUvXSxcbiAgWydHRVQnLCAvdGV4dC9dLFxuICBbJ1BPU1QnLCAvY2xlYXIvXSxcbiAgWydHRVQnLCAvZWxlbWVudC9dLFxuICBbJ1BPU1QnLCAvY2xpY2svXSxcbiAgWydQT1NUJywgL3JlZnJlc2gvXSxcbiAgWydHRVQnLCAvY29va2llL10sXG4gIFsnUE9TVCcsIC9jb29raWUvXSxcbiAgWydERUxFVEUnLCAvY29va2llL10sXG4gIFsnUE9TVCcsIC9mcmFtZS9dLFxuXS5jb25jYXQoTk9fUFJPWFlfTkFUSVZFX0xJU1QpO1xuXG5jbGFzcyBYQ1VJVGVzdERyaXZlciBleHRlbmRzIEJhc2VEcml2ZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9LCBzaG91bGRWYWxpZGF0ZUNhcHMgPSB0cnVlKSB7XG4gICAgc3VwZXIob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAgIGxvZy5kZWJ1ZyhgWENVSVRlc3REcml2ZXIgdmVyc2lvbjogJHt2ZXJzaW9ufWApO1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSBkZXNpcmVkQ2FwQ29uc3RyYWludHM7XG5cbiAgICB0aGlzLmxvY2F0b3JTdHJhdGVnaWVzID0gW1xuICAgICAgJ3hwYXRoJyxcbiAgICAgICdpZCcsXG4gICAgICAnbmFtZScsXG4gICAgICAnY2xhc3MgbmFtZScsXG4gICAgICAnLWlvcyBwcmVkaWNhdGUgc3RyaW5nJyxcbiAgICAgICdhY2Nlc3NpYmlsaXR5IGlkJ1xuICAgIF07XG4gICAgdGhpcy53ZWJMb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICdsaW5rIHRleHQnLFxuICAgICAgJ2NzcyBzZWxlY3RvcicsXG4gICAgICAndGFnIG5hbWUnLFxuICAgICAgJ2xpbmsgdGV4dCcsXG4gICAgICAncGFydGlhbCBsaW5rIHRleHQnXG4gICAgXTtcblxuICAgIHRoaXMucmVzZXRJb3MoKTtcbiAgfVxuXG4gIHJlc2V0SW9zICgpIHtcbiAgICB0aGlzLm9wdHMgPSB0aGlzLm9wdHMgfHwge307XG4gICAgdGhpcy53ZGEgPSBudWxsO1xuICAgIHRoaXMub3B0cy5kZXZpY2UgPSBudWxsO1xuICAgIHRoaXMuandwUHJveHlBY3RpdmUgPSBmYWxzZTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gbnVsbDtcbiAgICB0aGlzLmp3cFByb3h5QXZvaWQgPSBbXTtcbiAgICB0aGlzLnNhZmFyaSA9IGZhbHNlO1xuXG4gICAgLy8gc29tZSB0aGluZ3MgdGhhdCBjb21tYW5kcyBpbXBvcnRlZCBmcm9tIGFwcGl1bS1pb3MtZHJpdmVyIG5lZWRcbiAgICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICAgIHRoaXMud2ViRWxlbWVudElkcyA9IFtdO1xuICAgIHRoaXMuX2N1cnJlbnRVcmwgPSBudWxsO1xuICAgIHRoaXMuY3VyQ29udGV4dCA9IG51bGw7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSBudWxsO1xuICAgIHRoaXMuaW9zU2RrVmVyc2lvbiA9IG51bGw7XG4gICAgdGhpcy5jb250ZXh0cyA9IFtdO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSAwO1xuICAgIHRoaXMuYXN5bmNsaWJXYWl0TXMgPSAwO1xuICAgIHRoaXMucGFnZUxvYWRNcyA9IDYwMDA7XG4gIH1cblxuICBnZXQgZHJpdmVyRGF0YSAoKSB7XG4gICAgLy8gVE9ETyBmaWxsIG91dCByZXNvdXJjZSBpbmZvIGhlcmVcbiAgICByZXR1cm4ge307XG4gIH1cblxuICBhc3luYyBnZXRTdGF0dXMgKCkge1xuICAgIGxldCB3ZGFTdGF0dXMgPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICByZXR1cm4ge3dkYTogd2RhU3RhdHVzfTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24gKGNhcHMpIHtcbiAgICB0aGlzLmxpZmVjeWNsZURhdGEgPSB7fTsgLy8gdGhpcyBpcyB1c2VkIGZvciBrZWVwaW5nIHRyYWNrIG9mIHRoZSBzdGF0ZSB3ZSBzdGFydCBzbyB3aGVuIHdlIGRlbGV0ZSB0aGUgc2Vzc2lvbiB3ZSBjYW4gcHV0IHRoaW5ncyBiYWNrXG4gICAgdHJ5IHtcbiAgICAgIC8vIFRPRE8gYWRkIHZhbGlkYXRpb24gb24gY2Fwc1xuICAgICAgLy8gVE9ETyBoYW5kbGUgb3RoZXJTZXNzaW9uRGF0YSBmb3IgbXVsdGlwbGUgc2Vzc2lvbnNcbiAgICAgIGxldCBbc2Vzc2lvbklkXSA9IGF3YWl0IHN1cGVyLmNyZWF0ZVNlc3Npb24oY2Fwcyk7XG4gICAgICB0aGlzLm9wdHMuc2Vzc2lvbklkID0gc2Vzc2lvbklkO1xuXG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG5cbiAgICAgIC8vIG1lcmdlIHNlcnZlciBjYXBhYmlsaXRpZXMgKyBkZXNpcmVkIGNhcGFiaWxpdGllc1xuICAgICAgY2FwcyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRTZXJ2ZXJDYXBzLCBjYXBzKTtcbiAgICAgIHJldHVybiBbc2Vzc2lvbklkLCBjYXBzXTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3IoZSk7XG4gICAgICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24oKTtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIHRoaXMub3B0cy5ub1Jlc2V0ID0gISF0aGlzLm9wdHMubm9SZXNldDtcbiAgICB0aGlzLm9wdHMuZnVsbFJlc2V0ID0gISF0aGlzLm9wdHMuZnVsbFJlc2V0O1xuXG4gICAgaWYgKCF0aGlzLnhjb2RlVmVyc2lvbikge1xuICAgICAgdGhpcy54Y29kZVZlcnNpb24gPSBhd2FpdCBnZXRBbmRDaGVja1hjb2RlVmVyc2lvbigpO1xuICAgICAgbG9nLmRlYnVnKGBYY29kZSB2ZXJzaW9uIHNldCB0byAnJHt0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nfSdgKTtcbiAgICB9XG5cbiAgICB0aGlzLmlvc1Nka1ZlcnNpb24gPSBhd2FpdCBnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24oKTtcbiAgICBsb2cuZGVidWcoYGlPUyBTREsgVmVyc2lvbiBzZXQgdG8gJyR7dGhpcy5pb3NTZGtWZXJzaW9ufSdgKTtcblxuICAgIGlmICh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uICYmIHBhcnNlRmxvYXQodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbikgPCA5LjMpIHtcbiAgICAgIHRocm93IEVycm9yKGBQbGF0Zm9ybSB2ZXJzaW9uIG11c3QgYmUgOS4zIG9yIGFib3ZlLiAnJHt0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9ufScgaXMgbm90IHN1cHBvcnRlZC5gKTtcbiAgICB9XG5cbiAgICBsZXQgeyBkZXZpY2UsIHVkaWQsIHJlYWxEZXZpY2UgfSA9IGF3YWl0IHRoaXMuZGV0ZXJtaW5lRGV2aWNlKCk7XG4gICAgbG9nLmluZm8oYERldGVybWluaW5nIGRldmljZSB0byBydW4gdGVzdHMgb246IHVkaWQ6ICcke3VkaWR9JywgcmVhbCBkZXZpY2U6ICR7cmVhbERldmljZX1gKTtcbiAgICB0aGlzLm9wdHMuZGV2aWNlID0gZGV2aWNlO1xuICAgIHRoaXMub3B0cy51ZGlkID0gdWRpZDtcbiAgICB0aGlzLm9wdHMucmVhbERldmljZSA9IHJlYWxEZXZpY2U7XG5cbiAgICBpZiAodGhpcy5pc1NpbXVsYXRvcigpICYmIHRoaXMub3B0cy5jdXN0b21TU0xDZXJ0KSB7XG4gICAgICBhd2FpdCBpbnN0YWxsU1NMQ2VydCh0aGlzLm9wdHMuY3VzdG9tU1NMQ2VydCwgdGhpcy5vcHRzLnVkaWQpO1xuICAgIH1cblxuICAgIC8vIGF0IHRoaXMgcG9pbnQgaWYgdGhlcmUgaXMgbm8gcGxhdGZvcm1WZXJzaW9uLCBnZXQgaXQgZnJvbSB0aGUgZGV2aWNlXG4gICAgaWYgKCF0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uKSB7XG4gICAgICBpZiAodGhpcy5vcHRzLmRldmljZSAmJiBfLmlzRnVuY3Rpb24odGhpcy5vcHRzLmRldmljZS5nZXRQbGF0Zm9ybVZlcnNpb24pKSB7XG4gICAgICAgIHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24gPSBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmdldFBsYXRmb3JtVmVyc2lvbigpO1xuICAgICAgICBsb2cuaW5mbyhgTm8gcGxhdGZvcm1WZXJzaW9uIHNwZWNpZmllZC4gVXNpbmcgZGV2aWNlIHZlcnNpb246ICcke3RoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb259J2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVE9ETzogdGhpcyBpcyB3aGVuIGl0IGlzIGEgcmVhbCBkZXZpY2UuIHdoZW4gd2UgaGF2ZSBhIHJlYWwgb2JqZWN0IHdpcmUgaXQgaW5cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgeGNvZGUgd2UgYXJlIHVzaW5nIGNhbiBoYW5kbGUgdGhlIHBsYXRmb3JtXG4gICAgaWYgKHBhcnNlRmxvYXQodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbikgPiBwYXJzZUZsb2F0KHRoaXMuaW9zU2RrVmVyc2lvbikpIHtcbiAgICAgIGxldCBtc2cgPSBgWGNvZGUgJHt0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nfSBoYXMgYSBtYXhpbXVtIFNESyB2ZXJzaW9uIG9mICR7dGhpcy5pb3NTZGtWZXJzaW9ufS4gYCArXG4gICAgICAgICAgICAgICAgYEl0IGRvZXMgbm90IHN1cHBvcnQgaU9TIHZlcnNpb24gJHt0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9ufWA7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cblxuICAgIGlmICgodGhpcy5vcHRzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnc2FmYXJpJykge1xuICAgICAgbG9nLmluZm8oJ1NhZmFyaSB0ZXN0IHJlcXVlc3RlZCcpO1xuICAgICAgdGhpcy5zYWZhcmkgPSB0cnVlO1xuICAgICAgdGhpcy5vcHRzLmFwcCA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMub3B0cy5wcm9jZXNzQXJndW1lbnRzID0gdGhpcy5vcHRzLnByb2Nlc3NBcmd1bWVudHMgfHwge307XG4gICAgICB0aGlzLm9wdHMuYnVuZGxlSWQgPSBTQUZBUklfQlVORExFX0lEO1xuICAgICAgdGhpcy5fY3VycmVudFVybCA9IHRoaXMub3B0cy5zYWZhcmlJbml0aWFsVXJsIHx8IChcbiAgICAgICAgdGhpcy5pc1JlYWxEZXZpY2UoKSA/XG4gICAgICAgICdodHRwOi8vYXBwaXVtLmlvJyA6XG4gICAgICAgIGBodHRwOi8vJHt0aGlzLm9wdHMuYWRkcmVzc306JHt0aGlzLm9wdHMucG9ydH0vd2VsY29tZWBcbiAgICAgICk7XG4gICAgICB0aGlzLm9wdHMucHJvY2Vzc0FyZ3VtZW50cy5hcmdzID0gWyctdScsIHRoaXMuX2N1cnJlbnRVcmxdO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLmNvbmZpZ3VyZUFwcCgpO1xuICAgIH1cblxuICAgIC8vIGZhaWwgdmVyeSBlYXJseSBpZiB0aGUgYXBwIGRvZXNuJ3QgYWN0dWFsbHkgZXhpc3RcbiAgICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgICAgYXdhaXQgdGhpcy5jaGVja0FwcFByZXNlbnQoKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gYXdhaXQgdGhpcy5leHRyYWN0QnVuZGxlSWQodGhpcy5vcHRzLmFwcCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm9wdHMucmVhbERldmljZSAmJiB0aGlzLm9wdHMuc2NhbGVGYWN0b3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgbG9nLmluZm8oYFNldHRpbmdzIG5vbi1kZWZhdWx0IFNpbXVsYXRvciBzY2FsZSBmYWN0b3IgJHt0aGlzLm9wdHMuc2NhbGVGYWN0b3J9YCk7XG4gICAgICBkZXZpY2Uuc2V0U2NhbGVGYWN0b3IodGhpcy5vcHRzLnNjYWxlRmFjdG9yKTtcbiAgICB9XG5cbiAgICAvLyBoYW5kbGUgbG9nZ2luZ1xuICAgIHRoaXMubG9ncyA9IHt9O1xuICAgIGF3YWl0IHRoaXMuc3RhcnRMb2dDYXB0dXJlKCk7XG5cbiAgICBsb2cuaW5mbyhgU2V0dGluZyB1cCAke3RoaXMuaXNSZWFsRGV2aWNlKCkgPyAncmVhbCBkZXZpY2UnIDogJ3NpbXVsYXRvcid9YCk7XG4gICAgaWYgKCF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICB0aGlzLmxvY2FsZUNvbmZpZyA9IGF3YWl0IGlvc1NldHRpbmdzLnNldExvY2FsZSh0aGlzLm9wdHMuZGV2aWNlLCB0aGlzLm9wdHMsIHt9LCB0aGlzLmlzU2FmYXJpKCkpO1xuICAgICAgYXdhaXQgaW9zU2V0dGluZ3Muc2V0UHJlZmVyZW5jZXModGhpcy5vcHRzLmRldmljZSwgdGhpcy5vcHRzLCB0aGlzLmlzU2FmYXJpKCkpO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFNpbSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm9wdHMuYXBwKSB7XG4gICAgICBhd2FpdCB0aGlzLmluc3RhbGxBcHAoKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnN0YXJ0V2RhKHRoaXMub3B0cy5zZXNzaW9uSWQsIHJlYWxEZXZpY2UpO1xuXG4gICAgYXdhaXQgdGhpcy5zZXRJbml0aWFsT3JpZW50YXRpb24odGhpcy5vcHRzLm9yaWVudGF0aW9uKTtcblxuICAgIGlmICh0aGlzLmlzU2FmYXJpKCkgfHwgdGhpcy5vcHRzLmF1dG9XZWJ2aWV3KSB7XG4gICAgICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGluaXRpYWwgd2VidmlldycpO1xuICAgICAgYXdhaXQgdGhpcy5uYXZUb0luaXRpYWxXZWJ2aWV3KCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnRXZGEgKHNlc3Npb25JZCwgcmVhbERldmljZSwgdHJpZXMgPSAwKSB7XG4gICAgdHJpZXMrKztcbiAgICB0aGlzLndkYSA9IG5ldyBXZWJEcml2ZXJBZ2VudCh0aGlzLnhjb2RlVmVyc2lvbiwgdGhpcy5vcHRzKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLndkYS5sYXVuY2goc2Vzc2lvbklkLCByZWFsRGV2aWNlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmICgoZXJyLm1lc3NhZ2UgfHwgJycpLmluZGV4T2YoJ3hjb2RlYnVpbGQgZmFpbGVkIHdpdGggY29kZSA2NScpID09PSAtMSkge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgICAvLyBYY29kZSBlcnJvciBjb2RlIDY1IG1lYW5zIHRoYXQgdGhlIFdEQSBhcHAgaXMgc3RpbGwgYmVpbmcgaW5zdGFsbGVkXG4gICAgICAvLyBhbmQgeGNvZGVidWlsZCBjYW4ndCBkbyBpdHMgYnVzaW5lc3MsIHNvIGl0IGlzIHJlYXNvbmFibGUgdG8gcmV0cnlcbiAgICAgIGxvZy5kZWJ1ZygneGNvZGVidWlsZCBmYWlsdXJlIHdhcnJhbnRzIHJldHJ5LiBSZXRyeWluZy4uLicpO1xuICAgICAgYXdhaXQgdGhpcy53ZGEucXVpdCgpO1xuICAgICAgYXdhaXQgdGhpcy53ZGEudW5pbnN0YWxsKCk7XG4gICAgICBhd2FpdCB0aGlzLndkYS5sYXVuY2goc2Vzc2lvbklkLCByZWFsRGV2aWNlKTtcbiAgICB9XG5cbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy53ZGEucHJveHlSZXFSZXMuYmluZCh0aGlzLndkYSk7XG4gICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IHRydWU7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFdkYVNlc3Npb24odGhpcy5vcHRzLmJ1bmRsZUlkLCB0aGlzLm9wdHMucHJvY2Vzc0FyZ3VtZW50cyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBzdGFydCBXZWJEcml2ZXJBZ2VudCBzZXNzaW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgaWYgKHRyaWVzID4gMikgdGhyb3cgZXJyO1xuXG4gICAgICBsb2cuZGVidWcoJ1F1aXR0aW5nIGFuZCB1bmluc3RhbGxpbmcgV2ViRHJpdmVyQWdlbnQsIHRoZW4gcmV0cnlpbmcnKTtcbiAgICAgIGF3YWl0IHRoaXMud2RhLnF1aXQoKTtcbiAgICAgIGF3YWl0IHRoaXMud2RhLnVuaW5zdGFsbCgpO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFdkYShzZXNzaW9uSWQsIHJlYWxEZXZpY2UsIHRyaWVzKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHRoaXMub3B0cy5wcmV2ZW50V0RBQXR0YWNobWVudHMgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBhd2FpdCBhZGp1c3RXREFBdHRhY2htZW50c1Blcm1pc3Npb25zKHRoaXMub3B0cy5wcmV2ZW50V0RBQXR0YWNobWVudHMgPyAnNTU1JyA6ICc3NTUnKTtcbiAgICB9XG4gIH1cblxuICAvLyBjcmVhdGUgYW4gYWxpYXMgc28gd2UgY2FuIGFjdHVhbGx5IHVuaXQgdGVzdCBjcmVhdGVTZXNzaW9uIGJ5IHN0dWJiaW5nXG4gIC8vIHRoaXNcbiAgYXN5bmMgZXh0cmFjdEJ1bmRsZUlkIChhcHApIHtcbiAgICByZXR1cm4gYXdhaXQgZXh0cmFjdEJ1bmRsZUlkKGFwcCk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBhd2FpdCB0aGlzLnN0b3AoKTtcblxuICAgIGF3YWl0IHN1cGVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkge1xuICAgIHRoaXMuandwUHJveHlBY3RpdmUgPSBmYWxzZTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gbnVsbDtcblxuICAgIGlmICh0aGlzLndkYSkge1xuICAgICAgaWYgKHRoaXMud2RhLmp3cHJveHkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9YCwgJ0RFTEVURScpO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy53ZGEucXVpdCgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICBsb2cuZGVidWcoJ0luIGEgd2ViIHNlc3Npb24uIFJlbW92aW5nIHJlbW90ZSBkZWJ1Z2dlcicpO1xuICAgICAgYXdhaXQgdGhpcy5zdG9wUmVtb3RlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGF3YWl0IHJ1blJlYWxEZXZpY2VSZXNldCh0aGlzLm9wdHMuZGV2aWNlLCB0aGlzLm9wdHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCBydW5TaW11bGF0b3JSZXNldCh0aGlzLm9wdHMuZGV2aWNlLCB0aGlzLm9wdHMpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzU2ltdWxhdG9yKCkgJiYgdGhpcy5vcHRzLnVkaWQgJiYgdGhpcy5vcHRzLmN1c3RvbVNTTENlcnQpIHtcbiAgICAgIGF3YWl0IHVuaW5zdGFsbFNTTENlcnQodGhpcy5vcHRzLmN1c3RvbVNTTENlcnQsIHRoaXMub3B0cy51ZGlkKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMub3B0cy5ub1Jlc2V0ICYmICEhdGhpcy5vcHRzLmRldmljZSkge1xuICAgICAgbG9nLmRlYnVnKCdSZXNldHRpbmcgc2ltdWxhdG9yJyk7XG4gICAgICBpZiAodGhpcy5saWZlY3ljbGVEYXRhLmJvb3RTaW0pIHtcbiAgICAgICAgbG9nLmRlYnVnKCdTaHV0dGluZyBkb3duIHNpbXVsYXRvcicpO1xuICAgICAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLnNodXRkb3duKCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5saWZlY3ljbGVEYXRhLmNyZWF0ZVNpbSkge1xuICAgICAgICBsb2cuZGVidWcoJ0RlbGV0aW5nIHNpbXVsYXRvciBjcmVhdGVkIGZvciB0aGlzIHJ1bicpO1xuICAgICAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmRlbGV0ZSgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc0VtcHR5KHRoaXMubG9ncykpIHtcbiAgICAgIHRoaXMubG9ncy5zeXNsb2cuc3RvcENhcHR1cmUoKTtcbiAgICAgIHRoaXMubG9ncyA9IHt9O1xuICAgIH1cblxuICAgIHRoaXMucmVzZXRJb3MoKTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICBsb2cuZGVidWcoYEV4ZWN1dGluZyBjb21tYW5kICcke2NtZH0nYCk7XG4gICAgaWYgKGNtZCA9PT0gJ3JlY2VpdmVBc3luY1Jlc3BvbnNlJykge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVjZWl2ZUFzeW5jUmVzcG9uc2UoLi4uYXJncyk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBzdXBlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICB9XG5cblxuICBhc3luYyBjaGVja0FwcFByZXNlbnQgKCkge1xuICAgIGxvZy5kZWJ1ZyhgQ2hlY2tpbmcgd2hldGhlciBhcHAgJyR7dGhpcy5vcHRzLmFwcH0nIGlzIGFjdHVhbGx5IHByZXNlbnRgKTtcbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5vcHRzLmFwcCkpKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGZpbmQgYXBwIGF0ICR7dGhpcy5vcHRzLmFwcH1gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKCdBcHAgaXMgcHJlc2VudCcpO1xuICB9XG5cbiAgYXN5bmMgY29uZmlndXJlQXBwICgpIHtcbiAgICBmdW5jdGlvbiBhcHBJc1BhY2thZ2VPckJ1bmRsZSAoYXBwKSB7XG4gICAgICByZXR1cm4gKC9eKFthLXpBLVowLTlcXC1fXStcXC5bYS16QS1aMC05XFwtX10rKSskLykudGVzdChhcHApO1xuICAgIH1cblxuICAgIC8vIHRoZSBhcHAgbmFtZSBpcyBhIGJ1bmRsZUlkIGFzc2lnbiBpdCB0byB0aGUgYnVuZGxlSWQgcHJvcGVydHlcbiAgICBpZiAoIXRoaXMub3B0cy5idW5kbGVJZCAmJiBhcHBJc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYXBwKSkge1xuICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gdGhpcy5vcHRzLmFwcDtcbiAgICAgIHRoaXMub3B0cy5hcHAgPSAnJztcbiAgICB9XG4gICAgLy8gd2UgaGF2ZSBhIGJ1bmRsZSBJRCwgYnV0IG5vIGFwcCwgb3IgYXBwIGlzIGFsc28gYSBidW5kbGVcbiAgICBpZiAoKHRoaXMub3B0cy5idW5kbGVJZCAmJiBhcHBJc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYnVuZGxlSWQpKSAmJlxuICAgICAgICAodGhpcy5vcHRzLmFwcCA9PT0gJycgfHwgYXBwSXNQYWNrYWdlT3JCdW5kbGUodGhpcy5vcHRzLmFwcCkpKSB7XG4gICAgICBsb2cuZGVidWcoJ0FwcCBpcyBhbiBpT1MgYnVuZGxlLCB3aWxsIGF0dGVtcHQgdG8gcnVuIGFzIHByZS1leGlzdGluZycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuXG4gICAgLy8gY2hlY2sgZm9yIHN1cHBvcnRlZCBidWlsZC1pbiBhcHBzXG4gICAgaWYgKHRoaXMub3B0cy5hcHAgJiYgdGhpcy5vcHRzLmFwcC50b0xvd2VyQ2FzZSgpID09PSAnc2V0dGluZ3MnKSB7XG4gICAgICB0aGlzLm9wdHMuYnVuZGxlSWQgPSAnY29tLmFwcGxlLlByZWZlcmVuY2VzJztcbiAgICAgIHRoaXMub3B0cy5hcHAgPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAodGhpcy5vcHRzLmFwcCAmJiB0aGlzLm9wdHMuYXBwLnRvTG93ZXJDYXNlKCkgPT09ICdjYWxlbmRhcicpIHtcbiAgICAgIHRoaXMub3B0cy5idW5kbGVJZCA9ICdjb20uYXBwbGUubW9iaWxlY2FsJztcbiAgICAgIHRoaXMub3B0cy5hcHAgPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBkb3dubG9hZCBpZiBuZWNlc3NhcnlcbiAgICAgIHRoaXMub3B0cy5hcHAgPSBhd2FpdCB0aGlzLmhlbHBlcnMuY29uZmlndXJlQXBwKHRoaXMub3B0cy5hcHAsICcuYXBwJywgdGhpcy5vcHRzLm1vdW50Um9vdCwgdGhpcy5vcHRzLndpbmRvd3NTaGFyZVVzZXJOYW1lLCB0aGlzLm9wdHMud2luZG93c1NoYXJlUGFzc3dvcmQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yKGVycik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBCYWQgYXBwOiAke3RoaXMub3B0cy5hcHB9LiBBcHAgcGF0aHMgbmVlZCB0byBiZSBhYnNvbHV0ZSwgb3IgcmVsYXRpdmUgdG8gdGhlIGFwcGl1bSBgICtcbiAgICAgICAgJ3NlcnZlciBpbnN0YWxsIGRpciwgb3IgYSBVUkwgdG8gY29tcHJlc3NlZCBmaWxlLCBvciBhIHNwZWNpYWwgYXBwIG5hbWUuJyk7XG4gICAgfVxuICB9XG5cblxuICBhc3luYyBkZXRlcm1pbmVEZXZpY2UgKCkge1xuICAgIC8vIGluIHRoZSBvbmUgY2FzZSB3aGVyZSB3ZSBjcmVhdGUgYSBzaW0sIHdlIHdpbGwgc2V0IHRoaXMgc3RhdGVcbiAgICB0aGlzLmxpZmVjeWNsZURhdGEuY3JlYXRlU2ltID0gZmFsc2U7XG5cbiAgICAvLyBpZiB3ZSBnZXQgZ2VuZXJpYyBuYW1lcywgdHJhbnNsYXRlIHRoZW1cbiAgICB0aGlzLm9wdHMuZGV2aWNlTmFtZSA9IChmdW5jdGlvbiB0cmFuc2xhdGVEZXZpY2VOYW1lIChkbiA9ICcnKSB7XG4gICAgICBsZXQgZGV2aWNlTmFtZSA9IGRuO1xuICAgICAgaWYgKGRuLnRvTG93ZXJDYXNlKCkgPT09ICdpcGhvbmUgc2ltdWxhdG9yJykge1xuICAgICAgICBkZXZpY2VOYW1lID0gJ2lQaG9uZSA2JztcbiAgICAgIH0gZWxzZSBpZiAoZG4udG9Mb3dlckNhc2UoKSA9PT0gJ2lwYWQgc2ltdWxhdG9yJykge1xuICAgICAgICBkZXZpY2VOYW1lID0gJ2lQYWQgUmV0aW5hJztcbiAgICAgIH1cbiAgICAgIGlmIChkZXZpY2VOYW1lICE9PSBkbikge1xuICAgICAgICBsb2cuZGVidWcoYENoYW5naW5nIGRldmljZU5hbWUgZnJvbSAnJHtkbn0nIHRvICcke2RldmljZU5hbWV9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRldmljZU5hbWU7XG4gICAgfSkodGhpcy5vcHRzLmRldmljZU5hbWUpO1xuXG4gICAgLy8gY2hlY2sgZm9yIGEgcGFydGljdWxhciBzaW11bGF0b3JcbiAgICBpZiAodGhpcy5vcHRzLnVkaWQgJiYgKGF3YWl0IHNpbUV4aXN0cyh0aGlzLm9wdHMudWRpZCkpKSB7XG4gICAgICBsZXQgZGV2aWNlID0gYXdhaXQgZ2V0U2ltdWxhdG9yKHRoaXMub3B0cy51ZGlkKTtcbiAgICAgIHJldHVybiB7ZGV2aWNlLCByZWFsRGV2aWNlOiBmYWxzZSwgdWRpZDogdGhpcy5vcHRzLnVkaWR9O1xuICAgIH1cblxuICAgIC8vIGNoZWNrIGZvciBhIHBhcnRpY3VsYXIgcmVhbCBkZXZpY2VcbiAgICBpZiAodGhpcy5vcHRzLnVkaWQpIHtcbiAgICAgIGlmICh0aGlzLm9wdHMudWRpZC50b0xvd2VyQ2FzZSgpID09PSAnYXV0bycpIHtcbiAgICAgICAgdGhpcy5vcHRzLnVkaWQgPSBhd2FpdCBkZXRlY3RVZGlkKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBtYWtlIHN1cmUgaXQgaXMgYSBjb25uZWN0ZWQgZGV2aWNlLiBJZiBub3QsIHRoZSB1ZGlkIHBhc3NlZCBpbiBpcyBpbnZhbGlkXG4gICAgICAgIGxldCBkZXZpY2VzID0gYXdhaXQgZ2V0Q29ubmVjdGVkRGV2aWNlcygpO1xuICAgICAgICBsb2cuZGVidWcoYEF2YWlsYWJsZSBkZXZpY2VzOiAke2RldmljZXMuam9pbignLCAnKX1gKTtcbiAgICAgICAgaWYgKGRldmljZXMuaW5kZXhPZih0aGlzLm9wdHMudWRpZCkgPT09IC0xKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGRldmljZSBvciBzaW11bGF0b3IgVURJRDogJyR7dGhpcy5vcHRzLnVkaWR9J2ApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGxldCBkZXZpY2UgPSBhd2FpdCB0aGlzLmdldElEZXZpY2VPYmooKTtcbiAgICAgIHJldHVybiB7ZGV2aWNlLCByZWFsRGV2aWNlOiB0cnVlLCB1ZGlkOiB0aGlzLm9wdHMudWRpZH07XG4gICAgfVxuXG4gICAgLy8gZmlndXJlIG91dCB0aGUgY29ycmVjdCBzaW11bGF0b3IgdG8gdXNlLCBnaXZlbiB0aGUgZGVzaXJlZCBjYXBhYmlsaXRpZXNcbiAgICBsZXQgZGV2aWNlID0gYXdhaXQgZ2V0RXhpc3RpbmdTaW0odGhpcy5vcHRzLmRldmljZU5hbWUsIHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pO1xuXG4gICAgLy8gY2hlY2sgZm9yIGFuIGV4aXN0aW5nIHNpbXVsYXRvclxuICAgIGlmIChkZXZpY2UpIHtcbiAgICAgIGlmICh0aGlzLm9wdHMucmVzZXQgfHwgdGhpcy5vcHRzLmZ1bGxSZXNldCkge1xuICAgICAgICBsb2cuZGVidWcoJ0Z1bGwgcmVzZXQgcmVxdWVzdGVkLiBDbGVhbmluZyBhbmQgc3RvcHBpbmcgc2ltdWxhdG9yJyk7XG4gICAgICAgIGF3YWl0IGRldmljZS5jbGVhbigpO1xuICAgICAgICBhd2FpdCBkZXZpY2Uuc2h1dGRvd24oKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7ZGV2aWNlLCByZWFsRGV2aWNlOiBmYWxzZSwgdWRpZDogZGV2aWNlLnVkaWR9O1xuICAgIH1cblxuICAgIC8vIG5vIGRldmljZSBvZiB0aGlzIHR5cGUgZXhpc3RzLCBzbyBjcmVhdGUgb25lXG4gICAgbG9nLmluZm8oJ1NpbWx1YXRvciB1ZGlkIG5vdCBwcm92aWRlZCwgdXNpbmcgZGVzaXJlZCBjYXBzIHRvIGNyZWF0ZSBhIG5ldyBzaW11bGF0b3InKTtcbiAgICBpZiAoIXRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgIGxvZy5pbmZvKGBObyBwbGF0Zm9ybVZlcnNpb24gc3BlY2lmaWVkLiBVc2luZyBsYXRlc3QgdmVyc2lvbiBYY29kZSBzdXBwb3J0czogJyR7dGhpcy5pb3NTZGtWZXJzaW9ufScgYCArXG4gICAgICAgICAgICAgICBgVGhpcyBtYXkgY2F1c2UgcHJvYmxlbXMgaWYgYSBzaW11bGF0b3IgZG9lcyBub3QgZXhpc3QgZm9yIHRoaXMgcGxhdGZvcm0gdmVyc2lvbi5gKTtcbiAgICAgIHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24gPSB0aGlzLmlvc1Nka1ZlcnNpb247XG4gICAgfVxuICAgIGRldmljZSA9IGF3YWl0IHRoaXMuY3JlYXRlU2ltKCk7XG4gICAgcmV0dXJuIHtkZXZpY2UsIHJlYWxEZXZpY2U6IGZhbHNlLCB1ZGlkOiBkZXZpY2UudWRpZH07XG4gIH1cblxuICBhc3luYyBzdGFydFNpbSAoKSB7XG4gICAgLy8gVE9ETyBmb3Igbm93IGp1c3Qga2lsbCBhbGwgc2ltcyB1bmxlc3Mgc3BlY2lmaWVkIHVkaWQgaXMgYm9vdGVkLlxuICAgIC8vIGlmIGJvb3RlZCwgdXNlIGl0LiBpZiBub3QgYm9vdGVkLCBzdGFydCBpdCB1cFxuICAgIC8vIGlmIG5vIHVkaWQsIHdlbGwgbGV0cyBzZWUgaWYgd2UgY2FuIHN0YXJ0IG9uZSB1cCBiYXNlZCBvbiBkZXNpcmVkIGNhcHNcbiAgICAvLyBpZiB3ZSBzdXBwb3J0IG11bHRpcGxlIHNpbXMgd2UgbmVlZCB0byBjaGFuZ2UgdGhpc1xuXG4gICAgaWYgKCFhd2FpdCBzaW1Cb290ZWQodGhpcy5vcHRzLmRldmljZSkpIHtcbiAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCB1ZGlkICcke3RoaXMub3B0cy51ZGlkfScgbm90IGJvb3RlZC4gQm9vdGluZyB1cCBub3dgKTtcbiAgICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gICAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLnJ1bigpO1xuICAgICAgdGhpcy5saWZlY3ljbGVEYXRhLmJvb3RTaW0gPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIHdpdGggdWRpZCAnJHt0aGlzLm9wdHMudWRpZH0nIGFscmVhZHkgYm9vdGVkYCk7XG4gICAgICB0aGlzLmxpZmVjeWNsZURhdGEuYm9vdFNpbSA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNpbSAoKSB7XG4gICAgdGhpcy5saWZlY3ljbGVEYXRhLmNyZWF0ZVNpbSA9IHRydWU7XG5cbiAgICAvLyBjcmVhdGUgc2ltIGZvciBjYXBzXG4gICAgbGV0IHNpbSA9IGF3YWl0IGNyZWF0ZVNpbSh0aGlzLm9wdHMsIHRoaXMuc2Vzc2lvbklkKTtcbiAgICBsb2cuaW5mbyhgQ3JlYXRlZCBzaW11bGF0b3Igd2l0aCB1ZGlkICcke3NpbS51ZGlkfScuYCk7XG5cbiAgICByZXR1cm4gc2ltO1xuICB9XG5cbiAgYXN5bmMgbGF1bmNoQXBwICgpIHtcbiAgICBjb25zdCBBUFBfTEFVTkNIX1RJTUVPVVQgPSAyMCAqIDEwMDA7XG5cbiAgICBhd2FpdCBsYXVuY2godGhpcy5vcHRzLmRldmljZS51ZGlkLCB0aGlzLm9wdHMuYnVuZGxlSWQpO1xuXG4gICAgbGV0IGNoZWNrU3RhdHVzID0gYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgICBsZXQgY3VycmVudEFwcCA9IHJlc3BvbnNlLmN1cnJlbnRBcHAuYnVuZGxlSUQ7XG4gICAgICBpZiAoY3VycmVudEFwcCAhPT0gdGhpcy5vcHRzLmJ1bmRsZUlkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLm9wdHMuYnVuZGxlSWR9IG5vdCBpbiBmb3JlZ3JvdW5kLiAke2N1cnJlbnRBcHB9IGlzIGluIGZvcmVncm91bmRgKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgbG9nLmluZm8oYFdhaXRpbmcgZm9yICcke3RoaXMub3B0cy5idW5kbGVJZH0nIHRvIGJlIGluIGZvcmVncm91bmRgKTtcbiAgICBsZXQgcmV0cmllcyA9IHBhcnNlSW50KEFQUF9MQVVOQ0hfVElNRU9VVCAvIDIwMCwgMTApO1xuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwocmV0cmllcywgMjAwLCBjaGVja1N0YXR1cyk7XG4gICAgbG9nLmluZm8oYCR7dGhpcy5vcHRzLmJ1bmRsZUlkfSBpcyBpbiBmb3JlZ3JvdW5kYCk7XG4gIH1cblxuICBhc3luYyBzdGFydFdkYVNlc3Npb24gKGJ1bmRsZUlkLCBwcm9jZXNzQXJndW1lbnRzKSB7XG4gICAgbGV0IGFyZ3MgPSBwcm9jZXNzQXJndW1lbnRzID8gcHJvY2Vzc0FyZ3VtZW50cy5hcmdzIDogW107XG4gICAgbGV0IGVudiA9IHByb2Nlc3NBcmd1bWVudHMgPyBwcm9jZXNzQXJndW1lbnRzLmVudiA6IHt9O1xuXG4gICAgbGV0IGRlc2lyZWQgPSB7XG4gICAgICBkZXNpcmVkQ2FwYWJpbGl0aWVzOiB7XG4gICAgICAgIGJ1bmRsZUlkLFxuICAgICAgICBhcmd1bWVudHM6IGFyZ3MsXG4gICAgICAgIGVudmlyb25tZW50OiBlbnYsXG4gICAgICAgIHNob3VsZFdhaXRGb3JRdWllc2NlbmNlOiB0cnVlXG4gICAgICB9XG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywgZGVzaXJlZCk7XG4gIH1cblxuICAvLyBPdmVycmlkZSBQcm94eSBtZXRob2RzIGZyb20gQmFzZURyaXZlclxuICBwcm94eUFjdGl2ZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuandwUHJveHlBY3RpdmU7XG4gIH1cblxuICBnZXRQcm94eUF2b2lkTGlzdCAoKSB7XG4gICAgaWYgKHRoaXMuaXNXZWJ2aWV3KCkpIHtcbiAgICAgIHJldHVybiBOT19QUk9YWV9XRUJfTElTVDtcbiAgICB9XG4gICAgcmV0dXJuIE5PX1BST1hZX05BVElWRV9MSVNUO1xuICB9XG5cbiAgY2FuUHJveHkgKCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaXNTYWZhcmkgKCkge1xuICAgIHJldHVybiAhIXRoaXMuc2FmYXJpO1xuICB9XG5cbiAgaXNSZWFsRGV2aWNlICgpIHtcbiAgICByZXR1cm4gdGhpcy5vcHRzLnJlYWxEZXZpY2U7XG4gIH1cblxuICBpc1NpbXVsYXRvciAoKSB7XG4gICAgcmV0dXJuICF0aGlzLm9wdHMucmVhbERldmljZTtcbiAgfVxuXG4gIGlzV2VidmlldyAoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNTYWZhcmkoKSB8fCB0aGlzLmlzV2ViQ29udGV4dCgpO1xuICB9XG5cbiAgdmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3kgKHN0cmF0ZWd5KSB7XG4gICAgc3VwZXIudmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3koc3RyYXRlZ3ksIHRoaXMuaXNXZWJDb250ZXh0KCkpO1xuICB9XG5cbiAgdmFsaWRhdGVEZXNpcmVkQ2FwcyAoY2Fwcykge1xuICAgIC8vIGNoZWNrIHdpdGggdGhlIGJhc2UgY2xhc3MsIGFuZCByZXR1cm4gaWYgaXQgZmFpbHNcbiAgICBsZXQgcmVzID0gc3VwZXIudmFsaWRhdGVEZXNpcmVkQ2FwcyhjYXBzKTtcbiAgICBpZiAoIXJlcykgcmV0dXJuIHJlcztcblxuICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBjYXBhYmlsaXRpZXMgaGF2ZSBvbmUgb2YgYGFwcGAgb3IgYGJ1bmRsZUlkYFxuICAgIGlmICgoY2Fwcy5icm93c2VyTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSAhPT0gJ3NhZmFyaScgJiZcbiAgICAgICAgIWNhcHMuYXBwICYmICEgY2Fwcy5idW5kbGVJZCkge1xuICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIGVpdGhlciBhbiBhcHAgb3IgYSBidW5kbGVJZCBmb3IgaU9TJztcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuXG4gICAgbGV0IHZlcmlmeVByb2Nlc3NBcmd1bWVudCA9IChwcm9jZXNzQXJndW1lbnRzKSA9PiB7XG4gICAgICBpZiAoIV8uaXNOaWwocHJvY2Vzc0FyZ3VtZW50cy5hcmdzKSAmJiAhXy5pc0FycmF5KHByb2Nlc3NBcmd1bWVudHMuYXJncykpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ3Byb2Nlc3NBcmd1bWVudHMuYXJncyBtdXN0IGJlIGFuIGFycmF5IG9mIHN0cmluZycpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIV8uaXNOaWwocHJvY2Vzc0FyZ3VtZW50cy5lbnYpICYmICFfLmlzT2JqZWN0KGNhcHMucHJvY2Vzc0FyZ3VtZW50cy5lbnYpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KCdwcm9jZXNzQXJndW1lbnRzLmVudiBtdXN0IGJlIGFuIG9iamVjdCA8a2V5LHZhbHVlPiBwYWlyIHthOmIsIGM6ZH0nKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gYHByb2Nlc3NBcmd1bWVudHNgIHNob3VsZCBiZSBKU09OIHN0cmluZyBvciBhbiBvYmplY3Qgd2l0aCBhcmd1bWVudHMgYW5kLyBlbnZpcm9ubWVudCBkZXRhaWxzXG4gICAgaWYgKGNhcHMucHJvY2Vzc0FyZ3VtZW50cykge1xuICAgICAgaWYgKF8uaXNTdHJpbmcoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIHRyeSB0byBwYXJzZSB0aGUgc3RyaW5nIGFzIEpTT05cbiAgICAgICAgICBjYXBzLnByb2Nlc3NBcmd1bWVudHMgPSBKU09OLnBhcnNlKGNhcHMucHJvY2Vzc0FyZ3VtZW50cyk7XG4gICAgICAgICAgdmVyaWZ5UHJvY2Vzc0FyZ3VtZW50KGNhcHMucHJvY2Vzc0FyZ3VtZW50cyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBwcm9jZXNzQXJndW1lbnRzIG11c3QgYmUgYSBqc29uIGZvcm1hdCBvciBhbiBvYmplY3Qgd2l0aCBmb3JtYXQge2FyZ3MgOiBbXSwgZW52IDoge2E6YiwgYzpkfX0uIEJvdGggZW52aXJvbm1lbnQgYW5kIGFyZ3VtZW50IGNhbiBiZSBudWxsLiBFcnJvcjogJHtlcnJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdChjYXBzLnByb2Nlc3NBcmd1bWVudHMpKSB7XG4gICAgICAgIHZlcmlmeVByb2Nlc3NBcmd1bWVudChjYXBzLnByb2Nlc3NBcmd1bWVudHMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ3Byb2Nlc3NBcmd1bWVudHMgbXVzdCBiZSBhbiBvYmplY3QsIG9yIGEgc3RyaW5nIEpTT04gb2JqZWN0IHdpdGggZm9ybWF0IHthcmdzIDogW10sIGVudiA6IHthOmIsIGM6ZH19LiBCb3RoIGVudmlyb25tZW50IGFuZCBhcmd1bWVudCBjYW4gYmUgbnVsbC4nKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB0aGVyZSBpcyBubyBwb2ludCBpbiBoYXZpbmcgYGtleWNoYWluUGF0aGAgd2l0aG91dCBga2V5Y2hhaW5QYXNzd29yZGBcbiAgICBpZiAoKGNhcHMua2V5Y2hhaW5QYXRoICYmICFjYXBzLmtleWNoYWluUGFzc3dvcmQpIHx8ICghY2Fwcy5rZXljaGFpblBhdGggJiYgY2Fwcy5rZXljaGFpblBhc3N3b3JkKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYElmICdrZXljaGFpblBhdGgnIGlzIHNldCwgJ2tleWNoYWluUGFzc3dvcmQnIG11c3QgYWxzbyBiZSBzZXQgKGFuZCB2aWNlIHZlcnNhKS5gKTtcbiAgICB9XG5cbiAgICAvLyBmaW5hbGx5LCByZXR1cm4gdHJ1ZSBzaW5jZSB0aGUgc3VwZXJjbGFzcyBjaGVjayBwYXNzZWQsIGFzIGRpZCB0aGlzXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsQXBwICgpIHtcbiAgICBpZiAodGhpcy5pc1NhZmFyaSgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGlmIHVzZXIgaGFzIHBhc3NlZCBpbiBkZXNpcmVkQ2Fwcy5hdXRvTGF1bmNoID0gZmFsc2VcbiAgICAvLyBtZWFuaW5nIHRoZXkgd2lsbCBtYW5hZ2UgYXBwIGluc3RhbGwgLyBsYXVuY2hpbmdcbiAgICBpZiAodGhpcy5vcHRzLmF1dG9MYXVuY2ggPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5zdGFsbFRvUmVhbERldmljZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLmluc3RhbGxUb1NpbXVsYXRvcigpO1xuICAgIH1cblxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHRoaXMub3B0cy5pb3NJbnN0YWxsUGF1c2UpKSB7XG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvNjg4OVxuICAgICAgbGV0IHBhdXNlID0gcGFyc2VJbnQodGhpcy5vcHRzLmlvc0luc3RhbGxQYXVzZSwgMTApO1xuICAgICAgYXdhaXQgQi5kZWxheShwYXVzZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRvU2ltdWxhdG9yICgpIHtcbiAgICBpZiAodGhpcy5vcHRzLmZ1bGxSZXNldCAmJiB0aGlzLm9wdHMuYnVuZGxlSWQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRnVsbCByZXNldCByZXF1ZXN0ZWQuIFJlbW92aW5nIGFwcCBmcm9tIGRldmljZScpO1xuICAgICAgYXdhaXQgcmVtb3ZlQXBwKHRoaXMub3B0cy5kZXZpY2UudWRpZCwgdGhpcy5vcHRzLmJ1bmRsZUlkKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBJbnN0YWxsaW5nIGFwcCAnJHt0aGlzLm9wdHMuYXBwfScgb24gZGV2aWNlYCk7XG4gICAgYXdhaXQgaW5zdGFsbEFwcCh0aGlzLm9wdHMuZGV2aWNlLnVkaWQsIHRoaXMub3B0cy5hcHApO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRvUmVhbERldmljZSAoKSB7XG4gICAgaWYgKHRoaXMub3B0cy51ZGlkKSB7XG4gICAgICBpZiAoYXdhaXQgdGhpcy5vcHRzLmRldmljZS5pc0luc3RhbGxlZCh0aGlzLm9wdHMuYnVuZGxlSWQpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhcIkFwcCBpcyBhbHJlYWR5IGluc3RhbGxlZC5cIik7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuZnVsbFJlc2V0KSB7XG4gICAgICAgICAgbG9nLmRlYnVnKCdGdWxsIHJlc2V0IHJlcXVlc3RlZC4gRm9yY2luZyBhcHAgaW5zdGFsbCBhZnRlciB1bmluc3RhbGwgYXBwJyk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5yZW1vdmUodGhpcy5vcHRzLmJ1bmRsZUlkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2cuZGVidWcoJ0Z1bGwgcmVzZXQgbm90IHJlcXVlc3RlZC4gTm8gbmVlZCB0byBpbnN0YWxsLicpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKCdBcHAgaXMgbm90IGluc3RhbGxlZC4gV2lsbCB0cnkgdG8gaW5zdGFsbC4nKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICAgICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5pbnN0YWxsKHRoaXMub3B0cy5hcHApO1xuICAgICAgICBsb2cuZGVidWcoJ0FwcCBpbnN0YWxsZWQgc3VjY2Vzc2Z1bGx5LicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKFwiUmVhbCBkZXZpY2Ugc3BlY2lmaWVkIGJ1dCBubyBpcGEgb3IgYXBwIHBhdGgsIGFzc3VtaW5nIGJ1bmRsZSBJRCBpcyBcIiArXG4gICAgICAgICAgICAgICAgICAgICBcIm9uIGRldmljZVwiKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKFwiTm8gZGV2aWNlIGlkIG9yIGFwcCwgbm90IGluc3RhbGxpbmcgdG8gcmVhbCBkZXZpY2UuXCIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldElEZXZpY2VPYmogKCkge1xuICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgaURldmljZSBvYmplY3Qgd2l0aCB1ZGlkICR7dGhpcy5vcHRzLnVkaWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIC8vVGhpcyBpRGV2aWNlIG9iamVjdCBjb3VsZCBiZSBpZGV2aWNlaW5zdGFsbGVyIChub2RlLWlkZXZpY2UpIGZvciBmdXR1cmUgb25jZSB3ZSBoYXZlIGlkZXZpY2VpbnN0YWxsZXIgd29ya2luZyBmb3IgaW9zIDEwXG4gICAgICBsZXQgaURldmljZSA9IG5ldyBJT1NEZXBsb3kodGhpcy5vcHRzLnVkaWQpO1xuICAgICAgYXdhaXQgaURldmljZS5jaGVja1N0YXR1cygpO1xuICAgICAgcmV0dXJuIGlEZXZpY2U7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbGV0IG1zZyA9IFwiQ291bGQgbm90IGluaXRpYWxpemUgaW9zLWRlcGxveSBtYWtlIHN1cmUgaXQgaXMgXCIgK1xuICAgICAgICAgICAgICAgIFwiaW5zdGFsbGVkIGFuZCB3b3JrcyBvbiB5b3VyIHN5c3RlbVwiO1xuICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXRJbml0aWFsT3JpZW50YXRpb24gKG9yaWVudGF0aW9uKSB7XG4gICAgaWYgKHR5cGVvZiBvcmllbnRhdGlvbiAhPT0gJ3N0cmluZycpIHtcbiAgICAgIG9yaWVudGF0aW9uID0gJ1BPUlRSQUlUJztcbiAgICB9XG4gICAgb3JpZW50YXRpb24gPSBvcmllbnRhdGlvbi50b1VwcGVyQ2FzZSgpO1xuICAgIGlmICghXy5pbmNsdWRlcyhbJ0xBTkRTQ0FQRScsICdQT1JUUkFJVCddLCBvcmllbnRhdGlvbikpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVW5hYmxlIHRvIHNldCBpbml0aWFsIG9yaWVudGF0aW9uIHRvICcke29yaWVudGF0aW9ufSdgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBTZXR0aW5nIGluaXRpYWwgb3JpZW50YXRpb24gdG8gJyR7b3JpZW50YXRpb259J2ApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL29yaWVudGF0aW9uJywgJ1BPU1QnLCB7b3JpZW50YXRpb259KTtcbiAgICAgIHRoaXMub3B0cy5jdXJPcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYFNldHRpbmcgaW5pdGlhbCBvcmllbnRhdGlvbiBmYWlsZWQgd2l0aDogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG59XG5cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gIFhDVUlUZXN0RHJpdmVyLnByb3RvdHlwZVtjbWRdID0gZm47XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgWENVSVRlc3REcml2ZXI7XG5leHBvcnQgeyBYQ1VJVGVzdERyaXZlciB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
