'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

function getConnectedDevices() {
  var _ref, stdout;

  return _regeneratorRuntime.async(function getConnectedDevices$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('idevice_id', ['-l']));

      case 2:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        return context$1$0.abrupt('return', stdout.trim().split('\n'));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function resetRealDevice(device, opts) {
  var bundleId;
  return _regeneratorRuntime.async(function resetRealDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(opts.bundleId && opts.fullReset)) {
          context$1$0.next = 18;
          break;
        }

        bundleId = opts.bundleId;

        _logger2['default'].debug('Full reset requested. Will try to uninstall the app \'' + bundleId + '\'.');
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(device.isInstalled(bundleId));

      case 5:
        if (context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].debug('App not installed. No need to uninstall');
        return context$1$0.abrupt('return');

      case 8:
        context$1$0.prev = 8;
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(device.remove(bundleId));

      case 11:
        context$1$0.next = 17;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](8);

        _logger2['default'].error('Could not remove \'' + bundleId + '\' from device');
        throw context$1$0.t0;

      case 17:
        _logger2['default'].debug('Removed \'' + bundleId + '\'');

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 13]]);
}

function runRealDeviceReset(device, opts) {
  return _regeneratorRuntime.async(function runRealDeviceReset$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!opts.noReset || opts.fullReset)) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].debug('Running ios real device reset flow');

        if (opts.noReset) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(resetRealDevice(device, opts));

      case 5:
        context$1$0.next = 8;
        break;

      case 7:
        _logger2['default'].debug("Reset not set, continuing");

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.getConnectedDevices = getConnectedDevices;
exports.runRealDeviceReset = runRealDeviceReset;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZWFsLWRldmljZS1tYW5hZ2VtZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7NEJBQXFCLGNBQWM7O3NCQUNuQixVQUFVOzs7O0FBRzFCLFNBQWUsbUJBQW1CO1lBQzNCLE1BQU07Ozs7Ozt5Q0FBVSx3QkFBSyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7OztBQUExQyxjQUFNLFFBQU4sTUFBTTs0Q0FDSixNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzs7Ozs7OztDQUNqQzs7QUFFRCxTQUFlLGVBQWUsQ0FBRSxNQUFNLEVBQUUsSUFBSTtNQUVwQyxRQUFROzs7O2NBRFYsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFBOzs7OztBQUM3QixnQkFBUSxHQUFHLElBQUksQ0FBQyxRQUFROztBQUM1Qiw0QkFBSSxLQUFLLDREQUF5RCxRQUFRLFNBQUssQ0FBQzs7eUNBQ3JFLE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDOzs7Ozs7OztBQUNyQyw0QkFBSSxLQUFLLENBQUMseUNBQXlDLENBQUMsQ0FBQzs7Ozs7O3lDQUkvQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQzs7Ozs7Ozs7OztBQUU3Qiw0QkFBSSxLQUFLLHlCQUFzQixRQUFRLG9CQUFnQixDQUFDOzs7O0FBRzFELDRCQUFJLEtBQUssZ0JBQWEsUUFBUSxRQUFJLENBQUM7Ozs7Ozs7Q0FFdEM7O0FBRUQsU0FBZSxrQkFBa0IsQ0FBRSxNQUFNLEVBQUUsSUFBSTs7OztjQUN6QyxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQTs7Ozs7QUFDakMsNEJBQUksS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7O1lBQzNDLElBQUksQ0FBQyxPQUFPOzs7Ozs7eUNBQ1QsZUFBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUM7Ozs7Ozs7QUFHckMsNEJBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7Ozs7Ozs7Q0FFMUM7O1FBRVEsbUJBQW1CLEdBQW5CLG1CQUFtQjtRQUFFLGtCQUFrQixHQUFsQixrQkFBa0IiLCJmaWxlIjoibGliL3JlYWwtZGV2aWNlLW1hbmFnZW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGdldENvbm5lY3RlZERldmljZXMgKCkge1xuICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdpZGV2aWNlX2lkJywgWyctbCddKTtcbiAgcmV0dXJuIHN0ZG91dC50cmltKCkuc3BsaXQoJ1xcbicpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNldFJlYWxEZXZpY2UgKGRldmljZSwgb3B0cykge1xuICBpZiAob3B0cy5idW5kbGVJZCAmJiBvcHRzLmZ1bGxSZXNldCkge1xuICAgIGxldCBidW5kbGVJZCA9IG9wdHMuYnVuZGxlSWQ7XG4gICAgbG9nLmRlYnVnKGBGdWxsIHJlc2V0IHJlcXVlc3RlZC4gV2lsbCB0cnkgdG8gdW5pbnN0YWxsIHRoZSBhcHAgJyR7YnVuZGxlSWR9Jy5gKTtcbiAgICBpZiAoIWF3YWl0IGRldmljZS5pc0luc3RhbGxlZChidW5kbGVJZCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnQXBwIG5vdCBpbnN0YWxsZWQuIE5vIG5lZWQgdG8gdW5pbnN0YWxsJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBkZXZpY2UucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcihgQ291bGQgbm90IHJlbW92ZSAnJHtidW5kbGVJZH0nIGZyb20gZGV2aWNlYCk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgUmVtb3ZlZCAnJHtidW5kbGVJZH0nYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuUmVhbERldmljZVJlc2V0IChkZXZpY2UsIG9wdHMpIHtcbiAgaWYgKCFvcHRzLm5vUmVzZXQgfHwgb3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2cuZGVidWcoJ1J1bm5pbmcgaW9zIHJlYWwgZGV2aWNlIHJlc2V0IGZsb3cnKTtcbiAgICBpZiAoIW9wdHMubm9SZXNldCkge1xuICAgICAgYXdhaXQgcmVzZXRSZWFsRGV2aWNlKGRldmljZSwgb3B0cyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZyhcIlJlc2V0IG5vdCBzZXQsIGNvbnRpbnVpbmdcIik7XG4gIH1cbn1cblxuZXhwb3J0IHsgZ2V0Q29ubmVjdGVkRGV2aWNlcywgcnVuUmVhbERldmljZVJlc2V0IH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
